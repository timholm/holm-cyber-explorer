<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#0a0a0f">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>holm.chat</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" type="image/svg+xml" href="/icons/icon-192.svg">
<link rel="apple-touch-icon" href="/icons/icon-192.svg">
<meta name="apple-mobile-web-app-title" content="holm.chat">
<meta name="format-detection" content="telephone=no">

<style>
@font-face { font-family: 'JetBrains Mono'; src: url('/fonts/JetBrainsMono-Regular.woff2') format('woff2'); font-weight: 400; font-style: normal; font-display: swap; }
@font-face { font-family: 'JetBrains Mono'; src: url('/fonts/JetBrainsMono-Medium.woff2') format('woff2'); font-weight: 500; font-style: normal; font-display: swap; }
@font-face { font-family: 'JetBrains Mono'; src: url('/fonts/JetBrainsMono-Bold.woff2') format('woff2'); font-weight: 700; font-style: normal; font-display: swap; }

:root {
  --bg: #0a0a0f;
  --bg2: #111118;
  --bg3: #1a1a24;
  --cyan: #00f0ff;
  --magenta: #ff00aa;
  --text: #d8d8e0;
  --muted: #666678;
  --dim: #333344;
  --border: #222233;
  --font: 'JetBrains Mono', monospace;
  --max-w: 800px;
  --safe-b: env(safe-area-inset-bottom, 0px);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 14px; -webkit-text-size-adjust: 100%; }
body { font-family: var(--font); background: var(--bg); color: var(--text); min-height: 100dvh; overscroll-behavior: none; -webkit-font-smoothing: antialiased; }
a { color: var(--cyan); text-decoration: none; }
a:hover { text-decoration: underline; }
button { font-family: var(--font); cursor: pointer; border: none; background: none; color: var(--text); -webkit-tap-highlight-color: transparent; }
input, textarea { font-family: var(--font); }
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--dim); border-radius: 3px; }

/* ── Header ── */
header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(10,10,15,0.92); backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--border);
  padding: 0 1rem; height: 48px;
  display: flex; align-items: center; gap: 1rem;
}
.logo { font-weight: 700; color: var(--cyan); letter-spacing: 0.08em; font-size: 0.95rem; cursor: pointer; white-space: nowrap; }
.logo:hover { text-shadow: 0 0 8px rgba(0,240,255,0.4); }
header nav { display: flex; gap: 0.75rem; align-items: center; flex: 1; justify-content: flex-end; }
header nav button { font-size: 0.75rem; color: var(--muted); padding: 0.3rem 0; transition: color 0.15s; }
header nav button:hover, header nav button.active { color: var(--cyan); }
.search-trigger { display: flex; align-items: center; gap: 0.4rem; padding: 0.3rem 0.6rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.7rem; color: var(--muted); }
.search-trigger:hover { border-color: var(--cyan); color: var(--cyan); }
.search-trigger kbd { font-size: 0.6rem; background: var(--bg3); padding: 0.1rem 0.3rem; border-radius: 3px; }

/* ── Page Layout ── */
main { max-width: var(--max-w); margin: 0 auto; padding: 1.5rem 1rem 4rem; }

/* ── Wiki Home ── */
.wiki-home h1 { font-size: 1.3rem; font-weight: 700; color: var(--cyan); margin-bottom: 0.3rem; }
.wiki-home .subtitle { font-size: 0.75rem; color: var(--muted); margin-bottom: 2rem; }

.domain-section { margin-bottom: 1.5rem; }
.domain-heading {
  font-size: 0.7rem; font-weight: 500; color: var(--muted);
  letter-spacing: 0.1em; text-transform: uppercase;
  padding-bottom: 0.4rem; margin-bottom: 0.5rem;
  border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center;
}
.domain-heading span { color: var(--dim); font-weight: 400; text-transform: none; letter-spacing: 0; }

.doc-link {
  display: flex; align-items: baseline; gap: 0.6rem;
  padding: 0.35rem 0; cursor: pointer;
  transition: color 0.1s;
}
.doc-link:hover { color: var(--cyan); }
.doc-link-id { font-size: 0.65rem; color: var(--dim); min-width: 55px; flex-shrink: 0; }
.doc-link-title { font-size: 0.8rem; }
.doc-link:hover .doc-link-id { color: var(--muted); }

/* ── Document Page ── */
.doc-page .breadcrumb {
  font-size: 0.7rem; color: var(--muted); margin-bottom: 1.5rem;
  display: flex; align-items: center; gap: 0.3rem; flex-wrap: wrap;
}
.breadcrumb a { color: var(--cyan); }
.breadcrumb .sep { color: var(--dim); }

.doc-page h1 { font-size: 1.2rem; font-weight: 700; line-height: 1.3; margin-bottom: 0.6rem; }

.doc-meta { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 1.5rem; }
.tag {
  font-size: 0.6rem; padding: 0.12rem 0.45rem;
  border: 1px solid var(--border); border-radius: 12px;
  color: var(--muted);
}
.tag.domain { border-color: var(--cyan); color: var(--cyan); }
/* Document Metadata Bar */
.doc-meta-bar {
  display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem;
  padding: 0.5rem 0.65rem; margin-bottom: 0.8rem;
  background: var(--bg2); border: 1px solid var(--border); border-radius: 6px;
}
.meta-badge {
  font-size: 0.6rem; font-weight: 700; padding: 0.15rem 0.5rem;
  border-radius: 4px; letter-spacing: 0.04em; text-transform: uppercase;
  display: inline-flex; align-items: center; gap: 0.25rem;
}
.meta-badge.version {
  background: rgba(0, 240, 255, 0.1); border: 1px solid rgba(0, 240, 255, 0.3);
  color: var(--cyan);
}
.meta-badge.domain-badge {
  border: 1px solid; font-weight: 500;
}
.status-pill {
  font-size: 0.6rem; font-weight: 700; padding: 0.15rem 0.5rem;
  border-radius: 10px; letter-spacing: 0.04em; text-transform: uppercase;
  display: inline-flex; align-items: center; gap: 0.25rem;
}
.status-pill::before {
  content: ''; width: 6px; height: 6px; border-radius: 50%;
  display: inline-block; flex-shrink: 0;
}
.status-pill.active { background: rgba(0, 230, 118, 0.1); border: 1px solid rgba(0, 230, 118, 0.3); color: #00e676; }
.status-pill.active::before { background: #00e676; box-shadow: 0 0 4px #00e676; }
.status-pill.draft { background: rgba(255, 235, 59, 0.1); border: 1px solid rgba(255, 235, 59, 0.3); color: #ffeb3b; }
.status-pill.draft::before { background: #ffeb3b; box-shadow: 0 0 4px #ffeb3b; }
.status-pill.deprecated { background: rgba(255, 68, 68, 0.1); border: 1px solid rgba(255, 68, 68, 0.3); color: #ff4444; }
.status-pill.deprecated::before { background: #ff4444; box-shadow: 0 0 4px #ff4444; }
.status-pill.unknown { background: rgba(102, 102, 120, 0.1); border: 1px solid rgba(102, 102, 120, 0.3); color: var(--muted); }
.status-pill.unknown::before { background: var(--muted); }
.meta-date {
  font-size: 0.6rem; color: var(--muted); margin-left: auto;
  display: inline-flex; align-items: center; gap: 0.25rem;
}
.meta-date .date-icon { opacity: 0.6; }
.meta-sep { width: 1px; height: 1rem; background: var(--border); flex-shrink: 0; }


/* Dependencies */
.deps { margin-bottom: 1.5rem; }
.deps-label { font-size: 0.65rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 0.4rem; }
.deps-list { display: flex; flex-wrap: wrap; gap: 0.3rem; }
.dep-chip {
  font-size: 0.7rem; padding: 0.15rem 0.5rem;
  background: var(--bg2); border: 1px solid var(--border); border-radius: 4px;
  color: var(--cyan); cursor: pointer; transition: border-color 0.15s;
}
.dep-chip:hover { border-color: var(--cyan); }
.dep-chip.broken { color: #f44; border-color: rgba(255,68,68,0.3); text-decoration: line-through; cursor: default; }

/* Document content */
.doc-content {
  line-height: 1.75; font-size: 0.85rem;
  word-break: break-word;
}
.doc-content h1 { font-size: 1.2rem; font-weight: 700; margin: 2rem 0 0.75rem; color: var(--cyan); }
.doc-content h2 { font-size: 1.05rem; font-weight: 700; margin: 1.8rem 0 0.6rem; border-bottom: 1px solid var(--border); padding-bottom: 0.3rem; }
.doc-content h3 { font-size: 0.95rem; font-weight: 600; margin: 1.5rem 0 0.5rem; }
.doc-content h4 { font-size: 0.85rem; font-weight: 600; margin: 1rem 0 0.4rem; color: var(--muted); }
.doc-content p { margin-bottom: 0.8rem; }
.doc-content ul, .doc-content ol { margin-bottom: 0.8rem; padding-left: 1.5rem; }
.doc-content li { margin-bottom: 0.25rem; }
.doc-content code { background: rgba(0,240,255,0.08); padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.8rem; color: var(--cyan); border: 1px solid rgba(0,240,255,0.15); }
.doc-content pre { background: #12121a; padding: 1rem 1rem 1rem 3.5rem; border-radius: 6px; border: 1px solid var(--border); border-left: 3px solid var(--magenta); overflow-x: auto; margin-bottom: 0.8rem; counter-reset: line-number; position: relative; }
.doc-content pre code { background: none; padding: 0; color: var(--text); border: none; font-size: 0.8rem; counter-increment: line-number; }
.doc-content pre code .line, .doc-content pre code { display: block; }
.doc-content pre::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 2.8rem; background: rgba(255,0,170,0.05); border-radius: 6px 0 0 6px; }
.doc-content blockquote { border-left: 3px solid var(--magenta); padding: 0.75rem 1.2rem; margin-bottom: 0.8rem; color: var(--muted); background: rgba(255,0,170,0.04); border-radius: 0 6px 6px 0; font-style: italic; }
.doc-content table { width: 100%; border-collapse: collapse; margin-bottom: 0.8rem; font-size: 0.8rem; border: 1px solid var(--border); }
.doc-content th, .doc-content td { padding: 0.5rem 0.75rem; border: 1px solid var(--border); text-align: left; }
.doc-content th { background: var(--bg3); color: var(--cyan); font-weight: 600; border-bottom: 2px solid var(--magenta); }
.doc-content tr:nth-child(even) { background: rgba(0,240,255,0.02); }
.doc-content tr:nth-child(odd) { background: var(--bg); }
.doc-content tr:hover { background: rgba(0,240,255,0.05); }
.doc-content dl { margin-bottom: 0.8rem; }
.doc-content dt { font-weight: 600; color: var(--cyan); margin-top: 0.5rem; }
.doc-content dd { margin-left: 1rem; margin-bottom: 0.3rem; color: var(--muted); }
.doc-content a { color: var(--cyan); }
.doc-content img { max-width: 100%; border-radius: 6px; }
.doc-content hr { border: none; border-top: 1px solid var(--border); margin: 1.5rem 0; }
.doc-content mark { background: rgba(0,240,255,0.15); color: var(--cyan); padding: 0 0.2rem; border-radius: 2px; }

/* Comments */
.comments { margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border); }
.comments-title { font-size: 0.7rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 1rem; }
.comment-form { display: flex; flex-direction: column; gap: 0.4rem; margin-bottom: 1.5rem; }
.comment-form input, .comment-form textarea {
  background: var(--bg2); border: 1px solid var(--border); border-radius: 6px;
  padding: 0.5rem 0.7rem; color: var(--text); font-size: 0.8rem; outline: none;
}
.comment-form input:focus, .comment-form textarea:focus { border-color: var(--magenta); }
.comment-form textarea { resize: vertical; min-height: 50px; }
.comment-form button {
  align-self: flex-end; padding: 0.4rem 1rem;
  background: rgba(255,0,170,0.1); border: 1px solid var(--magenta); border-radius: 6px;
  color: var(--magenta); font-size: 0.7rem; font-weight: 500; transition: background 0.15s;
}
.comment-form button:hover { background: rgba(255,0,170,0.2); }

.comment { background: var(--bg2); border: 1px solid var(--border); border-left: 3px solid var(--magenta); border-radius: 6px; padding: 0.6rem 0.75rem; margin-bottom: 0.5rem; }
.comment-header { display: flex; justify-content: space-between; margin-bottom: 0.2rem; }
.comment-author { font-size: 0.7rem; font-weight: 500; color: var(--magenta); }
.comment-time { font-size: 0.6rem; color: var(--dim); }
.comment-body { font-size: 0.8rem; line-height: 1.5; }

/* ── Search Overlay ── */
.search-overlay {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(10,10,15,0.95); backdrop-filter: blur(12px);
  display: none; flex-direction: column;
}
.search-overlay.open { display: flex; }
.search-bar {
  padding: 1rem; display: flex; align-items: center; gap: 0.75rem;
  border-bottom: 1px solid var(--border);
}
.search-bar input {
  flex: 1; background: var(--bg2); border: 1px solid var(--border); border-radius: 6px;
  padding: 0.6rem 0.8rem; color: var(--text); font-size: 0.9rem; outline: none;
}
.search-bar input:focus { border-color: var(--cyan); }
.search-bar input::placeholder { color: var(--dim); }
.search-bar .close-btn { font-size: 1.2rem; color: var(--muted); padding: 0.3rem; }
.search-bar .close-btn:hover { color: var(--text); }

.search-results { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 0.75rem 1rem; max-width: var(--max-w); margin: 0 auto; width: 100%; }
.search-result {
  padding: 0.65rem 0; border-bottom: 1px solid var(--border); cursor: pointer;
}
.search-result:hover .sr-title { color: var(--cyan); }
.sr-id { font-size: 0.6rem; color: var(--cyan); letter-spacing: 0.04em; }
.sr-title { font-size: 0.85rem; font-weight: 500; transition: color 0.1s; }
.sr-snippet { font-size: 0.75rem; color: var(--muted); line-height: 1.4; margin-top: 0.15rem; }
.sr-snippet mark { background: rgba(0,240,255,0.15); color: var(--cyan); padding: 0 0.1rem; border-radius: 2px; }
.sr-title mark { background: rgba(0,240,255,0.2); color: var(--cyan); padding: 0 0.1rem; border-radius: 2px; }
.sr-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.1rem; }
.sr-domain-badge { font-size: 0.55rem; padding: 0.08rem 0.35rem; border-radius: 3px; font-weight: 500; letter-spacing: 0.03em; white-space: nowrap; border: 1px solid; }
.search-empty { text-align: center; padding: 3rem; color: var(--dim); font-size: 0.8rem; }

/* ── Collapsible domain sections ── */
.domain-heading { cursor: pointer; user-select: none; }
.domain-heading::before { content: '▾'; margin-right: 0.5rem; color: var(--dim); transition: transform 0.15s; display: inline-block; }
.domain-section.collapsed .domain-heading::before { transform: rotate(-90deg); }
.domain-section.collapsed .doc-link { display: none; }


/* ── Toast ── */
.toast-container { position: fixed; bottom: calc(1rem + var(--safe-b)); left: 50%; transform: translateX(-50%); z-index: 300; display: flex; flex-direction: column; gap: 0.4rem; pointer-events: none; }
.toast { background: var(--bg3); border: 1px solid var(--border); border-radius: 6px; padding: 0.5rem 0.9rem; font-size: 0.7rem; pointer-events: auto; animation: fade-in 0.2s ease; white-space: nowrap; }
.toast.error { border-color: #f44; color: #f44; }
.toast.out { animation: fade-out 0.2s ease forwards; }
@keyframes fade-in { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fade-out { from { opacity: 1; } to { opacity: 0; } }

/* ── Loading ── */
.loading { display: flex; align-items: center; justify-content: center; min-height: 60vh; color: var(--muted); font-size: 0.8rem; }

/* ── Offline ── */
.offline-bar { display: none; position: fixed; top: 0; left: 0; right: 0; z-index: 400; background: var(--magenta); text-align: center; padding: 0.4rem 1rem; font-size: 0.7rem; font-weight: 700; color: #fff; letter-spacing: 0.1em; text-transform: uppercase; font-family: var(--font); box-shadow: 0 2px 12px rgba(255,0,170,0.4); }
body.offline .offline-bar { display: block; }
body.offline header { top: 28px; }
body.offline main { padding-top: 2.5rem; }

/* ── Table of Contents ── */
.toc { margin-bottom: 1.5rem; padding: 0.75rem 1rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 6px; }
.toc-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; -webkit-user-select: none; }
.toc-title { font-size: 0.65rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; }
.toc-toggle { font-size: 0.6rem; color: var(--muted); transition: transform 0.2s ease, color 0.15s; padding: 0.15rem 0.3rem; }
.toc-header:hover .toc-toggle { color: var(--cyan); }
.toc-body { overflow: hidden; transition: max-height 0.3s ease, opacity 0.2s ease; max-height: 2000px; opacity: 1; margin-top: 0.5rem; }
.toc.collapsed .toc-body { max-height: 0; opacity: 0; margin-top: 0; }
.toc.collapsed .toc-toggle { transform: rotate(-90deg); }
.toc a { display: block; font-size: 0.75rem; color: var(--muted); padding: 0.15rem 0; transition: color 0.15s; border-left: 2px solid transparent; padding-left: 0.5rem; }
.toc a:hover { color: var(--cyan); text-decoration: none; }
.toc a.toc-active { color: var(--cyan); border-left-color: var(--cyan); }
.toc a.toc-h2 { padding-left: 1.3rem; }
.toc a.toc-h3 { padding-left: 2.1rem; font-size: 0.7rem; }
.doc-content h1[id], .doc-content h2[id], .doc-content h3[id] { scroll-margin-top: 1rem; }

/* ── Document Nav ── */
.doc-nav-footer { display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border); }
.doc-nav-link { font-size: 0.75rem; color: var(--muted); cursor: pointer; transition: color 0.15s; max-width: 45%; }
.doc-nav-link:hover { color: var(--cyan); }
.doc-nav-link .nav-label { font-size: 0.6rem; letter-spacing: 0.06em; text-transform: uppercase; margin-bottom: 0.15rem; }
.doc-nav-link .nav-title { color: var(--text); font-size: 0.8rem; }
.doc-nav-link:hover .nav-title { color: var(--cyan); }
.doc-nav-link.next { text-align: right; margin-left: auto; }


/* ── Progress Bar ── */
.progress-bar { position: fixed; top: 0; left: 0; height: 2px; background: var(--cyan); z-index: 200; width: 0%; transition: width 0.1s; pointer-events: none; opacity: 0; }
.progress-bar.visible { opacity: 1; }
/* ── Copy Button ── */
.copy-btn { font-size: 0.65rem; color: var(--muted); padding: 0.2rem 0.5rem; border: 1px solid var(--border); border-radius: 4px; transition: color 0.15s, border-color 0.15s; }
.copy-btn:hover { color: var(--cyan); border-color: var(--cyan); }
.recent { margin-bottom: 2rem; }
.recent-title { font-size: 0.65rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 0.5rem; }
.recent-list { display: flex; flex-wrap: wrap; gap: 0.4rem; }
.recent-chip { font-size: 0.7rem; padding: 0.2rem 0.5rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 4px; color: var(--cyan); cursor: pointer; transition: border-color 0.15s; }
.recent-chip:hover { border-color: var(--cyan); }

/* ── Bookmarks ── */
.bookmarks { margin-bottom: 2rem; }
.bookmarks-title { font-size: 0.65rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 0.5rem; }
.bookmarks-list { display: flex; flex-wrap: wrap; gap: 0.4rem; }
.bookmark-chip { font-size: 0.7rem; padding: 0.2rem 0.5rem; background: var(--bg2); border: 1px solid rgba(0,240,255,0.25); border-radius: 4px; color: var(--cyan); cursor: pointer; transition: border-color 0.15s; }
.bookmark-chip:hover { border-color: var(--cyan); }
.bookmark-btn { font-size: 1.2rem; cursor: pointer; transition: color 0.15s, text-shadow 0.15s; line-height: 1; padding: 0.2rem; }
.bookmark-btn.active { color: var(--cyan); text-shadow: 0 0 8px rgba(0,240,255,0.5); }
.bookmark-btn:not(.active) { color: var(--muted); }
.bookmark-btn:hover { color: var(--cyan); }

/* ── Print ── */
@media print {
  header, .search-overlay, .toast-container, .comments, .offline-bar, .back-top, .progress-bar, .doc-nav-footer, .toc, .deps { display: none !important; }
  body { background: white; color: black; font-size: 12pt; }
  main { max-width: none; padding: 0; }
  .doc-page h1 { color: black; font-size: 18pt; }
  .doc-meta-bar { display: none; }
  .doc-meta { display: none; }
  .breadcrumb { display: none; }
  .doc-content { font-size: 11pt; line-height: 1.6; }
  .doc-content h1, .doc-content h2, .doc-content h3 { color: black; }
  .doc-content a { color: black; text-decoration: underline; }
  .doc-content code { background: #f0f0f0; color: black; }
  .doc-content pre { background: #f5f5f5; border: 1px solid #ddd; }
  .doc-content blockquote { border-left-color: #999; color: #333; background: none; }
  .doc-content table { border-color: #ccc; }
  .doc-content th { background: #f0f0f0; color: black; }
}

@media (min-width: 768px) {
  html { font-size: 15px; }
  main { padding: 2rem 1.5rem 4rem; }
}

/* ── Domain Health Bars ── */
.domain-health { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
.health-bar { flex: 1; height: 3px; background: var(--bg3); border-radius: 2px; overflow: hidden; }
.health-fill { height: 100%; border-radius: 2px; transition: width 0.4s ease; }
.health-fill.green { background: #00ff88; box-shadow: 0 0 4px rgba(0,255,136,0.3); }
.health-fill.yellow { background: #ffcc00; box-shadow: 0 0 4px rgba(255,204,0,0.3); }
.health-fill.red { background: #ff4444; box-shadow: 0 0 4px rgba(255,68,68,0.3); }
.health-score { font-size: 0.6rem; color: var(--dim); min-width: 2.5rem; text-align: right; }

/* ── Mini Dependency Graph ── */
.mini-graph {
  margin: 1rem 0 1.5rem;
  padding: 1rem;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 8px;
}
.mini-graph-label {
  font-size: 0.65rem;
  color: var(--muted);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  margin-bottom: 0.5rem;
}
.mini-graph svg { display: block; margin: 0 auto; }
.mini-graph svg text { font-family: var(--font); }
.mini-graph svg .graph-node { cursor: pointer; }
.mini-graph svg .graph-node:hover circle { filter: brightness(1.4); }
.mini-graph svg .graph-node:hover text { fill: #fff; }
.mini-graph svg .graph-edge { stroke-width: 1.5; fill: none; }

/* ── Hero Section ── */
.hero-section { text-align: center; padding: 2rem 0 2.5rem; border-bottom: 1px solid var(--border); margin-bottom: 2rem; }
.hero-title { font-size: 2.5rem; font-weight: 700; color: var(--cyan); letter-spacing: 0.15em; text-shadow: 0 0 30px rgba(0,240,255,0.3), 0 0 60px rgba(0,240,255,0.1); margin-bottom: 0.3rem; }
.hero-subtitle { font-size: 0.85rem; color: var(--magenta); letter-spacing: 0.08em; margin-bottom: 0.75rem; }
.hero-desc { font-size: 0.75rem; color: var(--muted); max-width: 500px; margin: 0 auto 1.5rem; line-height: 1.5; }
.hero-stats { display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; }
.hero-stat { text-align: center; }
.hero-stat-value { font-size: 1.3rem; font-weight: 700; color: var(--cyan); }
.hero-stat-label { font-size: 0.6rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; }

/* ── Section Heading ── */
.section-heading { font-size: 0.8rem; font-weight: 600; color: var(--cyan); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 1rem; padding-bottom: 0.4rem; border-bottom: 1px solid var(--border); }

/* ── Domain Filter ── */
.domain-filter { margin-bottom: 1.5rem; }
.domain-filter input { width: 100%; background: var(--bg2); border: 1px solid var(--border); border-radius: 6px; padding: 0.6rem 0.8rem 0.6rem 2rem; color: var(--text); font-size: 0.8rem; font-family: var(--font); outline: none; }
.domain-filter input:focus { border-color: var(--cyan); }
.domain-filter input::placeholder { color: var(--dim); }
.domain-filter-wrap { position: relative; }
.domain-filter-wrap::before { content: '\2315'; position: absolute; left: 0.65rem; top: 50%; transform: translateY(-50%); color: var(--dim); font-size: 0.9rem; pointer-events: none; }
.domain-filter .filter-count { font-size: 0.65rem; color: var(--dim); margin-top: 0.3rem; }
.expand-controls { display: flex; gap: 0.75rem; margin-bottom: 0.75rem; }
.expand-controls button { font-size: 0.65rem; color: var(--muted); letter-spacing: 0.04em; }
.expand-controls button:hover { color: var(--cyan); }

/* ── Projects Grid ── */
.projects-section { margin-bottom: 2.5rem; }
.projects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 0.75rem; }
.project-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; padding: 0.85rem; cursor: pointer; transition: border-color 0.2s, transform 0.15s; }
.project-card:hover { border-color: var(--cyan); transform: translateY(-2px); }
.project-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.4rem; }
.project-card-name { font-size: 0.8rem; font-weight: 600; color: var(--text); }
.project-card-status { width: 6px; height: 6px; border-radius: 50%; background: #00e676; box-shadow: 0 0 4px #00e676; flex-shrink: 0; }
.project-card-desc { font-size: 0.7rem; color: var(--muted); line-height: 1.4; margin-bottom: 0.6rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.project-card-tags { display: flex; flex-wrap: wrap; gap: 0.25rem; }
.tech-tag { font-size: 0.55rem; padding: 0.1rem 0.35rem; border-radius: 3px; font-weight: 500; letter-spacing: 0.03em; }
.tech-tag.cat-core { background: rgba(0,240,255,0.1); border: 1px solid rgba(0,240,255,0.25); color: var(--cyan); }
.tech-tag.cat-interface { background: rgba(255,0,170,0.1); border: 1px solid rgba(255,0,170,0.25); color: var(--magenta); }
.tech-tag.cat-infrastructure { background: rgba(0,255,136,0.1); border: 1px solid rgba(0,255,136,0.25); color: #00ff88; }
.tech-tag.cat-tools { background: rgba(255,235,59,0.1); border: 1px solid rgba(255,235,59,0.25); color: #ffeb3b; }

/* ── Architecture Diagram ── */
.arch-section { margin-bottom: 2.5rem; }
.arch-diagram { background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; padding: 1.25rem; overflow-x: auto; }
.arch-diagram pre { margin: 0; font-size: 0.65rem; line-height: 1.4; color: var(--muted); white-space: pre; }
.arch-layer-voice { color: #00e676; }
.arch-layer-intel { color: var(--cyan); }
.arch-layer-platform { color: var(--magenta); }
.arch-layer-infra { color: #ff9800; }
.arch-layer-hardware { color: #ff4444; }

/* ── Back to Top ── */
.back-top { position: fixed; bottom: calc(1.5rem + var(--safe-b)); right: 1rem; width: 36px; height: 36px; border-radius: 50%; background: var(--bg3); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; color: var(--muted); font-size: 1rem; opacity: 0; pointer-events: none; transition: opacity 0.2s, color 0.15s; z-index: 50; }
.back-top.show { opacity: 1; pointer-events: auto; }
.back-top:hover { color: var(--cyan); border-color: var(--cyan); }

/* ── Mission Control ── */
.mission-control { margin-bottom: 2.5rem; }
.mc-agents { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem; }
.mc-agent { background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; display: flex; align-items: center; gap: 0.75rem; }
.mc-agent-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--dim); flex-shrink: 0; transition: background 0.3s, box-shadow 0.3s; }
.mc-agent-dot.thinking, .mc-agent-dot.working { background: var(--cyan); box-shadow: 0 0 8px var(--cyan); animation: pulse-dot 1.5s ease-in-out infinite; }
.mc-agent-dot.monitoring { background: var(--magenta); box-shadow: 0 0 8px var(--magenta); animation: pulse-dot 2s ease-in-out infinite; }
.mc-agent-dot.done { background: #00e676; box-shadow: 0 0 6px #00e676; }
.mc-agent-dot.error { background: #ff4444; box-shadow: 0 0 6px #ff4444; }
.mc-agent-name { font-size: 0.75rem; font-weight: 600; }
.mc-agent-status { font-size: 0.6rem; color: var(--muted); }
.mc-agent-info { flex: 1; }
@keyframes pulse-dot { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.3); } }

.mc-iteration { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; padding: 0.5rem 0.75rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; }
.mc-iter-num { font-size: 1.3rem; font-weight: 700; color: var(--cyan); min-width: 2.5rem; text-align: center; }
.mc-iter-bar { flex: 1; height: 4px; background: var(--bg3); border-radius: 2px; overflow: hidden; }
.mc-iter-fill { height: 100%; background: var(--cyan); border-radius: 2px; transition: width 0.4s ease; box-shadow: 0 0 4px rgba(0,240,255,0.3); }
.mc-iter-label { font-size: 0.65rem; color: var(--muted); }

.mc-task { font-size: 0.75rem; color: var(--muted); margin-bottom: 1rem; padding: 0.4rem 0.75rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 6px; }
.mc-task strong { color: var(--magenta); }

.mc-feed { max-height: 280px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; background: var(--bg2); }
.mc-feed-header { font-size: 0.65rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.mc-feed-live { display: flex; align-items: center; gap: 0.3rem; }
.mc-feed-live-dot { width: 6px; height: 6px; border-radius: 50%; background: #00e676; animation: pulse-dot 2s ease-in-out infinite; }
.mc-feed-list { padding: 0.25rem 0; }
.mc-event { display: flex; align-items: flex-start; gap: 0.5rem; padding: 0.3rem 0.75rem; font-size: 0.7rem; border-bottom: 1px solid rgba(34,34,51,0.5); }
.mc-event:last-child { border-bottom: none; }
.mc-event-time { color: var(--dim); font-size: 0.6rem; min-width: 3.5rem; flex-shrink: 0; padding-top: 0.05rem; }
.mc-event-agent { font-size: 0.55rem; font-weight: 700; padding: 0.1rem 0.35rem; border-radius: 3px; min-width: 3.5rem; text-align: center; flex-shrink: 0; }
.mc-event-agent.brain { background: rgba(255,0,170,0.15); color: var(--magenta); }
.mc-event-agent.claude { background: rgba(0,240,255,0.15); color: var(--cyan); }
.mc-event-agent.system { background: rgba(102,102,120,0.15); color: var(--muted); }
.mc-event-msg { flex: 1; color: var(--text); }

/* ── Roadmap ── */
.roadmap-section { margin-bottom: 2.5rem; }
.roadmap-list { display: flex; flex-direction: column; gap: 0.4rem; }
.roadmap-item { display: flex; align-items: flex-start; gap: 0.6rem; padding: 0.6rem 0.75rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 6px; }
.roadmap-status { width: 8px; height: 8px; border-radius: 50%; margin-top: 0.3rem; flex-shrink: 0; }
.roadmap-status.planned { background: var(--dim); }
.roadmap-status.in_progress { background: var(--cyan); box-shadow: 0 0 6px var(--cyan); animation: pulse-dot 1.5s ease-in-out infinite; }
.roadmap-status.completed { background: #00e676; box-shadow: 0 0 4px #00e676; }
.roadmap-status.skipped { background: var(--dim); opacity: 0.4; }
.roadmap-info { flex: 1; }
.roadmap-title { font-size: 0.8rem; font-weight: 500; }
.roadmap-desc { font-size: 0.65rem; color: var(--muted); margin-top: 0.15rem; }
.roadmap-meta { display: flex; gap: 0.3rem; margin-top: 0.25rem; flex-wrap: wrap; }
.roadmap-tag { font-size: 0.5rem; padding: 0.08rem 0.3rem; border-radius: 3px; border: 1px solid var(--border); color: var(--muted); }
.roadmap-priority { font-size: 0.55rem; font-weight: 700; padding: 0.08rem 0.35rem; border-radius: 3px; }
.roadmap-priority.p1 { background: rgba(255,68,68,0.15); color: #ff4444; }
.roadmap-priority.p2 { background: rgba(255,152,0,0.15); color: #ff9800; }
.roadmap-priority.p3 { background: rgba(0,240,255,0.15); color: var(--cyan); }
.roadmap-priority.p4, .roadmap-priority.p5 { background: rgba(102,102,120,0.15); color: var(--muted); }
.roadmap-empty { font-size: 0.75rem; color: var(--dim); text-align: center; padding: 1.5rem; }

@media (max-width: 500px) {
  .mc-agents { grid-template-columns: 1fr; }
}

/* ── Directive Panel ── */
.directive-panel { margin-bottom: 1.5rem; }
.directive-cards { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.75rem; }
.directive-card {
  background: var(--bg2); border: 1px solid var(--border); border-radius: 8px;
  padding: 0.65rem 0.75rem; display: flex; align-items: center; gap: 0.75rem;
}
.directive-card.active { border-color: var(--cyan); }
.directive-card.completed { border-color: #00e676; opacity: 0.7; }
.directive-status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.directive-status-dot.pending { background: var(--dim); }
.directive-status-dot.active { background: var(--cyan); box-shadow: 0 0 6px var(--cyan); animation: pulse-dot 1.5s ease-in-out infinite; }
.directive-status-dot.completed { background: #00e676; box-shadow: 0 0 4px #00e676; }
.directive-status-dot.failed { background: #ff4444; box-shadow: 0 0 4px #ff4444; }
.directive-info { flex: 1; min-width: 0; }
.directive-intent { font-size: 0.8rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.directive-meta { font-size: 0.6rem; color: var(--muted); display: flex; gap: 0.75rem; margin-top: 0.15rem; }
.directive-progress { width: 80px; height: 4px; background: var(--bg3); border-radius: 2px; overflow: hidden; align-self: center; }
.directive-progress-fill { height: 100%; background: var(--cyan); border-radius: 2px; transition: width 0.4s ease; }

.directive-input { display: flex; gap: 0.5rem; align-items: flex-start; }
.directive-input textarea {
  flex: 1; background: var(--bg2); border: 1px solid var(--border); border-radius: 6px;
  padding: 0.5rem 0.7rem; color: var(--text); font-size: 0.8rem; font-family: var(--font);
  resize: none; min-height: 36px; max-height: 60px; outline: none;
}
.directive-input textarea:focus { border-color: var(--cyan); }
.directive-input textarea::placeholder { color: var(--dim); }
.directive-input select {
  background: var(--bg2); border: 1px solid var(--border); border-radius: 6px;
  padding: 0.4rem; color: var(--muted); font-size: 0.7rem; font-family: var(--font); outline: none;
}
.directive-submit {
  padding: 0.5rem 1rem; background: rgba(0,240,255,0.1); border: 1px solid var(--cyan);
  border-radius: 6px; color: var(--cyan); font-size: 0.7rem; font-weight: 600;
  letter-spacing: 0.04em; transition: background 0.15s; white-space: nowrap;
}
.directive-submit:hover { background: rgba(0,240,255,0.2); }
.directive-empty { font-size: 0.75rem; color: var(--dim); text-align: center; padding: 0.75rem; }

/* ── Orchestrator Status Bar ── */
.orch-status {
  display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem;
  padding: 0.6rem 0.75rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 8px;
}
.orch-stat { display: flex; align-items: center; gap: 0.4rem; flex: 1; min-width: 100px; }
.orch-stat-label { font-size: 0.55rem; color: var(--dim); letter-spacing: 0.06em; text-transform: uppercase; }
.orch-stat-value { font-size: 0.85rem; font-weight: 700; color: var(--cyan); }
.orch-stat-value.warn { color: #ffcc00; }
.orch-stat-value.danger { color: #ff4444; }
.orch-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--dim); flex-shrink: 0; }
.orch-dot.running { background: #00e676; box-shadow: 0 0 6px #00e676; animation: pulse-dot 2s ease-in-out infinite; }
.orch-dot.stopped { background: var(--dim); }

/* ── Worker Grid ── */
.worker-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 0.75rem; margin-bottom: 1.5rem;
}
.worker-card {
  background: var(--bg2); border: 1px solid var(--border); border-radius: 8px;
  padding: 0.65rem 0.75rem; transition: border-color 0.2s;
}
.worker-card.working { border-left: 3px solid var(--cyan); }
.worker-card.idle { border-left: 3px solid #00e676; }
.worker-card.error { border-left: 3px solid #ff4444; }
.worker-card-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.4rem; }
.worker-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.worker-dot.working { background: var(--cyan); box-shadow: 0 0 6px var(--cyan); animation: pulse-dot 1.5s ease-in-out infinite; }
.worker-dot.idle { background: #00e676; box-shadow: 0 0 4px #00e676; }
.worker-dot.error { background: #ff4444; box-shadow: 0 0 4px #ff4444; }
.worker-dot.stopped { background: var(--dim); }
.worker-id { font-size: 0.75rem; font-weight: 600; }
.worker-task { font-size: 0.6rem; color: var(--muted); margin-left: auto; max-width: 50%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.worker-output {
  background: #0d0d14; border: 1px solid var(--border); border-radius: 4px;
  padding: 0.4rem 0.5rem; font-size: 0.65rem; color: var(--muted);
  min-height: 3.5em; max-height: 5em; overflow-y: auto; line-height: 1.4;
  white-space: pre-wrap; word-break: break-all; font-family: var(--font);
}
.worker-meta { display: flex; gap: 0.75rem; margin-top: 0.4rem; font-size: 0.55rem; color: var(--dim); }
.worker-empty {
  grid-column: 1 / -1; text-align: center; padding: 1.5rem;
  font-size: 0.75rem; color: var(--dim); border: 1px dashed var(--border);
  border-radius: 8px;
}

/* ── Feed Filter Tabs ── */
.feed-filters { display: flex; gap: 0.25rem; padding: 0.4rem 0.75rem; border-bottom: 1px solid var(--border); overflow-x: auto; }
.feed-filter-tab {
  font-size: 0.55rem; font-weight: 600; padding: 0.2rem 0.5rem; border-radius: 3px;
  color: var(--dim); cursor: pointer; transition: all 0.15s; white-space: nowrap;
  letter-spacing: 0.04em; text-transform: uppercase;
}
.feed-filter-tab:hover { color: var(--muted); background: var(--bg3); }
.feed-filter-tab.active { color: var(--cyan); background: rgba(0,240,255,0.1); }

/* Worker color palette for feed borders */
.mc-event[data-worker="worker-01"] { border-left: 2px solid #00f0ff; }
.mc-event[data-worker="worker-02"] { border-left: 2px solid #ff00aa; }
.mc-event[data-worker="worker-03"] { border-left: 2px solid #00e676; }
.mc-event[data-worker="worker-04"] { border-left: 2px solid #ffeb3b; }
.mc-event[data-worker="worker-05"] { border-left: 2px solid #7c4dff; }
.mc-event[data-worker="worker-06"] { border-left: 2px solid #ff6e40; }
.mc-event[data-worker="worker-07"] { border-left: 2px solid #64ffda; }
.mc-event[data-worker="worker-08"] { border-left: 2px solid #ea80fc; }
.mc-event[data-worker="orch"] { border-left: 2px solid var(--magenta); }
.mc-event[data-worker="ollama"] { border-left: 2px solid #ffcc00; }

/* Tool badge in feed */
.tool-badge {
  font-size: 0.5rem; font-weight: 600; padding: 0.08rem 0.3rem; border-radius: 3px;
  background: rgba(255,0,170,0.15); color: var(--magenta); display: inline-block; margin-right: 0.3rem;
}

/* Enhanced roadmap — directive grouping */
.roadmap-directive-group { margin-bottom: 1rem; }
.roadmap-directive-header {
  font-size: 0.65rem; font-weight: 600; color: var(--cyan); letter-spacing: 0.06em;
  padding: 0.3rem 0.5rem; background: rgba(0,240,255,0.05); border-radius: 4px;
  margin-bottom: 0.4rem; display: flex; align-items: center; gap: 0.5rem;
}
.roadmap-directive-header .dir-id { color: var(--muted); font-weight: 400; }
.roadmap-worker-badge {
  font-size: 0.5rem; font-weight: 600; padding: 0.08rem 0.3rem; border-radius: 3px;
  background: rgba(0,240,255,0.15); color: var(--cyan); margin-left: auto;
}
.roadmap-dep-link { font-size: 0.5rem; color: var(--dim); font-style: italic; }

.roadmap-status.queued { background: #ffcc00; box-shadow: 0 0 4px rgba(255,204,0,0.3); }
.roadmap-status.blocked { background: #ff9800; box-shadow: 0 0 4px rgba(255,152,0,0.3); }
.roadmap-status.failed { background: #ff4444; box-shadow: 0 0 4px rgba(255,68,68,0.3); }

/* ── Full Graph View ── */
.graph-container { position: relative; width: 100%; height: calc(100vh - 56px); background: var(--bg); overflow: hidden; margin: -1.5rem; margin-top: -1rem; }
.graph-container canvas { display: block; width: 100%; height: 100%; cursor: grab; }
.graph-container canvas.dragging { cursor: grabbing; }
.graph-hud { position: absolute; top: 1rem; left: 1rem; z-index: 10; display: flex; flex-direction: column; gap: 0.5rem; pointer-events: none; }
.graph-hud > * { pointer-events: auto; }
.graph-title { font-size: 1.1rem; color: var(--cyan); letter-spacing: 0.12em; text-shadow: 0 0 20px rgba(0,240,255,0.3); }
.graph-stats { font-size: 0.65rem; color: var(--dim); letter-spacing: 0.05em; }
.graph-legend { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 0.3rem; }
.graph-legend-item { font-size: 0.55rem; color: var(--muted); display: flex; align-items: center; gap: 0.25rem; cursor: pointer; padding: 0.15rem 0.4rem; border-radius: 3px; transition: background 0.15s; }
.graph-legend-item:hover { background: var(--bg3); }
.graph-legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.graph-controls { position: absolute; bottom: 1rem; right: 1rem; z-index: 10; display: flex; gap: 0.4rem; }
.graph-btn { background: var(--bg2); border: 1px solid var(--border); color: var(--muted); font-family: var(--font); font-size: 0.7rem; padding: 0.4rem 0.7rem; border-radius: 4px; cursor: pointer; transition: all 0.15s; }
.graph-btn:hover { border-color: var(--cyan); color: var(--cyan); }
.graph-tooltip { position: absolute; display: none; background: var(--bg2); border: 1px solid var(--cyan); border-radius: 6px; padding: 0.5rem 0.7rem; pointer-events: none; z-index: 20; max-width: 280px; box-shadow: 0 0 15px rgba(0,240,255,0.15); }
.graph-tooltip .tt-id { color: var(--cyan); font-size: 0.7rem; font-weight: 700; }
.graph-tooltip .tt-title { color: var(--text); font-size: 0.65rem; margin-top: 0.15rem; }
.graph-tooltip .tt-domain { color: var(--muted); font-size: 0.55rem; margin-top: 0.2rem; }
.graph-tooltip .tt-deps { color: var(--dim); font-size: 0.55rem; margin-top: 0.15rem; }
</style>
</head>
<body>

<div class="progress-bar" id="progress-bar"></div>

<div class="offline-bar" id="offline-bar">OFFLINE MODE</div>

<header>
  <span class="logo" onclick="goHome()">holm.chat</span>
  <span id="doc-count" style="font-size:0.6rem;color:var(--dim);margin-left:-0.5rem"></span>
  <nav>
    <button onclick="openGraph()" style="font-size:0.75rem;color:var(--muted);padding:0.3rem 0;transition:color 0.15s" onmouseover="this.style.color='var(--cyan)'" onmouseout="this.style.color='var(--muted)'">graph</button>
    <button onclick="openRandom()" style="font-size:0.75rem;color:var(--muted);padding:0.3rem 0;transition:color 0.15s" onmouseover="this.style.color='var(--cyan)'" onmouseout="this.style.color='var(--muted)'">random</button>
    <button class="search-trigger" onclick="openSearch()">search <kbd>/</kbd></button>
  </nav>
</header>

<main id="main">
  <div class="loading" id="loading">loading...</div>
</main>

<div class="search-overlay" id="search-overlay">
  <div class="search-bar">
    <input type="text" id="search-input" placeholder="Search documents..." autocomplete="off">
    <button class="close-btn" onclick="closeSearch()">&times;</button>
  </div>
  <div class="search-results" id="search-results">
    <div class="search-empty">Type to search across all documents</div>
  </div>
</div>

<button class="back-top" id="back-top" onclick="window.scrollTo({top:0,behavior:'smooth'})">&uarr;</button>

<div class="toast-container" id="toasts"></div>

<script>
/* ── State ── */
let allDocs = [];
let docsById = {};
let currentDocId = null;
let histStack = [];
let currentDomain = null;

const DOMAIN_NAMES = {
  '1':'Constitution & Philosophy','2':'Governance & Authority','3':'Security & Integrity',
  '4':'Infrastructure & Power','5':'Platform & Core Systems','6':'Data & Archives',
  '7':'Intelligence & Analysis','8':'Automation & Agents','9':'Education & Training',
  '10':'User Operations','11':'Administration','12':'Disaster Recovery',
  '13':'Evolution & Adaptation','14':'Research & Theory','15':'Ethics & Safeguards',
  '16':'Federation & External','17':'Federation Protocol','18':'Data Pipeline',
  '19':'Advanced Automation','20':'Meta & Documentation',
  'META':'Meta','FW':'Framework','HIC':'HIC Architecture','PROJ':'Projects & Repositories',
  'LOG':'Autopilot Work Log'
};

function computeDomainHealth(docs) {
  if (!docs || docs.length === 0) return 0;
  var allDocIds = new Set(allDocs.map(function(d) { return d.docId; }));
  var activeCount = 0;
  var noBrokenDepsCount = 0;
  var hasDepCount = 0;
  for (var i = 0; i < docs.length; i++) {
    var d = docs[i];
    if (d.status === 'active') activeCount++;
    var deps = d.dependsOn || [];
    var hasBroken = false;
    for (var j = 0; j < deps.length; j++) {
      if (!allDocIds.has(deps[j])) { hasBroken = true; break; }
    }
    if (!hasBroken) noBrokenDepsCount++;
    if (deps.length > 0 || (d.dependedBy && d.dependedBy.length > 0)) hasDepCount++;
  }
  var n = docs.length;
  var pctActive = activeCount / n;
  var pctNoBroken = noBrokenDepsCount / n;
  var pctConnected = hasDepCount / n;
  return Math.round((pctActive + pctNoBroken + pctConnected) / 3 * 100);
}

/* ── Utilities ── */
function esc(s) { return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : ''; }

function getRecent() {
  try { return JSON.parse(sessionStorage.getItem('holm-recent') || '[]'); } catch(e) { return []; }
}

function addRecent(docId) {
  var recent = getRecent().filter(function(id) { return id !== docId; });
  recent.unshift(docId);
  if (recent.length > 8) recent = recent.slice(0, 8);
  sessionStorage.setItem('holm-recent', JSON.stringify(recent));
}
function getBookmarks() {
  try { return JSON.parse(localStorage.getItem('holm-bookmarks') || '[]'); } catch(e) { return []; }
}

function isBookmarked(docId) {
  return getBookmarks().indexOf(docId) !== -1;
}

function toggleBookmark(docId) {
  var bm = getBookmarks();
  var idx = bm.indexOf(docId);
  if (idx !== -1) { bm.splice(idx, 1); toast('Bookmark removed'); }
  else { bm.unshift(docId); toast('Bookmarked'); }
  localStorage.setItem('holm-bookmarks', JSON.stringify(bm));
  var btn = document.getElementById('bookmark-btn');
  if (btn) { btn.textContent = isBookmarked(docId) ? '\u2605' : '\u2606'; btn.className = 'bookmark-btn' + (isBookmarked(docId) ? ' active' : ''); }
}


function toast(msg, type) {
  var t = document.createElement('div');
  t.className = 'toast' + (type === 'error' ? ' error' : '');
  t.textContent = msg;
  document.getElementById('toasts').appendChild(t);
  setTimeout(function() { t.classList.add('out'); setTimeout(function() { t.remove(); }, 200); }, 3000);
}

function copyDocText() {
  var el = document.querySelector('.doc-content');
  if (!el) return;
  var text = el.innerText || el.textContent;
  navigator.clipboard.writeText(text).then(function() {
    toast('Copied to clipboard');
  }).catch(function() {
    toast('Copy failed', 'error');
  });
}

function timeAgo(d) {
  var s = Math.floor((Date.now() - new Date(d).getTime()) / 1000);
  if (s < 60) return 'just now';
  if (s < 3600) return Math.floor(s/60) + 'm ago';
  if (s < 86400) return Math.floor(s/3600) + 'h ago';
  return Math.floor(s/86400) + 'd ago';
}

function linkifyDocIds(html) {
  if (!html) return html;
  // Match doc ID patterns not already inside HTML tags or existing links
  var idPattern = /\b([A-Z]{1,10}-\d{1,4}|D\d{1,2}-\d{1,4})\b/g;
  // Simple approach: split on HTML tags, process text nodes only
  var parts = html.split(/(<[^>]*>)/);
  var inLink = false;
  for (var i = 0; i < parts.length; i++) {
    if (parts[i].match(/^<a[\s>]/i)) inLink = true;
    if (parts[i].match(/^<\/a>/i)) inLink = false;
    if (parts[i].charAt(0) !== '<' && !inLink) {
      parts[i] = parts[i].replace(idPattern, function(match) {
        if (docsById[match]) {
          return '<a href="#' + match + '" onclick="event.preventDefault();openDoc(\'' + match + '\')" style="color:var(--cyan);cursor:pointer">' + match + '</a>';
        }
        return match;
      });
    }
  }
  return parts.join('');
}

/* ── Routing ── */
function goHome() {
  if (graphAnim) { cancelAnimationFrame(graphAnim); graphAnim = null; }
  histStack = [];
  currentDocId = null;
  currentDomain = null;
  renderHome();
  history.replaceState(null, '', '/');
  progressBar.classList.remove('visible'); progressBar.style.width = '0%';
}

function openDoc(id) {
  var doc = docsById[id];
  if (!doc) { toast('Not found: ' + id, 'error'); return; }
  if (currentDocId) histStack.push(currentDocId);
  currentDocId = id;
  addRecent(id);
  renderDoc(id);
  history.pushState({ doc: id }, '', '#' + id);
}

function openDomain(key) {
  currentDomain = key;
  histStack = [];
  currentDocId = null;
  renderDomain(key);
  history.pushState({ domain: key }, '', '#d/' + key);
}

function renderDomain(key) {
  var el = document.getElementById('main');
  var docs = allDocs.filter(function(d) { return d.domain === key; })
    .sort(function(a, b) { return a.docId.localeCompare(b.docId); });
  var name = DOMAIN_NAMES[key] || (docs[0] && docs[0].domainName) || key;

  var html = '<div style="margin-bottom:1rem">';
  html += '<div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1.5rem">';
  html += '<button onclick="goHome()" style="color:var(--cyan);font-size:0.8rem">&larr; Home</button>';
  html += '<h1 style="font-size:1.1rem;font-weight:600">' + esc(name) + '</h1>';
  html += '<span style="font-size:0.7rem;color:var(--muted)">' + docs.length + ' docs</span>';
  html += '</div>';

  for (var i = 0; i < docs.length; i++) {
    var d = docs[i];
    html += '<div class="doc-link" onclick="openDoc(\'' + esc(d.docId) + '\')">';
    html += '<span class="doc-link-id">' + esc(d.docId) + '</span>';
    html += '<span class="doc-link-title">' + esc(d.title) + '</span>';
    html += '</div>';
  }
  html += '</div>';
  el.innerHTML = html;
  window.scrollTo(0, 0);
}

function goBack() {
  if (histStack.length > 0) {
    var prev = histStack.pop();
    currentDocId = prev;
    renderDoc(prev);
    history.replaceState({ doc: prev }, '', '#' + prev);
  } else if (currentDomain) {
    currentDocId = null;
    renderDomain(currentDomain);
    history.replaceState({ domain: currentDomain }, '', '#d/' + currentDomain);
  } else {
    goHome();
  }
}

window.addEventListener('popstate', function() {
  var h = location.hash.slice(1);
  if (h === 'graph') { renderGraph(); return; }
  if (h.startsWith('d/')) { openDomain(h.slice(2)); return; }
  if (h && docsById[h]) { currentDocId = h; renderDoc(h); }
  else goHome();
});

/* ── Projects ── */
var projectsData = null;
async function loadProjects() {
  if (projectsData) return projectsData;
  try {
    var res = await fetch('/api/projects');
    if (!res.ok) throw new Error();
    projectsData = await res.json();
    return projectsData;
  } catch(e) { return []; }
}

function renderProjectCards(projects, container) {
  if (!projects || projects.length === 0) {
    container.innerHTML = '<div style="color:var(--dim);font-size:0.75rem;text-align:center;padding:1rem">No projects indexed yet. Run: node index-repos.js</div>';
    return;
  }
  var catClass = { core: 'cat-core', interface: 'cat-interface', infrastructure: 'cat-infrastructure', tools: 'cat-tools' };
  container.innerHTML = projects.map(function(p) {
    var tags = (p.techStack || []).map(function(t) {
      return '<span class="tech-tag ' + (catClass[p.category] || 'cat-tools') + '">' + esc(t) + '</span>';
    }).join('');
    return '<div class="project-card" onclick="openDoc(\'' + esc(p.docId) + '\')">' +
      '<div class="project-card-header">' +
        '<span class="project-card-name">' + esc(p.name) + '</span>' +
        '<span class="project-card-status"></span>' +
      '</div>' +
      '<div class="project-card-desc">' + esc(p.description) + '</div>' +
      '<div class="project-card-tags">' + tags + '</div>' +
    '</div>';
  }).join('');
}

/* ── Home Page ── */
function renderHome() {
  var el = document.getElementById('main');

  var domains = {};
  allDocs.forEach(function(d) {
    var k = d.domain || 'other';
    if (!domains[k]) domains[k] = [];
    domains[k].push(d);
  });

  var keys = Object.keys(domains).sort(function(a, b) {
    var na = parseInt(a), nb = parseInt(b);
    if (!isNaN(na) && !isNaN(nb)) return na - nb;
    if (!isNaN(na)) return -1;
    if (!isNaN(nb)) return 1;
    return a.localeCompare(b);
  });

  var html = '<div class="wiki-home">';

  // ── Hero Section ──
  html += '<div class="hero-section">';
  html += '<div class="hero-title">HOLM</div>';
  html += '<div class="hero-subtitle">Personal Sovereign Intelligence System</div>';
  html += '<div class="hero-desc">A fully air-gapped system interacted with through voice only. No screens, no keyboards, no phones — a private intelligence agency running on local hardware.</div>';
  html += '<div class="hero-stats">';
  var totalDeps = 0;
  allDocs.forEach(function(d) { totalDeps += (d.dependsOn || []).length; });
  html += '<div class="hero-stat"><div class="hero-stat-value">' + allDocs.length + '</div><div class="hero-stat-label">Documents</div></div>';
  html += '<div class="hero-stat"><div class="hero-stat-value">' + keys.length + '</div><div class="hero-stat-label">Domains</div></div>';
  html += '<div class="hero-stat"><div class="hero-stat-value">' + totalDeps + '</div><div class="hero-stat-label">Dependencies</div></div>';
  html += '</div></div>';

  // ── Orchestrator Status Bar ──
  html += '<div class="orch-status" id="orch-status">';
  html += '<div class="orch-stat"><span class="orch-dot" id="orch-dot"></span><div><div class="orch-stat-label">Workers</div><div class="orch-stat-value" id="orch-workers">0/0</div></div></div>';
  html += '<div class="orch-stat"><div><div class="orch-stat-label">Tasks Done</div><div class="orch-stat-value" id="orch-tasks-done">0</div></div></div>';
  html += '<div class="orch-stat"><div><div class="orch-stat-label">Session Cost</div><div class="orch-stat-value" id="orch-cost">$0.00</div></div></div>';
  html += '<div class="orch-stat"><div><div class="orch-stat-label">Rate Limit</div><div class="orch-stat-value" id="orch-rate">0/900</div></div></div>';
  html += '<div class="orch-stat"><div><div class="orch-stat-label">Uptime</div><div class="orch-stat-value" id="orch-uptime">--</div></div></div>';
  html += '</div>';

  // ── Directive Panel ──
  html += '<div class="directive-panel">';
  html += '<div class="section-heading">Directives</div>';
  html += '<div class="directive-cards" id="directive-cards"><div class="directive-empty">No active directives</div></div>';
  html += '<div class="directive-input">';
  html += '<textarea id="directive-text" placeholder="Issue a directive... (e.g. Fix all broken dependencies)" rows="1"></textarea>';
  html += '<select id="directive-priority"><option value="1">P1</option><option value="2">P2</option><option value="3" selected>P3</option><option value="4">P4</option><option value="5">P5</option></select>';
  html += '<button class="directive-submit" onclick="submitDirective()">ISSUE</button>';
  html += '</div>';
  html += '</div>';

  // ── Worker Grid ──
  html += '<div class="section-heading">Workers</div>';
  html += '<div class="worker-grid" id="worker-grid"><div class="worker-empty">No workers active &mdash; issue a directive or start the orchestrator</div></div>';

  // ── Live Activity Feed ──
  html += '<div class="mission-control">';
  html += '<div class="section-heading">Live Activity</div>';
  html += '<div class="mc-feed">';
  html += '<div class="mc-feed-header"><span>Activity Stream</span><span class="mc-feed-live"><span class="mc-feed-live-dot" id="mc-live-dot"></span> <span id="mc-live-label">connecting...</span></span></div>';
  html += '<div class="feed-filters" id="feed-filters"><button class="feed-filter-tab active" data-filter="all" onclick="filterFeed(\'all\')">ALL</button></div>';
  html += '<div class="mc-feed-list" id="mc-feed-list"><div style="font-size:0.7rem;color:var(--dim);text-align:center;padding:1rem">No recent activity</div></div>';
  html += '</div>';
  html += '</div>';

  // ── Roadmap ──
  html += '<div class="roadmap-section">';
  html += '<div class="section-heading">Roadmap</div>';
  html += '<div class="roadmap-list" id="roadmap-list"><div class="roadmap-empty">Loading tasks...</div></div>';
  html += '</div>';

  // ── Bookmarks (existing) ──
  var bookmarks = getBookmarks();
  if (bookmarks.length > 0) {
    html += '<div class="bookmarks"><div class="bookmarks-title">\u2605 Bookmarks</div><div class="bookmarks-list">';
    bookmarks.forEach(function(id) {
      var d = docsById[id];
      if (d) html += '<span class="bookmark-chip" onclick="openDoc(\'' + esc(id) + '\')">' + esc(d.title) + '</span>';
    });
    html += '</div></div>';
  }

  // ── Recently Viewed (existing) ──
  var recent = getRecent();
  if (recent.length > 0) {
    html += '<div class="recent"><div class="recent-title">Recently viewed</div><div class="recent-list">';
    recent.forEach(function(id) {
      var d = docsById[id];
      if (d) html += '<span class="recent-chip" onclick="openDoc(\'' + esc(id) + '\')">' + esc(d.title) + '</span>';
    });
    html += '</div></div>';
  }

  // ── Domain Filter ──
  html += '<div class="section-heading">Document Index</div>';
  html += '<div class="domain-filter"><div class="domain-filter-wrap"><input type="text" id="domain-filter" placeholder="Filter domains and documents..." oninput="filterDomains(this.value)"></div>';
  html += '<div class="filter-count" id="filter-count"></div></div>';
  html += '<div class="expand-controls"><button onclick="expandAllDomains()">Expand all</button><button onclick="collapseAllDomains()">Collapse all</button></div>';

  // ── Domain Sections ──
  html += '<div id="domain-list">';
  for (var i = 0; i < keys.length; i++) {
    var k = keys[i];
    var docs = domains[k].sort(function(a, b) { return a.docId.localeCompare(b.docId); });
    var name = DOMAIN_NAMES[k] || (docs[0] && docs[0].domainName) || k;
    html += '<div class="domain-section collapsed" data-domain="' + esc(k) + '" data-name="' + esc(name.toLowerCase()) + '">';
    html += '<div class="domain-heading" onclick="toggleDomainSection(this.parentNode)">' + esc(name) + ' <span>' + docs.length + '</span></div>';
    var health = computeDomainHealth(docs);
    var hClass = health > 80 ? 'green' : (health >= 50 ? 'yellow' : 'red');
    html += '<div class="domain-health"><div class="health-bar"><div class="health-fill ' + hClass + '" style="width:' + health + '%"></div></div><span class="health-score">' + health + '%</span></div>';
    for (var j = 0; j < docs.length; j++) {
      var d = docs[j];
      html += '<div class="doc-link" onclick="openDoc(\'' + esc(d.docId) + '\')" data-id="' + esc(d.docId.toLowerCase()) + '" data-title="' + esc(d.title.toLowerCase()) + '">';
      html += '<span class="doc-link-id">' + esc(d.docId) + '</span>';
      html += '<span class="doc-link-title">' + esc(d.title) + '</span>';
      html += '</div>';
    }
    html += '</div>';
  }
  html += '</div>';
  html += '</div>';
  el.innerHTML = html;
  window.scrollTo(0, 0);

  // Load orchestrator data
  loadOrchestratorState();
  loadDirectives();
  loadWorkers();
  loadActivity();
  loadTasks();
  connectSSE();
}

/* ── Orchestrator Dashboard ── */
var sseSource = null;
var currentFeedFilter = 'all';
var orchState = null;
var workersData = [];
var directivesData = [];

// Worker color palette
var WORKER_COLORS = ['#00f0ff','#ff00aa','#00e676','#ffeb3b','#7c4dff','#ff6e40','#64ffda','#ea80fc'];
function workerColor(wid) {
  var idx = parseInt((wid || '').replace(/\D/g, '') || '0') - 1;
  return WORKER_COLORS[idx % WORKER_COLORS.length];
}

function connectSSE() {
  if (sseSource) { try { sseSource.close(); } catch(e) {} }
  sseSource = new EventSource('/api/activity/stream');
  sseSource.onopen = function() {
    var dot = document.getElementById('mc-live-dot');
    var label = document.getElementById('mc-live-label');
    if (dot) dot.style.background = '#00e676';
    if (label) label.textContent = 'connected';
  };
  sseSource.addEventListener('activity', function(e) {
    try {
      var event = JSON.parse(e.data);
      prependActivityEvent(event);
    } catch(err) {}
  });
  sseSource.addEventListener('state', function(e) {
    // Legacy autopilot state — update orchestrator bar from it
    try {
      var state = JSON.parse(e.data);
      if (state.autopilotRunning) {
        var dot = document.getElementById('orch-dot');
        if (dot) dot.className = 'orch-dot running';
      }
    } catch(err) {}
  });
  sseSource.addEventListener('worker', function(e) {
    try {
      var worker = JSON.parse(e.data);
      updateWorkerInGrid(worker);
      updateFeedFilterTabs();
    } catch(err) {}
  });
  sseSource.addEventListener('orchestrator', function(e) {
    try {
      orchState = JSON.parse(e.data);
      renderOrchestratorBar();
    } catch(err) {}
  });
  sseSource.addEventListener('directive', function(e) {
    try { loadDirectives(); } catch(err) {}
  });
  sseSource.addEventListener('task', function(e) {
    loadTasks();
  });
  sseSource.addEventListener('doc_created', function(e) {
    refreshDocsQuietly();
  });
  sseSource.onerror = function() {
    var label = document.getElementById('mc-live-label');
    if (label) label.textContent = 'reconnecting...';
  };
}

// ── Orchestrator State ──
function loadOrchestratorState() {
  fetch('/api/orchestrator').then(function(r) { return r.json(); }).then(function(state) {
    orchState = state;
    renderOrchestratorBar();
  }).catch(function() {});
}

function renderOrchestratorBar() {
  if (!orchState) return;
  var dot = document.getElementById('orch-dot');
  var workers = document.getElementById('orch-workers');
  var tasksDone = document.getElementById('orch-tasks-done');
  var cost = document.getElementById('orch-cost');
  var rate = document.getElementById('orch-rate');
  var uptime = document.getElementById('orch-uptime');

  if (dot) dot.className = 'orch-dot ' + (orchState.running ? 'running' : 'stopped');
  if (workers) workers.textContent = (orchState.activeWorkers || 0) + '/' + (orchState.maxWorkers || 0);
  if (tasksDone) tasksDone.textContent = orchState.totalIterations || 0;
  if (cost) cost.textContent = '$' + (orchState.totalCost || 0).toFixed(2);

  var rl = orchState.rateLimitBudget || {};
  var used = rl.promptsUsed || 0;
  var limit = rl.promptsLimit || 900;
  var pct = limit > 0 ? used / limit : 0;
  if (rate) {
    rate.textContent = used + '/' + limit;
    rate.className = 'orch-stat-value' + (pct > 0.8 ? ' danger' : pct > 0.5 ? ' warn' : '');
  }

  if (uptime && orchState.startedAt) {
    var elapsed = Math.floor((Date.now() - new Date(orchState.startedAt).getTime()) / 1000);
    if (elapsed < 60) uptime.textContent = elapsed + 's';
    else if (elapsed < 3600) uptime.textContent = Math.floor(elapsed / 60) + 'm';
    else uptime.textContent = Math.floor(elapsed / 3600) + 'h ' + Math.floor((elapsed % 3600) / 60) + 'm';
  } else if (uptime) {
    uptime.textContent = '--';
  }
}

// Refresh uptime every 30s
setInterval(renderOrchestratorBar, 30000);

// ── Directives ──
function loadDirectives() {
  fetch('/api/directives').then(function(r) { return r.json(); }).then(function(dirs) {
    directivesData = dirs;
    renderDirectivePanel();
  }).catch(function() {});
}

function renderDirectivePanel() {
  var el = document.getElementById('directive-cards');
  if (!el) return;
  if (!directivesData || directivesData.length === 0) {
    el.innerHTML = '<div class="directive-empty">No directives &mdash; issue one below or let the orchestrator self-direct</div>';
    return;
  }
  // Show most recent first, max 5
  var recent = directivesData.slice(0, 5);
  el.innerHTML = recent.map(function(d) {
    var decomp = d.decomposition || [];
    var completedCount = 0;
    // We'd need task data to count completed, but show decomp count for now
    var progressPct = decomp.length > 0 ? 0 : 0; // Will be updated when tasks load
    return '<div class="directive-card ' + (d.status || 'pending') + '">' +
      '<div class="directive-status-dot ' + (d.status || 'pending') + '"></div>' +
      '<div class="directive-info">' +
        '<div class="directive-intent">' + esc(d.intent) + '</div>' +
        '<div class="directive-meta">' +
          '<span>' + esc(d.directiveId) + '</span>' +
          '<span>' + (d.source || 'user') + '</span>' +
          '<span>' + decomp.length + ' tasks</span>' +
          '<span>P' + (d.priority || 3) + '</span>' +
        '</div>' +
      '</div>' +
      (decomp.length > 0 ? '<div class="directive-progress"><div class="directive-progress-fill" data-directive="' + d.directiveId + '" style="width:' + progressPct + '%"></div></div>' : '') +
    '</div>';
  }).join('');
}

function submitDirective() {
  var textEl = document.getElementById('directive-text');
  var prioEl = document.getElementById('directive-priority');
  if (!textEl || !textEl.value.trim()) { toast('Enter a directive', 'error'); return; }

  fetch('/api/directives', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ intent: textEl.value.trim(), priority: parseInt(prioEl.value) || 3 })
  }).then(function(r) {
    if (!r.ok) throw new Error('Failed');
    textEl.value = '';
    toast('Directive issued');
    loadDirectives();
  }).catch(function(e) { toast('Failed to issue directive', 'error'); });
}

// ── Workers ──
function loadWorkers() {
  fetch('/api/workers').then(function(r) { return r.json(); }).then(function(workers) {
    workersData = workers;
    renderWorkerGrid();
    updateFeedFilterTabs();
  }).catch(function() {});
}

function renderWorkerGrid() {
  var el = document.getElementById('worker-grid');
  if (!el) return;
  if (!workersData || workersData.length === 0) {
    el.innerHTML = '<div class="worker-empty">No workers active &mdash; issue a directive or start the orchestrator</div>';
    return;
  }
  el.innerHTML = workersData.map(function(w) {
    var status = w.status || 'idle';
    var color = workerColor(w._id);
    return '<div class="worker-card ' + status + '" data-worker="' + esc(w._id) + '">' +
      '<div class="worker-card-header">' +
        '<div class="worker-dot ' + status + '" style="background:' + color + ';box-shadow:0 0 6px ' + color + '"></div>' +
        '<span class="worker-id">' + esc(w._id) + '</span>' +
        '<span class="worker-task">' + esc(w.currentTaskId || 'idle') + '</span>' +
      '</div>' +
      '<div class="worker-output" id="worker-output-' + esc(w._id) + '">' + esc(w.currentOutput || 'Waiting...') + '</div>' +
      '<div class="worker-meta">' +
        '<span>Tasks: ' + (w.totalTasks || 0) + '</span>' +
        '<span>Cost: $' + (w.totalCost || 0).toFixed(2) + '</span>' +
      '</div>' +
    '</div>';
  }).join('');
}

function updateWorkerInGrid(worker) {
  if (!worker || !worker._id) return;
  // Update existing worker card or reload
  var existing = document.querySelector('.worker-card[data-worker="' + worker._id + '"]');
  if (existing) {
    var outEl = document.getElementById('worker-output-' + worker._id);
    if (outEl && worker.currentOutput) {
      outEl.textContent = worker.currentOutput;
      outEl.scrollTop = outEl.scrollHeight;
    }
    var dot = existing.querySelector('.worker-dot');
    if (dot) {
      dot.className = 'worker-dot ' + (worker.status || 'idle');
    }
    existing.className = 'worker-card ' + (worker.status || 'idle');
    var taskSpan = existing.querySelector('.worker-task');
    if (taskSpan) taskSpan.textContent = worker.currentTaskId || 'idle';
  } else if (worker.status !== 'removed') {
    // New worker — reload grid
    loadWorkers();
  }
  // Update workers data cache
  var found = false;
  for (var i = 0; i < workersData.length; i++) {
    if (workersData[i]._id === worker._id) {
      workersData[i] = worker;
      found = true;
      break;
    }
  }
  if (!found && worker.status !== 'removed') workersData.push(worker);
  if (worker.status === 'removed') {
    workersData = workersData.filter(function(w) { return w._id !== worker._id; });
    loadWorkers();
  }
}

function updateWorkerOutput(workerId, text) {
  var el = document.getElementById('worker-output-' + workerId);
  if (el) {
    el.textContent = text;
    el.scrollTop = el.scrollHeight;
  }
}

// ── Feed Filter Tabs ──
function updateFeedFilterTabs() {
  var el = document.getElementById('feed-filters');
  if (!el) return;
  var tabs = '<button class="feed-filter-tab' + (currentFeedFilter === 'all' ? ' active' : '') + '" onclick="filterFeed(\'all\')">ALL</button>';
  workersData.forEach(function(w) {
    var color = workerColor(w._id);
    tabs += '<button class="feed-filter-tab' + (currentFeedFilter === w._id ? ' active' : '') + '" style="border-bottom: 2px solid ' + color + '" onclick="filterFeed(\'' + esc(w._id) + '\')">' + esc(w._id).replace('worker-', 'W') + '</button>';
  });
  tabs += '<button class="feed-filter-tab' + (currentFeedFilter === 'orch' ? ' active' : '') + '" onclick="filterFeed(\'orch\')">ORCH</button>';
  tabs += '<button class="feed-filter-tab' + (currentFeedFilter === 'ollama' ? ' active' : '') + '" onclick="filterFeed(\'ollama\')">OLLAMA</button>';
  el.innerHTML = tabs;
}

function filterFeed(filter) {
  currentFeedFilter = filter;
  updateFeedFilterTabs();
  var events = document.querySelectorAll('#mc-feed-list .mc-event');
  events.forEach(function(ev) {
    if (filter === 'all') {
      ev.style.display = '';
    } else {
      var evWorker = ev.getAttribute('data-worker') || '';
      ev.style.display = (evWorker === filter || evWorker.indexOf(filter) !== -1) ? '' : 'none';
    }
  });
}

// ── Activity Feed ──
function loadActivity() {
  fetch('/api/activity').then(function(r) { return r.json(); }).then(function(events) {
    updateActivityFeed(events);
  }).catch(function() {});
}

function updateActivityFeed(events) {
  var list = document.getElementById('mc-feed-list');
  if (!list) return;
  if (!events || events.length === 0) {
    list.innerHTML = '<div style="font-size:0.7rem;color:var(--dim);text-align:center;padding:1rem">No recent activity</div>';
    return;
  }
  list.innerHTML = events.map(function(ev) {
    var agent = ev.agent || 'system';
    var agentClass = 'system';
    var agentLabel = 'SYS';
    var workerAttr = '';
    if (agent === 'ollama' || agent === 'brain') { agentClass = 'brain'; agentLabel = 'OLLAMA'; workerAttr = 'ollama'; }
    else if (agent === 'claude') { agentClass = 'claude'; agentLabel = 'CLAUDE'; }
    else if (agent.indexOf('worker-') === 0) { agentClass = 'claude'; agentLabel = agent.replace('worker-', 'W'); workerAttr = agent; }
    else if (agent === 'system' && (ev.type || '').indexOf('orchestrator') !== -1) { workerAttr = 'orch'; }
    var t = new Date(ev.createdAt);
    var timeStr = t.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    var toolBadge = '';
    if (ev.type === 'tool_use' || (ev.message || '').indexOf('[tool]') === 0) {
      toolBadge = '<span class="tool-badge">TOOL</span>';
    }
    return '<div class="mc-event" data-worker="' + esc(workerAttr) + '"><span class="mc-event-time">' + timeStr + '</span><span class="mc-event-agent ' + agentClass + '">' + agentLabel + '</span><span class="mc-event-msg">' + toolBadge + esc(ev.message) + '</span></div>';
  }).join('');
}

function prependActivityEvent(ev) {
  var list = document.getElementById('mc-feed-list');
  if (!list) return;
  // Clear "no activity" placeholder
  if (list.querySelector('div[style]') && list.children.length === 1) list.innerHTML = '';
  var agent = ev.agent || 'system';
  var agentClass = 'system';
  var agentLabel = 'SYS';
  var workerAttr = '';
  if (agent === 'ollama' || agent === 'brain') { agentClass = 'brain'; agentLabel = 'OLLAMA'; workerAttr = 'ollama'; }
  else if (agent === 'claude') { agentClass = 'claude'; agentLabel = 'CLAUDE'; }
  else if (agent.indexOf('worker-') === 0) { agentClass = 'claude'; agentLabel = agent.replace('worker-', 'W'); workerAttr = agent; }
  else if (agent === 'system' && (ev.type || '').indexOf('orchestrator') !== -1) { workerAttr = 'orch'; }
  var t = new Date(ev.createdAt);
  var timeStr = t.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  var toolBadge = '';
  if (ev.type === 'tool_use' || (ev.message || '').indexOf('[tool]') === 0) {
    toolBadge = '<span class="tool-badge">TOOL</span>';
  }
  var div = document.createElement('div');
  div.className = 'mc-event';
  div.setAttribute('data-worker', workerAttr);
  div.innerHTML = '<span class="mc-event-time">' + timeStr + '</span><span class="mc-event-agent ' + agentClass + '">' + agentLabel + '</span><span class="mc-event-msg">' + toolBadge + esc(ev.message) + '</span>';
  // Apply current filter
  if (currentFeedFilter !== 'all' && workerAttr !== currentFeedFilter && workerAttr.indexOf(currentFeedFilter) === -1) {
    div.style.display = 'none';
  }
  list.insertBefore(div, list.firstChild);
  // Cap at 100 events
  while (list.children.length > 100) list.removeChild(list.lastChild);
}

function loadTasks() {
  fetch('/api/tasks').then(function(r) { return r.json(); }).then(function(tasks) {
    updateRoadmap(tasks);
  }).catch(function() {});
}

function updateRoadmap(tasks) {
  var list = document.getElementById('roadmap-list');
  if (!list) return;
  if (!tasks || tasks.length === 0) {
    list.innerHTML = '<div class="roadmap-empty">No roadmap tasks yet</div>';
    return;
  }

  // Update directive progress bars
  if (directivesData && directivesData.length > 0) {
    directivesData.forEach(function(d) {
      var decomp = d.decomposition || [];
      if (decomp.length === 0) return;
      var completed = 0;
      decomp.forEach(function(tid) {
        for (var i = 0; i < tasks.length; i++) {
          if (tasks[i].taskId === tid && (tasks[i].status === 'completed' || tasks[i].status === 'skipped')) {
            completed++;
            break;
          }
        }
      });
      var pct = Math.round((completed / decomp.length) * 100);
      var bar = document.querySelector('.directive-progress-fill[data-directive="' + d.directiveId + '"]');
      if (bar) bar.style.width = pct + '%';
    });
  }

  // Group tasks by directive
  var grouped = {};
  var ungrouped = [];
  tasks.forEach(function(t) {
    if (t.directiveId) {
      if (!grouped[t.directiveId]) grouped[t.directiveId] = [];
      grouped[t.directiveId].push(t);
    } else {
      ungrouped.push(t);
    }
  });

  var html = '';

  // Render grouped tasks under directive headers
  var dirIds = Object.keys(grouped);
  dirIds.forEach(function(dirId) {
    var dirTasks = grouped[dirId];
    var directive = directivesData.find(function(d) { return d.directiveId === dirId; });
    var dirIntent = directive ? directive.intent : dirId;
    html += '<div class="roadmap-directive-group">';
    html += '<div class="roadmap-directive-header"><span class="dir-id">' + esc(dirId) + '</span> ' + esc(dirIntent).slice(0, 80) + '</div>';
    html += dirTasks.map(function(t) { return renderRoadmapItem(t); }).join('');
    html += '</div>';
  });

  // Render ungrouped tasks
  if (ungrouped.length > 0) {
    if (dirIds.length > 0) {
      html += '<div class="roadmap-directive-group">';
      html += '<div class="roadmap-directive-header"><span class="dir-id">STANDALONE</span> Manual & legacy tasks</div>';
    }
    html += ungrouped.map(function(t) { return renderRoadmapItem(t); }).join('');
    if (dirIds.length > 0) html += '</div>';
  }

  list.innerHTML = html;
}

function renderRoadmapItem(t) {
  var priorityClass = 'p' + (t.priority || 3);
  var tagsHtml = (t.tags || []).map(function(tag) { return '<span class="roadmap-tag">' + esc(tag) + '</span>'; }).join('');
  var workerBadge = '';
  if (t.assignedWorker && t.status === 'in_progress') {
    var wColor = workerColor(t.assignedWorker);
    workerBadge = '<span class="roadmap-worker-badge" style="background:' + wColor + '22;color:' + wColor + '">' + esc(t.assignedWorker) + '</span>';
  }
  var depLink = '';
  if (t.dependencies && t.dependencies.length > 0) {
    depLink = '<span class="roadmap-dep-link">depends on ' + t.dependencies.map(function(d) { return esc(d); }).join(', ') + '</span>';
  }
  return '<div class="roadmap-item">' +
    '<div class="roadmap-status ' + (t.status || 'planned') + '"></div>' +
    '<div class="roadmap-info">' +
      '<div class="roadmap-title">' + esc(t.title) + workerBadge + '</div>' +
      (t.description ? '<div class="roadmap-desc">' + esc(t.description).slice(0, 120) + '</div>' : '') +
      '<div class="roadmap-meta"><span class="roadmap-priority ' + priorityClass + '">P' + (t.priority || 3) + '</span>' + tagsHtml + depLink + '</div>' +
    '</div></div>';
}

function refreshDocsQuietly() {
  fetch('/api/docs').then(function(r) { return r.json(); }).then(function(docs) {
    allDocs = docs;
    docsById = {};
    allDocs.forEach(function(d) { docsById[d.docId] = d; });
    var dc = document.getElementById('doc-count');
    if (dc) dc.textContent = allDocs.length + ' docs';
  }).catch(function() {});
}

/* ── Document Page ── */
function buildTOC(content) {
  var div = document.createElement('div');
  div.innerHTML = content || '';
  var headings = div.querySelectorAll('h1, h2, h3');
  if (headings.length < 3) return { toc: '', content: content };
  var isMobile = window.innerWidth < 768;
  var tocHtml = '<div class="toc' + (isMobile ? ' collapsed' : '') + '">';
  tocHtml += '<div class="toc-header" onclick="toggleToc(this)">';
  tocHtml += '<span class="toc-title">Contents</span>';
  tocHtml += '<span class="toc-toggle">&#9660;</span>';
  tocHtml += '</div>';
  tocHtml += '<div class="toc-body">';
  for (var i = 0; i < headings.length; i++) {
    var h = headings[i];
    var id = 'h-' + h.textContent.trim().toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+$/, '');
    h.id = id;
    var level = h.tagName.toLowerCase();
    tocHtml += '<a data-target="' + id + '" class="toc-' + level + '" onclick="scrollToHeading(\'' + id + '\');return false">' + h.textContent.trim() + '</a>';
  }
  tocHtml += '</div></div>';
  return { toc: tocHtml, content: div.innerHTML };
}

function toggleToc(header) {
  var toc = header.closest('.toc');
  if (toc) toc.classList.toggle('collapsed');
}

function scrollToHeading(id) {
  var el = document.getElementById(id);
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

var tocObserver = null;

function setupTocObserver() {
  if (tocObserver) { tocObserver.disconnect(); tocObserver = null; }
  var headings = document.querySelectorAll('.doc-content h1[id], .doc-content h2[id], .doc-content h3[id]');
  if (headings.length === 0) return;
  var tocLinks = document.querySelectorAll('.toc a[data-target]');
  if (tocLinks.length === 0) return;

  tocObserver = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        tocLinks.forEach(function(a) { a.classList.remove('toc-active'); });
        var active = document.querySelector('.toc a[data-target="' + entry.target.id + '"]');
        if (active) active.classList.add('toc-active');
      }
    });
  }, { rootMargin: '-10% 0px -80% 0px', threshold: 0 });

  headings.forEach(function(h) { tocObserver.observe(h); });
}

/* ── Mini Dependency Graph ── */
function renderMiniGraph(doc) {
  var container = document.getElementById('mini-graph');
  if (!container) return;

  var deps = (doc.dependsOn || []).filter(function(d) { return docsById[d]; });
  var refs = (doc.dependedBy || []).filter(function(d) { return docsById[d]; });
  var totalNodes = deps.length + refs.length;
  if (totalNodes === 0) { container.style.display = 'none'; return; }

  var w = Math.min(460, container.clientWidth - 32);
  var h = Math.min(320, 180 + totalNodes * 12);
  var cx = w / 2;
  var cy = h / 2;
  var radius = Math.min(cx, cy) - 40;

  var allConnected = [];
  deps.forEach(function(d) { allConnected.push({ id: d, type: 'dep' }); });
  refs.forEach(function(d) { allConnected.push({ id: d, type: 'ref' }); });

  var angleStep = (2 * Math.PI) / allConnected.length;
  var startAngle = -Math.PI / 2;

  var svg = '<svg width="' + w + '" height="' + h + '" viewBox="0 0 ' + w + ' ' + h + '">';

  // Draw edges from center to each connected node
  allConnected.forEach(function(node, i) {
    var angle = startAngle + i * angleStep;
    var nx = cx + radius * Math.cos(angle);
    var ny = cy + radius * Math.sin(angle);
    var color = node.type === 'dep' ? '#ff00aa' : '#333344';
    svg += '<line class="graph-edge" x1="' + cx + '" y1="' + cy + '" x2="' + nx + '" y2="' + ny + '" stroke="' + color + '" opacity="0.5"/>';
  });

  // Draw connected nodes with labels
  allConnected.forEach(function(node, i) {
    var angle = startAngle + i * angleStep;
    var nx = cx + radius * Math.cos(angle);
    var ny = cy + radius * Math.sin(angle);
    var fill = node.type === 'dep' ? '#ff00aa' : '#444460';
    var textFill = node.type === 'dep' ? '#ff00aa' : '#666678';
    var label = node.id.length > 12 ? node.id.substring(0, 11) + '\u2026' : node.id;
    svg += '<g class="graph-node" onclick="openDoc(\'' + esc(node.id) + '\')"><title>' + esc(node.id) + '</title>';
    svg += '<circle cx="' + nx + '" cy="' + ny + '" r="6" fill="' + fill + '" stroke="' + fill + '" stroke-width="2" fill-opacity="0.3"/>';
    var textAnchor = (nx < cx - 10) ? 'end' : (nx > cx + 10) ? 'start' : 'middle';
    var textDx = (nx < cx - 10) ? -10 : (nx > cx + 10) ? 10 : 0;
    var textDy = (Math.abs(nx - cx) <= 10) ? (ny < cy ? -12 : 18) : 4;
    svg += '<text x="' + nx + '" y="' + ny + '" dx="' + textDx + '" dy="' + textDy + '" text-anchor="' + textAnchor + '" fill="' + textFill + '" font-size="9">' + esc(label) + '</text>';
    svg += '</g>';
  });

  // Draw center node (current document) in cyan
  svg += '<circle cx="' + cx + '" cy="' + cy + '" r="10" fill="#00f0ff" fill-opacity="0.2" stroke="#00f0ff" stroke-width="2"/>';
  var centerLabel = doc.docId.length > 14 ? doc.docId.substring(0, 13) + '\u2026' : doc.docId;
  svg += '<text x="' + cx + '" y="' + (cy + 22) + '" text-anchor="middle" fill="#00f0ff" font-size="10" font-weight="bold">' + esc(centerLabel) + '</text>';

  svg += '</svg>';
  container.querySelector('.mini-graph-svg').innerHTML = svg;
}

/* ── Full Graph Visualization ── */
var graphAnim = null;
function openGraph() {
  histStack = [];
  currentDocId = null;
  currentDomain = null;
  renderGraph();
  history.pushState({ graph: true }, '', '#graph');
}

async function renderGraph() {
  var el = document.getElementById('main');
  el.innerHTML = '<div class="loading">Loading graph...</div>';

  var domainColors = {
    '1':'#00f0ff','2':'#ff00aa','3':'#ff4444','4':'#ff9800','5':'#00e676',
    '6':'#7c4dff','7':'#00bcd4','8':'#ffeb3b','9':'#e040fb','10':'#76ff03',
    '11':'#ff6e40','12':'#f44336','13':'#64ffda','14':'#448aff','15':'#ea80fc',
    '16':'#ffd740','17':'#b388ff','18':'#84ffff','19':'#ff80ab','20':'#69f0ae',
    'META':'#666678','FW':'#555568','HIC':'#00f0ff','PROJ':'#00ff88','LOG':'#ffcc00'
  };

  var data;
  try {
    var res = await fetch('/api/graph');
    data = await res.json();
  } catch(e) {
    el.innerHTML = '<div class="loading">Failed to load graph data</div>';
    return;
  }

  var nodes = data.nodes;
  var edges = data.edges;
  var nodeMap = {};
  nodes.forEach(function(n, i) { nodeMap[n.id] = i; });

  // Build adjacency for edge lookup
  var adj = {};
  nodes.forEach(function(n) { adj[n.id] = []; });
  edges.forEach(function(e) {
    if (adj[e.source]) adj[e.source].push(e.target);
    if (adj[e.target]) adj[e.target].push(e.source);
  });

  // Domain legend data
  var domainSet = {};
  nodes.forEach(function(n) {
    if (!domainSet[n.domain]) domainSet[n.domain] = { name: n.domainName, count: 0 };
    domainSet[n.domain].count++;
  });

  // Build legend HTML
  var legendHtml = '';
  var domainKeys = Object.keys(domainSet).sort(function(a,b) {
    var na = parseInt(a), nb = parseInt(b);
    if (!isNaN(na) && !isNaN(nb)) return na - nb;
    if (!isNaN(na)) return -1;
    if (!isNaN(nb)) return 1;
    return a.localeCompare(b);
  });
  var hiddenDomains = {};
  domainKeys.forEach(function(k) {
    var c = domainColors[k] || '#666678';
    legendHtml += '<div class="graph-legend-item" data-domain="' + k + '" onclick="toggleGraphDomain(\'' + k + '\')">' +
      '<span class="graph-legend-dot" style="background:' + c + '"></span>' +
      k + ' (' + domainSet[k].count + ')</div>';
  });

  el.innerHTML = '<div class="graph-container">' +
    '<canvas id="graph-canvas"></canvas>' +
    '<div class="graph-hud">' +
      '<div class="graph-title">KNOWLEDGE GRAPH</div>' +
      '<div class="graph-stats">' + nodes.length + ' nodes &middot; ' + edges.length + ' edges</div>' +
      '<div class="graph-legend" id="graph-legend">' + legendHtml + '</div>' +
    '</div>' +
    '<div class="graph-controls">' +
      '<button class="graph-btn" onclick="graphZoom(1.3)">+</button>' +
      '<button class="graph-btn" onclick="graphZoom(0.7)">-</button>' +
      '<button class="graph-btn" onclick="graphReset()">reset</button>' +
      '<button class="graph-btn" onclick="goHome()">&larr; home</button>' +
    '</div>' +
    '<div class="graph-tooltip" id="graph-tooltip">' +
      '<div class="tt-id"></div><div class="tt-title"></div><div class="tt-domain"></div><div class="tt-deps"></div>' +
    '</div>' +
  '</div>';

  var canvas = document.getElementById('graph-canvas');
  var ctx = canvas.getContext('2d');
  var tooltip = document.getElementById('graph-tooltip');
  var dpr = window.devicePixelRatio || 1;
  var W, H;

  function resize() {
    var rect = canvas.parentElement.getBoundingClientRect();
    W = rect.width;
    H = rect.height;
    canvas.width = W * dpr;
    canvas.height = H * dpr;
    canvas.style.width = W + 'px';
    canvas.style.height = H + 'px';
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  resize();
  window.addEventListener('resize', resize);

  // Initialize positions — cluster by domain
  var domainAngle = {};
  var aStep = (2 * Math.PI) / domainKeys.length;
  domainKeys.forEach(function(k, i) { domainAngle[k] = i * aStep; });

  var cx = W / 2, cy = H / 2;
  var spread = Math.min(W, H) * 0.3;
  nodes.forEach(function(n) {
    var a = domainAngle[n.domain] || 0;
    n.x = cx + spread * Math.cos(a) + (Math.random() - 0.5) * spread * 0.6;
    n.y = cy + spread * Math.sin(a) + (Math.random() - 0.5) * spread * 0.6;
    n.vx = 0;
    n.vy = 0;
    n.r = Math.min(8, 3 + (adj[n.id] ? adj[n.id].length : 0) * 0.4);
  });

  // Camera
  var cam = { x: 0, y: 0, zoom: 1 };

  function toScreen(px, py) {
    return { x: (px + cam.x) * cam.zoom + W / 2, y: (py + cam.y) * cam.zoom + H / 2 };
  }
  function toWorld(sx, sy) {
    return { x: (sx - W / 2) / cam.zoom - cam.x, y: (sy - H / 2) / cam.zoom - cam.y };
  }

  window.graphZoom = function(factor) {
    cam.zoom = Math.max(0.1, Math.min(10, cam.zoom * factor));
  };
  window.graphReset = function() {
    cam.x = 0; cam.y = 0; cam.zoom = 1;
    // Re-center on centroid
    var sx = 0, sy = 0, cnt = 0;
    nodes.forEach(function(n) { if (!hiddenDomains[n.domain]) { sx += n.x; sy += n.y; cnt++; } });
    if (cnt > 0) { cam.x = -(sx / cnt - W / 2); cam.y = -(sy / cnt - H / 2); }
  };

  window.toggleGraphDomain = function(k) {
    hiddenDomains[k] = !hiddenDomains[k];
    var items = document.querySelectorAll('.graph-legend-item[data-domain="' + k + '"]');
    items.forEach(function(el) { el.style.opacity = hiddenDomains[k] ? '0.3' : '1'; });
  };

  // Force simulation
  var alpha = 1;
  var alphaDecay = 0.0028;
  var alphaMin = 0.001;

  function simulate() {
    if (alpha < alphaMin) return;
    alpha *= (1 - alphaDecay);

    var n = nodes.length;

    // Repulsion (Barnes-Hut approximation: grid-based)
    var repStr = 800;
    for (var i = 0; i < n; i++) {
      if (hiddenDomains[nodes[i].domain]) continue;
      for (var j = i + 1; j < n; j++) {
        if (hiddenDomains[nodes[j].domain]) continue;
        var dx = nodes[j].x - nodes[i].x;
        var dy = nodes[j].y - nodes[i].y;
        var d2 = dx * dx + dy * dy;
        if (d2 < 1) d2 = 1;
        var d = Math.sqrt(d2);
        var f = repStr / d2 * alpha;
        var fx = dx / d * f;
        var fy = dy / d * f;
        nodes[i].vx -= fx;
        nodes[i].vy -= fy;
        nodes[j].vx += fx;
        nodes[j].vy += fy;
      }
    }

    // Attraction along edges
    var attStr = 0.06;
    var idealLen = 60;
    edges.forEach(function(e) {
      var si = nodeMap[e.source], ti = nodeMap[e.target];
      if (si === undefined || ti === undefined) return;
      var s = nodes[si], t = nodes[ti];
      if (hiddenDomains[s.domain] || hiddenDomains[t.domain]) return;
      var dx = t.x - s.x;
      var dy = t.y - s.y;
      var d = Math.sqrt(dx * dx + dy * dy) || 1;
      var f = (d - idealLen) * attStr * alpha;
      var fx = dx / d * f;
      var fy = dy / d * f;
      s.vx += fx; s.vy += fy;
      t.vx -= fx; t.vy -= fy;
    });

    // Center gravity
    var gravStr = 0.02;
    var gx = W / 2, gy = H / 2;
    nodes.forEach(function(n) {
      if (hiddenDomains[n.domain]) return;
      n.vx += (gx - n.x) * gravStr * alpha;
      n.vy += (gy - n.y) * gravStr * alpha;
    });

    // Domain clustering force
    var clusterStr = 0.3;
    domainKeys.forEach(function(k) {
      if (hiddenDomains[k]) return;
      var sx = 0, sy = 0, cnt = 0;
      nodes.forEach(function(n) { if (n.domain === k) { sx += n.x; sy += n.y; cnt++; } });
      if (cnt < 2) return;
      var mx = sx / cnt, my = sy / cnt;
      nodes.forEach(function(n) {
        if (n.domain !== k) return;
        n.vx += (mx - n.x) * clusterStr * alpha * 0.1;
        n.vy += (my - n.y) * clusterStr * alpha * 0.1;
      });
    });

    // Velocity damping + position update
    var damping = 0.6;
    var maxV = 15;
    nodes.forEach(function(n) {
      if (hiddenDomains[n.domain]) return;
      n.vx *= damping;
      n.vy *= damping;
      var v = Math.sqrt(n.vx * n.vx + n.vy * n.vy);
      if (v > maxV) { n.vx *= maxV / v; n.vy *= maxV / v; }
      n.x += n.vx;
      n.y += n.vy;
    });
  }

  // Draw
  function draw() {
    ctx.clearRect(0, 0, W, H);
    ctx.save();
    ctx.translate(W / 2, H / 2);
    ctx.scale(cam.zoom, cam.zoom);
    ctx.translate(cam.x, cam.y);

    // Edges
    ctx.lineWidth = 0.5 / cam.zoom;
    edges.forEach(function(e) {
      var si = nodeMap[e.source], ti = nodeMap[e.target];
      if (si === undefined || ti === undefined) return;
      var s = nodes[si], t = nodes[ti];
      if (hiddenDomains[s.domain] || hiddenDomains[t.domain]) return;
      ctx.strokeStyle = 'rgba(0,240,255,0.07)';
      ctx.beginPath();
      ctx.moveTo(s.x, s.y);
      ctx.lineTo(t.x, t.y);
      ctx.stroke();
    });

    // Highlighted edges for hovered node
    if (hoveredNode) {
      ctx.lineWidth = 1.5 / cam.zoom;
      var hAdj = adj[hoveredNode.id] || [];
      edges.forEach(function(e) {
        if (e.source !== hoveredNode.id && e.target !== hoveredNode.id) return;
        var si = nodeMap[e.source], ti = nodeMap[e.target];
        if (si === undefined || ti === undefined) return;
        var s = nodes[si], t = nodes[ti];
        if (hiddenDomains[s.domain] || hiddenDomains[t.domain]) return;
        var isSource = e.source === hoveredNode.id;
        ctx.strokeStyle = isSource ? 'rgba(255,0,170,0.6)' : 'rgba(0,240,255,0.4)';
        ctx.beginPath();
        ctx.moveTo(s.x, s.y);
        ctx.lineTo(t.x, t.y);
        ctx.stroke();
      });
    }

    // Nodes
    nodes.forEach(function(n) {
      if (hiddenDomains[n.domain]) return;
      var c = domainColors[n.domain] || '#666678';
      var isHovered = hoveredNode && hoveredNode.id === n.id;
      var isConnected = hoveredNode && (adj[hoveredNode.id] || []).indexOf(n.id) !== -1;
      var nodeAlpha = hoveredNode ? (isHovered ? 1 : isConnected ? 0.9 : 0.15) : 0.75;

      // Glow
      if (isHovered) {
        ctx.beginPath();
        ctx.arc(n.x, n.y, n.r * 3, 0, Math.PI * 2);
        ctx.fillStyle = c.replace(')', ',0.12)').replace('rgb', 'rgba').replace('#', '');
        // Use hex-based glow
        ctx.shadowColor = c;
        ctx.shadowBlur = 20 / cam.zoom;
        ctx.fill();
        ctx.shadowBlur = 0;
      }

      ctx.beginPath();
      ctx.arc(n.x, n.y, isHovered ? n.r * 1.5 : n.r, 0, Math.PI * 2);
      ctx.globalAlpha = nodeAlpha;
      ctx.fillStyle = c;
      ctx.fill();
      ctx.globalAlpha = 1;

      // Label for hovered or large nodes
      if (isHovered || isConnected) {
        ctx.font = (isHovered ? 'bold ' : '') + (10 / cam.zoom) + 'px JetBrains Mono, monospace';
        ctx.fillStyle = isHovered ? '#ffffff' : c;
        ctx.globalAlpha = isHovered ? 1 : 0.8;
        ctx.textAlign = 'center';
        ctx.fillText(n.id, n.x, n.y - n.r - 6 / cam.zoom);
        ctx.globalAlpha = 1;
      }
    });

    ctx.restore();
  }

  // Interaction
  var hoveredNode = null;
  var dragNode = null;
  var isPanning = false;
  var panStart = { x: 0, y: 0 };

  function findNode(sx, sy) {
    var w = toWorld(sx, sy);
    var closest = null;
    var closestD = Infinity;
    nodes.forEach(function(n) {
      if (hiddenDomains[n.domain]) return;
      var dx = n.x - w.x;
      var dy = n.y - w.y;
      var d = Math.sqrt(dx * dx + dy * dy);
      var hitR = Math.max(n.r, 12 / cam.zoom);
      if (d < hitR && d < closestD) { closest = n; closestD = d; }
    });
    return closest;
  }

  canvas.addEventListener('mousemove', function(e) {
    var rect = canvas.getBoundingClientRect();
    var mx = e.clientX - rect.left;
    var my = e.clientY - rect.top;

    if (dragNode) {
      var w = toWorld(mx, my);
      dragNode.x = w.x;
      dragNode.y = w.y;
      dragNode.vx = 0;
      dragNode.vy = 0;
      return;
    }

    if (isPanning) {
      var dx = (e.clientX - panStart.x) / cam.zoom;
      var dy = (e.clientY - panStart.y) / cam.zoom;
      cam.x += dx;
      cam.y += dy;
      panStart.x = e.clientX;
      panStart.y = e.clientY;
      return;
    }

    var node = findNode(mx, my);
    hoveredNode = node;
    canvas.style.cursor = node ? 'pointer' : 'grab';

    if (node) {
      var depCount = (adj[node.id] || []).length;
      tooltip.style.display = 'block';
      tooltip.style.left = (e.clientX - rect.left + 15) + 'px';
      tooltip.style.top = (e.clientY - rect.top - 10) + 'px';
      tooltip.querySelector('.tt-id').textContent = node.id;
      tooltip.querySelector('.tt-title').textContent = node.title;
      tooltip.querySelector('.tt-domain').textContent = node.domainName;
      tooltip.querySelector('.tt-deps').textContent = depCount + ' connections';
    } else {
      tooltip.style.display = 'none';
    }
  });

  canvas.addEventListener('mousedown', function(e) {
    var rect = canvas.getBoundingClientRect();
    var mx = e.clientX - rect.left;
    var my = e.clientY - rect.top;
    var node = findNode(mx, my);
    if (node) {
      dragNode = node;
      alpha = Math.max(alpha, 0.1);
      canvas.classList.add('dragging');
    } else {
      isPanning = true;
      panStart.x = e.clientX;
      panStart.y = e.clientY;
      canvas.classList.add('dragging');
    }
  });

  canvas.addEventListener('mouseup', function() {
    if (dragNode) { dragNode = null; }
    isPanning = false;
    canvas.classList.remove('dragging');
  });

  canvas.addEventListener('mouseleave', function() {
    hoveredNode = null;
    dragNode = null;
    isPanning = false;
    tooltip.style.display = 'none';
    canvas.classList.remove('dragging');
  });

  canvas.addEventListener('dblclick', function(e) {
    var rect = canvas.getBoundingClientRect();
    var node = findNode(e.clientX - rect.left, e.clientY - rect.top);
    if (node) openDoc(node.id);
  });

  canvas.addEventListener('wheel', function(e) {
    e.preventDefault();
    var factor = e.deltaY < 0 ? 1.1 : 0.9;
    cam.zoom = Math.max(0.1, Math.min(10, cam.zoom * factor));
  }, { passive: false });

  // Touch support
  var lastTouchDist = 0;
  canvas.addEventListener('touchstart', function(e) {
    if (e.touches.length === 1) {
      var t = e.touches[0];
      var rect = canvas.getBoundingClientRect();
      var node = findNode(t.clientX - rect.left, t.clientY - rect.top);
      if (node) { dragNode = node; alpha = Math.max(alpha, 0.1); }
      else { isPanning = true; panStart.x = t.clientX; panStart.y = t.clientY; }
    } else if (e.touches.length === 2) {
      var dx = e.touches[0].clientX - e.touches[1].clientX;
      var dy = e.touches[0].clientY - e.touches[1].clientY;
      lastTouchDist = Math.sqrt(dx * dx + dy * dy);
    }
  });
  canvas.addEventListener('touchmove', function(e) {
    e.preventDefault();
    if (e.touches.length === 2) {
      var dx = e.touches[0].clientX - e.touches[1].clientX;
      var dy = e.touches[0].clientY - e.touches[1].clientY;
      var dist = Math.sqrt(dx * dx + dy * dy);
      if (lastTouchDist > 0) {
        cam.zoom = Math.max(0.1, Math.min(10, cam.zoom * (dist / lastTouchDist)));
      }
      lastTouchDist = dist;
      return;
    }
    var t = e.touches[0];
    if (dragNode) {
      var rect = canvas.getBoundingClientRect();
      var w = toWorld(t.clientX - rect.left, t.clientY - rect.top);
      dragNode.x = w.x; dragNode.y = w.y; dragNode.vx = 0; dragNode.vy = 0;
    } else if (isPanning) {
      cam.x += (t.clientX - panStart.x) / cam.zoom;
      cam.y += (t.clientY - panStart.y) / cam.zoom;
      panStart.x = t.clientX; panStart.y = t.clientY;
    }
  }, { passive: false });
  canvas.addEventListener('touchend', function() {
    dragNode = null; isPanning = false; lastTouchDist = 0;
  });

  // Animation loop
  if (graphAnim) cancelAnimationFrame(graphAnim);
  function tick() {
    simulate();
    draw();
    graphAnim = requestAnimationFrame(tick);
  }
  tick();

  // Center camera on centroid after a short delay
  setTimeout(function() {
    var sx = 0, sy = 0, cnt = 0;
    nodes.forEach(function(n) { sx += n.x; sy += n.y; cnt++; });
    if (cnt > 0) { cam.x = -(sx / cnt - W / 2); cam.y = -(sy / cnt - H / 2); }
  }, 100);
}

async function renderDoc(id) {
  var el = document.getElementById('main');
  var doc = docsById[id];
  if (!doc) { el.innerHTML = '<div class="loading">Document not found</div>'; return; }

  if (doc.content === undefined) {
    el.innerHTML = '<div class="loading">loading...</div>';
    var cacheKey = 'holm-doc-' + id;
    try {
      var res = await fetch('/api/docs/' + encodeURIComponent(id));
      if (!res.ok) throw new Error();
      var fetched = await res.json();
      Object.assign(doc, fetched);
      try { sessionStorage.setItem(cacheKey, JSON.stringify(fetched)); } catch(e) {}
    } catch(e) {
      // Offline or network error — try sessionStorage cache
      try {
        var cached = sessionStorage.getItem(cacheKey);
        if (cached) {
          Object.assign(doc, JSON.parse(cached));
          toast('Loaded from cache');
        } else {
          toast('Unavailable offline', 'error'); return;
        }
      } catch(e2) { toast('Failed to load', 'error'); return; }
    }
  }

  var domainName = doc.domainName || DOMAIN_NAMES[doc.domain] || doc.domain;
  var docIds = new Set(allDocs.map(function(d) { return d.docId; }));
  var deps = doc.dependsOn || [];
  var refs = doc.dependedBy || [];

  var plain = (doc.content || '').replace(/<[^>]*>/g, '');
  var words = plain.split(/\s+/).filter(function(w) { return w.length > 0; }).length;
  var readMin = Math.max(1, Math.ceil(words / 200));

  var html = '<div class="doc-page">';

  html += '<div class="breadcrumb">';
  html += '<a href="#" onclick="goHome();return false">Home</a>';
  html += '<span class="sep">/</span>';
  html += '<span>' + esc(domainName) + '</span>';
  html += '<span class="sep">/</span>';
  html += '<span>' + esc(doc.docId) + '</span>';
  html += '</div>';

  html += '<div style="display:flex;justify-content:flex-end;margin-bottom:0.5rem">';
  html += '<button class="copy-btn" onclick="copyDocText()">Copy text</button>';
  html += '</div>';

  html += '<div style="display:flex;align-items:flex-start;gap:0.5rem">';
  html += '<h1 style="flex:1">' + esc(doc.title) + '</h1>';
  html += '<button id="bookmark-btn" class="bookmark-btn' + (isBookmarked(id) ? ' active' : '') + '" onclick="toggleBookmark(\'' + esc(id) + '\')">' + (isBookmarked(id) ? '\u2605' : '\u2606') + '</button>';
  html += '</div>';

  // Domain color mapping
  var domainColors = {
    '1':'#00f0ff','2':'#ff00aa','3':'#ff4444','4':'#ff9800','5':'#00e676',
    '6':'#7c4dff','7':'#00bcd4','8':'#ffeb3b','9':'#e040fb','10':'#76ff03',
    '11':'#ff6e40','12':'#f44336','13':'#64ffda','14':'#448aff','15':'#ea80fc',
    '16':'#ffd740','17':'#b388ff','18':'#84ffff','19':'#ff80ab','20':'#69f0ae',
    'META':'#666678','FW':'#666678','HIC':'#00f0ff','PROJ':'#00ff88','LOG':'#ffcc00'
  };
  var dColor = domainColors[doc.domain] || 'var(--cyan)';

  // Status class mapping
  var statusRaw = (doc.status || '').toLowerCase().trim();
  var statusClass = 'unknown';
  if (statusRaw === 'active' || statusRaw === 'ratified' || statusRaw === 'approved' || statusRaw === 'final') statusClass = 'active';
  else if (statusRaw === 'draft' || statusRaw === 'pending' || statusRaw === 'review') statusClass = 'draft';
  else if (statusRaw === 'deprecated' || statusRaw === 'archived' || statusRaw === 'obsolete' || statusRaw === 'retired') statusClass = 'deprecated';
  else if (statusRaw) statusClass = 'active';

  // Format date
  var metaDateStr = '';
  var rawDate = doc.updatedAt || doc.date;
  if (rawDate) {
    var dd = new Date(rawDate);
    if (!isNaN(dd.getTime())) {
      var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      metaDateStr = months[dd.getMonth()] + ' ' + dd.getDate() + ', ' + dd.getFullYear();
    }
  }

  // Metadata bar
  html += '<div class="doc-meta-bar">';
  if (doc.version) html += '<span class="meta-badge version">v' + esc(doc.version) + '</span>';
  if (doc.status) html += '<span class="status-pill ' + statusClass + '">' + esc(doc.status) + '</span>';
  if ((doc.version || doc.status) && metaDateStr) html += '<span class="meta-sep"></span>';
  html += '<span class="meta-badge domain-badge" style="border-color:' + dColor + ';color:' + dColor + ';background:' + dColor + '11">' + esc(domainName) + '</span>';
  if (metaDateStr) html += '<span class="meta-date"><span class="date-icon">&#9719;</span> ' + esc(metaDateStr) + '</span>';
  html += '</div>';

  // Tags row
  html += '<div class="doc-meta">';
  html += '<span class="tag">' + words.toLocaleString() + ' words</span>';
  html += '<span class="tag">' + readMin + ' min</span>';
  if (doc.tags) doc.tags.forEach(function(t) { html += '<span class="tag">' + esc(t) + '</span>'; });
  html += '</div>';

  if (deps.length > 0) {
    html += '<div class="deps"><div class="deps-label">Depends on</div><div class="deps-list">';
    deps.forEach(function(d) {
      html += docIds.has(d)
        ? '<span class="dep-chip" onclick="openDoc(\'' + esc(d) + '\')">' + esc(d) + '</span>'
        : '<span class="dep-chip broken">' + esc(d) + '</span>';
    });
    html += '</div></div>';
  }
  if (refs.length > 0) {
    html += '<div class="deps"><div class="deps-label">Referenced by</div><div class="deps-list">';
    refs.forEach(function(d) {
      html += docIds.has(d)
        ? '<span class="dep-chip" onclick="openDoc(\'' + esc(d) + '\')">' + esc(d) + '</span>'
        : '<span class="dep-chip broken">' + esc(d) + '</span>';
    });
    html += '</div></div>';
  }

  if (deps.length > 0 || refs.length > 0) {
    html += '<div id="mini-graph" class="mini-graph">';
    html += '<div class="mini-graph-label">Dependency Graph</div>';
    html += '<div class="mini-graph-svg"></div>';
    html += '</div>';
  }

  var tocResult = buildTOC(doc.content);
  html += tocResult.toc;
  html += '<div class="doc-content">' + (linkifyDocIds(tocResult.content) || '<p style="color:var(--dim)">No content</p>') + '</div>';

  html += buildDocNav(doc);

  html += '<div class="comments">';
  html += '<div class="comments-title">Comments <span id="cc"></span></div>';
  html += '<div class="comment-form">';
  html += '<input type="text" id="c-author" placeholder="Name" maxlength="50">';
  html += '<textarea id="c-text" placeholder="Write a comment..." maxlength="2000"></textarea>';
  html += '<button onclick="postComment()">Post</button>';
  html += '</div>';
  html += '<div id="c-list"><div style="font-size:0.75rem;color:var(--dim);text-align:center;padding:0.5rem">Loading...</div></div>';
  html += '</div>';

  html += '</div>';
  el.innerHTML = html;
  renderMiniGraph(doc);
  window.scrollTo(0, 0);

  var saved = localStorage.getItem('holm-author');
  if (saved) document.getElementById('c-author').value = saved;

  loadComments(id);
  setupTocObserver();
}

/* ── Document Navigation ── */
function buildDocNav(doc) {
  var domainDocs = allDocs.filter(function(d) { return d.domain === doc.domain; })
    .sort(function(a, b) { return a.docId.localeCompare(b.docId); });
  var idx = domainDocs.findIndex(function(d) { return d.docId === doc.docId; });
  if (idx === -1) return '';
  var prev = idx > 0 ? domainDocs[idx - 1] : null;
  var next = idx < domainDocs.length - 1 ? domainDocs[idx + 1] : null;
  if (!prev && !next) return '';
  var html = '<div class="doc-nav-footer">';
  if (prev) {
    html += '<div class="doc-nav-link" onclick="openDoc(\'' + esc(prev.docId) + '\')">';
    html += '<div class="nav-label">&larr; Previous</div>';
    html += '<div class="nav-title">' + esc(prev.title) + '</div></div>';
  } else {
    html += '<div></div>';
  }
  if (next) {
    html += '<div class="doc-nav-link next" onclick="openDoc(\'' + esc(next.docId) + '\')">';
    html += '<div class="nav-label">Next &rarr;</div>';
    html += '<div class="nav-title">' + esc(next.title) + '</div></div>';
  }
  html += '</div>';
  return html;
}

/* ── Comments ── */
async function loadComments(id) {
  try {
    var res = await fetch('/api/docs/' + encodeURIComponent(id) + '/comments');
    var comments = await res.json();
    var cc = document.getElementById('cc');
    var list = document.getElementById('c-list');
    if (cc) cc.textContent = comments.length > 0 ? '(' + comments.length + ')' : '';
    if (!list) return;
    if (comments.length === 0) {
      list.innerHTML = '<div style="font-size:0.75rem;color:var(--dim);text-align:center;padding:0.5rem">No comments yet</div>';
      return;
    }
    list.innerHTML = comments.map(function(c) {
      return '<div class="comment"><div class="comment-header"><span class="comment-author">' + esc(c.author) + '</span><span class="comment-time">' + timeAgo(c.createdAt) + '</span></div><div class="comment-body">' + esc(c.text) + '</div></div>';
    }).join('');
  } catch(e) { }
}

async function postComment() {
  if (!currentDocId) return;
  var author = document.getElementById('c-author').value.trim();
  var text = document.getElementById('c-text').value.trim();
  if (!author) { toast('Enter your name', 'error'); return; }
  if (!text) { toast('Enter a comment', 'error'); return; }
  try {
    var res = await fetch('/api/docs/' + encodeURIComponent(currentDocId) + '/comments', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ author: author, text: text })
    });
    if (!res.ok) { var e = await res.json(); throw new Error(e.error); }
    localStorage.setItem('holm-author', author);
    document.getElementById('c-text').value = '';
    toast('Comment posted');
    loadComments(currentDocId);
  } catch(e) { toast(e.message, 'error'); }
}

/* ── Search ── */
var searchTimer = null;

function openSearch() {
  document.getElementById('search-overlay').classList.add('open');
  var input = document.getElementById('search-input');
  input.value = '';
  input.focus();
  document.getElementById('search-results').innerHTML = '<div class="search-empty">Type to search across all documents</div>';
}

function closeSearch() {
  document.getElementById('search-overlay').classList.remove('open');
}

document.getElementById('search-input').addEventListener('input', function(e) {
  clearTimeout(searchTimer);
  var q = e.target.value.trim();
  if (!q) {
    document.getElementById('search-results').innerHTML = '<div class="search-empty">Type to search</div>';
    return;
  }
  searchTimer = setTimeout(function() { doSearch(q); }, 250);
});

function highlightMatch(text, query) {
  if (!text || !query) return esc(text);
  var escaped = esc(text);
  var terms = query.trim().split(/\s+/).filter(function(t) { return t.length > 0; });
  if (terms.length === 0) return escaped;
  var pattern = terms.map(function(t) {
    return t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }).join('|');
  var re = new RegExp('(' + pattern + ')', 'gi');
  return escaped.replace(re, '<mark>$1</mark>');
}

function domainBadgeColor(domain) {
  var colors = {
    '1':'#00f0ff','2':'#ff00aa','3':'#f44','4':'#ff8800','5':'#00ff88',
    '6':'#8888ff','7':'#ffcc00','8':'#00ccff','9':'#ff6688','10':'#88ff00',
    '11':'#cc88ff','12':'#ff4444','13':'#00ffcc','14':'#ff88cc','15':'#88ccff',
    '16':'#ffaa44','17':'#44ffaa','18':'#aa88ff','19':'#ff6644','20':'#44aaff',
    'META':'#888','FW':'#aaa','HIC':'#ccc','PROJ':'#00ff88','LOG':'#ffcc00'
  };
  return colors[domain] || 'var(--muted)';
}

async function doSearch(q) {
  var el = document.getElementById('search-results');
  try {
    var res = await fetch('/api/search?q=' + encodeURIComponent(q));
    var results = await res.json();
    if (results.length === 0) { el.innerHTML = '<div class="search-empty">No results</div>'; return; }
    el.innerHTML = results.map(function(r) {
      var badgeColor = domainBadgeColor(r.domain);
      var domainLabel = DOMAIN_NAMES[r.domain] || r.domainName || r.domain;
      var snippetHtml = highlightMatch((r.snippet || '').replace(/<[^>]*>/g, ''), q);
      return '<div class="search-result" onclick="closeSearch();openDoc(\'' + esc(r.docId) + '\')">'+
        '<div class="sr-header">'+
          '<span class="sr-domain-badge" style="color:' + badgeColor + ';border-color:' + badgeColor + '">' + esc(domainLabel) + '</span>'+
          '<span class="sr-id">' + esc(r.docId) + '</span>'+
        '</div>'+
        '<div class="sr-title">' + highlightMatch(r.title, q) + '</div>'+
        '<div class="sr-snippet">' + snippetHtml + '</div></div>';
    }).join('');
  } catch(e) { el.innerHTML = '<div class="search-empty">Search failed</div>'; }
}

/* ── Domain Section Controls ── */
function toggleDomainSection(el) {
  el.classList.toggle('collapsed');
}

function expandAllDomains() {
  var sections = document.querySelectorAll('#domain-list .domain-section');
  sections.forEach(function(s) { s.classList.remove('collapsed'); });
}

function collapseAllDomains() {
  var sections = document.querySelectorAll('#domain-list .domain-section');
  sections.forEach(function(s) { s.classList.add('collapsed'); });
}

function filterDomains(q) {
  var sections = document.querySelectorAll('#domain-list .domain-section');
  var term = (q || '').toLowerCase().trim();
  var countEl = document.getElementById('filter-count');
  if (!term) {
    sections.forEach(function(s) {
      s.style.display = '';
      s.classList.add('collapsed');
      var links = s.querySelectorAll('.doc-link');
      links.forEach(function(l) { l.style.display = ''; });
    });
    if (countEl) countEl.textContent = '';
    return;
  }
  var matchedDocs = 0;
  var matchedDomains = 0;
  sections.forEach(function(s) {
    var domainName = s.getAttribute('data-name') || '';
    var domainMatch = domainName.indexOf(term) !== -1;
    var links = s.querySelectorAll('.doc-link');
    var visibleCount = 0;
    links.forEach(function(l) {
      var id = l.getAttribute('data-id') || '';
      var title = l.getAttribute('data-title') || '';
      if (domainMatch || id.indexOf(term) !== -1 || title.indexOf(term) !== -1) {
        l.style.display = '';
        visibleCount++;
      } else {
        l.style.display = 'none';
      }
    });
    if (visibleCount > 0) {
      s.style.display = '';
      s.classList.remove('collapsed');
      matchedDocs += visibleCount;
      matchedDomains++;
    } else {
      s.style.display = 'none';
    }
  });
  if (countEl) countEl.textContent = matchedDocs + ' docs in ' + matchedDomains + ' domains';
}

/* ── Keyboard Shortcuts ── */
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    if (document.getElementById('search-overlay').classList.contains('open')) closeSearch();
    else goBack();
    return;
  }
  var tag = (e.target.tagName || '').toLowerCase();
  if (tag === 'input' || tag === 'textarea') return;
  if (e.key === '/' && !e.ctrlKey && !e.metaKey) { e.preventDefault(); openSearch(); }
});

/* ── Offline ── */
window.addEventListener('online', function() {
  document.body.classList.remove('offline');
  toast('Back online');
});
window.addEventListener('offline', function() {
  document.body.classList.add('offline');
  toast('You are offline — cached documents still available', 'error');
});
if (!navigator.onLine) { document.body.classList.add('offline'); }

/* ── Service Worker ── */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(function() {});
}

async function openRandom() {
  try {
    var res = await fetch('/api/random');
    if (!res.ok) throw new Error();
    var doc = await res.json();
    if (doc && doc.docId) openDoc(doc.docId);
  } catch(e) {
    // Fallback: pick random from allDocs
    if (allDocs.length > 0) {
      var idx = Math.floor(Math.random() * allDocs.length);
      openDoc(allDocs[idx].docId);
    }
  }
}

/* ── Init ── */
async function init() {
  try {
    var res = await fetch('/api/docs');
    if (!res.ok) throw new Error();
    allDocs = await res.json();
    docsById = {};
    allDocs.forEach(function(d) { docsById[d.docId] = d; });
    document.getElementById('doc-count').textContent = allDocs.length + ' docs';
    // Cache doc index for offline use
    try { sessionStorage.setItem('holm-doc-index', JSON.stringify(allDocs)); } catch(e) {}

    var h = location.hash.slice(1);
    if (h === 'graph') { renderGraph(); }
    else if (h.startsWith('d/')) { openDomain(h.slice(2)); }
    else if (h && docsById[h]) { currentDocId = h; renderDoc(h); }
    else renderHome();
  } catch(e) {
    // Offline fallback: try to restore from sessionStorage
    try {
      var cached = sessionStorage.getItem('holm-doc-index');
      if (cached) {
        allDocs = JSON.parse(cached);
        docsById = {};
        allDocs.forEach(function(d) { docsById[d.docId] = d; });
        document.getElementById('doc-count').textContent = allDocs.length + ' docs (cached)';
        toast('Loaded cached index');
        var h = location.hash.slice(1);
        if (h === 'graph') { renderGraph(); }
        else if (h.startsWith('d/')) { openDomain(h.slice(2)); }
        else if (h && docsById[h]) { currentDocId = h; renderDoc(h); }
        else renderHome();
        return;
      }
    } catch(e2) {}
    document.getElementById('loading').textContent = 'Failed to load — retrying...';
    setTimeout(init, 3000);
  }
}


/* ── Back to Top ── */
var backTop = document.getElementById('back-top');
window.addEventListener('scroll', function() {
  backTop.classList.toggle('show', window.scrollY > 400);
});


/* ── Reading Progress ── */
var progressBar = document.getElementById('progress-bar');
window.addEventListener('scroll', function() {
  if (currentDocId) {
    var h = document.documentElement.scrollHeight - window.innerHeight;
    var pct = h > 0 ? Math.min(100, (window.scrollY / h) * 100) : 0;
    progressBar.style.width = pct + '%';
    progressBar.classList.add('visible');
  } else {
    progressBar.classList.remove('visible');
    progressBar.style.width = '0%';
  }
});

init();
</script>
</body>
</html>
