<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#0a0a0f">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>holm.chat</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" type="image/svg+xml" href="/icons/icon-192.svg">
<link rel="apple-touch-icon" href="/icons/icon-192.svg">
<meta name="apple-mobile-web-app-title" content="holm.chat">
<meta name="format-detection" content="telephone=no">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════════════════════════
   CSS Variables & Reset
   ═══════════════════════════════════════════════════════════════ */
:root {
  --bg-primary: #0a0a0f;
  --bg-secondary: #12121a;
  --bg-surface: #1a1a2e;
  --bg-surface-hover: #22223a;
  --neon-cyan: #00f0ff;
  --neon-magenta: #ff00aa;
  --neon-blue: #4444ff;
  --neon-cyan-dim: rgba(0, 240, 255, 0.15);
  --neon-magenta-dim: rgba(255, 0, 170, 0.15);
  --text-primary: #e0e0e8;
  --text-muted: #6a6a7a;
  --text-dim: #444455;
  --border: #2a2a3a;
  --border-glow: rgba(0, 240, 255, 0.2);
  --radius: 8px;
  --radius-lg: 12px;
  --nav-height: 56px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --font: 'JetBrains Mono', 'Fira Code', 'SF Mono', 'Cascadia Code', monospace;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html {
  font-size: 14px;
  -webkit-text-size-adjust: 100%;
  scroll-behavior: smooth;
}

body {
  font-family: var(--font);
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  min-height: 100dvh;
  overflow-x: hidden;
  overscroll-behavior: none;
  -webkit-font-smoothing: antialiased;
}

a { color: var(--neon-cyan); text-decoration: none; }
a:hover { text-decoration: underline; }
button { font-family: var(--font); cursor: pointer; border: none; background: none; color: var(--text-primary); }
.domain-card, .doc-card, .search-result-card, .connection-chip, .comment-form button, .back-btn {
  -webkit-tap-highlight-color: transparent;
}
input, textarea { font-family: var(--font); }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* Safari-specific fixes */
@supports (-webkit-touch-callout: none) {
  body { min-height: -webkit-fill-available; }
  html { height: -webkit-fill-available; }
}

/* ═══════════════════════════════════════════════════════════════
   Loading Screen
   ═══════════════════════════════════════════════════════════════ */
#loading-screen {
  position: fixed; inset: 0; z-index: 9999;
  background: var(--bg-primary);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  transition: opacity 0.5s ease, visibility 0.5s ease;
}
#loading-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

.loading-logo {
  font-size: 2rem; font-weight: 700; letter-spacing: 0.1em;
  color: var(--neon-cyan);
  text-shadow: 0 0 20px rgba(0, 240, 255, 0.5), 0 0 40px rgba(0, 240, 255, 0.2);
  margin-bottom: 2rem;
  animation: glitch 2.5s infinite;
}

.loading-bar-track {
  width: min(280px, 70vw); height: 3px;
  background: var(--border);
  border-radius: 2px; overflow: hidden;
}
.loading-bar-fill {
  height: 100%; width: 0%;
  background: linear-gradient(90deg, var(--neon-cyan), var(--neon-magenta));
  border-radius: 2px;
  transition: width 0.3s ease;
}

.loading-status {
  margin-top: 1rem; font-size: 0.75rem;
  color: var(--text-muted); letter-spacing: 0.05em;
}

@keyframes glitch {
  0%, 90%, 100% { opacity: 1; transform: translate(0); }
  92% { opacity: 0.8; transform: translate(-2px, 1px); color: var(--neon-magenta); }
  94% { opacity: 1; transform: translate(1px, -1px); color: var(--neon-cyan); }
  96% { opacity: 0.9; transform: translate(-1px, 0); }
}

/* ═══════════════════════════════════════════════════════════════
   Top Nav (desktop)
   ═══════════════════════════════════════════════════════════════ */
#top-nav {
  display: none; /* shown on desktop via media query */
  position: fixed; top: 0; left: 0; right: 0; z-index: 100;
  height: var(--nav-height);
  background: rgba(10, 10, 15, 0.9);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  padding: 0 1.5rem;
  align-items: center; justify-content: space-between;
}

.top-nav-logo {
  font-size: 1rem; font-weight: 600;
  color: var(--neon-cyan);
  letter-spacing: 0.08em;
  cursor: pointer;
}
.top-nav-logo:hover { text-shadow: 0 0 10px rgba(0, 240, 255, 0.4); }

.top-nav-links { display: flex; gap: 1.5rem; align-items: center; }
.top-nav-links button {
  font-size: 0.8rem; color: var(--text-muted);
  padding: 0.4rem 0; letter-spacing: 0.04em;
  border-bottom: 2px solid transparent;
  transition: color 0.2s, border-color 0.2s;
}
.top-nav-links button:hover { color: var(--text-primary); }
.top-nav-links button.active { color: var(--neon-cyan); border-bottom-color: var(--neon-cyan); }

/* ═══════════════════════════════════════════════════════════════
   Bottom Nav (mobile)
   ═══════════════════════════════════════════════════════════════ */
#bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
  height: calc(var(--nav-height) + var(--safe-bottom));
  padding-bottom: var(--safe-bottom);
  background: rgba(10, 10, 15, 0.95);
  backdrop-filter: blur(12px);
  border-top: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-around;
}

.bottom-nav-btn {
  display: flex; flex-direction: column; align-items: center; gap: 2px;
  padding: 10px 16px; font-size: 0.65rem;
  -webkit-tap-highlight-color: transparent;
  color: var(--text-muted); letter-spacing: 0.05em;
  transition: color 0.2s;
}
.bottom-nav-btn svg { width: 22px; height: 22px; stroke: currentColor; fill: none; stroke-width: 1.5; }
.bottom-nav-btn.active { color: var(--neon-cyan); }

/* ═══════════════════════════════════════════════════════════════
   Main Content Area
   ═══════════════════════════════════════════════════════════════ */
#app {
  padding-bottom: calc(var(--nav-height) + var(--safe-bottom) + 8px);
  min-height: 100dvh;
  -webkit-overflow-scrolling: touch;
}

.view { display: none; }
.view.active { display: block; }

/* ═══════════════════════════════════════════════════════════════
   Hub View
   ═══════════════════════════════════════════════════════════════ */
#hub-view { padding: 1rem; }

.hub-header {
  text-align: center; padding: 2rem 0 1.5rem;
}
.hub-title {
  font-size: 1.4rem; font-weight: 300; color: var(--text-primary);
  letter-spacing: 0.15em;
}
.hub-title span { color: var(--neon-cyan); font-weight: 600; }

.hub-stats {
  display: flex; justify-content: center; gap: 1.5rem;
  margin-bottom: 1.5rem; flex-wrap: wrap;
}
.hub-stat {
  text-align: center;
}
.hub-stat-value {
  font-size: 1.5rem; font-weight: 600; color: var(--neon-cyan);
}
.hub-stat-label {
  font-size: 0.65rem; color: var(--text-muted); letter-spacing: 0.08em; text-transform: uppercase;
}

.domain-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 0.75rem;
}

.domain-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 1rem;
  cursor: pointer;
  transition: transform 0.15s, border-color 0.2s, box-shadow 0.2s;
  position: relative;
  overflow: hidden;
}
.domain-card::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: var(--card-accent, var(--neon-cyan));
  box-shadow: 0 0 8px var(--card-accent, var(--neon-cyan));
}
.domain-card:hover {
  transform: translateY(-2px);
  border-color: var(--card-accent, var(--neon-cyan));
  box-shadow: 0 4px 20px rgba(0, 240, 255, 0.1);
}
.domain-card:active { transform: translateY(0); }

.domain-card-id {
  font-size: 0.65rem; color: var(--text-muted);
  letter-spacing: 0.1em; margin-bottom: 0.3rem;
}
.domain-card-name {
  font-size: 0.85rem; font-weight: 500; color: var(--text-primary);
  margin-bottom: 0.6rem; line-height: 1.3;
}
.domain-card-meta {
  display: flex; justify-content: space-between; align-items: center;
}
.domain-card-count {
  font-size: 0.7rem; color: var(--text-muted);
}

/* Health bar */
.health-bar {
  width: 48px; height: 4px;
  background: var(--border); border-radius: 2px;
  overflow: hidden;
}
.health-bar-fill {
  height: 100%; border-radius: 2px;
  transition: width 0.5s ease;
}

/* ═══════════════════════════════════════════════════════════════
   Domain View (doc list)
   ═══════════════════════════════════════════════════════════════ */
#domain-view { padding: 1rem; }

.domain-header {
  display: flex; align-items: center; gap: 0.75rem;
  margin-bottom: 1rem; padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--border);
}
.back-btn {
  width: 36px; height: 36px;
  display: flex; align-items: center; justify-content: center;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  color: var(--text-muted);
  transition: color 0.2s, border-color 0.2s;
  flex-shrink: 0;
}
.back-btn:hover { color: var(--neon-cyan); border-color: var(--neon-cyan); }
.back-btn svg { width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2; }

.domain-title { font-size: 1.1rem; font-weight: 500; flex: 1; }
.domain-health-summary {
  font-size: 0.7rem; color: var(--text-muted); margin-top: 0.2rem;
}

.doc-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 0.5rem;
}

.doc-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 0.75rem 1rem;
  cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
  display: flex; align-items: center; gap: 0.75rem;
}
.doc-card:hover {
  border-color: var(--neon-cyan);
  background: var(--bg-surface);
}

.doc-card-id {
  font-size: 0.65rem; color: var(--neon-cyan);
  letter-spacing: 0.05em; white-space: nowrap;
  min-width: 60px;
}
.doc-card-title {
  font-size: 0.8rem; flex: 1;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.doc-card-indicators {
  display: flex; gap: 4px; flex-shrink: 0;
}
.indicator {
  width: 8px; height: 8px; border-radius: 50%;
  flex-shrink: 0;
}
.indicator.broken { background: #ff4444; box-shadow: 0 0 4px #ff4444; }
.indicator.orphan { background: #ffaa00; box-shadow: 0 0 4px #ffaa00; }
.indicator.ok { background: #00cc66; box-shadow: 0 0 4px #00cc66; }

/* ═══════════════════════════════════════════════════════════════
   Document View
   ═══════════════════════════════════════════════════════════════ */
#doc-view { padding: 1rem; }

.doc-nav {
  display: flex; align-items: center; gap: 0.5rem;
  margin-bottom: 1rem; flex-wrap: wrap;
}
.doc-breadcrumb {
  font-size: 0.7rem; color: var(--text-muted);
}
.doc-breadcrumb a { color: var(--neon-cyan); }

.doc-title-bar {
  margin-bottom: 1rem;
}
.doc-title {
  font-size: 1.3rem; font-weight: 600;
  line-height: 1.3; margin-bottom: 0.5rem;
}
.doc-meta-pills {
  display: flex; flex-wrap: wrap; gap: 0.4rem;
}
.pill {
  display: inline-flex; align-items: center;
  padding: 0.15rem 0.5rem;
  font-size: 0.65rem; letter-spacing: 0.03em;
  border-radius: 20px;
  border: 1px solid var(--border);
  color: var(--text-muted);
}
.pill.domain { border-color: var(--neon-cyan); color: var(--neon-cyan); }
.pill.status { border-color: var(--neon-magenta); color: var(--neon-magenta); }

/* Connections */
.doc-connections {
  margin: 1rem 0; padding: 0.75rem;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
}
.connections-title {
  font-size: 0.7rem; color: var(--text-muted);
  letter-spacing: 0.1em; text-transform: uppercase;
  margin-bottom: 0.5rem;
}
.connection-list {
  display: flex; flex-wrap: wrap; gap: 0.4rem;
}
.connection-chip {
  display: inline-flex; align-items: center;
  padding: 0.2rem 0.6rem; font-size: 0.7rem;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 4px; cursor: pointer;
  color: var(--neon-cyan);
  transition: border-color 0.2s, background 0.2s;
}
.connection-chip:hover { border-color: var(--neon-cyan); background: var(--bg-surface-hover); }
.connection-chip.broken {
  color: #ff4444;
  border-color: rgba(255, 68, 68, 0.3);
  text-decoration: line-through;
  cursor: default;
}

/* Document Body */
.doc-body {
  max-width: 720px;
  line-height: 1.7; font-size: 0.85rem;
  word-break: break-word;
  -webkit-hyphens: auto;
  hyphens: auto;
  padding: 1rem 0;
}
.doc-body h1 { font-size: 1.3rem; font-weight: 600; margin: 1.5rem 0 0.75rem; color: var(--neon-cyan); }
.doc-body h2 { font-size: 1.1rem; font-weight: 600; margin: 1.3rem 0 0.6rem; color: var(--text-primary); }
.doc-body h3 { font-size: 0.95rem; font-weight: 600; margin: 1rem 0 0.5rem; color: var(--text-primary); }
.doc-body h4 { font-size: 0.85rem; font-weight: 600; margin: 0.8rem 0 0.4rem; color: var(--text-muted); }
.doc-body p { margin-bottom: 0.75rem; }
.doc-body ul, .doc-body ol { margin-bottom: 0.75rem; padding-left: 1.5rem; }
.doc-body li { margin-bottom: 0.3rem; }
.doc-body code {
  background: var(--bg-surface); padding: 0.1rem 0.35rem;
  border-radius: 3px; font-size: 0.8rem; color: var(--neon-magenta);
}
.doc-body pre {
  background: var(--bg-secondary); padding: 1rem;
  border-radius: var(--radius); border: 1px solid var(--border);
  overflow-x: auto; margin-bottom: 0.75rem;
}
.doc-body pre code { background: none; padding: 0; color: var(--text-primary); }
.doc-body blockquote {
  border-left: 3px solid var(--neon-cyan);
  padding: 0.5rem 0 0.5rem 1rem;
  margin-bottom: 0.75rem; color: var(--text-muted);
  background: var(--neon-cyan-dim);
  border-radius: 0 var(--radius) var(--radius) 0;
}
.doc-body table { width: 100%; border-collapse: collapse; margin-bottom: 0.75rem; font-size: 0.8rem; }
.doc-body th, .doc-body td { padding: 0.4rem 0.6rem; border: 1px solid var(--border); text-align: left; }
.doc-body th { background: var(--bg-surface); color: var(--neon-cyan); font-weight: 500; }
.doc-body dl { margin-bottom: 0.75rem; }
.doc-body dt { font-weight: 600; color: var(--neon-cyan); margin-top: 0.5rem; }
.doc-body dd { margin-left: 1rem; margin-bottom: 0.3rem; color: var(--text-muted); }
.doc-body mark { background: var(--neon-cyan-dim); color: var(--neon-cyan); padding: 0 0.2rem; border-radius: 2px; }
.doc-body hr { border: none; border-top: 1px solid var(--border); margin: 1.5rem 0; }
.doc-body a { color: var(--neon-cyan); }
.doc-body img { max-width: 100%; border-radius: var(--radius); }

/* ═══════════════════════════════════════════════════════════════
   Comments Section
   ═══════════════════════════════════════════════════════════════ */
.comments-section {
  margin-top: 2rem; padding-top: 1.5rem;
  border-top: 1px solid var(--border);
}
.comments-header {
  font-size: 0.8rem; color: var(--text-muted);
  letter-spacing: 0.08em; text-transform: uppercase;
  margin-bottom: 1rem;
}
.comments-header span { color: var(--neon-magenta); }

.comment-form {
  display: flex; flex-direction: column; gap: 0.5rem;
  margin-bottom: 1.5rem;
}
.comment-form input, .comment-form textarea {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 0.6rem 0.75rem;
  color: var(--text-primary);
  font-size: 0.8rem;
  outline: none;
  transition: border-color 0.2s;
}
.comment-form input:focus, .comment-form textarea:focus {
  border-color: var(--neon-magenta);
}
.comment-form textarea { resize: vertical; min-height: 60px; }
.comment-form button {
  align-self: flex-end;
  padding: 0.5rem 1.2rem;
  background: var(--neon-magenta-dim);
  border: 1px solid var(--neon-magenta);
  border-radius: var(--radius);
  color: var(--neon-magenta);
  font-size: 0.75rem; font-weight: 500;
  letter-spacing: 0.05em;
  transition: background 0.2s, box-shadow 0.2s;
}
.comment-form button:hover {
  background: rgba(255, 0, 170, 0.25);
  box-shadow: 0 0 12px rgba(255, 0, 170, 0.2);
}

.comment-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-left: 3px solid var(--neon-magenta);
  border-radius: var(--radius);
  padding: 0.75rem;
  margin-bottom: 0.5rem;
}
.comment-meta {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 0.3rem;
}
.comment-author {
  font-size: 0.75rem; font-weight: 500;
  color: var(--neon-magenta);
}
.comment-date {
  font-size: 0.65rem; color: var(--text-dim);
}
.comment-text {
  font-size: 0.8rem; color: var(--text-primary);
  line-height: 1.5;
}
.no-comments {
  font-size: 0.75rem; color: var(--text-dim);
  text-align: center; padding: 1rem;
}

/* ═══════════════════════════════════════════════════════════════
   Graph View
   ═══════════════════════════════════════════════════════════════ */
#graph-view {
  position: fixed; inset: 0; z-index: 50;
  background: var(--bg-primary);
}
.graph-header {
  position: absolute; top: 0; left: 0; right: 0;
  display: flex; align-items: center; gap: 0.75rem;
  padding: 0.75rem 1rem;
  background: rgba(10, 10, 15, 0.85);
  backdrop-filter: blur(8px);
  z-index: 2;
}
.graph-header h2 {
  font-size: 0.9rem; font-weight: 500; flex: 1;
  color: var(--neon-cyan);
}
.graph-stats {
  font-size: 0.65rem; color: var(--text-muted);
}

#graph-canvas { width: 100%; height: 100%; display: block; }

.graph-tooltip {
  position: fixed; z-index: 60;
  background: var(--bg-surface);
  border: 1px solid var(--neon-cyan);
  border-radius: var(--radius);
  padding: 0.5rem 0.75rem;
  font-size: 0.7rem;
  pointer-events: none;
  display: none;
  max-width: 220px;
  box-shadow: 0 0 15px rgba(0, 240, 255, 0.15);
}
.graph-tooltip .tt-id { color: var(--neon-cyan); font-weight: 600; }
.graph-tooltip .tt-title { color: var(--text-primary); margin-top: 2px; }
.graph-tooltip .tt-domain { color: var(--text-muted); font-size: 0.65rem; margin-top: 2px; }

.graph-legend {
  position: absolute; bottom: 70px; left: 0.75rem; z-index: 2;
  background: rgba(10, 10, 15, 0.85);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 0.5rem;
  max-height: 200px; overflow-y: auto;
  font-size: 0.6rem;
  backdrop-filter: blur(8px);
}
.graph-legend-item {
  display: flex; align-items: center; gap: 6px;
  padding: 2px 0; color: var(--text-muted);
}
.graph-legend-dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
}

/* ═══════════════════════════════════════════════════════════════
   Search View
   ═══════════════════════════════════════════════════════════════ */
#search-view {
  position: fixed; inset: 0; z-index: 50;
  background: var(--bg-primary);
  display: flex; flex-direction: column;
}
.search-header {
  padding: 0.75rem 1rem;
  display: flex; align-items: center; gap: 0.75rem;
  border-bottom: 1px solid var(--border);
}
.search-input-wrap {
  flex: 1; position: relative;
}
.search-input-wrap input {
  width: 100%; padding: 0.6rem 0.75rem;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-primary);
  font-size: 0.9rem;
  outline: none;
  transition: border-color 0.2s;
}
.search-input-wrap input:focus { border-color: var(--neon-cyan); }
.search-input-wrap input::placeholder { color: var(--text-dim); }

.search-results {
  flex: 1; overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 0.75rem 1rem;
}

.search-result-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 0.75rem;
  margin-bottom: 0.5rem;
  cursor: pointer;
  transition: border-color 0.2s;
}
.search-result-card:hover { border-color: var(--neon-cyan); }
.search-result-id { font-size: 0.65rem; color: var(--neon-cyan); letter-spacing: 0.05em; }
.search-result-title { font-size: 0.85rem; font-weight: 500; margin: 0.2rem 0; }
.search-result-snippet {
  font-size: 0.75rem; color: var(--text-muted); line-height: 1.4;
}
.search-result-snippet mark {
  background: var(--neon-cyan-dim); color: var(--neon-cyan);
  padding: 0 0.15rem; border-radius: 2px;
}
.search-empty {
  text-align: center; padding: 3rem 1rem;
  color: var(--text-dim); font-size: 0.8rem;
}

/* ═══════════════════════════════════════════════════════════════
   Toast
   ═══════════════════════════════════════════════════════════════ */
#toast-container {
  position: fixed; bottom: calc(var(--nav-height) + var(--safe-bottom) + 12px);
  left: 50%; transform: translateX(-50%);
  z-index: 200; display: flex; flex-direction: column; gap: 0.5rem;
  pointer-events: none;
}
.toast {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 0.6rem 1rem;
  font-size: 0.75rem;
  color: var(--text-primary);
  pointer-events: auto;
  animation: toast-in 0.3s ease;
  white-space: nowrap;
}
.toast.error { border-color: #ff4444; color: #ff4444; }
.toast.fade-out { animation: toast-out 0.3s ease forwards; }
@keyframes toast-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes toast-out { from { opacity: 1; } to { opacity: 0; transform: translateY(-10px); } }

/* ═══════════════════════════════════════════════════════════════
   Offline Banner
   ═══════════════════════════════════════════════════════════════ */
#offline-banner {
  display: none;
  position: fixed; top: 0; left: 0; right: 0;
  background: var(--neon-magenta-dim);
  border-bottom: 1px solid var(--neon-magenta);
  text-align: center; padding: 0.4rem;
  font-size: 0.7rem; color: var(--neon-magenta);
  z-index: 300;
}
body.offline #offline-banner { display: block; }

/* ═══════════════════════════════════════════════════════════════
   Desktop Media Queries
   ═══════════════════════════════════════════════════════════════ */
@media (min-width: 768px) {
  html { font-size: 15px; }
  #top-nav { display: flex; }
  #bottom-nav { display: none; }
  #app { padding-top: var(--nav-height); padding-bottom: 1rem; }
  #hub-view, #domain-view, #doc-view { max-width: 960px; margin: 0 auto; }
  .domain-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
  .doc-grid { grid-template-columns: 1fr 1fr; gap: 0.75rem; }
  .doc-body { font-size: 0.9rem; }
  .graph-legend { bottom: 1rem; }
  #graph-view { top: var(--nav-height); }
  #search-view { top: var(--nav-height); }
}

@media (min-width: 1024px) {
  .domain-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
  .doc-grid { grid-template-columns: 1fr 1fr 1fr; }
}

/* ═══════════════════════════════════════════════════════════════
   Print
   ═══════════════════════════════════════════════════════════════ */
@media print {
  #top-nav, #bottom-nav, #toast-container, .doc-connections, .comments-section { display: none !important; }
  body { background: white; color: black; }
  .doc-body { max-width: none; }
}
</style>
</head>
<body>

<!-- Offline Banner -->
<div id="offline-banner">You are offline — showing cached data</div>

<!-- Loading Screen -->
<div id="loading-screen">
  <div class="loading-logo">holm.chat</div>
  <div class="loading-bar-track">
    <div class="loading-bar-fill" id="loading-bar"></div>
  </div>
  <div class="loading-status" id="loading-status">initializing...</div>
</div>

<!-- Top Nav (desktop) -->
<nav id="top-nav">
  <div class="top-nav-logo" onclick="showHub()">holm.chat</div>
  <div class="top-nav-links">
    <button onclick="showHub()" data-nav="hub">Nexus</button>
    <button onclick="openSearch()" data-nav="search">Search</button>
    <button onclick="showGraph()" data-nav="graph">Map</button>
  </div>
</nav>

<!-- Main App -->
<main id="app">
  <!-- Hub View -->
  <div id="hub-view" class="view active">
    <div class="hub-header">
      <h1 class="hub-title"><span>holm</span>.chat</h1>
    </div>
    <div class="hub-stats" id="hub-stats"></div>
    <div class="domain-grid" id="domain-grid"></div>
  </div>

  <!-- Domain View -->
  <div id="domain-view" class="view">
    <div class="domain-header">
      <button class="back-btn" onclick="navigateBack()">
        <svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div>
        <div class="domain-title" id="domain-title"></div>
        <div class="domain-health-summary" id="domain-health-summary"></div>
      </div>
    </div>
    <div class="doc-grid" id="doc-grid"></div>
  </div>

  <!-- Document View -->
  <div id="doc-view" class="view">
    <div class="doc-nav">
      <button class="back-btn" onclick="navigateBack()">
        <svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div class="doc-breadcrumb" id="doc-breadcrumb"></div>
    </div>
    <div class="doc-title-bar">
      <h1 class="doc-title" id="doc-title"></h1>
      <div class="doc-meta-pills" id="doc-meta-pills"></div>
    </div>
    <div class="doc-connections" id="doc-connections"></div>
    <div class="doc-body" id="doc-body"></div>
    <div class="comments-section" id="comments-section">
      <div class="comments-header">Comments <span id="comment-count"></span></div>
      <div class="comment-form">
        <input type="text" id="comment-author" placeholder="Your name" maxlength="50">
        <textarea id="comment-text" placeholder="Write a comment..." maxlength="2000"></textarea>
        <button onclick="submitComment()">Post Comment</button>
      </div>
      <div id="comments-list"></div>
    </div>
  </div>
</main>

<!-- Graph View -->
<div id="graph-view" class="view">
  <div class="graph-header">
    <button class="back-btn" onclick="closeOverlay()">
      <svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <h2>Network Map</h2>
    <div class="graph-stats" id="graph-stats"></div>
  </div>
  <canvas id="graph-canvas"></canvas>
  <div class="graph-tooltip" id="graph-tooltip">
    <div class="tt-id"></div>
    <div class="tt-title"></div>
    <div class="tt-domain"></div>
  </div>
  <div class="graph-legend" id="graph-legend"></div>
</div>

<!-- Search View -->
<div id="search-view" class="view">
  <div class="search-header">
    <button class="back-btn" onclick="closeOverlay()">
      <svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <div class="search-input-wrap">
      <input type="text" id="search-input" placeholder="Search documents..." autocomplete="off">
    </div>
  </div>
  <div class="search-results" id="search-results">
    <div class="search-empty">Type to search across all documents</div>
  </div>
</div>

<!-- Bottom Nav (mobile) -->
<nav id="bottom-nav">
  <button class="bottom-nav-btn active" onclick="showHub()" data-nav="hub">
    <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <span>Nexus</span>
  </button>
  <button class="bottom-nav-btn" onclick="openSearch()" data-nav="search">
    <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <span>Search</span>
  </button>
  <button class="bottom-nav-btn" onclick="showGraph()" data-nav="graph">
    <svg viewBox="0 0 24 24"><circle cx="12" cy="5" r="3"/><circle cx="5" cy="19" r="3"/><circle cx="19" cy="19" r="3"/><path d="M12 8v4M7.5 17.2L10 13M16.5 17.2L14 13" stroke-linecap="round"/></svg>
    <span>Map</span>
  </button>
</nav>

<!-- Toast Container -->
<div id="toast-container"></div>

<script>
/* ═══════════════════════════════════════════════════════════════
   State
   ═══════════════════════════════════════════════════════════════ */
let allDocs = [];
let docsById = {};
let currentDoc = null;
let currentDomain = null;
let currentView = 'hub';
let domainHealth = {};
let navHistory = [];
let graphData = null;
let graphSim = null;

/* ═══════════════════════════════════════════════════════════════
   Domain Config
   ═══════════════════════════════════════════════════════════════ */
const DOMAIN_NAMES = {
  '1': 'Constitution & Philosophy', '2': 'Governance & Authority',
  '3': 'Security & Integrity', '4': 'Infrastructure & Power',
  '5': 'Platform & Core Systems', '6': 'Data & Archives',
  '7': 'Intelligence & Analysis', '8': 'Automation & Agents',
  '9': 'Education & Training', '10': 'User Operations',
  '11': 'Administration', '12': 'Disaster Recovery',
  '13': 'Evolution & Adaptation', '14': 'Research & Theory',
  '15': 'Ethics & Safeguards', '16': 'Federation & External',
  '17': 'Federation Protocol', '18': 'Data Pipeline',
  '19': 'Advanced Automation', '20': 'Meta & Documentation',
  'META': 'Meta & Documentation', 'FW': 'Framework', 'HIC': 'HIC Architecture'
};

const DOMAIN_COLORS = {
  '1': '#00f0ff', '2': '#ff00aa', '3': '#ff4444', '4': '#ffaa00',
  '5': '#00cc66', '6': '#4444ff', '7': '#aa44ff', '8': '#ff6600',
  '9': '#44ccff', '10': '#ff44aa', '11': '#888888', '12': '#ff0000',
  '13': '#00ff88', '14': '#8888ff', '15': '#ffcc00', '16': '#00aaff',
  '17': '#ff8844', '18': '#44ff88', '19': '#ff44ff', '20': '#aaaaaa',
  'META': '#aaaaaa', 'FW': '#66cccc', 'HIC': '#cc66cc'
};

/* ═══════════════════════════════════════════════════════════════
   Utilities
   ═══════════════════════════════════════════════════════════════ */
function escHtml(s) {
  if (!s) return '';
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function showToast(msg, type) {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = 'toast' + (type === 'error' ? ' error' : '');
  toast.textContent = msg;
  container.appendChild(toast);
  setTimeout(() => { toast.classList.add('fade-out'); setTimeout(() => toast.remove(), 300); }, 3000);
}

function timeAgo(date) {
  const s = Math.floor((Date.now() - new Date(date).getTime()) / 1000);
  if (s < 60) return 'just now';
  if (s < 3600) return Math.floor(s / 60) + 'm ago';
  if (s < 86400) return Math.floor(s / 3600) + 'h ago';
  if (s < 2592000) return Math.floor(s / 86400) + 'd ago';
  return new Date(date).toLocaleDateString();
}

function healthColor(score) {
  if (score >= 80) return '#00cc66';
  if (score >= 50) return '#ffaa00';
  return '#ff4444';
}

/* ═══════════════════════════════════════════════════════════════
   View Router
   ═══════════════════════════════════════════════════════════════ */
function switchView(name, pushHistory) {
  if (pushHistory !== false && currentView !== name) {
    navHistory.push({ view: currentView, domain: currentDomain, doc: currentDoc ? currentDoc.docId : null });
  }

  // Hide all main views
  document.querySelectorAll('#app > .view').forEach(v => v.classList.remove('active'));

  // Hide overlays
  document.getElementById('graph-view').classList.remove('active');
  document.getElementById('search-view').classList.remove('active');

  if (name === 'graph') {
    document.getElementById('graph-view').classList.add('active');
  } else if (name === 'search') {
    document.getElementById('search-view').classList.add('active');
  } else {
    const el = document.getElementById(name + '-view');
    if (el) el.classList.add('active');
  }

  currentView = name;
  updateNavActive(name);
  updateHash();
}

function updateNavActive(name) {
  document.querySelectorAll('[data-nav]').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.nav === name);
  });
}

function updateHash() {
  let hash = '';
  if (currentView === 'hub') hash = '';
  else if (currentView === 'domain' && currentDomain) hash = '#domain/' + currentDomain;
  else if (currentView === 'doc' && currentDoc) hash = '#doc/' + currentDoc.docId;
  else if (currentView === 'graph') hash = '#graph';
  else if (currentView === 'search') hash = '#search';
  if (location.hash !== hash && hash !== '') {
    history.replaceState(null, '', hash);
  } else if (hash === '' && location.hash !== '') {
    history.replaceState(null, '', location.pathname);
  }
}

function navigateBack() {
  if (navHistory.length === 0) { showHub(); return; }
  const prev = navHistory.pop();
  if (prev.view === 'doc' && prev.doc) {
    const doc = docsById[prev.doc];
    if (doc) { openDoc(doc.docId, false); return; }
  }
  if (prev.view === 'domain' && prev.domain) {
    openDomainView(prev.domain, false);
    return;
  }
  showHub(false);
}

function closeOverlay() {
  document.getElementById('graph-view').classList.remove('active');
  document.getElementById('search-view').classList.remove('active');
  // Restore previous main view
  const mainView = currentView === 'graph' || currentView === 'search' ? 'hub' : currentView;
  if (navHistory.length > 0) {
    const prev = navHistory.pop();
    if (prev.view === 'doc' && prev.doc && docsById[prev.doc]) {
      openDoc(prev.doc, false);
      return;
    }
    if (prev.view === 'domain' && prev.domain) {
      openDomainView(prev.domain, false);
      return;
    }
  }
  showHub(false);
}

/* ═══════════════════════════════════════════════════════════════
   Loading & Init
   ═══════════════════════════════════════════════════════════════ */
async function init() {
  const bar = document.getElementById('loading-bar');
  const status = document.getElementById('loading-status');

  bar.style.width = '20%';
  status.textContent = 'connecting to nexus...';

  try {
    const res = await fetch('/api/docs');
    if (!res.ok) throw new Error('Failed to fetch documents');
    bar.style.width = '60%';
    status.textContent = 'loading documents...';

    allDocs = await res.json();
    docsById = {};
    allDocs.forEach(d => { docsById[d.docId] = d; });

    bar.style.width = '80%';
    status.textContent = 'computing health...';
    computeDomainHealth();

    bar.style.width = '100%';
    status.textContent = 'ready';

    await new Promise(r => setTimeout(r, 400));
    document.getElementById('loading-screen').classList.add('hidden');

    // Check hash routing
    handleHash();
  } catch (err) {
    status.textContent = 'connection failed — retrying...';
    console.error('Init error:', err);
    setTimeout(init, 3000);
  }
}

/* ═══════════════════════════════════════════════════════════════
   Domain Health
   ═══════════════════════════════════════════════════════════════ */
function computeDomainHealth() {
  domainHealth = {};
  const docIdSet = new Set(allDocs.map(d => d.docId));

  for (const doc of allDocs) {
    const key = doc.domain || 'unknown';
    if (!domainHealth[key]) {
      domainHealth[key] = {
        name: doc.domainName || DOMAIN_NAMES[key] || key,
        total: 0, broken: 0, orphaned: 0, score: 100
      };
    }
    const dh = domainHealth[key];
    dh.total++;

    const brokenDeps = (doc.dependsOn || []).filter(d => !docIdSet.has(d));
    if (brokenDeps.length > 0) dh.broken++;

    if ((doc.dependsOn || []).length === 0 && (doc.dependedBy || []).length === 0) dh.orphaned++;
  }

  // Compute score: 100 - penalties
  for (const key in domainHealth) {
    const dh = domainHealth[key];
    if (dh.total === 0) { dh.score = 0; continue; }
    const brokenPct = (dh.broken / dh.total) * 50;
    const orphanPct = (dh.orphaned / dh.total) * 30;
    dh.score = Math.max(0, Math.round(100 - brokenPct - orphanPct));
  }
}

/* ═══════════════════════════════════════════════════════════════
   Hub View
   ═══════════════════════════════════════════════════════════════ */
function showHub(pushHistory) {
  switchView('hub', pushHistory);
  renderHub();
}

function renderHub() {
  const statsEl = document.getElementById('hub-stats');
  const gridEl = document.getElementById('domain-grid');

  const domainKeys = Object.keys(domainHealth).sort((a, b) => {
    const na = parseInt(a), nb = parseInt(b);
    if (!isNaN(na) && !isNaN(nb)) return na - nb;
    if (!isNaN(na)) return -1;
    if (!isNaN(nb)) return 1;
    return a.localeCompare(b);
  });

  const totalDocs = allDocs.length;
  const totalDomains = domainKeys.length;
  const avgHealth = totalDomains > 0
    ? Math.round(domainKeys.reduce((s, k) => s + domainHealth[k].score, 0) / totalDomains)
    : 0;

  statsEl.innerHTML = `
    <div class="hub-stat"><div class="hub-stat-value">${totalDocs}</div><div class="hub-stat-label">Documents</div></div>
    <div class="hub-stat"><div class="hub-stat-value">${totalDomains}</div><div class="hub-stat-label">Domains</div></div>
    <div class="hub-stat"><div class="hub-stat-value">${avgHealth}%</div><div class="hub-stat-label">Health</div></div>
  `;

  gridEl.innerHTML = domainKeys.map(key => {
    const dh = domainHealth[key];
    const color = DOMAIN_COLORS[key] || '#00f0ff';
    return `
      <div class="domain-card" style="--card-accent: ${color}" onclick="openDomainView('${escHtml(key)}')">
        <div class="domain-card-id">D${escHtml(key)}</div>
        <div class="domain-card-name">${escHtml(dh.name)}</div>
        <div class="domain-card-meta">
          <span class="domain-card-count">${dh.total} docs</span>
          <div class="health-bar">
            <div class="health-bar-fill" style="width:${dh.score}%; background:${healthColor(dh.score)}"></div>
          </div>
        </div>
      </div>`;
  }).join('');
}

/* ═══════════════════════════════════════════════════════════════
   Domain View
   ═══════════════════════════════════════════════════════════════ */
function openDomainView(key, pushHistory) {
  currentDomain = key;
  switchView('domain', pushHistory);
  renderDomainDocs(key);
}

function renderDomainDocs(key) {
  const dh = domainHealth[key];
  const color = DOMAIN_COLORS[key] || '#00f0ff';
  document.getElementById('domain-title').textContent = dh ? dh.name : key;
  document.getElementById('domain-health-summary').innerHTML = dh
    ? `${dh.total} docs · Health: <span style="color:${healthColor(dh.score)}">${dh.score}%</span>` +
      (dh.broken > 0 ? ` · <span style="color:#ff4444">${dh.broken} broken</span>` : '') +
      (dh.orphaned > 0 ? ` · <span style="color:#ffaa00">${dh.orphaned} orphaned</span>` : '')
    : '';

  const docs = allDocs.filter(d => d.domain === key).sort((a, b) => a.docId.localeCompare(b.docId));
  const docIdSet = new Set(allDocs.map(d => d.docId));
  const gridEl = document.getElementById('doc-grid');

  gridEl.innerHTML = docs.map(doc => {
    const hasBroken = (doc.dependsOn || []).some(d => !docIdSet.has(d));
    const isOrphan = (doc.dependsOn || []).length === 0 && (doc.dependedBy || []).length === 0;
    let indicator = '<span class="indicator ok"></span>';
    if (hasBroken) indicator = '<span class="indicator broken"></span>';
    else if (isOrphan) indicator = '<span class="indicator orphan"></span>';

    return `
      <div class="doc-card" onclick="openDoc('${escHtml(doc.docId)}')">
        <span class="doc-card-id">${escHtml(doc.docId)}</span>
        <span class="doc-card-title">${escHtml(doc.title)}</span>
        <span class="doc-card-indicators">${indicator}</span>
      </div>`;
  }).join('');
}

/* ═══════════════════════════════════════════════════════════════
   Document View
   ═══════════════════════════════════════════════════════════════ */
async function openDoc(id, pushHistory) {
  const doc = docsById[id];
  if (!doc) { showToast('Document not found: ' + id, 'error'); return; }

  // If we don't have content, fetch the full document
  if (doc.content === undefined) {
    try {
      const res = await fetch('/api/docs/' + encodeURIComponent(id));
      if (!res.ok) throw new Error('Failed to fetch');
      const full = await res.json();
      Object.assign(doc, full);
    } catch (err) {
      showToast('Failed to load document', 'error');
      return;
    }
  }

  currentDoc = doc;
  switchView('doc', pushHistory);
  renderDocView(doc);
  loadComments(doc.docId);
}

function renderDocView(doc) {
  // Breadcrumb
  const domainName = doc.domainName || DOMAIN_NAMES[doc.domain] || doc.domain;
  document.getElementById('doc-breadcrumb').innerHTML =
    `<a href="#" onclick="showHub();return false">Nexus</a> / ` +
    `<a href="#" onclick="openDomainView('${escHtml(doc.domain)}');return false">${escHtml(domainName)}</a> / ` +
    `<span>${escHtml(doc.docId)}</span>`;

  document.getElementById('doc-title').textContent = doc.title;

  // Meta pills
  const pills = [];
  pills.push(`<span class="pill domain">${escHtml(doc.domain)}</span>`);
  if (doc.status) pills.push(`<span class="pill status">${escHtml(doc.status)}</span>`);
  if (doc.version) pills.push(`<span class="pill">v${escHtml(doc.version)}</span>`);
  if (doc.date) pills.push(`<span class="pill">${escHtml(doc.date)}</span>`);
  document.getElementById('doc-meta-pills').innerHTML = pills.join('');

  // Connections
  renderConnections(doc);

  // Body
  document.getElementById('doc-body').innerHTML = doc.content || '<p style="color:var(--text-dim)">No content</p>';
}

function renderConnections(doc) {
  const el = document.getElementById('doc-connections');
  const docIdSet = new Set(allDocs.map(d => d.docId));
  const deps = doc.dependsOn || [];
  const refs = doc.dependedBy || [];

  if (deps.length === 0 && refs.length === 0) {
    el.innerHTML = '<div class="connections-title">Connections</div><div style="font-size:0.75rem;color:var(--text-dim)">No connections (orphaned document)</div>';
    return;
  }

  let html = '';

  if (deps.length > 0) {
    html += '<div class="connections-title">Depends On</div><div class="connection-list">';
    html += deps.map(d => {
      const exists = docIdSet.has(d);
      return exists
        ? `<span class="connection-chip" onclick="openDoc('${escHtml(d)}')">${escHtml(d)}</span>`
        : `<span class="connection-chip broken" title="Document not found">${escHtml(d)}</span>`;
    }).join('');
    html += '</div>';
  }

  if (refs.length > 0) {
    html += '<div class="connections-title" style="margin-top:0.75rem">Depended By</div><div class="connection-list">';
    html += refs.map(d => {
      const exists = docIdSet.has(d);
      return exists
        ? `<span class="connection-chip" onclick="openDoc('${escHtml(d)}')">${escHtml(d)}</span>`
        : `<span class="connection-chip broken" title="Document not found">${escHtml(d)}</span>`;
    }).join('');
    html += '</div>';
  }

  el.innerHTML = html;
}

/* ═══════════════════════════════════════════════════════════════
   Comments
   ═══════════════════════════════════════════════════════════════ */
async function loadComments(docId) {
  const listEl = document.getElementById('comments-list');
  const countEl = document.getElementById('comment-count');
  listEl.innerHTML = '<div class="no-comments">Loading comments...</div>';

  try {
    const res = await fetch(`/api/docs/${encodeURIComponent(docId)}/comments`);
    if (!res.ok) throw new Error('Failed to load comments');
    const comments = await res.json();
    countEl.textContent = comments.length > 0 ? `(${comments.length})` : '';
    renderComments(comments);
  } catch (err) {
    listEl.innerHTML = '<div class="no-comments">Failed to load comments</div>';
    countEl.textContent = '';
  }

  // Restore author from localStorage
  const saved = localStorage.getItem('holm-comment-author');
  if (saved) document.getElementById('comment-author').value = saved;
}

function renderComments(comments) {
  const listEl = document.getElementById('comments-list');
  if (comments.length === 0) {
    listEl.innerHTML = '<div class="no-comments">No comments yet — be the first</div>';
    return;
  }
  listEl.innerHTML = comments.map(c => `
    <div class="comment-card">
      <div class="comment-meta">
        <span class="comment-author">${escHtml(c.author)}</span>
        <span class="comment-date">${timeAgo(c.createdAt)}</span>
      </div>
      <div class="comment-text">${escHtml(c.text)}</div>
    </div>
  `).join('');
}

async function submitComment() {
  if (!currentDoc) return;
  const authorEl = document.getElementById('comment-author');
  const textEl = document.getElementById('comment-text');
  const author = authorEl.value.trim();
  const text = textEl.value.trim();

  if (!author) { showToast('Enter your name', 'error'); authorEl.focus(); return; }
  if (!text) { showToast('Enter a comment', 'error'); textEl.focus(); return; }

  try {
    const res = await fetch(`/api/docs/${encodeURIComponent(currentDoc.docId)}/comments`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ author, text })
    });
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'Failed to post');
    }
    localStorage.setItem('holm-comment-author', author);
    textEl.value = '';
    showToast('Comment posted');
    loadComments(currentDoc.docId);
  } catch (err) {
    showToast(err.message, 'error');
  }
}

/* ═══════════════════════════════════════════════════════════════
   Graph View
   ═══════════════════════════════════════════════════════════════ */
let graphAnimId = null;
let graphNodes = [];
let graphEdges = [];
let graphTransform = { x: 0, y: 0, scale: 1 };
let graphDrag = null;
let graphHover = null;

function showGraph(pushHistory) {
  switchView('graph', pushHistory);
  initGraph();
}

async function initGraph() {
  const canvas = document.getElementById('graph-canvas');
  const ctx = canvas.getContext('2d');

  // Resize canvas
  function resize() {
    canvas.width = canvas.clientWidth * devicePixelRatio;
    canvas.height = canvas.clientHeight * devicePixelRatio;
    ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
  }
  resize();
  window.addEventListener('resize', resize);

  // Fetch graph data if needed
  if (!graphData) {
    try {
      const res = await fetch('/api/graph');
      graphData = await res.json();
    } catch (err) {
      showToast('Failed to load graph data', 'error');
      return;
    }
  }

  // Initialize nodes with positions
  const w = canvas.clientWidth, h = canvas.clientHeight;
  graphNodes = graphData.nodes.map((n, i) => ({
    ...n, x: w / 2 + (Math.random() - 0.5) * w * 0.6,
    y: h / 2 + (Math.random() - 0.5) * h * 0.6,
    vx: 0, vy: 0,
    color: DOMAIN_COLORS[n.domain] || '#00f0ff',
    radius: 4
  }));

  const nodeMap = {};
  graphNodes.forEach(n => { nodeMap[n.id] = n; });

  graphEdges = graphData.edges.filter(e => nodeMap[e.source] && nodeMap[e.target])
    .map(e => ({ source: nodeMap[e.source], target: nodeMap[e.target] }));

  // Update stats
  const domains = new Set(graphNodes.map(n => n.domain));
  document.getElementById('graph-stats').textContent =
    `${graphNodes.length} nodes · ${graphEdges.length} edges · ${domains.size} domains`;

  // Build legend
  const domainCounts = {};
  graphNodes.forEach(n => {
    const key = n.domain;
    if (!domainCounts[key]) domainCounts[key] = { name: n.domainName || DOMAIN_NAMES[key] || key, count: 0, color: n.color };
    domainCounts[key].count++;
  });
  document.getElementById('graph-legend').innerHTML = Object.keys(domainCounts)
    .sort((a, b) => domainCounts[b].count - domainCounts[a].count)
    .map(k => `<div class="graph-legend-item"><span class="graph-legend-dot" style="background:${domainCounts[k].color}"></span>${domainCounts[k].name} (${domainCounts[k].count})</div>`)
    .join('');

  // Reset transform
  graphTransform = { x: 0, y: 0, scale: 1 };

  // Force simulation
  let iterations = 0;
  const maxIterations = 300;

  function simulate() {
    if (iterations > maxIterations) { drawGraph(ctx, canvas); return; }
    iterations++;

    const alpha = Math.max(0.001, 1 - iterations / maxIterations);

    // Repulsion between all nodes
    for (let i = 0; i < graphNodes.length; i++) {
      for (let j = i + 1; j < graphNodes.length; j++) {
        const a = graphNodes[i], b = graphNodes[j];
        let dx = b.x - a.x, dy = b.y - a.y;
        let dist = Math.sqrt(dx * dx + dy * dy) || 1;
        const force = -300 / (dist * dist) * alpha;
        const fx = (dx / dist) * force, fy = (dy / dist) * force;
        a.vx -= fx; a.vy -= fy;
        b.vx += fx; b.vy += fy;
      }
    }

    // Attraction along edges
    for (const e of graphEdges) {
      let dx = e.target.x - e.source.x, dy = e.target.y - e.source.y;
      let dist = Math.sqrt(dx * dx + dy * dy) || 1;
      const force = (dist - 80) * 0.005 * alpha;
      const fx = (dx / dist) * force, fy = (dy / dist) * force;
      e.source.vx += fx; e.source.vy += fy;
      e.target.vx -= fx; e.target.vy -= fy;
    }

    // Center gravity
    for (const n of graphNodes) {
      n.vx += (w / 2 - n.x) * 0.0005 * alpha;
      n.vy += (h / 2 - n.y) * 0.0005 * alpha;
    }

    // Apply velocity with damping
    for (const n of graphNodes) {
      n.vx *= 0.85; n.vy *= 0.85;
      n.x += n.vx; n.y += n.vy;
    }

    drawGraph(ctx, canvas);
    graphAnimId = requestAnimationFrame(simulate);
  }

  if (graphAnimId) cancelAnimationFrame(graphAnimId);
  simulate();

  // Setup interactions
  setupGraphInteractions(canvas, ctx);
}

function drawGraph(ctx, canvas) {
  const w = canvas.clientWidth, h = canvas.clientHeight;
  ctx.clearRect(0, 0, w, h);
  ctx.save();
  ctx.translate(graphTransform.x, graphTransform.y);
  ctx.scale(graphTransform.scale, graphTransform.scale);

  // Draw edges
  ctx.lineWidth = 0.5;
  for (const e of graphEdges) {
    const isHighlight = graphHover && (e.source.id === graphHover.id || e.target.id === graphHover.id);
    ctx.strokeStyle = isHighlight ? 'rgba(0, 240, 255, 0.6)' : 'rgba(255, 255, 255, 0.08)';
    ctx.lineWidth = isHighlight ? 1.5 : 0.5;
    ctx.beginPath();
    ctx.moveTo(e.source.x, e.source.y);
    ctx.lineTo(e.target.x, e.target.y);
    ctx.stroke();
  }

  // Draw nodes
  for (const n of graphNodes) {
    const isHover = graphHover && n.id === graphHover.id;
    const isConnected = graphHover && graphEdges.some(e =>
      (e.source.id === graphHover.id && e.target.id === n.id) ||
      (e.target.id === graphHover.id && e.source.id === n.id)
    );
    const r = isHover ? 7 : isConnected ? 5 : n.radius;
    const alpha = (graphHover && !isHover && !isConnected) ? 0.3 : 1;

    ctx.globalAlpha = alpha;
    ctx.fillStyle = n.color;
    ctx.beginPath();
    ctx.arc(n.x, n.y, r, 0, Math.PI * 2);
    ctx.fill();

    if (isHover) {
      ctx.strokeStyle = n.color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(n.x, n.y, r + 3, 0, Math.PI * 2);
      ctx.stroke();
    }
    ctx.globalAlpha = 1;
  }

  ctx.restore();
}

function setupGraphInteractions(canvas, ctx) {
  const tooltip = document.getElementById('graph-tooltip');
  let isDragging = false;
  let dragNode = null;
  let lastPos = null;

  function screenToGraph(x, y) {
    return {
      x: (x - graphTransform.x) / graphTransform.scale,
      y: (y - graphTransform.y) / graphTransform.scale
    };
  }

  function findNode(x, y) {
    const gp = screenToGraph(x, y);
    let closest = null, minDist = 20 / graphTransform.scale;
    for (const n of graphNodes) {
      const d = Math.sqrt((n.x - gp.x) ** 2 + (n.y - gp.y) ** 2);
      if (d < minDist) { closest = n; minDist = d; }
    }
    return closest;
  }

  canvas.addEventListener('mousedown', e => {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left, y = e.clientY - rect.top;
    dragNode = findNode(x, y);
    if (!dragNode) { isDragging = true; }
    lastPos = { x: e.clientX, y: e.clientY };
  });

  canvas.addEventListener('mousemove', e => {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left, y = e.clientY - rect.top;

    if (dragNode && lastPos) {
      const gp = screenToGraph(x, y);
      dragNode.x = gp.x; dragNode.y = gp.y;
      dragNode.vx = 0; dragNode.vy = 0;
      drawGraph(ctx, canvas);
    } else if (isDragging && lastPos) {
      graphTransform.x += e.clientX - lastPos.x;
      graphTransform.y += e.clientY - lastPos.y;
      lastPos = { x: e.clientX, y: e.clientY };
      drawGraph(ctx, canvas);
    } else {
      const node = findNode(x, y);
      if (node !== graphHover) {
        graphHover = node;
        drawGraph(ctx, canvas);
        if (node) {
          tooltip.style.display = 'block';
          tooltip.style.left = (e.clientX + 12) + 'px';
          tooltip.style.top = (e.clientY - 10) + 'px';
          tooltip.querySelector('.tt-id').textContent = node.id;
          tooltip.querySelector('.tt-title').textContent = node.title;
          tooltip.querySelector('.tt-domain').textContent = node.domainName || DOMAIN_NAMES[node.domain] || node.domain;
        } else {
          tooltip.style.display = 'none';
        }
      } else if (node) {
        tooltip.style.left = (e.clientX + 12) + 'px';
        tooltip.style.top = (e.clientY - 10) + 'px';
      }
    }
  });

  canvas.addEventListener('mouseup', () => {
    isDragging = false; dragNode = null; lastPos = null;
  });

  canvas.addEventListener('dblclick', e => {
    const rect = canvas.getBoundingClientRect();
    const node = findNode(e.clientX - rect.left, e.clientY - rect.top);
    if (node) {
      closeOverlay();
      openDoc(node.id);
    }
  });

  canvas.addEventListener('wheel', e => {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    const delta = e.deltaY > 0 ? 0.9 : 1.1;
    const newScale = Math.max(0.1, Math.min(5, graphTransform.scale * delta));
    graphTransform.x = mx - (mx - graphTransform.x) * (newScale / graphTransform.scale);
    graphTransform.y = my - (my - graphTransform.y) * (newScale / graphTransform.scale);
    graphTransform.scale = newScale;
    drawGraph(ctx, canvas);
  }, { passive: false });

  // Touch support
  let lastTouchDist = 0;
  let lastTouchCenter = null;

  canvas.addEventListener('touchstart', e => {
    if (e.touches.length === 1) {
      const rect = canvas.getBoundingClientRect();
      const x = e.touches[0].clientX - rect.left, y = e.touches[0].clientY - rect.top;
      dragNode = findNode(x, y);
      if (!dragNode) isDragging = true;
      lastPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
    } else if (e.touches.length === 2) {
      const dx = e.touches[1].clientX - e.touches[0].clientX;
      const dy = e.touches[1].clientY - e.touches[0].clientY;
      lastTouchDist = Math.sqrt(dx * dx + dy * dy);
      lastTouchCenter = {
        x: (e.touches[0].clientX + e.touches[1].clientX) / 2,
        y: (e.touches[0].clientY + e.touches[1].clientY) / 2
      };
    }
  }, { passive: true });

  canvas.addEventListener('touchmove', e => {
    e.preventDefault();
    if (e.touches.length === 1 && lastPos) {
      const rect = canvas.getBoundingClientRect();
      const x = e.touches[0].clientX - rect.left, y = e.touches[0].clientY - rect.top;
      if (dragNode) {
        const gp = screenToGraph(x, y);
        dragNode.x = gp.x; dragNode.y = gp.y;
        dragNode.vx = 0; dragNode.vy = 0;
        drawGraph(ctx, canvas);
      } else if (isDragging) {
        graphTransform.x += e.touches[0].clientX - lastPos.x;
        graphTransform.y += e.touches[0].clientY - lastPos.y;
        lastPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        drawGraph(ctx, canvas);
      }
    } else if (e.touches.length === 2) {
      const dx = e.touches[1].clientX - e.touches[0].clientX;
      const dy = e.touches[1].clientY - e.touches[0].clientY;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (lastTouchDist > 0) {
        const rect = canvas.getBoundingClientRect();
        const cx = (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left;
        const cy = (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top;
        const delta = dist / lastTouchDist;
        const newScale = Math.max(0.1, Math.min(5, graphTransform.scale * delta));
        graphTransform.x = cx - (cx - graphTransform.x) * (newScale / graphTransform.scale);
        graphTransform.y = cy - (cy - graphTransform.y) * (newScale / graphTransform.scale);
        graphTransform.scale = newScale;
        drawGraph(ctx, canvas);
      }
      lastTouchDist = dist;
    }
  }, { passive: false });

  canvas.addEventListener('touchend', () => {
    isDragging = false; dragNode = null; lastPos = null; lastTouchDist = 0;
  });
}

/* ═══════════════════════════════════════════════════════════════
   Search
   ═══════════════════════════════════════════════════════════════ */
let searchDebounce = null;

function openSearch(pushHistory) {
  switchView('search', pushHistory);
  const input = document.getElementById('search-input');
  input.value = '';
  input.focus();
  document.getElementById('search-results').innerHTML =
    '<div class="search-empty">Type to search across all documents</div>';
}

document.getElementById('search-input').addEventListener('input', e => {
  clearTimeout(searchDebounce);
  const q = e.target.value.trim();
  if (!q) {
    document.getElementById('search-results').innerHTML =
      '<div class="search-empty">Type to search across all documents</div>';
    return;
  }
  searchDebounce = setTimeout(() => performSearch(q), 250);
});

async function performSearch(q) {
  const resultsEl = document.getElementById('search-results');
  try {
    const res = await fetch('/api/search?q=' + encodeURIComponent(q));
    if (!res.ok) throw new Error('Search failed');
    const results = await res.json();

    if (results.length === 0) {
      resultsEl.innerHTML = '<div class="search-empty">No results found</div>';
      return;
    }

    resultsEl.innerHTML = results.map(r => `
      <div class="search-result-card" onclick="closeOverlay();openDoc('${escHtml(r.docId)}')">
        <div class="search-result-id">${escHtml(r.docId)} · ${escHtml(r.domainName || r.domain)}</div>
        <div class="search-result-title">${escHtml(r.title)}</div>
        <div class="search-result-snippet">${r.snippet || ''}</div>
      </div>
    `).join('');
  } catch (err) {
    resultsEl.innerHTML = '<div class="search-empty">Search failed — try again</div>';
  }
}

/* ═══════════════════════════════════════════════════════════════
   Hash Routing
   ═══════════════════════════════════════════════════════════════ */
function handleHash() {
  const hash = location.hash;
  if (hash.startsWith('#doc/')) {
    const id = hash.slice(5);
    openDoc(id, false);
  } else if (hash.startsWith('#domain/')) {
    const key = hash.slice(8);
    openDomainView(key, false);
  } else if (hash === '#graph') {
    showGraph(false);
  } else if (hash === '#search') {
    openSearch(false);
  } else {
    showHub(false);
  }
}

window.addEventListener('popstate', handleHash);

/* ═══════════════════════════════════════════════════════════════
   Offline Detection
   ═══════════════════════════════════════════════════════════════ */
window.addEventListener('online', () => { document.body.classList.remove('offline'); showToast('Back online'); });
window.addEventListener('offline', () => { document.body.classList.add('offline'); });

/* ═══════════════════════════════════════════════════════════════
   Service Worker
   ═══════════════════════════════════════════════════════════════ */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(err => console.warn('SW registration failed:', err));
}

/* ═══════════════════════════════════════════════════════════════
   Boot
   ═══════════════════════════════════════════════════════════════ */
init();
</script>
</body>
</html>