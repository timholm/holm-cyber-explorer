<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#0a0a0f">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>holm.chat</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" type="image/svg+xml" href="/icons/icon-192.svg">
<link rel="apple-touch-icon" href="/icons/icon-192.svg">
<meta name="apple-mobile-web-app-title" content="holm.chat">
<meta name="format-detection" content="telephone=no">

<style>
@font-face { font-family: 'JetBrains Mono'; src: url('/fonts/JetBrainsMono-Regular.woff2') format('woff2'); font-weight: 400; font-style: normal; font-display: swap; }
@font-face { font-family: 'JetBrains Mono'; src: url('/fonts/JetBrainsMono-Medium.woff2') format('woff2'); font-weight: 500; font-style: normal; font-display: swap; }
@font-face { font-family: 'JetBrains Mono'; src: url('/fonts/JetBrainsMono-Bold.woff2') format('woff2'); font-weight: 700; font-style: normal; font-display: swap; }

:root {
  --bg: #0a0a0f;
  --bg2: #111118;
  --bg3: #1a1a24;
  --cyan: #00f0ff;
  --magenta: #ff00aa;
  --text: #d8d8e0;
  --muted: #666678;
  --dim: #333344;
  --border: #222233;
  --font: 'JetBrains Mono', monospace;
  --max-w: 800px;
  --safe-b: env(safe-area-inset-bottom, 0px);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 14px; -webkit-text-size-adjust: 100%; }
body { font-family: var(--font); background: var(--bg); color: var(--text); min-height: 100dvh; overscroll-behavior: none; -webkit-font-smoothing: antialiased; }
a { color: var(--cyan); text-decoration: none; }
a:hover { text-decoration: underline; }
button { font-family: var(--font); cursor: pointer; border: none; background: none; color: var(--text); -webkit-tap-highlight-color: transparent; }
input, textarea { font-family: var(--font); }
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--dim); border-radius: 3px; }

/* ── Header ── */
header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(10,10,15,0.92); backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--border);
  padding: 0 1rem; height: 48px;
  display: flex; align-items: center; gap: 1rem;
}
.logo { font-weight: 700; color: var(--cyan); letter-spacing: 0.08em; font-size: 0.95rem; cursor: pointer; white-space: nowrap; }
.logo:hover { text-shadow: 0 0 8px rgba(0,240,255,0.4); }
header nav { display: flex; gap: 0.75rem; align-items: center; flex: 1; justify-content: flex-end; }
header nav button { font-size: 0.75rem; color: var(--muted); padding: 0.3rem 0; transition: color 0.15s; }
header nav button:hover, header nav button.active { color: var(--cyan); }
.search-trigger { display: flex; align-items: center; gap: 0.4rem; padding: 0.3rem 0.6rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.7rem; color: var(--muted); }
.search-trigger:hover { border-color: var(--cyan); color: var(--cyan); }
.search-trigger kbd { font-size: 0.6rem; background: var(--bg3); padding: 0.1rem 0.3rem; border-radius: 3px; }

/* ── Page Layout ── */
main { max-width: var(--max-w); margin: 0 auto; padding: 1.5rem 1rem 4rem; }

/* ── Wiki Home ── */
.wiki-home h1 { font-size: 1.3rem; font-weight: 700; color: var(--cyan); margin-bottom: 0.3rem; }
.wiki-home .subtitle { font-size: 0.75rem; color: var(--muted); margin-bottom: 2rem; }

.domain-section { margin-bottom: 1.5rem; }
.domain-heading {
  font-size: 0.7rem; font-weight: 500; color: var(--muted);
  letter-spacing: 0.1em; text-transform: uppercase;
  padding-bottom: 0.4rem; margin-bottom: 0.5rem;
  border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center;
}
.domain-heading span { color: var(--dim); font-weight: 400; text-transform: none; letter-spacing: 0; }

.doc-link {
  display: flex; align-items: baseline; gap: 0.6rem;
  padding: 0.35rem 0; cursor: pointer;
  transition: color 0.1s;
}
.doc-link:hover { color: var(--cyan); }
.doc-link-id { font-size: 0.65rem; color: var(--dim); min-width: 55px; flex-shrink: 0; }
.doc-link-title { font-size: 0.8rem; }
.doc-link:hover .doc-link-id { color: var(--muted); }

/* ── Document Page ── */
.doc-page .breadcrumb {
  font-size: 0.7rem; color: var(--muted); margin-bottom: 1.5rem;
  display: flex; align-items: center; gap: 0.3rem; flex-wrap: wrap;
}
.breadcrumb a { color: var(--cyan); }
.breadcrumb .sep { color: var(--dim); }

.doc-page h1 { font-size: 1.2rem; font-weight: 700; line-height: 1.3; margin-bottom: 0.6rem; }

.doc-meta { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 1.5rem; }
.tag {
  font-size: 0.6rem; padding: 0.12rem 0.45rem;
  border: 1px solid var(--border); border-radius: 12px;
  color: var(--muted);
}
.tag.domain { border-color: var(--cyan); color: var(--cyan); }

/* Dependencies */
.deps { margin-bottom: 1.5rem; }
.deps-label { font-size: 0.65rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 0.4rem; }
.deps-list { display: flex; flex-wrap: wrap; gap: 0.3rem; }
.dep-chip {
  font-size: 0.7rem; padding: 0.15rem 0.5rem;
  background: var(--bg2); border: 1px solid var(--border); border-radius: 4px;
  color: var(--cyan); cursor: pointer; transition: border-color 0.15s;
}
.dep-chip:hover { border-color: var(--cyan); }
.dep-chip.broken { color: #f44; border-color: rgba(255,68,68,0.3); text-decoration: line-through; cursor: default; }

/* Document content */
.doc-content {
  line-height: 1.75; font-size: 0.85rem;
  word-break: break-word;
}
.doc-content h1 { font-size: 1.2rem; font-weight: 700; margin: 2rem 0 0.75rem; color: var(--cyan); }
.doc-content h2 { font-size: 1.05rem; font-weight: 700; margin: 1.8rem 0 0.6rem; border-bottom: 1px solid var(--border); padding-bottom: 0.3rem; }
.doc-content h3 { font-size: 0.95rem; font-weight: 600; margin: 1.5rem 0 0.5rem; }
.doc-content h4 { font-size: 0.85rem; font-weight: 600; margin: 1rem 0 0.4rem; color: var(--muted); }
.doc-content p { margin-bottom: 0.8rem; }
.doc-content ul, .doc-content ol { margin-bottom: 0.8rem; padding-left: 1.5rem; }
.doc-content li { margin-bottom: 0.25rem; }
.doc-content code { background: var(--bg3); padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.8rem; color: var(--magenta); }
.doc-content pre { background: var(--bg2); padding: 1rem; border-radius: 6px; border: 1px solid var(--border); overflow-x: auto; margin-bottom: 0.8rem; }
.doc-content pre code { background: none; padding: 0; color: var(--text); }
.doc-content blockquote { border-left: 3px solid var(--cyan); padding: 0.5rem 1rem; margin-bottom: 0.8rem; color: var(--muted); background: rgba(0,240,255,0.05); border-radius: 0 6px 6px 0; }
.doc-content table { width: 100%; border-collapse: collapse; margin-bottom: 0.8rem; font-size: 0.8rem; }
.doc-content th, .doc-content td { padding: 0.4rem 0.6rem; border: 1px solid var(--border); text-align: left; }
.doc-content th { background: var(--bg3); color: var(--cyan); font-weight: 500; }
.doc-content dl { margin-bottom: 0.8rem; }
.doc-content dt { font-weight: 600; color: var(--cyan); margin-top: 0.5rem; }
.doc-content dd { margin-left: 1rem; margin-bottom: 0.3rem; color: var(--muted); }
.doc-content a { color: var(--cyan); }
.doc-content img { max-width: 100%; border-radius: 6px; }
.doc-content hr { border: none; border-top: 1px solid var(--border); margin: 1.5rem 0; }
.doc-content mark { background: rgba(0,240,255,0.15); color: var(--cyan); padding: 0 0.2rem; border-radius: 2px; }

/* Comments */
.comments { margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border); }
.comments-title { font-size: 0.7rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 1rem; }
.comment-form { display: flex; flex-direction: column; gap: 0.4rem; margin-bottom: 1.5rem; }
.comment-form input, .comment-form textarea {
  background: var(--bg2); border: 1px solid var(--border); border-radius: 6px;
  padding: 0.5rem 0.7rem; color: var(--text); font-size: 0.8rem; outline: none;
}
.comment-form input:focus, .comment-form textarea:focus { border-color: var(--magenta); }
.comment-form textarea { resize: vertical; min-height: 50px; }
.comment-form button {
  align-self: flex-end; padding: 0.4rem 1rem;
  background: rgba(255,0,170,0.1); border: 1px solid var(--magenta); border-radius: 6px;
  color: var(--magenta); font-size: 0.7rem; font-weight: 500; transition: background 0.15s;
}
.comment-form button:hover { background: rgba(255,0,170,0.2); }

.comment { background: var(--bg2); border: 1px solid var(--border); border-left: 3px solid var(--magenta); border-radius: 6px; padding: 0.6rem 0.75rem; margin-bottom: 0.5rem; }
.comment-header { display: flex; justify-content: space-between; margin-bottom: 0.2rem; }
.comment-author { font-size: 0.7rem; font-weight: 500; color: var(--magenta); }
.comment-time { font-size: 0.6rem; color: var(--dim); }
.comment-body { font-size: 0.8rem; line-height: 1.5; }

/* ── Search Overlay ── */
.search-overlay {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(10,10,15,0.95); backdrop-filter: blur(12px);
  display: none; flex-direction: column;
}
.search-overlay.open { display: flex; }
.search-bar {
  padding: 1rem; display: flex; align-items: center; gap: 0.75rem;
  border-bottom: 1px solid var(--border);
}
.search-bar input {
  flex: 1; background: var(--bg2); border: 1px solid var(--border); border-radius: 6px;
  padding: 0.6rem 0.8rem; color: var(--text); font-size: 0.9rem; outline: none;
}
.search-bar input:focus { border-color: var(--cyan); }
.search-bar input::placeholder { color: var(--dim); }
.search-bar .close-btn { font-size: 1.2rem; color: var(--muted); padding: 0.3rem; }
.search-bar .close-btn:hover { color: var(--text); }

.search-results { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 0.75rem 1rem; max-width: var(--max-w); margin: 0 auto; width: 100%; }
.search-result {
  padding: 0.65rem 0; border-bottom: 1px solid var(--border); cursor: pointer;
}
.search-result:hover .sr-title { color: var(--cyan); }
.sr-id { font-size: 0.6rem; color: var(--cyan); letter-spacing: 0.04em; }
.sr-title { font-size: 0.85rem; font-weight: 500; transition: color 0.1s; }
.sr-snippet { font-size: 0.75rem; color: var(--muted); line-height: 1.4; margin-top: 0.15rem; }
.sr-snippet mark { background: rgba(0,240,255,0.15); color: var(--cyan); padding: 0 0.1rem; border-radius: 2px; }
.search-empty { text-align: center; padding: 3rem; color: var(--dim); font-size: 0.8rem; }

/* ── Collapsible domain sections ── */
.domain-heading { cursor: pointer; user-select: none; }
.domain-heading::before { content: '▾'; margin-right: 0.5rem; color: var(--dim); transition: transform 0.15s; display: inline-block; }
.domain-section.collapsed .domain-heading::before { transform: rotate(-90deg); }
.domain-section.collapsed .doc-link { display: none; }


/* ── Toast ── */
.toast-container { position: fixed; bottom: calc(1rem + var(--safe-b)); left: 50%; transform: translateX(-50%); z-index: 300; display: flex; flex-direction: column; gap: 0.4rem; pointer-events: none; }
.toast { background: var(--bg3); border: 1px solid var(--border); border-radius: 6px; padding: 0.5rem 0.9rem; font-size: 0.7rem; pointer-events: auto; animation: fade-in 0.2s ease; white-space: nowrap; }
.toast.error { border-color: #f44; color: #f44; }
.toast.out { animation: fade-out 0.2s ease forwards; }
@keyframes fade-in { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fade-out { from { opacity: 1; } to { opacity: 0; } }

/* ── Loading ── */
.loading { display: flex; align-items: center; justify-content: center; min-height: 60vh; color: var(--muted); font-size: 0.8rem; }

/* ── Offline ── */
.offline-bar { display: none; position: fixed; top: 0; left: 0; right: 0; z-index: 400; background: rgba(255,0,170,0.1); border-bottom: 1px solid var(--magenta); text-align: center; padding: 0.3rem; font-size: 0.65rem; color: var(--magenta); }
body.offline .offline-bar { display: block; }

/* ── Table of Contents ── */
.toc { margin-bottom: 1.5rem; padding: 0.75rem 1rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 6px; }
.toc-title { font-size: 0.65rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 0.5rem; }
.toc a { display: block; font-size: 0.75rem; color: var(--muted); padding: 0.15rem 0; transition: color 0.1s; }
.toc a:hover { color: var(--cyan); text-decoration: none; }
.toc a.toc-h2 { padding-left: 0.8rem; }
.toc a.toc-h3 { padding-left: 1.6rem; font-size: 0.7rem; }

/* ── Document Nav ── */
.doc-nav-footer { display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border); }
.doc-nav-link { font-size: 0.75rem; color: var(--muted); cursor: pointer; transition: color 0.15s; max-width: 45%; }
.doc-nav-link:hover { color: var(--cyan); }
.doc-nav-link .nav-label { font-size: 0.6rem; letter-spacing: 0.06em; text-transform: uppercase; margin-bottom: 0.15rem; }
.doc-nav-link .nav-title { color: var(--text); font-size: 0.8rem; }
.doc-nav-link:hover .nav-title { color: var(--cyan); }
.doc-nav-link.next { text-align: right; margin-left: auto; }


/* ── Progress Bar ── */
.progress-bar { position: fixed; top: 0; left: 0; height: 2px; background: var(--cyan); z-index: 200; width: 0%; transition: width 0.1s; pointer-events: none; opacity: 0; }
.progress-bar.visible { opacity: 1; }
/* ── Copy Button ── */
.copy-btn { font-size: 0.65rem; color: var(--muted); padding: 0.2rem 0.5rem; border: 1px solid var(--border); border-radius: 4px; transition: color 0.15s, border-color 0.15s; }
.copy-btn:hover { color: var(--cyan); border-color: var(--cyan); }
.recent { margin-bottom: 2rem; }
.recent-title { font-size: 0.65rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 0.5rem; }
.recent-list { display: flex; flex-wrap: wrap; gap: 0.4rem; }
.recent-chip { font-size: 0.7rem; padding: 0.2rem 0.5rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 4px; color: var(--cyan); cursor: pointer; transition: border-color 0.15s; }
.recent-chip:hover { border-color: var(--cyan); }

/* ── Print ── */
@media print {
  header, .search-overlay, .toast-container, .comments, .offline-bar, .back-top, .progress-bar, .doc-nav-footer, .toc, .deps { display: none !important; }
  body { background: white; color: black; font-size: 12pt; }
  main { max-width: none; padding: 0; }
  .doc-page h1 { color: black; font-size: 18pt; }
  .doc-meta { display: none; }
  .breadcrumb { display: none; }
  .doc-content { font-size: 11pt; line-height: 1.6; }
  .doc-content h1, .doc-content h2, .doc-content h3 { color: black; }
  .doc-content a { color: black; text-decoration: underline; }
  .doc-content code { background: #f0f0f0; color: black; }
  .doc-content pre { background: #f5f5f5; border: 1px solid #ddd; }
  .doc-content blockquote { border-left-color: #999; color: #333; background: none; }
  .doc-content table { border-color: #ccc; }
  .doc-content th { background: #f0f0f0; color: black; }
}

@media (min-width: 768px) {
  html { font-size: 15px; }
  main { padding: 2rem 1.5rem 4rem; }
}
</style>
</head>
<body>


/* ── Back to Top ── */
.back-top { position: fixed; bottom: calc(1.5rem + var(--safe-b)); right: 1rem; width: 36px; height: 36px; border-radius: 50%; background: var(--bg3); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; color: var(--muted); font-size: 1rem; opacity: 0; pointer-events: none; transition: opacity 0.2s, color 0.15s; z-index: 50; }
.back-top.show { opacity: 1; pointer-events: auto; }
.back-top:hover { color: var(--cyan); border-color: var(--cyan); }

<div class="progress-bar" id="progress-bar"></div>

<div class="offline-bar">Offline — showing cached data</div>

<header>
  <span class="logo" onclick="goHome()">holm.chat</span>
  <span id="doc-count" style="font-size:0.6rem;color:var(--dim);margin-left:-0.5rem"></span>
  <nav>
    <button onclick="openRandom()" style="font-size:0.75rem;color:var(--muted);padding:0.3rem 0;transition:color 0.15s" onmouseover="this.style.color='var(--cyan)'" onmouseout="this.style.color='var(--muted)'">random</button>
    <button class="search-trigger" onclick="openSearch()">search <kbd>/</kbd></button>
  </nav>
</header>

<main id="main">
  <div class="loading" id="loading">loading...</div>
</main>

<div class="search-overlay" id="search-overlay">
  <div class="search-bar">
    <input type="text" id="search-input" placeholder="Search documents..." autocomplete="off">
    <button class="close-btn" onclick="closeSearch()">&times;</button>
  </div>
  <div class="search-results" id="search-results">
    <div class="search-empty">Type to search across all documents</div>
  </div>
</div>

<button class="back-top" id="back-top" onclick="window.scrollTo({top:0,behavior:'smooth'})">&uarr;</button>

<div class="toast-container" id="toasts"></div>

<script>
/* ── State ── */
let allDocs = [];
let docsById = {};
let currentDocId = null;
let histStack = [];
let currentDomain = null;

const DOMAIN_NAMES = {
  '1':'Constitution & Philosophy','2':'Governance & Authority','3':'Security & Integrity',
  '4':'Infrastructure & Power','5':'Platform & Core Systems','6':'Data & Archives',
  '7':'Intelligence & Analysis','8':'Automation & Agents','9':'Education & Training',
  '10':'User Operations','11':'Administration','12':'Disaster Recovery',
  '13':'Evolution & Adaptation','14':'Research & Theory','15':'Ethics & Safeguards',
  '16':'Federation & External','17':'Federation Protocol','18':'Data Pipeline',
  '19':'Advanced Automation','20':'Meta & Documentation',
  'META':'Meta','FW':'Framework','HIC':'HIC Architecture'
};

/* ── Utilities ── */
function esc(s) { return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : ''; }

function getRecent() {
  try { return JSON.parse(sessionStorage.getItem('holm-recent') || '[]'); } catch(e) { return []; }
}

function addRecent(docId) {
  var recent = getRecent().filter(function(id) { return id !== docId; });
  recent.unshift(docId);
  if (recent.length > 8) recent = recent.slice(0, 8);
  sessionStorage.setItem('holm-recent', JSON.stringify(recent));
}

function toast(msg, type) {
  var t = document.createElement('div');
  t.className = 'toast' + (type === 'error' ? ' error' : '');
  t.textContent = msg;
  document.getElementById('toasts').appendChild(t);
  setTimeout(function() { t.classList.add('out'); setTimeout(function() { t.remove(); }, 200); }, 3000);
}

function copyDocText() {
  var el = document.querySelector('.doc-content');
  if (!el) return;
  var text = el.innerText || el.textContent;
  navigator.clipboard.writeText(text).then(function() {
    toast('Copied to clipboard');
  }).catch(function() {
    toast('Copy failed', 'error');
  });
}

function timeAgo(d) {
  var s = Math.floor((Date.now() - new Date(d).getTime()) / 1000);
  if (s < 60) return 'just now';
  if (s < 3600) return Math.floor(s/60) + 'm ago';
  if (s < 86400) return Math.floor(s/3600) + 'h ago';
  return Math.floor(s/86400) + 'd ago';
}

function linkifyDocIds(html) {
  if (!html) return html;
  // Match doc ID patterns not already inside HTML tags or existing links
  var idPattern = /\b([A-Z]{1,10}-\d{1,4}|D\d{1,2}-\d{1,4})\b/g;
  // Simple approach: split on HTML tags, process text nodes only
  var parts = html.split(/(<[^>]*>)/);
  var inLink = false;
  for (var i = 0; i < parts.length; i++) {
    if (parts[i].match(/^<a[\s>]/i)) inLink = true;
    if (parts[i].match(/^<\/a>/i)) inLink = false;
    if (parts[i].charAt(0) !== '<' && !inLink) {
      parts[i] = parts[i].replace(idPattern, function(match) {
        if (docsById[match]) {
          return '<a href="#' + match + '" onclick="event.preventDefault();openDoc(\'' + match + '\')" style="color:var(--cyan);cursor:pointer">' + match + '</a>';
        }
        return match;
      });
    }
  }
  return parts.join('');
}

/* ── Routing ── */
function goHome() {
  histStack = [];
  currentDocId = null;
  currentDomain = null;
  renderHome();
  history.replaceState(null, '', '/');
  progressBar.classList.remove('visible'); progressBar.style.width = '0%';
}

function openDoc(id) {
  var doc = docsById[id];
  if (!doc) { toast('Not found: ' + id, 'error'); return; }
  if (currentDocId) histStack.push(currentDocId);
  currentDocId = id;
  addRecent(id);
  renderDoc(id);
  history.pushState({ doc: id }, '', '#' + id);
}

function openDomain(key) {
  currentDomain = key;
  histStack = [];
  currentDocId = null;
  renderDomain(key);
  history.pushState({ domain: key }, '', '#d/' + key);
}

function renderDomain(key) {
  var el = document.getElementById('main');
  var docs = allDocs.filter(function(d) { return d.domain === key; })
    .sort(function(a, b) { return a.docId.localeCompare(b.docId); });
  var name = DOMAIN_NAMES[key] || (docs[0] && docs[0].domainName) || key;

  var html = '<div style="margin-bottom:1rem">';
  html += '<div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1.5rem">';
  html += '<button onclick="goHome()" style="color:var(--cyan);font-size:0.8rem">&larr; Home</button>';
  html += '<h1 style="font-size:1.1rem;font-weight:600">' + esc(name) + '</h1>';
  html += '<span style="font-size:0.7rem;color:var(--muted)">' + docs.length + ' docs</span>';
  html += '</div>';

  for (var i = 0; i < docs.length; i++) {
    var d = docs[i];
    html += '<div class="doc-link" onclick="openDoc(\'' + esc(d.docId) + '\')">';
    html += '<span class="doc-link-id">' + esc(d.docId) + '</span>';
    html += '<span class="doc-link-title">' + esc(d.title) + '</span>';
    html += '</div>';
  }
  html += '</div>';
  el.innerHTML = html;
  window.scrollTo(0, 0);
}

function goBack() {
  if (histStack.length > 0) {
    var prev = histStack.pop();
    currentDocId = prev;
    renderDoc(prev);
    history.replaceState({ doc: prev }, '', '#' + prev);
  } else if (currentDomain) {
    currentDocId = null;
    renderDomain(currentDomain);
    history.replaceState({ domain: currentDomain }, '', '#d/' + currentDomain);
  } else {
    goHome();
  }
}

window.addEventListener('popstate', function() {
  var h = location.hash.slice(1);
  if (h.startsWith('d/')) { openDomain(h.slice(2)); return; }
  if (h && docsById[h]) { currentDocId = h; renderDoc(h); }
  else goHome();
});

/* ── Home Page ── */
function renderHome() {
  var el = document.getElementById('main');

  var domains = {};
  allDocs.forEach(function(d) {
    var k = d.domain || 'other';
    if (!domains[k]) domains[k] = [];
    domains[k].push(d);
  });

  var keys = Object.keys(domains).sort(function(a, b) {
    var na = parseInt(a), nb = parseInt(b);
    if (!isNaN(na) && !isNaN(nb)) return na - nb;
    if (!isNaN(na)) return -1;
    if (!isNaN(nb)) return 1;
    return a.localeCompare(b);
  });

  var html = '<div class="wiki-home">';
  html += '<h1>holm.chat</h1>';
  html += '<div class="subtitle">' + allDocs.length + ' documents across ' + keys.length + ' domains</div>';

  var recent = getRecent();
  if (recent.length > 0) {
    html += '<div class="recent"><div class="recent-title">Recently viewed</div><div class="recent-list">';
    recent.forEach(function(id) {
      var d = docsById[id];
      if (d) html += '<span class="recent-chip" onclick="openDoc(\'' + esc(id) + '\')">' + esc(d.title) + '</span>';
    });
    html += '</div></div>';
  }

  for (var i = 0; i < keys.length; i++) {
    var k = keys[i];
    var docs = domains[k].sort(function(a, b) { return a.docId.localeCompare(b.docId); });
    var name = DOMAIN_NAMES[k] || (docs[0] && docs[0].domainName) || k;
    html += '<div class="domain-section">';
    html += '<div class="domain-heading" onclick="openDomain(\'' + esc(k) + '\')">' + esc(name) + ' <span>' + docs.length + '</span></div>';
    for (var j = 0; j < docs.length; j++) {
      var d = docs[j];
      html += '<div class="doc-link" onclick="openDoc(\'' + esc(d.docId) + '\')">';
      html += '<span class="doc-link-id">' + esc(d.docId) + '</span>';
      html += '<span class="doc-link-title">' + esc(d.title) + '</span>';
      html += '</div>';
    }
    html += '</div>';
  }
  html += '</div>';
  el.innerHTML = html;
  window.scrollTo(0, 0);
}

/* ── Document Page ── */
function buildTOC(content) {
  var div = document.createElement('div');
  div.innerHTML = content || '';
  var headings = div.querySelectorAll('h1, h2, h3');
  if (headings.length < 3) return { toc: '', content: content };
  var tocHtml = '<div class="toc"><div class="toc-title">Contents</div>';
  for (var i = 0; i < headings.length; i++) {
    var h = headings[i];
    var id = 'h-' + h.textContent.trim().toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+$/, '');
    h.id = id;
    var level = h.tagName.toLowerCase();
    tocHtml += '<a href="#' + id + '" class="toc-' + level + '">' + h.textContent.trim() + '</a>';
  }
  tocHtml += '</div>';
  return { toc: tocHtml, content: div.innerHTML };
}

async function renderDoc(id) {
  var el = document.getElementById('main');
  var doc = docsById[id];
  if (!doc) { el.innerHTML = '<div class="loading">Document not found</div>'; return; }

  if (doc.content === undefined) {
    el.innerHTML = '<div class="loading">loading...</div>';
    try {
      var res = await fetch('/api/docs/' + encodeURIComponent(id));
      if (!res.ok) throw new Error();
      Object.assign(doc, await res.json());
    } catch(e) { toast('Failed to load', 'error'); return; }
  }

  var domainName = doc.domainName || DOMAIN_NAMES[doc.domain] || doc.domain;
  var docIds = new Set(allDocs.map(function(d) { return d.docId; }));
  var deps = doc.dependsOn || [];
  var refs = doc.dependedBy || [];

  var plain = (doc.content || '').replace(/<[^>]*>/g, '');
  var words = plain.split(/\s+/).filter(function(w) { return w.length > 0; }).length;
  var readMin = Math.max(1, Math.ceil(words / 200));

  var html = '<div class="doc-page">';

  html += '<div class="breadcrumb">';
  html += '<a href="#" onclick="goHome();return false">Home</a>';
  html += '<span class="sep">/</span>';
  html += '<span>' + esc(domainName) + '</span>';
  html += '<span class="sep">/</span>';
  html += '<span>' + esc(doc.docId) + '</span>';
  html += '</div>';

  html += '<div style="display:flex;justify-content:flex-end;margin-bottom:0.5rem">';
  html += '<button class="copy-btn" onclick="copyDocText()">Copy text</button>';
  html += '</div>';

  html += '<h1>' + esc(doc.title) + '</h1>';

  html += '<div class="doc-meta">';
  html += '<span class="tag domain">' + esc(doc.domain) + '</span>';
  if (doc.status) html += '<span class="tag">' + esc(doc.status) + '</span>';
  if (doc.version) html += '<span class="tag">v' + esc(doc.version) + '</span>';
  html += '<span class="tag">' + words.toLocaleString() + ' words</span>';
  html += '<span class="tag">' + readMin + ' min</span>';
  if (doc.tags) doc.tags.forEach(function(t) { html += '<span class="tag">' + esc(t) + '</span>'; });
  html += '</div>';

  if (deps.length > 0) {
    html += '<div class="deps"><div class="deps-label">Depends on</div><div class="deps-list">';
    deps.forEach(function(d) {
      html += docIds.has(d)
        ? '<span class="dep-chip" onclick="openDoc(\'' + esc(d) + '\')">' + esc(d) + '</span>'
        : '<span class="dep-chip broken">' + esc(d) + '</span>';
    });
    html += '</div></div>';
  }
  if (refs.length > 0) {
    html += '<div class="deps"><div class="deps-label">Referenced by</div><div class="deps-list">';
    refs.forEach(function(d) {
      html += docIds.has(d)
        ? '<span class="dep-chip" onclick="openDoc(\'' + esc(d) + '\')">' + esc(d) + '</span>'
        : '<span class="dep-chip broken">' + esc(d) + '</span>';
    });
    html += '</div></div>';
  }

  var tocResult = buildTOC(doc.content);
  html += tocResult.toc;
  html += '<div class="doc-content">' + (linkifyDocIds(tocResult.content) || '<p style="color:var(--dim)">No content</p>') + '</div>';

  html += buildDocNav(doc);

  html += '<div class="comments">';
  html += '<div class="comments-title">Comments <span id="cc"></span></div>';
  html += '<div class="comment-form">';
  html += '<input type="text" id="c-author" placeholder="Name" maxlength="50">';
  html += '<textarea id="c-text" placeholder="Write a comment..." maxlength="2000"></textarea>';
  html += '<button onclick="postComment()">Post</button>';
  html += '</div>';
  html += '<div id="c-list"><div style="font-size:0.75rem;color:var(--dim);text-align:center;padding:0.5rem">Loading...</div></div>';
  html += '</div>';

  html += '</div>';
  el.innerHTML = html;
  window.scrollTo(0, 0);

  var saved = localStorage.getItem('holm-author');
  if (saved) document.getElementById('c-author').value = saved;

  loadComments(id);
}

/* ── Document Navigation ── */
function buildDocNav(doc) {
  var domainDocs = allDocs.filter(function(d) { return d.domain === doc.domain; })
    .sort(function(a, b) { return a.docId.localeCompare(b.docId); });
  var idx = domainDocs.findIndex(function(d) { return d.docId === doc.docId; });
  if (idx === -1) return '';
  var prev = idx > 0 ? domainDocs[idx - 1] : null;
  var next = idx < domainDocs.length - 1 ? domainDocs[idx + 1] : null;
  if (!prev && !next) return '';
  var html = '<div class="doc-nav-footer">';
  if (prev) {
    html += '<div class="doc-nav-link" onclick="openDoc(\'' + esc(prev.docId) + '\')">';
    html += '<div class="nav-label">&larr; Previous</div>';
    html += '<div class="nav-title">' + esc(prev.title) + '</div></div>';
  } else {
    html += '<div></div>';
  }
  if (next) {
    html += '<div class="doc-nav-link next" onclick="openDoc(\'' + esc(next.docId) + '\')">';
    html += '<div class="nav-label">Next &rarr;</div>';
    html += '<div class="nav-title">' + esc(next.title) + '</div></div>';
  }
  html += '</div>';
  return html;
}

/* ── Comments ── */
async function loadComments(id) {
  try {
    var res = await fetch('/api/docs/' + encodeURIComponent(id) + '/comments');
    var comments = await res.json();
    var cc = document.getElementById('cc');
    var list = document.getElementById('c-list');
    if (cc) cc.textContent = comments.length > 0 ? '(' + comments.length + ')' : '';
    if (!list) return;
    if (comments.length === 0) {
      list.innerHTML = '<div style="font-size:0.75rem;color:var(--dim);text-align:center;padding:0.5rem">No comments yet</div>';
      return;
    }
    list.innerHTML = comments.map(function(c) {
      return '<div class="comment"><div class="comment-header"><span class="comment-author">' + esc(c.author) + '</span><span class="comment-time">' + timeAgo(c.createdAt) + '</span></div><div class="comment-body">' + esc(c.text) + '</div></div>';
    }).join('');
  } catch(e) { }
}

async function postComment() {
  if (!currentDocId) return;
  var author = document.getElementById('c-author').value.trim();
  var text = document.getElementById('c-text').value.trim();
  if (!author) { toast('Enter your name', 'error'); return; }
  if (!text) { toast('Enter a comment', 'error'); return; }
  try {
    var res = await fetch('/api/docs/' + encodeURIComponent(currentDocId) + '/comments', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ author: author, text: text })
    });
    if (!res.ok) { var e = await res.json(); throw new Error(e.error); }
    localStorage.setItem('holm-author', author);
    document.getElementById('c-text').value = '';
    toast('Comment posted');
    loadComments(currentDocId);
  } catch(e) { toast(e.message, 'error'); }
}

/* ── Search ── */
var searchTimer = null;

function openSearch() {
  document.getElementById('search-overlay').classList.add('open');
  var input = document.getElementById('search-input');
  input.value = '';
  input.focus();
  document.getElementById('search-results').innerHTML = '<div class="search-empty">Type to search across all documents</div>';
}

function closeSearch() {
  document.getElementById('search-overlay').classList.remove('open');
}

document.getElementById('search-input').addEventListener('input', function(e) {
  clearTimeout(searchTimer);
  var q = e.target.value.trim();
  if (!q) {
    document.getElementById('search-results').innerHTML = '<div class="search-empty">Type to search</div>';
    return;
  }
  searchTimer = setTimeout(function() { doSearch(q); }, 250);
});

async function doSearch(q) {
  var el = document.getElementById('search-results');
  try {
    var res = await fetch('/api/search?q=' + encodeURIComponent(q));
    var results = await res.json();
    if (results.length === 0) { el.innerHTML = '<div class="search-empty">No results</div>'; return; }
    el.innerHTML = results.map(function(r) {
      return '<div class="search-result" onclick="closeSearch();openDoc(\'' + esc(r.docId) + '\')">' +
        '<div class="sr-id">' + esc(r.docId) + ' · ' + esc(r.domainName || r.domain) + '</div>' +
        '<div class="sr-title">' + esc(r.title) + '</div>' +
        '<div class="sr-snippet">' + (r.snippet || '') + '</div></div>';
    }).join('');
  } catch(e) { el.innerHTML = '<div class="search-empty">Search failed</div>'; }
}

/* ── Keyboard Shortcuts ── */
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    if (document.getElementById('search-overlay').classList.contains('open')) closeSearch();
    else goBack();
    return;
  }
  var tag = (e.target.tagName || '').toLowerCase();
  if (tag === 'input' || tag === 'textarea') return;
  if (e.key === '/' && !e.ctrlKey && !e.metaKey) { e.preventDefault(); openSearch(); }
});

/* ── Offline ── */
window.addEventListener('online', function() { document.body.classList.remove('offline'); toast('Back online'); });
window.addEventListener('offline', function() { document.body.classList.add('offline'); });

/* ── Service Worker ── */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(function() {});
}

async function openRandom() {
  try {
    var res = await fetch('/api/random');
    if (!res.ok) throw new Error();
    var doc = await res.json();
    if (doc && doc.docId) openDoc(doc.docId);
  } catch(e) {
    // Fallback: pick random from allDocs
    if (allDocs.length > 0) {
      var idx = Math.floor(Math.random() * allDocs.length);
      openDoc(allDocs[idx].docId);
    }
  }
}

/* ── Init ── */
async function init() {
  try {
    var res = await fetch('/api/docs');
    if (!res.ok) throw new Error();
    allDocs = await res.json();
    docsById = {};
    allDocs.forEach(function(d) { docsById[d.docId] = d; });
    document.getElementById('doc-count').textContent = allDocs.length + ' docs';

    var h = location.hash.slice(1);
    if (h.startsWith('d/')) { openDomain(h.slice(2)); }
    else if (h && docsById[h]) { currentDocId = h; renderDoc(h); }
    else renderHome();
  } catch(e) {
    document.getElementById('loading').textContent = 'Failed to load — retrying...';
    setTimeout(init, 3000);
  }
}


/* ── Back to Top ── */
var backTop = document.getElementById('back-top');
window.addEventListener('scroll', function() {
  backTop.classList.toggle('show', window.scrollY > 400);
});


/* ── Reading Progress ── */
var progressBar = document.getElementById('progress-bar');
window.addEventListener('scroll', function() {
  if (currentDocId) {
    var h = document.documentElement.scrollHeight - window.innerHeight;
    var pct = h > 0 ? Math.min(100, (window.scrollY / h) * 100) : 0;
    progressBar.style.width = pct + '%';
    progressBar.classList.add('visible');
  } else {
    progressBar.classList.remove('visible');
    progressBar.style.width = '0%';
  }
});

init();
</script>
</body>
</html>
