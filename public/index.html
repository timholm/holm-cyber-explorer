<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HOLM VAULT</title>
<style>
:root {
  --bg-primary: #1e1e2e;
  --bg-secondary: #181825;
  --bg-tertiary: #11111b;
  --bg-surface: #313244;
  --bg-hover: #45475a;
  --text-primary: #cdd6f4;
  --text-secondary: #a6adc8;
  --text-muted: #6c7086;
  --accent: #89b4fa;
  --accent-dim: #2a3a5c;
  --green: #a6e3a1;
  --red: #f38ba8;
  --yellow: #f9e2af;
  --peach: #fab387;
  --mauve: #cba6f7;
  --teal: #94e2d5;
  --pink: #f5c2e7;
  --border: #313244;
  --sidebar-width: 260px;
  --backlinks-width: 240px;
  --header-height: 48px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  height: 100vh;
  overflow: hidden;
}
a { color: var(--accent); text-decoration: none; }
a:hover { text-decoration: underline; }

/* HEADER */
.header {
  height: var(--header-height);
  background: var(--bg-tertiary);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 16px;
  gap: 12px;
  z-index: 100;
}
.header-brand {
  font-weight: 700;
  font-size: 14px;
  color: var(--accent);
  letter-spacing: 1px;
  white-space: nowrap;
}
.hamburger {
  display: none;
  background: none;
  border: none;
  color: var(--text-primary);
  font-size: 20px;
  cursor: pointer;
  padding: 4px 8px;
}
.search-box {
  flex: 1;
  max-width: 400px;
  position: relative;
}
.search-box input {
  width: 100%;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text-primary);
  padding: 6px 12px 6px 32px;
  font-size: 13px;
  outline: none;
}
.search-box input:focus { border-color: var(--accent); }
.search-box::before {
  content: '⌕';
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  font-size: 14px;
}
.search-results {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 6px;
  margin-top: 4px;
  max-height: 400px;
  overflow-y: auto;
  display: none;
  z-index: 200;
}
.search-results.active { display: block; }
.search-result-item {
  padding: 8px 12px;
  cursor: pointer;
  border-bottom: 1px solid var(--border);
}
.search-result-item:hover { background: var(--bg-hover); }
.search-result-item .sr-id { color: var(--accent); font-size: 11px; font-weight: 600; }
.search-result-item .sr-title { font-size: 13px; }
.sr-snippet { font-size: 12px; color: var(--text-muted); margin-top: 2px; max-height: 36px; overflow: hidden; }
.search-result-item mark { background: rgba(249,226,175,0.3); color: var(--yellow); padding: 0 2px; border-radius: 2px; }
.header-actions { display: flex; gap: 8px; margin-left: auto; }
.header-btn {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  color: var(--text-primary);
  padding: 5px 12px;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  white-space: nowrap;
}
.header-btn:hover { background: var(--bg-hover); }
.header-btn.active { background: var(--accent-dim); border-color: var(--accent); }

/* TAB BAR */
.tab-bar {
  display: flex;
  background: var(--bg-tertiary);
  border-bottom: 1px solid var(--border);
  overflow-x: auto;
  min-height: 0;
  scrollbar-width: none;
  flex-shrink: 0;
}
.tab-bar::-webkit-scrollbar { display: none; }
.tab-bar:empty { min-height: 0; border: none; }
.tab {
  display: flex;
  align-items: center;
  padding: 4px 12px;
  font-size: 12px;
  cursor: pointer;
  border-right: 1px solid var(--border);
  white-space: nowrap;
  color: var(--text-muted);
  gap: 6px;
  max-width: 180px;
  min-width: 0;
  user-select: none;
}
.tab:hover { background: var(--bg-surface); }
.tab.active { background: var(--bg-primary); color: var(--text-primary); border-bottom: 2px solid var(--accent); }
.tab-close { font-size: 14px; opacity: 0.5; line-height: 1; flex-shrink: 0; border-radius: 3px; padding: 0 2px; }
.tab-close:hover { opacity: 1; background: var(--bg-hover); }
.tab-title { overflow: hidden; text-overflow: ellipsis; min-width: 0; }
.tab-id { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 10px; color: var(--accent); opacity: 0.8; flex-shrink: 0; }
.tab.active .tab-id { opacity: 1; }

/* LAYOUT */
.layout {
  display: flex;
  height: calc(100vh - var(--header-height));
}

/* SIDEBAR */
.sidebar {
  width: var(--sidebar-width);
  min-width: var(--sidebar-width);
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  overflow-x: hidden;
  padding: 8px 0;
  transition: transform 0.2s;
}
.sidebar-filter {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
}
.filter-tag {
  display: inline-block;
  background: var(--accent-dim);
  color: var(--accent);
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  margin: 2px;
  cursor: pointer;
}
.filter-tag:hover { background: var(--bg-hover); }
.filter-tag.active { background: var(--accent); color: var(--bg-tertiary); }
.clear-filter { font-size: 11px; color: var(--text-muted); cursor: pointer; margin-left: 4px; }
.clear-filter:hover { color: var(--red); }
.sidebar-section { margin-bottom: 2px; }
.sidebar-section-header {
  display: flex;
  align-items: center;
  padding: 6px 12px;
  cursor: pointer;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-secondary);
  user-select: none;
}
.sidebar-section-header:hover { color: var(--text-primary); }
.sidebar-section-header .chevron {
  margin-right: 6px;
  font-size: 8px;
  transition: transform 0.2s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 12px;
  flex-shrink: 0;
}
.sidebar-section.collapsed .chevron { transform: rotate(-90deg); }
.sidebar-items-wrap {
  overflow: hidden;
  transition: height 0.2s ease;
}
.sidebar-item {
  display: flex;
  align-items: center;
  padding: 4px 12px 4px 28px;
  cursor: pointer;
  font-size: 13px;
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.sidebar-item:hover { background: var(--bg-hover); color: var(--text-primary); }
.sidebar-item.active { background: var(--accent-dim); color: var(--accent); }
.sidebar-item .doc-id {
  color: var(--text-muted);
  font-size: 11px;
  font-family: monospace;
  margin-right: 8px;
  min-width: 56px;
}
.sidebar-item .doc-title { overflow: hidden; text-overflow: ellipsis; }
.doc-count {
  padding: 8px 12px;
  font-size: 11px;
  color: var(--text-muted);
  border-top: 1px solid var(--border);
}

/* MAIN CONTENT */
.main-content {
  flex: 1;
  overflow-y: auto;
  padding: 32px 48px;
  min-width: 0;
  position: relative;
}
.welcome {
  max-width: 600px;
  margin: 80px auto;
  text-align: center;
}
.welcome h1 { font-size: 28px; margin-bottom: 12px; color: var(--accent); }
.welcome p { color: var(--text-secondary); font-size: 14px; line-height: 1.6; }
.welcome .stats { margin-top: 24px; display: flex; gap: 24px; justify-content: center; }
.welcome .stat { text-align: center; }
.welcome .stat-num { font-size: 28px; font-weight: 700; color: var(--accent); }
.welcome .stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; }

/* BREADCRUMB */
.breadcrumb {
  display: none;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--text-muted);
  margin-bottom: 12px;
  user-select: none;
}
.breadcrumb.active { display: flex; }
.breadcrumb .bc-separator { color: var(--text-muted); opacity: 0.5; font-size: 10px; }
.breadcrumb .bc-vault { color: var(--text-muted); }
.breadcrumb .bc-domain {
  color: var(--text-secondary);
  cursor: pointer;
  border-radius: 3px;
  padding: 1px 4px;
  transition: color 0.15s, background 0.15s;
}
.breadcrumb .bc-domain:hover { color: var(--accent); background: var(--accent-dim); }
.breadcrumb .bc-current { color: var(--text-muted); font-family: 'SF Mono', 'Fira Code', monospace; font-size: 11px; }

/* DOC VIEWER */
.doc-viewer { display: none; max-width: 860px; }
.doc-viewer.active { display: block; }
.doc-header { margin-bottom: 24px; }
.doc-header h1 { font-size: 24px; line-height: 1.3; margin-bottom: 8px; }
.doc-badges { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
.doc-badge-pill { display: inline-flex; align-items: center; font-size: 11px; font-weight: 600; padding: 2px 10px; border-radius: 9999px; line-height: 1.6; letter-spacing: 0.2px; white-space: nowrap; border: 1px solid transparent; }
.doc-badge-pill.badge-version { background: rgba(137,180,250,0.15); color: var(--accent); border-color: rgba(137,180,250,0.3); }
.doc-badge-pill.badge-status-ratified { background: rgba(166,227,161,0.15); color: var(--green); border-color: rgba(166,227,161,0.3); }
.doc-badge-pill.badge-status-draft { background: rgba(249,226,175,0.15); color: var(--yellow); border-color: rgba(249,226,175,0.3); }
.doc-badge-pill.badge-status-active { background: rgba(137,180,250,0.15); color: var(--accent); border-color: rgba(137,180,250,0.3); }
.doc-badge-pill.badge-status-deprecated { background: rgba(243,139,168,0.15); color: var(--red); border-color: rgba(243,139,168,0.3); }
.doc-badge-pill.badge-status-other { background: rgba(108,112,134,0.15); color: var(--text-muted); border-color: rgba(108,112,134,0.3); }
.doc-badge-pill.badge-date { background: rgba(108,112,134,0.10); color: var(--text-muted); border-color: rgba(108,112,134,0.2); font-weight: 500; }
.doc-meta { display: flex; gap: 12px; flex-wrap: wrap; font-size: 12px; color: var(--text-muted); }
.doc-meta .badge { background: var(--bg-surface); padding: 2px 8px; border-radius: 4px; }
.doc-reading-info { font-size: 12px; color: var(--text-muted); margin-top: 6px; letter-spacing: 0.2px; }
.doc-toolbar {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  border-bottom: 1px solid var(--border);
  padding-bottom: 12px;
}
.doc-toolbar button {
  background: none;
  border: 1px solid var(--border);
  color: var(--text-secondary);
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
}
.doc-toolbar button:hover { color: var(--text-primary); background: var(--bg-surface); }
.doc-toolbar button.active { color: var(--accent); border-color: var(--accent); }
.doc-body { font-size: 15px; line-height: 1.7; color: var(--text-primary); }
.doc-body h1 { font-size: 22px; margin: 24px 0 12px; color: var(--text-primary); }
.doc-body h2 { font-size: 18px; margin: 20px 0 10px; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 4px; }
.doc-body h3 { font-size: 15px; margin: 16px 0 8px; color: var(--peach); }
.doc-body p { margin: 8px 0; }
.doc-body ul, .doc-body ol { margin: 8px 0 8px 24px; }
.doc-body li { margin: 4px 0; }
.doc-body em { color: var(--yellow); font-style: italic; }
.doc-body strong { color: var(--text-primary); font-weight: 700; }
.doc-body blockquote {
  border-left: 3px solid var(--accent);
  padding: 8px 16px;
  margin: 12px 0;
  background: var(--bg-secondary);
  border-radius: 0 4px 4px 0;
}
.doc-body code { background: var(--bg-surface); padding: 1px 5px; border-radius: 3px; font-size: 13px; font-family: 'SF Mono', 'Fira Code', monospace; }
.doc-body pre { background: var(--bg-tertiary); padding: 16px; border-radius: 6px; overflow-x: auto; margin: 12px 0; position: relative; }
.doc-body pre code { background: none; padding: 0; }

/* CODE BLOCK COPY BUTTON */
.code-copy-btn {
  position: absolute;
  top: 6px;
  right: 6px;
  background: rgba(49, 50, 68, 0.8);
  border: 1px solid var(--border);
  color: var(--text-muted);
  font-size: 11px;
  font-family: inherit;
  padding: 2px 8px;
  border-radius: 4px;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.15s, background 0.15s, color 0.15s;
  z-index: 1;
  line-height: 1.4;
}
.doc-body pre:hover .code-copy-btn { opacity: 1; }
.code-copy-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
.code-copy-btn.copied { color: var(--green); border-color: var(--green); }
.doc-body table { border-collapse: collapse; margin: 12px 0; width: 100%; }
.doc-body th, .doc-body td { border: 1px solid var(--border); padding: 8px 12px; font-size: 13px; text-align: left; }
.doc-body th { background: var(--bg-surface); font-weight: 600; }
.doc-body .metadata { display: none; }
.doc-body aside.metadata { display: none; }

/* Doc ID inline links */
a.doc-link { color: var(--accent); cursor: pointer; text-decoration: underline dotted; text-underline-offset: 3px; }

/* Doc link preview tooltip */
.doc-link-tooltip {
  position: fixed;
  z-index: 500;
  display: none;
  width: 320px;
  max-width: calc(100vw - 32px);
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: 8px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 2px 8px rgba(0, 0, 0, 0.3);
  padding: 12px 14px;
  pointer-events: none;
  font-size: 13px;
  line-height: 1.5;
}
.doc-link-tooltip.visible { display: block; }
.doc-link-tooltip-id {
  font-family: 'SF Mono', 'Fira Code', monospace;
  font-size: 11px;
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 4px;
}
.doc-link-tooltip-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 6px;
  line-height: 1.3;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}
.doc-link-tooltip-domain {
  font-size: 11px;
  color: var(--text-muted);
  margin-bottom: 6px;
}
.doc-link-tooltip-excerpt {
  font-size: 12px;
  color: var(--text-secondary);
  line-height: 1.5;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  margin-bottom: 6px;
}
.doc-link-tooltip-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}
.doc-link-tooltip-tag {
  display: inline-block;
  background: var(--accent-dim);
  color: var(--accent);
  padding: 1px 6px;
  border-radius: 3px;
  font-size: 10px;
}

/* Edit mode */
.edit-area {
  display: none;
  width: 100%;
  min-height: 500px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  color: var(--text-primary);
  font-family: 'SF Mono', 'Fira Code', monospace;
  font-size: 14px;
  line-height: 1.6;
  padding: 16px;
  border-radius: 6px;
  resize: vertical;
}
.edit-area.active { display: block; }
.save-bar { display: none; margin-top: 12px; gap: 8px; }
.save-bar.active { display: flex; }
.save-bar button { padding: 6px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; border: none; }
.save-btn { background: var(--accent); color: var(--bg-tertiary); font-weight: 600; }
.cancel-btn { background: var(--bg-surface); color: var(--text-secondary); border: 1px solid var(--border) !important; }

/* TABLE OF CONTENTS */
.toc-section { margin-bottom: 20px; }
.toc-item { display: block; padding: 2px 0; font-size: 13px; color: var(--text-secondary); cursor: pointer; }
.toc-item:hover { color: var(--text-primary); }
.toc-item.toc-h2 { padding-left: 0; }
.toc-item.toc-h3 { padding-left: 12px; font-size: 12px; }

/* LOCAL GRAPH */
.local-graph { width: 100%; height: 200px; border-bottom: 1px solid var(--border); margin-bottom: 12px; position: relative; }
.local-graph canvas { display: block; width: 100%; height: 100%; cursor: default; }
#localGraphTooltip {
  position: fixed;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  color: var(--text-primary);
  font-size: 11px;
  font-family: 'SF Mono', 'Fira Code', monospace;
  padding: 4px 8px;
  border-radius: 4px;
  pointer-events: none;
  white-space: nowrap;
  z-index: 999;
  display: none;
}

/* BACKLINKS PANEL */
.backlinks-panel {
  width: var(--backlinks-width);
  min-width: var(--backlinks-width);
  background: var(--bg-secondary);
  border-left: 1px solid var(--border);
  overflow-y: auto;
  padding: 16px;
  display: none;
}
.backlinks-panel.active { display: block; }
.backlinks-section { margin-bottom: 20px; }
.backlinks-section h3 {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  margin-bottom: 8px;
}
.backlink-item { display: block; padding: 4px 0; font-size: 13px; color: var(--accent); cursor: pointer; }
.backlink-item:hover { color: var(--text-primary); }
.tag-item {
  display: inline-block;
  background: var(--accent-dim);
  color: var(--accent);
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  margin: 2px 4px 2px 0;
  cursor: pointer;
}
.tag-item:hover { background: var(--bg-hover); }

/* LOADING */
.loading { display: flex; align-items: center; justify-content: center; height: 200px; color: var(--text-muted); }
.spinner {
  width: 24px;
  height: 24px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  margin-right: 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* STATUS BAR */
.status-bar {
  height: 24px;
  background: var(--bg-tertiary);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 16px;
  font-size: 11px;
  color: var(--text-muted);
  gap: 16px;
}

/* QUICK OPEN / COMMAND PALETTE */
.quick-open-overlay {
  position: fixed; inset: 0;
  background: rgba(0, 0, 0, 0.55);
  z-index: 300;
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding-top: 12vh;
  backdrop-filter: blur(2px);
}
.quick-open-panel {
  width: 100%; max-width: 500px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 10px;
  box-shadow: 0 24px 64px rgba(0, 0, 0, 0.6);
  overflow: hidden;
  display: flex; flex-direction: column;
  max-height: 70vh;
}
#quickOpenInput {
  width: 100%; background: var(--bg-surface); border: none;
  border-bottom: 1px solid var(--border);
  color: var(--text-primary); font-size: 15px; padding: 14px 16px;
  outline: none; font-family: inherit; flex-shrink: 0;
}
#quickOpenInput::placeholder { color: var(--text-muted); }
.quick-open-results { overflow-y: auto; flex: 1; }
.quick-open-item {
  display: flex; align-items: baseline; gap: 10px;
  padding: 9px 16px; cursor: pointer;
  border-bottom: 1px solid rgba(49, 50, 68, 0.5);
}
.quick-open-item:last-child { border-bottom: none; }
.quick-open-item:hover, .quick-open-item.selected { background: var(--bg-hover); }
.quick-open-item .qo-id { color: var(--accent); font-size: 11px; font-weight: 600; font-family: 'SF Mono', 'Fira Code', monospace; min-width: 60px; flex-shrink: 0; }
.quick-open-item .qo-title { font-size: 13px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.quick-open-empty { padding: 24px 16px; text-align: center; color: var(--text-muted); font-size: 13px; }
.quick-open-hint {
  padding: 7px 16px; font-size: 11px; color: var(--text-muted);
  background: var(--bg-tertiary); border-top: 1px solid var(--border);
  display: flex; gap: 16px; flex-shrink: 0;
}
.quick-open-hint kbd {
  display: inline-block; background: var(--bg-surface); border: 1px solid var(--border);
  border-radius: 3px; padding: 0px 5px; font-size: 10px; font-family: inherit;
  color: var(--text-secondary); margin-right: 3px;
}

/* KEYBOARD SHORTCUTS MODAL */
.shortcuts-modal-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0, 0, 0, 0.65); z-index: 1000;
  align-items: center; justify-content: center;
  backdrop-filter: blur(2px);
}
.shortcuts-modal-overlay.active { display: flex; }
.shortcuts-modal {
  background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px;
  width: 520px; max-width: calc(100vw - 32px); max-height: calc(100vh - 64px);
  overflow-y: auto; box-shadow: 0 24px 64px rgba(0, 0, 0, 0.6);
}
.shortcuts-modal-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 18px 24px 14px; border-bottom: 1px solid var(--border);
}
.shortcuts-modal-header h2 { font-size: 15px; font-weight: 700; color: var(--text-primary); }
.shortcuts-modal-close {
  background: none; border: none; color: var(--text-muted); font-size: 20px;
  cursor: pointer; line-height: 1; padding: 2px 6px; border-radius: 4px;
}
.shortcuts-modal-close:hover { color: var(--text-primary); background: var(--bg-hover); }
.shortcuts-modal-body { padding: 16px 24px 20px; }
.shortcuts-group { margin-bottom: 20px; }
.shortcuts-group:last-child { margin-bottom: 0; }
.shortcuts-group-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-muted); margin-bottom: 8px; }
.shortcuts-table { width: 100%; border-collapse: collapse; }
.shortcuts-table tr + tr td { border-top: 1px solid var(--border); }
.shortcuts-table td { padding: 7px 0; font-size: 13px; vertical-align: middle; }
.shortcuts-table td:first-child { color: var(--text-secondary); padding-right: 24px; white-space: nowrap; }
.shortcuts-table td:last-child { color: var(--text-muted); text-align: right; }
.kbd {
  display: inline-block; background: var(--bg-surface); border: 1px solid var(--bg-hover);
  border-bottom-width: 2px; border-radius: 4px; padding: 1px 7px; font-size: 11px;
  font-family: 'SF Mono', 'Fira Code', monospace; color: var(--accent); white-space: nowrap;
}
.kbd + .kbd { margin-left: 4px; }

/* RESPONSIVE - MOBILE (below 768px) */
@media (max-width: 768px) {

  /* --- Hamburger menu button: touch-friendly 44px target --- */
  .hamburger {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 44px;
    min-height: 44px;
    font-size: 22px;
    padding: 0;
    border-radius: 6px;
    -webkit-tap-highlight-color: transparent;
  }
  .hamburger:active {
    background: var(--bg-hover);
  }

  /* --- Header: compact for mobile, no overflow --- */
  .header {
    padding: 0 8px;
    gap: 6px;
    overflow: hidden;
  }
  .header-brand {
    font-size: 12px;
    letter-spacing: 0.5px;
    flex-shrink: 0;
  }
  .search-box {
    max-width: none;
    min-width: 0;
    flex: 1;
  }
  .search-box input {
    font-size: 16px; /* prevents iOS auto-zoom on focus */
    padding: 8px 12px 8px 32px;
    min-height: 38px;
  }
  .header-actions {
    gap: 2px;
    flex-shrink: 0;
  }
  .header-actions .graph-label { display: none; }
  .header-btn {
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 6px;
    font-size: 15px;
    -webkit-tap-highlight-color: transparent;
  }
  .header-btn:active {
    background: var(--bg-hover);
  }

  /* --- Tab bar: horizontally scrollable with touch momentum --- */
  .tab-bar {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: x proximity;
    flex-shrink: 0;
  }
  .tab {
    min-height: 44px;
    padding: 6px 14px;
    font-size: 13px;
    scroll-snap-align: start;
    flex-shrink: 0;
    -webkit-tap-highlight-color: transparent;
  }
  .tab-close {
    min-width: 30px;
    min-height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    border-radius: 4px;
    -webkit-tap-highlight-color: transparent;
  }

  /* --- Layout: stack vertically on mobile --- */
  .layout {
    flex-direction: column;
    height: calc(100vh - var(--header-height));
    overflow: hidden;
  }

  /* --- Sidebar: fixed overlay sliding in from left --- */
  .sidebar {
    position: fixed;
    top: var(--header-height);
    left: 0;
    bottom: 24px;
    z-index: 50;
    transform: translateX(-100%);
    transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: none;
    will-change: transform;
  }
  .sidebar.open {
    transform: translateX(0);
    box-shadow: 6px 0 32px rgba(0, 0, 0, 0.5);
  }

  /* --- Sidebar overlay: tap outside to close --- */
  .sidebar-overlay {
    display: none;
    position: fixed;
    inset: 0;
    top: var(--header-height);
    bottom: 24px;
    background: rgba(0, 0, 0, 0.5);
    z-index: 49;
    -webkit-tap-highlight-color: transparent;
  }
  .sidebar-overlay.active {
    display: block;
  }

  /* --- Sidebar items: touch-friendly 44px tap targets --- */
  .sidebar-section-header {
    min-height: 44px;
    padding: 8px 12px;
    display: flex;
    align-items: center;
    -webkit-tap-highlight-color: transparent;
  }
  .sidebar-item {
    min-height: 44px;
    padding: 8px 12px 8px 28px;
    display: flex;
    align-items: center;
    -webkit-tap-highlight-color: transparent;
  }
  .sidebar-item:active {
    background: var(--bg-hover);
  }
  .filter-tag {
    min-height: 34px;
    display: inline-flex;
    align-items: center;
    padding: 4px 14px;
    font-size: 12px;
  }
  .clear-filter {
    min-width: 44px;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  /* --- Main content: reduced padding --- */
  .main-content {
    padding: 16px 14px;
    flex: 1;
    min-height: 0;
    overflow-y: auto;
  }
  .welcome {
    margin: 40px auto;
    padding: 0 8px;
  }
  .welcome h1 { font-size: 22px; }
  .welcome p { font-size: 13px; }
  .welcome .stats { gap: 16px; flex-wrap: wrap; }
  .welcome .stat-num { font-size: 22px; }

  /* --- Doc viewer --- */
  .doc-header h1 { font-size: 18px; word-break: break-word; }
  .doc-meta { font-size: 11px; gap: 6px; }
  .doc-meta .badge { padding: 3px 8px; }
  .doc-body { font-size: 14px; line-height: 1.65; }
  .doc-body h1 { font-size: 19px; }
  .doc-body h2 { font-size: 16px; }
  .doc-body h3 { font-size: 14px; }
  .doc-body pre {
    padding: 12px;
    font-size: 12px;
    -webkit-overflow-scrolling: touch;
  }
  .doc-body table {
    display: block;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  .doc-body blockquote {
    padding: 6px 12px;
    margin: 8px 0;
  }
  .doc-body ul, .doc-body ol { margin-left: 18px; }

  /* --- Code copy button: always visible on mobile (no hover) --- */
  .code-copy-btn {
    opacity: 1;
    min-width: 44px;
    min-height: 32px;
    padding: 4px 10px;
    font-size: 12px;
  }

  /* --- Doc toolbar: scrollable, prevents overflow --- */
  .doc-toolbar {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    flex-wrap: nowrap;
    gap: 6px;
    padding-bottom: 10px;
    margin-bottom: 16px;
    scrollbar-width: none;
  }
  .doc-toolbar::-webkit-scrollbar { display: none; }
  .doc-toolbar button {
    min-height: 44px;
    min-width: 44px;
    padding: 8px 16px;
    flex-shrink: 0;
    white-space: nowrap;
    font-size: 13px;
    -webkit-tap-highlight-color: transparent;
  }

  /* --- Backlinks panel: moves below content (not side-by-side) --- */
  .backlinks-panel {
    width: 100%;
    min-width: 100%;
    max-height: none;
    border-left: none;
    border-top: 1px solid var(--border);
    overflow-y: auto;
    flex-shrink: 0;
    padding: 14px;
  }
  .backlinks-panel.active {
    display: block;
    max-height: 45vh;
  }
  .backlink-item {
    min-height: 44px;
    display: flex;
    align-items: center;
    padding: 6px 0;
    -webkit-tap-highlight-color: transparent;
  }
  .tag-item {
    min-height: 34px;
    display: inline-flex;
    align-items: center;
    padding: 4px 14px;
    font-size: 12px;
  }
  .toc-item {
    min-height: 38px;
    display: flex;
    align-items: center;
    -webkit-tap-highlight-color: transparent;
  }
  .local-graph {
    height: 160px;
  }
  .backlinks-section h3 {
    min-height: 32px;
    display: flex;
    align-items: center;
  }

  /* --- Quick open palette: full-width on mobile --- */
  .quick-open-overlay {
    padding-top: 0;
    align-items: flex-start;
  }
  .quick-open-panel {
    max-width: 100%;
    width: 100%;
    border-radius: 0 0 10px 10px;
    max-height: 85vh;
  }
  #quickOpenInput {
    font-size: 16px; /* prevents iOS zoom */
    padding: 16px;
    min-height: 52px;
  }
  .quick-open-item {
    min-height: 48px;
    padding: 10px 16px;
    display: flex;
    align-items: center;
    -webkit-tap-highlight-color: transparent;
  }
  .quick-open-hint {
    flex-wrap: wrap;
    padding: 8px 16px;
    gap: 8px;
  }

  /* --- Search results dropdown --- */
  .search-results {
    max-height: 60vh;
  }
  .search-result-item {
    min-height: 44px;
    padding: 10px 12px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
  }

  /* --- Shortcuts modal --- */
  .shortcuts-modal {
    width: calc(100vw - 16px);
    max-height: calc(100vh - 32px);
  }
  .shortcuts-modal-body { padding: 12px 16px 16px; }
  .shortcuts-modal-header { padding: 14px 16px 10px; }
  .shortcuts-modal-close {
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* --- Favorites button: touch-friendly --- */
  .favorite-btn {
    min-width: 44px;
    min-height: 44px;
  }
  .sidebar-section.favorites-section .sidebar-item .fav-remove {
    opacity: 0.6;
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* --- Scroll-to-top: touch-friendly --- */
  .scroll-to-top {
    bottom: 16px;
    right: 16px;
    width: 44px;
    height: 44px;
  }

  /* --- Status bar --- */
  .status-bar {
    font-size: 10px;
    padding: 0 8px;
    gap: 8px;
    overflow: hidden;
    white-space: nowrap;
  }

  /* --- Edit area --- */
  .edit-area {
    font-size: 14px;
    padding: 12px;
    min-height: 300px;
  }
  .save-bar button {
    min-height: 44px;
    min-width: 80px;
    padding: 8px 20px;
    font-size: 14px;
    -webkit-tap-highlight-color: transparent;
  }

  /* --- Breadcrumb --- */
  .breadcrumb {
    font-size: 11px;
    flex-wrap: wrap;
    gap: 4px;
  }
  .breadcrumb .bc-domain {
    min-height: 28px;
    display: inline-flex;
    align-items: center;
    padding: 2px 6px;
  }

  /* --- Doc links: touch-friendly --- */
  a.doc-link {
    padding: 2px 0;
  }
}

/* Extra small screens (below 480px) */
@media (max-width: 480px) {
  .header-brand { display: none; }
  .main-content { padding: 12px 10px; }
  .doc-header h1 { font-size: 16px; }
  .doc-body { font-size: 13px; line-height: 1.6; }
  .doc-body h1 { font-size: 17px; }
  .doc-body h2 { font-size: 15px; }
  .doc-body h3 { font-size: 13px; }
  .welcome h1 { font-size: 18px; }
  .welcome p { font-size: 12px; }
  .quick-open-panel { border-radius: 0; }
  .doc-meta { gap: 4px; }
  .doc-meta .badge { font-size: 10px; }
}

/* FAVORITES STAR BUTTON (doc toolbar) */
.favorite-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--text-muted);
  font-size: 16px;
  cursor: pointer;
  padding: 4px 10px;
  border-radius: 4px;
  line-height: 1;
  transition: color 0.15s, border-color 0.15s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  margin-left: auto;
}
.favorite-btn:hover { color: var(--yellow); border-color: var(--yellow); background: var(--bg-surface); }
.favorite-btn.favorited { color: var(--yellow); border-color: var(--yellow); }

/* FAVORITES SIDEBAR SECTION */
.sidebar-section.favorites-section .sidebar-section-header {
  color: var(--yellow);
}
.sidebar-section.favorites-section .sidebar-item {
  padding-right: 8px;
}
.sidebar-section.favorites-section .sidebar-item .fav-remove {
  margin-left: auto;
  font-size: 13px;
  color: var(--text-muted);
  opacity: 0;
  padding: 0 4px;
  cursor: pointer;
  flex-shrink: 0;
  transition: opacity 0.15s;
  line-height: 1;
}
.sidebar-section.favorites-section .sidebar-item:hover .fav-remove {
  opacity: 1;
}
.sidebar-section.favorites-section .sidebar-item .fav-remove:hover {
  color: var(--red);
}
.sidebar-section.favorites-section .sidebar-items-empty {
  padding: 4px 12px 8px 28px;
  font-size: 12px;
  color: var(--text-muted);
  font-style: italic;
}

/* SCROLL-TO-TOP BUTTON */
.scroll-to-top {
  position: absolute;
  bottom: 24px;
  right: 24px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(49, 50, 68, 0.85);
  border: 1px solid var(--border);
  color: var(--accent);
  font-size: 18px;
  line-height: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 30;
  opacity: 0;
  transform: translateY(12px);
  pointer-events: none;
  transition: opacity 0.25s ease, transform 0.25s ease, background 0.15s ease, border-color 0.15s ease;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.35);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
.scroll-to-top.visible {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}
.scroll-to-top:hover {
  background: rgba(69, 71, 90, 0.95);
  color: var(--text-primary);
  border-color: var(--accent);
}
.scroll-to-top:active {
  transform: scale(0.92);
}


/* RECENTLY VIEWED */
.recent-section { border-bottom: 1px solid var(--border); padding-bottom: 4px; margin-bottom: 4px; }
.recent-section-header {
  display: flex;
  align-items: center;
  padding: 6px 12px;
  cursor: pointer;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--yellow);
  user-select: none;
}
.recent-section-header:hover { color: var(--text-primary); }
.recent-section-header .chevron {
  margin-right: 6px;
  font-size: 10px;
  transition: transform 0.15s;
  display: inline-block;
  width: 12px;
}
.recent-section.collapsed .chevron { transform: rotate(-90deg); }
.recent-section.collapsed .recent-items { display: none; }
.recent-section.collapsed .recent-clear-btn { display: none; }
.recent-clear-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--text-muted);
  font-size: 10px;
  padding: 1px 6px;
  border-radius: 3px;
  cursor: pointer;
  margin-left: auto;
  line-height: 1.4;
}
.recent-clear-btn:hover { color: var(--red); border-color: var(--red); }

/* FULLSCREEN / FOCUS MODE */
body.fullscreen-mode .sidebar {
  width: 0; min-width: 0; padding: 0; overflow: hidden;
  border-right-color: transparent; opacity: 0; pointer-events: none;
}
body.fullscreen-mode .backlinks-panel {
  width: 0; min-width: 0; padding: 0; overflow: hidden;
  border-left-color: transparent; opacity: 0; pointer-events: none;
}
body.fullscreen-mode .tab-bar {
  max-height: 0; min-height: 0; overflow: hidden; border-bottom: none; opacity: 0;
}
body.fullscreen-mode .main-content {
  padding: 48px 64px;
}
body.fullscreen-mode .doc-viewer {
  max-width: 800px;
  margin: 0 auto;
}
body.fullscreen-mode .welcome {
  max-width: 800px;
}
body.fullscreen-mode #fullscreenToggle {
  background: var(--accent-dim);
  border-color: var(--accent);
  color: var(--accent);
}

/* Smooth transitions for fullscreen */
.sidebar {
  transition: width 0.3s ease, min-width 0.3s ease, opacity 0.25s ease,
              padding 0.3s ease, border-right-color 0.3s ease, transform 0.2s;
}
.backlinks-panel {
  transition: width 0.3s ease, min-width 0.3s ease, opacity 0.25s ease,
              padding 0.3s ease, border-left-color 0.3s ease;
}
.tab-bar {
  transition: max-height 0.3s ease, opacity 0.25s ease;
}
.main-content {
  transition: padding 0.3s ease;
}
.doc-viewer {
  transition: max-width 0.3s ease, margin 0.3s ease;
}

/* Floating exit hint */
.fullscreen-exit-hint {
  display: none;
  position: fixed;
  bottom: 36px;
  left: 50%;
  transform: translateX(-50%) translateY(8px);
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  color: var(--text-muted);
  padding: 6px 16px;
  border-radius: 8px;
  font-size: 12px;
  z-index: 150;
  cursor: pointer;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.3s ease, transform 0.3s ease;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
  user-select: none;
}
.fullscreen-exit-hint:hover {
  color: var(--text-primary);
  border-color: var(--accent);
}
.fullscreen-exit-hint .kbd {
  font-size: 10px;
  margin-left: 6px;
}
body.fullscreen-mode .fullscreen-exit-hint {
  display: block;
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* Scrollbar */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg-secondary); }
::-webkit-scrollbar-thumb { background: var(--bg-hover); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* ─── PRINT STYLES ───────────────────────────────────────────────────────── */
@media print {
  /* Reset base colors for paper */
  * { color-adjust: exact; -webkit-print-color-adjust: exact; }
  html, body {
    background: #fff !important;
    color: #000 !important;
    height: auto !important;
    overflow: visible !important;
    font-size: 12pt;
  }

  /* Hide all chrome: sidebar, backlinks, toolbar, tabs, header, graph, overlays, status bar */
  .header,
  .tab-bar,
  .sidebar,
  .sidebar-overlay,
  .backlinks-panel,
  .doc-toolbar,
  .status-bar,
  .quick-open-overlay,
  .shortcuts-modal-overlay,
  .search-results,
  .local-graph,
  #localGraphTooltip,
  .hamburger,
  .welcome,
  .edit-area,
  .save-bar,
  .loading,
  .breadcrumb,
  .code-copy-btn,
  .doc-reading-info,
  .fullscreen-exit-hint { display: none !important; }

  /* Layout: full width, no flex constraints */
  .layout {
    display: block !important;
    height: auto !important;
    overflow: visible !important;
  }
  .main-content {
    padding: 0 !important;
    overflow: visible !important;
    width: 100% !important;
    max-width: 100% !important;
  }
  .doc-viewer {
    display: block !important;
    max-width: 100% !important;
  }

  /* Doc header: show title and ID prominently at top of printed page */
  .doc-header {
    margin-bottom: 16pt !important;
    border-bottom: 2pt solid #000;
    padding-bottom: 10pt;
  }
  .doc-header h1 {
    font-size: 20pt !important;
    color: #000 !important;
    margin-bottom: 6pt !important;
  }
  .doc-meta {
    font-size: 10pt !important;
    color: #333 !important;
  }
  .doc-meta .badge {
    background: #eee !important;
    color: #333 !important;
    border: 1px solid #ccc;
    padding: 1pt 6pt;
  }

  /* Body text */
  .doc-body {
    font-size: 11pt !important;
    line-height: 1.6 !important;
    color: #000 !important;
  }
  .doc-body h1 {
    font-size: 18pt !important;
    color: #000 !important;
    margin: 18pt 0 8pt !important;
  }
  .doc-body h2 {
    font-size: 15pt !important;
    color: #000 !important;
    border-bottom: 1px solid #999 !important;
    padding-bottom: 3pt !important;
    margin: 14pt 0 7pt !important;
  }
  .doc-body h3 {
    font-size: 13pt !important;
    color: #222 !important;
    margin: 10pt 0 5pt !important;
  }
  .doc-body p { color: #000 !important; }
  .doc-body em { color: #000 !important; font-style: italic; }
  .doc-body strong { color: #000 !important; }
  .doc-body ul, .doc-body ol { color: #000 !important; }
  .doc-body li { color: #000 !important; }
  .doc-body blockquote {
    border-left: 3px solid #666 !important;
    background: #f5f5f5 !important;
    color: #000 !important;
    padding: 6pt 12pt !important;
  }

  /* Inline code */
  .doc-body code {
    background: #f0f0f0 !important;
    color: #000 !important;
    border: 1px solid #ddd;
    padding: 0pt 3pt;
    font-size: 9pt !important;
  }

  /* Code blocks: avoid page breaks inside, clean border */
  .doc-body pre {
    background: #f5f5f5 !important;
    color: #000 !important;
    border: 1px solid #ccc;
    padding: 10pt !important;
    border-radius: 0 !important;
    page-break-inside: avoid;
    break-inside: avoid;
    overflow-x: visible !important;
    white-space: pre-wrap !important;
    word-wrap: break-word !important;
  }
  .doc-body pre code {
    background: none !important;
    border: none !important;
    color: #000 !important;
  }

  /* Tables: avoid page breaks inside, clean borders */
  .doc-body table {
    page-break-inside: avoid;
    break-inside: avoid;
    border-collapse: collapse !important;
    width: 100% !important;
  }
  .doc-body th, .doc-body td {
    border: 1px solid #999 !important;
    padding: 5pt 8pt !important;
    font-size: 10pt !important;
    color: #000 !important;
  }
  .doc-body th {
    background: #e8e8e8 !important;
    font-weight: 700 !important;
    color: #000 !important;
  }

  /* Links: show URL after the link text */
  .doc-body a[href]::after {
    content: " (" attr(href) ")";
    font-size: 9pt;
    color: #555;
    font-style: italic;
    word-break: break-all;
  }
  /* Doc-link cross-references (onclick-based, no href) -- keep clean */
  a.doc-link::after { content: none !important; }
  a.doc-link { color: #000 !important; text-decoration: underline !important; }

  /* General link styling for print */
  a { color: #000 !important; text-decoration: underline !important; }

  /* Headings: avoid orphaned headings at bottom of page */
  .doc-body h1, .doc-body h2, .doc-body h3 {
    page-break-after: avoid;
    break-after: avoid;
  }

  /* Images: avoid breaking */
  .doc-body img {
    max-width: 100% !important;
    page-break-inside: avoid;
    break-inside: avoid;
  }

  /* Page margins */
  @page {
    margin: 2cm;
  }
}

/* STATS DASHBOARD */
.stats-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.75);
  z-index: 500;
  backdrop-filter: blur(4px);
  overflow-y: auto;
}
.stats-overlay.active { display: block; }
.stats-dashboard {
  max-width: 900px;
  margin: 40px auto;
  padding: 32px 40px 48px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: 0 24px 64px rgba(0, 0, 0, 0.6);
  position: relative;
}
.stats-dashboard-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 28px;
  border-bottom: 1px solid var(--border);
  padding-bottom: 16px;
}
.stats-dashboard-header h2 {
  font-size: 18px;
  font-weight: 700;
  color: var(--accent);
  letter-spacing: 0.5px;
}
.stats-close-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--text-muted);
  font-size: 18px;
  cursor: pointer;
  padding: 4px 10px;
  border-radius: 6px;
  line-height: 1;
}
.stats-close-btn:hover { color: var(--text-primary); background: var(--bg-hover); }
.stats-summary {
  display: flex;
  gap: 24px;
  margin-bottom: 32px;
  flex-wrap: wrap;
}
.stats-card {
  flex: 1;
  min-width: 140px;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px 20px;
  text-align: center;
}
.stats-card-num {
  font-size: 32px;
  font-weight: 700;
  color: var(--accent);
  line-height: 1.2;
}
.stats-card-label {
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-top: 4px;
}
.stats-section {
  margin-bottom: 28px;
}
.stats-section h3 {
  font-size: 13px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-secondary);
  margin-bottom: 12px;
}
.stats-bar-chart {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.stats-bar-row {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 12px;
}
.stats-bar-label {
  min-width: 160px;
  max-width: 200px;
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-align: right;
  flex-shrink: 0;
}
.stats-bar-track {
  flex: 1;
  height: 20px;
  background: var(--bg-tertiary);
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}
.stats-bar-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.4s ease;
  min-width: 2px;
}
.stats-bar-value {
  min-width: 36px;
  color: var(--text-muted);
  font-size: 11px;
  font-family: 'SF Mono', 'Fira Code', monospace;
  text-align: right;
  flex-shrink: 0;
}
.stats-table {
  width: 100%;
  border-collapse: collapse;
}
.stats-table th {
  text-align: left;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.3px;
  padding: 6px 10px;
  border-bottom: 1px solid var(--border);
}
.stats-table td {
  padding: 6px 10px;
  font-size: 13px;
  border-bottom: 1px solid rgba(49, 50, 68, 0.5);
  color: var(--text-secondary);
}
.stats-table tr:hover td { background: var(--bg-surface); }
.stats-table .st-docid {
  color: var(--accent);
  font-family: 'SF Mono', 'Fira Code', monospace;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
}
.stats-table .st-docid:hover { text-decoration: underline; }
.stats-table .st-num {
  text-align: right;
  font-family: 'SF Mono', 'Fira Code', monospace;
  font-size: 12px;
  color: var(--text-muted);
}
.stats-columns {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 28px;
}
@media (max-width: 768px) {
  .stats-dashboard { margin: 16px; padding: 20px; }
  .stats-columns { grid-template-columns: 1fr; }
  .stats-bar-label { min-width: 100px; max-width: 120px; }
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <button class="hamburger" onclick="toggleSidebar()">☰</button>
  <div class="header-brand">HOLM VAULT</div>
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Search docs... (Cmd+K)" autocomplete="off">
    <div class="search-results" id="searchResults"></div>
  </div>
  <div class="header-actions">
    <button class="header-btn" onclick="window.open('/graph.html','_blank')"><span class="graph-label">Graph </span>⬡</button>
    <button class="header-btn" id="statsBtn" onclick="openStatsDashboard()" title="Domain Statistics"><span class="graph-label">Stats </span>&#x25A4;</button>
    <button class="header-btn" id="backlinkToggle" onclick="toggleBacklinks()">◫</button>
    <button class="header-btn" id="fullscreenToggle" onclick="toggleFullscreen()" title="Focus mode (Cmd+Shift+F)">&#x26F6;</button>
    <button class="header-btn" onclick="showShortcutsModal()">?</button>
  </div>
</div>

<!-- TAB BAR -->
<div class="tab-bar" id="tabBar"></div>

<!-- LAYOUT -->
<div class="layout">
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div id="sidebarContent">
      <div class="loading"><div class="spinner"></div>Loading...</div>
    </div>
    <div class="doc-count" id="docCount"></div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content" id="mainContent">
    <div class="welcome" id="welcome">
      <h1>HOLM VAULT</h1>
      <p>The holm.chat Documentation Institution — an Obsidian-like knowledge explorer backed by MongoDB.</p>
      <p style="margin-top:8px;color:var(--text-muted)">Select a document from the sidebar, use search, or press <kbd class="kbd">Cmd</kbd><kbd class="kbd">K</kbd> to begin.</p>
      <div class="stats" id="welcomeStats"></div>
    </div>
    <div class="doc-viewer" id="docViewer">
      <div class="breadcrumb" id="breadcrumb">
        <span class="bc-vault">HOLM Vault</span>
        <span class="bc-separator">&#8250;</span>
        <span class="bc-domain" id="bcDomain"></span>
        <span class="bc-separator">&#8250;</span>
        <span class="bc-current" id="bcDocId"></span>
      </div>
      <div class="doc-header">
        <h1 id="docTitle"></h1>
        <div class="doc-badges" id="docBadges"></div>
        <div class="doc-meta" id="docMeta"></div>
        <div class="doc-reading-info" id="docReadingInfo"></div>
      </div>
      <div class="doc-toolbar">
        <button class="active" onclick="setViewMode('preview')" id="btnPreview">Preview</button>
        <button onclick="setViewMode('edit')" id="btnEdit">Edit</button>
        <button onclick="setViewMode('raw')" id="btnRaw">Raw HTML</button>
        <button class="favorite-btn" id="favoriteBtn" onclick="toggleFavorite()" title="Toggle favorite">&#9734;</button>
      </div>
      <div class="doc-body" id="docBody"></div>
      <textarea class="edit-area" id="editArea"></textarea>
      <div class="save-bar" id="saveBar">
        <button class="save-btn" onclick="saveDoc()">Save</button>
        <button class="cancel-btn" onclick="setViewMode('preview')">Cancel</button>
      </div>
    </div>
    <button class="scroll-to-top" id="scrollToTop" title="Scroll to top">&#x2191;</button>
  </div>

  <!-- BACKLINKS PANEL -->
  <div class="backlinks-panel" id="backlinksPanel">
    <div class="local-graph" id="localGraphContainer">
      <canvas id="localGraphCanvas"></canvas>
    </div>
    <div id="localGraphTooltip"></div>
    <div class="backlinks-section toc-section">
      <h3>Contents</h3>
      <div id="tocList"></div>
    </div>
    <div class="backlinks-section">
      <h3>Depends On</h3>
      <div id="dependsOnList"></div>
    </div>
    <div class="backlinks-section">
      <h3>Depended Upon By</h3>
      <div id="dependedByList"></div>
    </div>
    <div class="backlinks-section">
      <h3>Tags</h3>
      <div id="tagsList"></div>
    </div>
  </div>
</div>

<!-- DOC LINK PREVIEW TOOLTIP -->
<div class="doc-link-tooltip" id="docLinkTooltip">
  <div class="doc-link-tooltip-id" id="tooltipDocId"></div>
  <div class="doc-link-tooltip-title" id="tooltipTitle"></div>
  <div class="doc-link-tooltip-domain" id="tooltipDomain"></div>
  <div class="doc-link-tooltip-excerpt" id="tooltipExcerpt"></div>
  <div class="doc-link-tooltip-tags" id="tooltipTags"></div>
</div>

<!-- FULLSCREEN EXIT HINT -->
<div class="fullscreen-exit-hint" id="fullscreenExitHint" onclick="toggleFullscreen()">
  Exit focus mode <span class="kbd">Esc</span>
</div>

<!-- STATUS BAR -->
<div class="status-bar">
  <span id="statusDocs">0 docs</span>
  <span id="statusDomain"></span>
  <span id="statusUpdated"></span>
</div>

<!-- QUICK OPEN -->
<div class="quick-open-overlay" id="quickOpen" style="display:none">
  <div class="quick-open-panel">
    <input type="text" id="quickOpenInput" placeholder="Type to search docs..." autocomplete="off" spellcheck="false">
    <div class="quick-open-results" id="quickOpenResults"></div>
    <div class="quick-open-hint">
      <span><kbd>↑</kbd><kbd>↓</kbd> navigate</span>
      <span><kbd>↵</kbd> open</span>
      <span><kbd>Esc</kbd> close</span>
      <span><kbd>⌘K</kbd> toggle</span>
    </div>
  </div>
</div>

<!-- KEYBOARD SHORTCUTS MODAL -->
<div class="shortcuts-modal-overlay" id="shortcutsModal" onclick="closeShortcutsModal(event)">
  <div class="shortcuts-modal">
    <div class="shortcuts-modal-header">
      <h2>Keyboard Shortcuts</h2>
      <button class="shortcuts-modal-close" onclick="hideShortcutsModal()">&times;</button>
    </div>
    <div class="shortcuts-modal-body">
      <div class="shortcuts-group">
        <div class="shortcuts-group-label">Navigation</div>
        <table class="shortcuts-table">
          <tr><td>Quick open</td><td><span class="kbd">Cmd</span><span class="kbd">K</span></td></tr>
          <tr><td>Graph view</td><td><span class="kbd">Cmd</span><span class="kbd">G</span></td></tr>
          <tr><td>Previous document</td><td><span class="kbd">Alt</span><span class="kbd">↑</span></td></tr>
          <tr><td>Next document</td><td><span class="kbd">Alt</span><span class="kbd">↓</span></td></tr>
        </table>
      </div>
      <div class="shortcuts-group">
        <div class="shortcuts-group-label">View</div>
        <table class="shortcuts-table">
          <tr><td>Toggle sidebar</td><td><span class="kbd">Cmd</span><span class="kbd">\</span></td></tr>
          <tr><td>Toggle backlinks</td><td><span class="kbd">Cmd</span><span class="kbd">B</span></td></tr>
          <tr><td>Focus mode</td><td><span class="kbd">Cmd</span><span class="kbd">Shift</span><span class="kbd">F</span></td></tr>
        </table>
      </div>
      <div class="shortcuts-group">
        <div class="shortcuts-group-label">Editing</div>
        <table class="shortcuts-table">
          <tr><td>Toggle edit mode</td><td><span class="kbd">Cmd</span><span class="kbd">E</span></td></tr>
          <tr><td>Save</td><td><span class="kbd">Cmd</span><span class="kbd">S</span></td></tr>
        </table>
      </div>
      <div class="shortcuts-group">
        <div class="shortcuts-group-label">General</div>
        <table class="shortcuts-table">
          <tr><td>Show shortcuts</td><td><span class="kbd">?</span></td></tr>
          <tr><td>Close / cancel</td><td><span class="kbd">Esc</span></td></tr>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
// ─── STATE ──────────────────────────────────────────────────────────────────
let allDocs = [];
let currentDoc = null;
let viewMode = 'preview';
let backlinksPanelOpen = window.innerWidth > 768;
let docsById = {};
let activeTagFilter = null;
let openTabs = [];

const DOMAIN_COLORS = {
  '1': '#89b4fa', '2': '#a6e3a1', '3': '#f38ba8', '4': '#fab387',
  '5': '#cba6f7', '6': '#94e2d5', '7': '#f9e2af', '8': '#f5c2e7',
  '9': '#89dceb', '10': '#b4befe', '11': '#74c7ec', '12': '#f38ba8',
  '13': '#a6e3a1', '14': '#fab387', '15': '#cba6f7', '16': '#94e2d5',
  '17': '#f9e2af', '18': '#f5c2e7', '19': '#89dceb', '20': '#b4befe',
  'META': '#6c7086', 'FW': '#585b70', 'HIC': '#74c7ec'
};

// ─── INIT ───────────────────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', init);

async function init() {
  try {
    const res = await fetch('/api/docs');
    allDocs = await res.json();
    docsById = {};
    allDocs.forEach(d => docsById[d.docId] = d);
    renderSidebar();
    renderWelcomeStats();
    if (backlinksPanelOpen) document.getElementById('backlinksPanel').classList.add('active');
    if (window.location.hash) {
      const id = window.location.hash.slice(1).toUpperCase();
      if (docsById[id]) openDoc(id);
    }
  } catch (err) {
    document.getElementById('sidebarContent').innerHTML =
      '<div style="padding:16px;color:var(--red)">Failed to load docs. Is the API running?</div>';
  }
}

function renderWelcomeStats() {
  const domains = new Set(allDocs.map(d => d.domain));
  document.getElementById('welcomeStats').innerHTML = `
    <div class="stat"><div class="stat-num">${allDocs.length}</div><div class="stat-label">Documents</div></div>
    <div class="stat"><div class="stat-num">${domains.size}</div><div class="stat-label">Domains</div></div>
  `;
  document.getElementById('statusDocs').textContent = `${allDocs.length} docs`;
}

// ─── SIDEBAR ────────────────────────────────────────────────────────────────
function renderSidebar() {
  const sourceDocs = activeTagFilter
    ? allDocs.filter(doc => doc.tags && doc.tags.includes(activeTagFilter))
    : allDocs;

  const groups = {};
  sourceDocs.forEach(doc => {
    const key = doc.domain || 'Other';
    if (!groups[key]) groups[key] = { name: doc.domainName || key, docs: [] };
    groups[key].docs.push(doc);
  });

  const sortedKeys = Object.keys(groups).sort((a, b) => {
    const na = parseInt(a), nb = parseInt(b);
    if (!isNaN(na) && !isNaN(nb)) return na - nb;
    if (!isNaN(na)) return -1;
    if (!isNaN(nb)) return 1;
    return a.localeCompare(b);
  });

  let filterBar = '';
  if (activeTagFilter) {
    filterBar = `<div class="sidebar-filter">Filtered: <span class="filter-tag active">#${escHtml(activeTagFilter)}</span> <span class="clear-filter" onclick="clearTagFilter()">✕</span></div>`;
  }

  let html = '';
  for (const key of sortedKeys) {
    const g = groups[key];
    const color = DOMAIN_COLORS[key] || 'var(--text-muted)';
    html += `<div class="sidebar-section" data-domain="${key}">
      <div class="sidebar-section-header" onclick="toggleSection(this)" style="color:${color}">
        <span class="chevron">&#9660;</span>D${key} ${g.name} <span style="margin-left:auto;font-size:10px;opacity:0.6">${g.docs.length}</span>
      </div>
      <div class="sidebar-items-wrap"><div class="sidebar-items">`;
    for (const doc of g.docs) {
      html += `<div class="sidebar-item" data-id="${doc.docId}" onclick="openDoc('${doc.docId}')">
        <span class="doc-id">${doc.docId}</span>
        <span class="doc-title">${escHtml(doc.title)}</span>
      </div>`;
    }
    html += '</div></div></div>';
  }

  if (activeTagFilter && sourceDocs.length === 0) {
    html = `<div style="padding:16px;color:var(--text-muted);font-size:13px">No documents tagged <strong>#${escHtml(activeTagFilter)}</strong></div>`;
  }

  document.getElementById('sidebarContent').innerHTML = buildFavoritesHtml() + renderRecentSection() + filterBar + html;
  document.getElementById('docCount').textContent = activeTagFilter
    ? `${sourceDocs.length} of ${allDocs.length} documents`
    : `${allDocs.length} documents`;

  // Restore collapsed state from localStorage
  applySidebarState();
}

// ─── SIDEBAR COLLAPSE STATE PERSISTENCE ─────────────────────────────────────
const SIDEBAR_STATE_KEY = 'holm-sidebar-state';

function getSidebarState() {
  try {
    const raw = localStorage.getItem(SIDEBAR_STATE_KEY);
    return raw ? JSON.parse(raw) : {};
  } catch (e) { return {}; }
}

function saveSidebarState(state) {
  try { localStorage.setItem(SIDEBAR_STATE_KEY, JSON.stringify(state)); } catch (e) {}
}

function applySidebarState() {
  const state = getSidebarState();
  // Determine the active doc's domain so we can force it open
  const activeDomain = currentDoc ? currentDoc.domain : null;

  document.querySelectorAll('.sidebar-section[data-domain]').forEach(section => {
    const domain = section.dataset.domain;
    const wrap = section.querySelector('.sidebar-items-wrap');
    const items = section.querySelector('.sidebar-items');
    if (!wrap || !items) return;

    // If this domain has the active doc, always expand it
    const shouldCollapse = (domain === activeDomain) ? false : (state[domain] === true);

    if (shouldCollapse) {
      section.classList.add('collapsed');
      wrap.style.height = '0px';
    } else {
      section.classList.remove('collapsed');
      wrap.style.height = items.scrollHeight + 'px';
      // After transition ends, set to auto so it can resize naturally
      requestAnimationFrame(() => {
        requestAnimationFrame(() => { wrap.style.height = 'auto'; });
      });
    }
  });
}

function toggleSection(headerEl) {
  const section = headerEl.parentElement;
  const domain = section.dataset.domain;
  const wrap = section.querySelector('.sidebar-items-wrap');
  const items = section.querySelector('.sidebar-items');
  if (!wrap || !items) return;

  const isCollapsed = section.classList.contains('collapsed');

  if (isCollapsed) {
    // Expand: set height from 0 to scrollHeight, then auto
    section.classList.remove('collapsed');
    wrap.style.height = '0px';
    // Force reflow
    void wrap.offsetHeight;
    wrap.style.height = items.scrollHeight + 'px';
    const onEnd = () => {
      wrap.style.height = 'auto';
      wrap.removeEventListener('transitionend', onEnd);
    };
    wrap.addEventListener('transitionend', onEnd);
  } else {
    // Collapse: set explicit height first, then transition to 0
    wrap.style.height = items.scrollHeight + 'px';
    // Force reflow
    void wrap.offsetHeight;
    section.classList.add('collapsed');
    wrap.style.height = '0px';
  }

  // Persist state
  const state = getSidebarState();
  state[domain] = !isCollapsed; // after toggle: collapsed = !wasCollapsed
  saveSidebarState(state);
}

// ─── TAG FILTER ─────────────────────────────────────────────────────────────
function filterByTag(tag) {
  activeTagFilter = tag;
  renderSidebar();
  if (currentDoc) {
    const activeItem = document.querySelector(`.sidebar-item[data-id="${currentDoc.docId}"]`);
    if (activeItem) { activeItem.classList.add('active'); activeItem.scrollIntoView({ block: 'nearest' }); }
  }
}

function clearTagFilter() {
  activeTagFilter = null;
  renderSidebar();
  if (currentDoc) {
    const activeItem = document.querySelector(`.sidebar-item[data-id="${currentDoc.docId}"]`);
    if (activeItem) { activeItem.classList.add('active'); activeItem.scrollIntoView({ block: 'nearest' }); }
  }
}

function filterByDomain(domainKey) {
  // Clear any active tag filter first
  activeTagFilter = null;
  renderSidebar();

  // Collapse all sections, then expand only the matching domain
  const filterState = {};
  document.querySelectorAll('.sidebar-section[data-domain]').forEach(section => {
    const d = section.dataset.domain;
    if (d === domainKey) {
      filterState[d] = false;
    } else {
      filterState[d] = true;
    }
  });
  saveSidebarState(filterState);
  applySidebarState();
  const targetSection = document.querySelector(`.sidebar-section[data-domain="${domainKey}"]`);
  if (targetSection) targetSection.scrollIntoView({ block: 'start', behavior: 'smooth' });

  // Re-highlight active doc if any
  if (currentDoc) {
    const activeItem = document.querySelector(`.sidebar-item[data-id="${currentDoc.docId}"]`);
    if (activeItem) { activeItem.classList.add('active'); activeItem.scrollIntoView({ block: 'nearest' }); }
  }
}

// ─── TABS + DOC OPEN ────────────────────────────────────────────────────────
async function openDoc(id) {
  if (!openTabs.find(t => t.docId === id)) {
    const meta = docsById[id];
    openTabs.push({ docId: id, title: meta ? meta.title : id });
  }
  await switchTab(id);
}

async function switchTab(docId) {
  try {
    const res = await fetch(`/api/docs/${docId}`);
    if (!res.ok) throw new Error('Not found');
    currentDoc = await res.json();

    const tab = openTabs.find(t => t.docId === docId);
    if (tab && tab.title === docId) tab.title = currentDoc.title;
    renderTabs();

    // Track in recently viewed
    addToRecent(currentDoc.docId, currentDoc.title);
    renderSidebar();

    window.location.hash = docId;

    document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
    const activeItem = document.querySelector(`.sidebar-item[data-id="${docId}"]`);
    if (activeItem) {
      activeItem.classList.add('active');
      // Ensure the active doc's domain section is expanded
      const parentSection = activeItem.closest('.sidebar-section');
      if (parentSection && parentSection.classList.contains('collapsed')) {
        const header = parentSection.querySelector('.sidebar-section-header');
        if (header) toggleSection(header);
      }
      activeItem.scrollIntoView({ block: 'nearest' });
    }

    document.getElementById('welcome').style.display = 'none';
    document.getElementById('docViewer').classList.add('active');

    document.getElementById('docTitle').textContent = `${currentDoc.docId} — ${currentDoc.title}`;
    document.getElementById('docMeta').innerHTML = `
      <span class="badge" style="color:${DOMAIN_COLORS[currentDoc.domain] || 'var(--text-muted)'}">Domain ${currentDoc.domain}: ${escHtml(currentDoc.domainName)}</span>
    `;
    renderDocBadges();

    // Breadcrumb
    const bcDomain = document.getElementById('bcDomain');
    const domainLabel = currentDoc.domainName ? `D${currentDoc.domain} ${currentDoc.domainName}` : `Domain ${currentDoc.domain}`;
    bcDomain.textContent = domainLabel;
    bcDomain.style.color = DOMAIN_COLORS[currentDoc.domain] || 'var(--text-secondary)';
    bcDomain.onclick = function() { filterByDomain(currentDoc.domain); };
    document.getElementById('bcDocId').textContent = currentDoc.docId;
    document.getElementById('breadcrumb').classList.add('active');

    updateReadingInfo();
    updateFavoriteBtn();
    setViewMode('preview');
    renderBacklinks();

    document.getElementById('statusDomain').textContent = `Domain ${currentDoc.domain}`;
    document.getElementById('statusUpdated').textContent = `Updated: ${new Date(currentDoc.updatedAt).toLocaleDateString()}`;

    if (window.innerWidth <= 768) {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('sidebarOverlay').classList.remove('active');
    }
  } catch (err) {
    console.error('Failed to open doc:', err);
  }
}

function renderTabs() {
  const bar = document.getElementById('tabBar');
  if (openTabs.length === 0) { bar.innerHTML = ''; return; }
  bar.innerHTML = openTabs.map(tab => {
    const isActive = currentDoc && currentDoc.docId === tab.docId;
    return `<div class="tab${isActive ? ' active' : ''}" data-tab-id="${escHtml(tab.docId)}"
               onclick="switchTab('${escHtml(tab.docId)}')"
               onmousedown="handleTabMousedown(event, '${escHtml(tab.docId)}')"
               title="${escHtml(tab.docId)}: ${escHtml(tab.title)}">
      <span class="tab-id">${escHtml(tab.docId)}</span>
      <span class="tab-title">${escHtml(tab.title)}</span>
      <span class="tab-close" onclick="event.stopPropagation(); closeTab('${escHtml(tab.docId)}')">×</span>
    </div>`;
  }).join('');
  const activeTab = bar.querySelector('.tab.active');
  if (activeTab) activeTab.scrollIntoView({ block: 'nearest', inline: 'nearest' });
}

function closeTab(docId) {
  const idx = openTabs.findIndex(t => t.docId === docId);
  if (idx === -1) return;
  openTabs.splice(idx, 1);
  if (currentDoc && currentDoc.docId === docId) {
    if (openTabs.length === 0) {
      currentDoc = null;
      document.getElementById('docViewer').classList.remove('active');
      document.getElementById('welcome').style.display = '';
      document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
      window.location.hash = '';
      renderTabs();
    } else {
      const nextTab = openTabs[Math.min(idx, openTabs.length - 1)];
      switchTab(nextTab.docId);
    }
  } else {
    renderTabs();
  }
}

function handleTabMousedown(event, docId) {
  if (event.button === 1) { event.preventDefault(); closeTab(docId); }
}

// ─── VIEW MODE ──────────────────────────────────────────────────────────────
function setViewMode(mode) {
  viewMode = mode;
  const body = document.getElementById('docBody');
  const edit = document.getElementById('editArea');
  const saveBar = document.getElementById('saveBar');
  document.querySelectorAll('.doc-toolbar button').forEach(b => b.classList.remove('active'));

  if (mode === 'preview') {
    body.style.display = 'block';
    body.innerHTML = linkifyDocIds(currentDoc.content);
    addCopyButtons();
    edit.classList.remove('active');
    saveBar.classList.remove('active');
    document.getElementById('btnPreview').classList.add('active');
  } else if (mode === 'edit') {
    body.style.display = 'none';
    edit.value = currentDoc.content;
    edit.classList.add('active');
    saveBar.classList.add('active');
    document.getElementById('btnEdit').classList.add('active');
  } else if (mode === 'raw') {
    body.style.display = 'block';
    body.innerHTML = `<pre><code>${escHtml(currentDoc.content)}</code></pre>`;
    addCopyButtons();
    edit.classList.remove('active');
    saveBar.classList.remove('active');
    document.getElementById('btnRaw').classList.add('active');
  }
}

async function saveDoc() {
  if (!currentDoc) return;
  const content = document.getElementById('editArea').value;
  try {
    const res = await fetch(`/api/docs/${currentDoc.docId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content })
    });
    if (!res.ok) throw new Error('Save failed');
    currentDoc.content = content;
    setViewMode('preview');
  } catch (err) {
    alert('Failed to save: ' + err.message);
  }
}

// ─── LINKIFY DOC IDS ────────────────────────────────────────────────────────
function linkifyDocIds(html) {
  const DOC_ID_RE = /\b([A-Z]{1,10}-\d{1,4}|D\d{1,2}-\d{1,4}|DOMAIN-\d{1,2}|APPENDIX-[A-Z](?:-\d)?)\b/g;
  const ANCHOR_RE = /(<a[\s\S]*?<\/a>)/gi;
  const parts = html.split(ANCHOR_RE);
  return parts.map((part, i) => {
    if (i % 2 === 1) return part;
    const TAG_RE = /(<[^>]+>)/g;
    const subParts = part.split(TAG_RE);
    return subParts.map((sub, j) => {
      if (j % 2 === 1) return sub;
      return sub.replace(DOC_ID_RE, (match) =>
        `<a class="doc-link" onclick="openDoc('${match}')" title="Open ${match}">${match}</a>`
      );
    }).join('');
  }).join('');
}

// ─── BACKLINKS + TOC + LOCAL GRAPH ──────────────────────────────────────────
function renderBacklinks() {
  if (!currentDoc) return;

  renderLocalGraph();
  renderTOC();

  // Depends On
  const depOn = document.getElementById('dependsOnList');
  if (currentDoc.dependsOn && currentDoc.dependsOn.length > 0) {
    depOn.innerHTML = currentDoc.dependsOn.map(id => {
      const ref = docsById[id];
      const title = ref ? ref.title : id;
      return `<a class="backlink-item" onclick="openDoc('${id}')">${id}: ${escHtml(title)}</a>`;
    }).join('');
  } else {
    depOn.innerHTML = '<span style="color:var(--text-muted);font-size:12px">None</span>';
  }

  // Depended Upon By
  const depBy = document.getElementById('dependedByList');
  if (currentDoc.dependedBy && currentDoc.dependedBy.length > 0) {
    depBy.innerHTML = currentDoc.dependedBy.map(id => {
      const ref = docsById[id];
      const title = ref ? ref.title : id;
      return `<a class="backlink-item" onclick="openDoc('${id}')">${id}: ${escHtml(title)}</a>`;
    }).join('');
  } else {
    depBy.innerHTML = '<span style="color:var(--text-muted);font-size:12px">None</span>';
  }

  // Tags (clickable for filtering)
  const tags = document.getElementById('tagsList');
  if (currentDoc.tags && currentDoc.tags.length > 0) {
    tags.innerHTML = currentDoc.tags.map(t =>
      `<span class="tag-item" onclick="filterByTag('${escHtml(t)}')">#${escHtml(t)}</span>`
    ).join('');
  } else {
    tags.innerHTML = '<span style="color:var(--text-muted);font-size:12px">No tags</span>';
  }
}

// ─── TABLE OF CONTENTS ──────────────────────────────────────────────────────
function slugify(text) {
  return text.toLowerCase().replace(/[^\w\s-]/g, '').trim().replace(/[\s_]+/g, '-').replace(/-+/g, '-');
}

function renderTOC() {
  const tocList = document.getElementById('tocList');
  if (!currentDoc || !currentDoc.content) {
    tocList.innerHTML = '<span style="color:var(--text-muted);font-size:12px">No headings</span>';
    return;
  }
  const headings = [];
  const regex = /<h([23])[^>]*>(.*?)<\/h\1>/gi;
  let match;
  while ((match = regex.exec(currentDoc.content)) !== null) {
    const level = match[1];
    const rawText = match[2].replace(/<[^>]+>/g, '').trim();
    const id = slugify(rawText);
    headings.push({ level, text: rawText, id });
  }
  if (headings.length === 0) {
    tocList.innerHTML = '<span style="color:var(--text-muted);font-size:12px">No headings</span>';
    return;
  }
  const docBody = document.getElementById('docBody');
  if (docBody) {
    const domHeadings = docBody.querySelectorAll('h2, h3');
    let tocIndex = 0;
    domHeadings.forEach(el => { if (tocIndex < headings.length) { el.id = headings[tocIndex].id; tocIndex++; } });
  }
  tocList.innerHTML = headings.map(h =>
    `<span class="toc-item toc-h${h.level}" onclick="scrollToHeading('${h.id}')">${escHtml(h.text)}</span>`
  ).join('');
}

function scrollToHeading(id) {
  const target = document.getElementById(id);
  const mainContent = document.getElementById('mainContent');
  if (target && mainContent) {
    const offset = target.offsetTop - mainContent.offsetTop;
    mainContent.scrollTo({ top: offset - 16, behavior: 'smooth' });
  }
}

// ─── LOCAL GRAPH ────────────────────────────────────────────────────────────
function renderLocalGraph() {
  const container = document.getElementById('localGraphContainer');
  const tooltip = document.getElementById('localGraphTooltip');
  const oldCanvas = container.querySelector('canvas');
  const canvas = document.createElement('canvas');
  canvas.id = 'localGraphCanvas';
  if (oldCanvas) container.replaceChild(canvas, oldCanvas);
  else container.appendChild(canvas);

  const W = container.clientWidth || 240;
  const H = container.clientHeight || 200;
  const DPR = window.devicePixelRatio || 1;
  canvas.width = W * DPR;
  canvas.height = H * DPR;
  const ctx = canvas.getContext('2d');
  ctx.scale(DPR, DPR);

  if (!currentDoc) return;

  const dependsOn = Array.isArray(currentDoc.dependsOn) ? currentDoc.dependsOn : [];
  const dependedBy = Array.isArray(currentDoc.dependedBy) ? currentDoc.dependedBy : [];
  const neighborIds = [...new Set([...dependsOn, ...dependedBy])];

  const nodes = [
    { id: currentDoc.docId, isCenter: true, domain: currentDoc.domain, x: W/2, y: H/2, vx: 0, vy: 0, fx: 0, fy: 0 },
    ...neighborIds.map((id, i) => {
      const doc = docsById[id];
      const angle = (2 * Math.PI * i) / Math.max(neighborIds.length, 1);
      const r = Math.min(W, H) * 0.30;
      return { id, isCenter: false, domain: doc ? doc.domain : null, x: W/2 + r * Math.cos(angle), y: H/2 + r * Math.sin(angle), vx: 0, vy: 0, fx: 0, fy: 0 };
    })
  ];
  const nodeIndex = {};
  nodes.forEach((n, i) => nodeIndex[n.id] = i);

  const edgeSet = new Set();
  const edges = [];
  function addEdge(a, b) {
    const key = [a, b].sort().join('||');
    if (!edgeSet.has(key) && nodeIndex[a] !== undefined && nodeIndex[b] !== undefined) {
      edgeSet.add(key);
      edges.push({ a, b });
    }
  }
  dependsOn.forEach(id => addEdge(currentDoc.docId, id));
  dependedBy.forEach(id => addEdge(id, currentDoc.docId));

  // Force simulation
  const cx = W/2, cy = H/2;
  for (let iter = 0; iter < 120; iter++) {
    nodes.forEach(n => { n.fx = 0; n.fy = 0; });
    for (let i = 0; i < nodes.length; i++) {
      for (let j = i + 1; j < nodes.length; j++) {
        const a = nodes[i], b = nodes[j];
        const dx = b.x - a.x, dy = b.y - a.y;
        const dist2 = dx * dx + dy * dy + 0.01;
        const dist = Math.sqrt(dist2);
        const force = 2800 / dist2;
        const ffx = (dx / dist) * force, ffy = (dy / dist) * force;
        a.fx -= ffx; a.fy -= ffy; b.fx += ffx; b.fy += ffy;
      }
    }
    edges.forEach(({ a: aId, b: bId }) => {
      const a = nodes[nodeIndex[aId]], b = nodes[nodeIndex[bId]];
      const dx = b.x - a.x, dy = b.y - a.y;
      const dist = Math.sqrt(dx * dx + dy * dy) + 0.01;
      const delta = (dist - 72) * 0.12;
      const ffx = (dx / dist) * delta, ffy = (dy / dist) * delta;
      a.fx += ffx; a.fy += ffy; b.fx -= ffx; b.fy -= ffy;
    });
    nodes.forEach(n => { n.fx += (cx - n.x) * 0.06; n.fy += (cy - n.y) * 0.06; });
    nodes.forEach(n => {
      if (n.isCenter) { n.x = cx; n.y = cy; return; }
      n.vx = (n.vx + n.fx) * 0.82; n.vy = (n.vy + n.fy) * 0.82;
      n.x += n.vx; n.y += n.vy;
      n.x = Math.max(20, Math.min(W - 20, n.x));
      n.y = Math.max(20, Math.min(H - 20, n.y));
    });
  }

  function nodeColor(domain) { return DOMAIN_COLORS[domain] || '#6c7086'; }

  // Draw
  ctx.fillStyle = '#181825'; ctx.fillRect(0, 0, W, H);
  edges.forEach(({ a: aId, b: bId }) => {
    const a = nodes[nodeIndex[aId]], b = nodes[nodeIndex[bId]];
    ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y);
    ctx.strokeStyle = '#45475a'; ctx.lineWidth = 1.2; ctx.stroke();
  });
  nodes.forEach(n => {
    const radius = n.isCenter ? 9 : 6;
    const color = nodeColor(n.domain);
    if (n.isCenter) { ctx.beginPath(); ctx.arc(n.x, n.y, radius + 4, 0, 2 * Math.PI); ctx.fillStyle = color + '33'; ctx.fill(); }
    ctx.beginPath(); ctx.arc(n.x, n.y, radius, 0, 2 * Math.PI); ctx.fillStyle = color; ctx.fill();
    if (n.isCenter) { ctx.strokeStyle = '#cdd6f4'; ctx.lineWidth = 1.5; ctx.stroke(); }
  });

  // Interaction
  function hitTest(px, py) {
    for (let i = nodes.length - 1; i >= 0; i--) {
      const n = nodes[i], r = n.isCenter ? 9 : 6;
      const dx = px - n.x, dy = py - n.y;
      if (dx * dx + dy * dy <= (r + 3) * (r + 3)) return n;
    }
    return null;
  }
  function eventPos(e) { const rect = canvas.getBoundingClientRect(); return { px: e.clientX - rect.left, py: e.clientY - rect.top }; }

  canvas.addEventListener('mousemove', function(e) {
    const { px, py } = eventPos(e);
    const hit = hitTest(px, py);
    if (hit) {
      this.style.cursor = hit.isCenter ? 'default' : 'pointer';
      tooltip.style.display = 'block';
      tooltip.textContent = hit.id;
      tooltip.style.left = (e.clientX + 12) + 'px';
      tooltip.style.top = (e.clientY - 6) + 'px';
    } else {
      this.style.cursor = 'default';
      tooltip.style.display = 'none';
    }
  });
  canvas.addEventListener('mouseleave', function() { tooltip.style.display = 'none'; });
  canvas.addEventListener('click', function(e) {
    const { px, py } = eventPos(e);
    const hit = hitTest(px, py);
    if (hit && !hit.isCenter) openDoc(hit.id);
  });
}

// ─── SEARCH ─────────────────────────────────────────────────────────────────
let searchTimeout;
document.getElementById('searchInput').addEventListener('input', function() {
  clearTimeout(searchTimeout);
  const q = this.value.trim();
  if (q.length < 2) { document.getElementById('searchResults').classList.remove('active'); return; }
  searchTimeout = setTimeout(() => doSearch(q), 250);
});
document.getElementById('searchInput').addEventListener('focus', function() {
  if (this.value.trim().length >= 2) document.getElementById('searchResults').classList.add('active');
});
document.addEventListener('click', function(e) {
  if (!e.target.closest('.search-box')) document.getElementById('searchResults').classList.remove('active');
});

async function doSearch(q) {
  try {
    const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
    const results = await res.json();
    const container = document.getElementById('searchResults');
    if (results.length === 0) {
      container.innerHTML = '<div class="search-result-item" style="color:var(--text-muted)">No results found</div>';
    } else {
      container.innerHTML = results.map(r => `
        <div class="search-result-item" onclick="openDoc('${r.docId}');document.getElementById('searchResults').classList.remove('active');">
          <div class="sr-id">${r.docId}</div>
          <div class="sr-title">${escHtml(r.title)}</div>
          ${r.snippet ? `<div class="sr-snippet">${r.snippet}</div>` : ''}
        </div>
      `).join('');
    }
    container.classList.add('active');
  } catch (err) {
    console.error('Search failed:', err);
  }
}

// ─── QUICK OPEN ─────────────────────────────────────────────────────────────
let quickOpenSelectedIndex = -1;
let quickOpenFilteredDocs = [];

function openQuickOpen() {
  const overlay = document.getElementById('quickOpen');
  const input = document.getElementById('quickOpenInput');
  overlay.style.display = 'flex';
  input.value = '';
  quickOpenSelectedIndex = -1;
  renderQuickOpenResults('');
  requestAnimationFrame(() => input.focus());
}

function closeQuickOpen() {
  document.getElementById('quickOpen').style.display = 'none';
  quickOpenSelectedIndex = -1;
  quickOpenFilteredDocs = [];
}

function renderQuickOpenResults(query) {
  const term = query.trim().toLowerCase();
  const container = document.getElementById('quickOpenResults');
  quickOpenFilteredDocs = term.length === 0
    ? allDocs.slice(0, 15)
    : allDocs.filter(d => d.docId.toLowerCase().includes(term) || d.title.toLowerCase().includes(term)).slice(0, 15);

  if (quickOpenFilteredDocs.length === 0) {
    container.innerHTML = `<div class="quick-open-empty">No documents match "${escHtml(query)}"</div>`;
    return;
  }
  container.innerHTML = quickOpenFilteredDocs.map((doc, i) => `
    <div class="quick-open-item${i === quickOpenSelectedIndex ? ' selected' : ''}" data-index="${i}"
         onmousedown="quickOpenSelectDoc('${escHtml(doc.docId)}')">
      <span class="qo-id">${escHtml(doc.docId)}</span>
      <span class="qo-title">${escHtml(doc.title)}</span>
    </div>
  `).join('');
}

function quickOpenSetSelected(index) {
  const items = document.querySelectorAll('.quick-open-item');
  items.forEach(el => el.classList.remove('selected'));
  if (index >= 0 && index < items.length) {
    items[index].classList.add('selected');
    items[index].scrollIntoView({ block: 'nearest' });
  }
  quickOpenSelectedIndex = index;
}

function quickOpenSelectDoc(docId) { closeQuickOpen(); openDoc(docId); }

document.getElementById('quickOpenInput').addEventListener('input', function() {
  quickOpenSelectedIndex = -1;
  renderQuickOpenResults(this.value);
});
document.getElementById('quickOpenInput').addEventListener('keydown', function(e) {
  const total = quickOpenFilteredDocs.length;
  if (e.key === 'ArrowDown') { e.preventDefault(); quickOpenSetSelected(quickOpenSelectedIndex < total - 1 ? quickOpenSelectedIndex + 1 : 0); }
  else if (e.key === 'ArrowUp') { e.preventDefault(); quickOpenSetSelected(quickOpenSelectedIndex > 0 ? quickOpenSelectedIndex - 1 : total - 1); }
  else if (e.key === 'Enter') { e.preventDefault(); const idx = quickOpenSelectedIndex >= 0 ? quickOpenSelectedIndex : 0; const doc = quickOpenFilteredDocs[idx]; if (doc) quickOpenSelectDoc(doc.docId); }
  else if (e.key === 'Escape') { closeQuickOpen(); }
});
document.getElementById('quickOpen').addEventListener('mousedown', function(e) { if (e.target === this) closeQuickOpen(); });

// ─── TOGGLE FUNCTIONS ───────────────────────────────────────────────────────
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  sidebar.classList.toggle('open');
  overlay.classList.toggle('active');
}

function toggleBacklinks() {
  backlinksPanelOpen = !backlinksPanelOpen;
  document.getElementById('backlinksPanel').classList.toggle('active', backlinksPanelOpen);
  document.getElementById('backlinkToggle').classList.toggle('active', backlinksPanelOpen);
}

// ─── FULLSCREEN / FOCUS MODE ────────────────────────────────────────────────
let fullscreenMode = false;
let _backlinksPanelWasOpen = false;

function toggleFullscreen() {
  fullscreenMode = !fullscreenMode;
  document.body.classList.toggle('fullscreen-mode', fullscreenMode);

  if (fullscreenMode) {
    // Remember backlinks state before hiding
    _backlinksPanelWasOpen = backlinksPanelOpen;
  } else {
    // Restore backlinks panel if it was open before entering fullscreen
    if (_backlinksPanelWasOpen && !backlinksPanelOpen) {
      backlinksPanelOpen = true;
      document.getElementById('backlinksPanel').classList.add('active');
      document.getElementById('backlinkToggle').classList.add('active');
    }
  }
}

// ─── SHORTCUTS MODAL ────────────────────────────────────────────────────────
function showShortcutsModal() { document.getElementById('shortcutsModal').classList.add('active'); }
function hideShortcutsModal() { document.getElementById('shortcutsModal').classList.remove('active'); }
function closeShortcutsModal(event) { if (event.target === document.getElementById('shortcutsModal')) hideShortcutsModal(); }

// ─── CODE BLOCK COPY BUTTONS ────────────────────────────────────────────────
function addCopyButtons() {
  const docBody = document.getElementById('docBody');
  if (!docBody) return;
  docBody.querySelectorAll('pre').forEach(pre => {
    if (pre.querySelector('.code-copy-btn')) return;
    const btn = document.createElement('button');
    btn.className = 'code-copy-btn';
    btn.textContent = 'Copy';
    btn.addEventListener('click', function() {
      const code = pre.querySelector('code');
      const text = code ? code.textContent : pre.textContent;
      navigator.clipboard.writeText(text).then(() => {
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = 'Copy';
          btn.classList.remove('copied');
        }, 1500);
      });
    });
    pre.appendChild(btn);
  });
}

// ─── WORD COUNT & READING TIME ──────────────────────────────────────────────
function updateReadingInfo() {
  const el = document.getElementById('docReadingInfo');
  if (!currentDoc || !currentDoc.content) { el.textContent = ''; return; }
  const plainText = currentDoc.content.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
  const words = plainText ? plainText.split(/\s+/).length : 0;
  const minutes = Math.max(1, Math.ceil(words / 200));
  const formatted = words.toLocaleString();
  el.textContent = `${formatted} words \u00b7 ${minutes} min read`;
}

// ─── FAVORITES / BOOKMARKS ──────────────────────────────────────────────────
const FAVORITES_KEY = 'holm-favorites';

function getFavorites() {
  try {
    const raw = localStorage.getItem(FAVORITES_KEY);
    return raw ? JSON.parse(raw) : [];
  } catch (e) {
    return [];
  }
}

function saveFavorites(favs) {
  localStorage.setItem(FAVORITES_KEY, JSON.stringify(favs));
}

function isFavorite(docId) {
  return getFavorites().includes(docId);
}

function toggleFavorite() {
  if (!currentDoc) return;
  const favs = getFavorites();
  const idx = favs.indexOf(currentDoc.docId);
  if (idx === -1) {
    favs.push(currentDoc.docId);
  } else {
    favs.splice(idx, 1);
  }
  saveFavorites(favs);
  updateFavoriteBtn();
  renderSidebar();
  // Re-highlight the active sidebar item after re-render
  if (currentDoc) {
    const activeItem = document.querySelector(`.sidebar-item[data-id="${currentDoc.docId}"]`);
    if (activeItem) activeItem.classList.add('active');
  }
}

function removeFavorite(docId, event) {
  if (event) { event.stopPropagation(); }
  const favs = getFavorites();
  const idx = favs.indexOf(docId);
  if (idx !== -1) {
    favs.splice(idx, 1);
    saveFavorites(favs);
    updateFavoriteBtn();
    renderSidebar();
    if (currentDoc) {
      const activeItem = document.querySelector(`.sidebar-item[data-id="${currentDoc.docId}"]`);
      if (activeItem) activeItem.classList.add('active');
    }
  }
}

function updateFavoriteBtn() {
  const btn = document.getElementById('favoriteBtn');
  if (!btn || !currentDoc) return;
  const faved = isFavorite(currentDoc.docId);
  btn.classList.toggle('favorited', faved);
  btn.innerHTML = faved ? '&#9733;' : '&#9734;';
  btn.title = faved ? 'Remove from favorites' : 'Add to favorites';
}

function buildFavoritesHtml() {
  const favs = getFavorites();
  if (favs.length === 0) {
    return '<div class="sidebar-section favorites-section">' +
      '<div class="sidebar-section-header" onclick="toggleSection(this)">' +
      '<span class="chevron">\u25BC</span>\u2605 Favorites <span style="margin-left:auto;font-size:10px;opacity:0.6">0</span>' +
      '</div>' +
      '<div class="sidebar-items-wrap" style="height:auto"><div class="sidebar-items">' +
      '<div class="sidebar-items-empty">No favorites yet</div>' +
      '</div></div></div>';
  }
  let items = '';
  for (const docId of favs) {
    const doc = docsById[docId];
    const title = doc ? doc.title : docId;
    items += '<div class="sidebar-item" data-id="' + docId + '" onclick="openDoc(\'' + docId + '\')">' +
      '<span class="doc-id">' + docId + '</span>' +
      '<span class="doc-title">' + escHtml(title) + '</span>' +
      '<span class="fav-remove" onclick="removeFavorite(\'' + docId + '\', event)" title="Remove favorite">\u2715</span>' +
      '</div>';
  }
  return '<div class="sidebar-section favorites-section">' +
    '<div class="sidebar-section-header" onclick="toggleSection(this)">' +
    '<span class="chevron">\u25BC</span>\u2605 Favorites <span style="margin-left:auto;font-size:10px;opacity:0.6">' + favs.length + '</span>' +
    '</div>' +
    '<div class="sidebar-items-wrap" style="height:auto"><div class="sidebar-items">' + items + '</div></div></div>';
}

// ─── DOC BADGES ──────────────────────────────────────────────────────────
function getStatusBadgeClass(status) {
  if (!status) return 'badge-status-other';
  const s = status.toLowerCase().trim();
  if (s === 'ratified') return 'badge-status-ratified';
  if (s === 'draft') return 'badge-status-draft';
  if (s === 'active') return 'badge-status-active';
  if (s === 'deprecated') return 'badge-status-deprecated';
  return 'badge-status-other';
}

function renderDocBadges() {
  const el = document.getElementById('docBadges');
  if (!currentDoc) { el.innerHTML = ''; return; }
  let html = '';
  if (currentDoc.version) {
    html += '<span class="doc-badge-pill badge-version">v' + escHtml(currentDoc.version) + '</span>';
  }
  if (currentDoc.status) {
    const cls = getStatusBadgeClass(currentDoc.status);
    html += '<span class="doc-badge-pill ' + cls + '">' + escHtml(currentDoc.status) + '</span>';
  }
  if (currentDoc.date) {
    html += '<span class="doc-badge-pill badge-date">' + escHtml(currentDoc.date) + '</span>';
  }
  el.innerHTML = html;
}

// ─── UTILITY ────────────────────────────────────────────────────────────────
function escHtml(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function navigateDoc(direction) {
  if (!allDocs.length) return;
  if (!currentDoc) { openDoc(direction === 'next' ? allDocs[0].docId : allDocs[allDocs.length - 1].docId); return; }
  const idx = allDocs.findIndex(d => d.docId === currentDoc.docId);
  if (idx === -1) return;
  const target = direction === 'prev' ? idx - 1 : idx + 1;
  if (target < 0 || target >= allDocs.length) return;
  openDoc(allDocs[target].docId);
}

// ─── KEYBOARD NAVIGATION ───────────────────────────────────────────────────
function isTypingTarget() {
  const el = document.activeElement;
  return el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT' || el.isContentEditable);
}

document.addEventListener('keydown', function(e) {
  const mod = (navigator.platform.toUpperCase().includes('MAC') ? e.metaKey : e.ctrlKey);

  if (mod && e.key === 'k') { e.preventDefault(); const o = document.getElementById('quickOpen'); if (o.style.display === 'none') openQuickOpen(); else closeQuickOpen(); return; }
  if (mod && e.key === 'e') { e.preventDefault(); if (currentDoc) setViewMode(viewMode === 'edit' ? 'preview' : 'edit'); return; }
  if (mod && e.key === 's') { e.preventDefault(); if (currentDoc && viewMode === 'edit') saveDoc(); return; }
  if (mod && e.key === 'g') { e.preventDefault(); window.open('/graph.html', '_blank'); return; }
  if (mod && e.key === 'b') { e.preventDefault(); toggleBacklinks(); return; }
  if (mod && e.shiftKey && (e.key === 'f' || e.key === 'F')) { e.preventDefault(); toggleFullscreen(); return; }
  if (mod && e.key === '\\') { e.preventDefault(); toggleSidebar(); return; }
  if (mod && e.key === '[') { e.preventDefault(); window.history.back(); return; }
  if (mod && e.key === ']') { e.preventDefault(); window.history.forward(); return; }
  if (e.altKey && e.key === 'ArrowUp') { e.preventDefault(); navigateDoc('prev'); return; }
  if (e.altKey && e.key === 'ArrowDown') { e.preventDefault(); navigateDoc('next'); return; }

  if (e.key === 'Escape') {
    const so = document.getElementById('statsOverlay');
    if (so && so.classList.contains('active')) { closeStatsDashboard(); return; }
    const sm = document.getElementById('shortcutsModal');
    if (sm && sm.classList.contains('active')) { hideShortcutsModal(); return; }
    const qo = document.getElementById('quickOpen');
    if (qo && qo.style.display !== 'none') { closeQuickOpen(); return; }
    if (fullscreenMode) { toggleFullscreen(); return; }
    if (currentDoc && viewMode === 'edit') { setViewMode('preview'); return; }
  }

  if (e.key === '?' && !mod && !e.altKey && !isTypingTarget()) { e.preventDefault(); showShortcutsModal(); }
});


// ─── RECENTLY VIEWED ────────────────────────────────────────────────────────
const RECENT_KEY = 'holm-recent';
const RECENT_MAX = 10;

function getRecentDocs() {
  try {
    return JSON.parse(localStorage.getItem(RECENT_KEY)) || [];
  } catch { return []; }
}

function addToRecent(docId, title) {
  let recent = getRecentDocs();
  // Remove existing entry for this docId (dedup)
  recent = recent.filter(r => r.id !== docId);
  // Add to front
  recent.unshift({ id: docId, title: title });
  // Cap at max
  if (recent.length > RECENT_MAX) recent = recent.slice(0, RECENT_MAX);
  localStorage.setItem(RECENT_KEY, JSON.stringify(recent));
}

function clearRecentHistory() {
  localStorage.removeItem(RECENT_KEY);
  renderSidebar();
  // Re-highlight active doc
  if (currentDoc) {
    const activeItem = document.querySelector(`.sidebar-item[data-id="${currentDoc.docId}"]`);
    if (activeItem) { activeItem.classList.add('active'); }
  }
}

function toggleRecentSection(el) {
  el.closest('.recent-section').classList.toggle('collapsed');
}

function renderRecentSection() {
  const recent = getRecentDocs();
  if (recent.length === 0) return '';
  let items = '';
  for (const r of recent) {
    const safeId = escHtml(r.id);
    const safeTitle = escHtml(r.title);
    items += `<div class="sidebar-item" data-id="${safeId}" onclick="openDoc('${safeId}')">
      <span class="doc-id">${safeId}</span>
      <span class="doc-title">${safeTitle}</span>
    </div>`;
  }
  return `<div class="recent-section">
    <div class="recent-section-header" onclick="toggleRecentSection(this)">
      <span class="chevron">&#9660;</span>Recent
      <button class="recent-clear-btn" onclick="event.stopPropagation(); clearRecentHistory();" title="Clear history">clear</button>
    </div>
    <div class="recent-items">${items}</div>
  </div>`;
}

// ─── DOC LINK PREVIEW TOOLTIPS ──────────────────────────────────────────
const docContentCache = {};
let tooltipTimer = null;
let tooltipActiveLink = null;

function stripHtmlToPlainText(html) {
  const tmp = document.createElement('div');
  tmp.innerHTML = html;
  return (tmp.textContent || tmp.innerText || '').replace(/\s+/g, ' ').trim();
}

function positionTooltipEl(el, mouseX, mouseY) {
  const tw = 320, th = el.offsetHeight || 180, pad = 12;
  let left = mouseX + pad, top = mouseY + pad;
  if (left + tw > window.innerWidth - pad) left = mouseX - tw - pad;
  if (left < pad) left = pad;
  if (top + th > window.innerHeight - pad) top = mouseY - th - pad;
  if (top < pad) top = pad;
  el.style.left = left + 'px';
  el.style.top = top + 'px';
}

async function getDocContentForTooltip(docId) {
  if (docContentCache[docId]) return docContentCache[docId];
  if (currentDoc && currentDoc.docId === docId && currentDoc.content) {
    docContentCache[docId] = currentDoc;
    return currentDoc;
  }
  const basicInfo = docsById[docId];
  if (!basicInfo) return null;
  try {
    const res = await fetch('/api/docs/' + docId);
    if (!res.ok) return basicInfo;
    const fullDoc = await res.json();
    docContentCache[docId] = fullDoc;
    return fullDoc;
  } catch (err) {
    return basicInfo;
  }
}

function showDocLinkTooltip(docId, mx, my) {
  const tip = document.getElementById('docLinkTooltip');
  getDocContentForTooltip(docId).then(function(doc) {
    if (!doc || tooltipActiveLink === null) return;
    document.getElementById('tooltipDocId').textContent = doc.docId;
    document.getElementById('tooltipTitle').textContent = doc.title || doc.docId;
    const dEl = document.getElementById('tooltipDomain');
    dEl.textContent = doc.domainName ? 'Domain ' + doc.domain + ': ' + doc.domainName : (doc.domain ? 'Domain ' + doc.domain : '');
    dEl.style.color = DOMAIN_COLORS[doc.domain] || 'var(--text-muted)';
    const exEl = document.getElementById('tooltipExcerpt');
    if (doc.content) {
      const plain = stripHtmlToPlainText(doc.content);
      exEl.textContent = plain.length > 150 ? plain.slice(0, 150) + '...' : plain;
      exEl.style.display = '';
    } else {
      exEl.textContent = '';
      exEl.style.display = 'none';
    }
    const tEl = document.getElementById('tooltipTags');
    if (doc.tags && doc.tags.length > 0) {
      tEl.innerHTML = doc.tags.map(function(t) { return '<span class="doc-link-tooltip-tag">#' + escHtml(t) + '</span>'; }).join('');
      tEl.style.display = '';
    } else {
      tEl.innerHTML = '';
      tEl.style.display = 'none';
    }
    positionTooltipEl(tip, mx, my);
    tip.classList.add('visible');
  });
}

function hideDocLinkTooltip() {
  clearTimeout(tooltipTimer);
  tooltipTimer = null;
  tooltipActiveLink = null;
  document.getElementById('docLinkTooltip').classList.remove('visible');
}

document.getElementById('docBody').addEventListener('mouseenter', function(e) {
  const link = e.target.closest('a.doc-link');
  if (!link) return;
  const docId = link.textContent.trim();
  if (currentDoc && currentDoc.docId === docId) return;
  if (!docsById[docId]) return;
  tooltipActiveLink = link;
  clearTimeout(tooltipTimer);
  tooltipTimer = setTimeout(function() {
    if (tooltipActiveLink === link) {
      const rect = link.getBoundingClientRect();
      showDocLinkTooltip(docId, rect.left + rect.width / 2, rect.bottom);
    }
  }, 300);
}, true);

document.getElementById('docBody').addEventListener('mouseleave', function(e) {
  const link = e.target.closest('a.doc-link');
  if (!link) return;
  hideDocLinkTooltip();
}, true);

document.getElementById('mainContent').addEventListener('scroll', function() {
  if (tooltipActiveLink) hideDocLinkTooltip();
}, { passive: true });

// ─── HASH ROUTING ───────────────────────────────────────────────────────────
window.addEventListener('hashchange', () => {
  const id = window.location.hash.slice(1).toUpperCase();
  if (id && docsById[id] && (!currentDoc || currentDoc.docId !== id)) openDoc(id);
});


// ─── SCROLL TO TOP ──────────────────────────────────────────────────────────
(function() {
  const mainContent = document.getElementById('mainContent');
  const scrollBtn = document.getElementById('scrollToTop');
  if (!mainContent || !scrollBtn) return;

  mainContent.addEventListener('scroll', function() {
    if (mainContent.scrollTop > 300) {
      scrollBtn.classList.add('visible');
    } else {
      scrollBtn.classList.remove('visible');
    }
  });

  scrollBtn.addEventListener('click', function() {
    mainContent.scrollTo({ top: 0, behavior: 'smooth' });
  });
})();

// ─── STATS DASHBOARD ────────────────────────────────────────────────────────
async function openStatsDashboard() {
  document.getElementById('statsOverlay').classList.add('active');
  await renderStatsDashboard();
}

function closeStatsDashboard() {
  document.getElementById('statsOverlay').classList.remove('active');
}

async function renderStatsDashboard() {
  const container = document.getElementById('statsDashboardContent');

  // Compute domain groups
  const domainMap = {};
  let totalEdges = 0;
  const connectionCounts = {};

  allDocs.forEach(doc => {
    const key = doc.domain || 'Other';
    const name = doc.domainName || key;
    if (!domainMap[key]) domainMap[key] = { name, count: 0 };
    domainMap[key].count++;

    const depOn = Array.isArray(doc.dependsOn) ? doc.dependsOn.length : 0;
    const depBy = Array.isArray(doc.dependedBy) ? doc.dependedBy.length : 0;
    totalEdges += depOn;
    connectionCounts[doc.docId] = {
      total: depOn + depBy,
      dependsOn: depOn,
      dependedBy: depBy,
      title: doc.title
    };
  });

  // Sort domains
  const domainKeys = Object.keys(domainMap).sort((a, b) => {
    const na = parseInt(a), nb = parseInt(b);
    if (!isNaN(na) && !isNaN(nb)) return na - nb;
    if (!isNaN(na)) return -1;
    if (!isNaN(nb)) return 1;
    return a.localeCompare(b);
  });

  const maxDomainCount = Math.max(...domainKeys.map(k => domainMap[k].count), 1);
  const domainCount = domainKeys.length;

  // Top 10 most connected docs
  const topConnected = Object.entries(connectionCounts)
    .sort((a, b) => b[1].total - a[1].total)
    .slice(0, 10);

  // Fetch tags from API
  let tagData = [];
  try {
    const tagRes = await fetch('/api/tags');
    if (tagRes.ok) {
      tagData = await tagRes.json();
    }
  } catch (e) {
    // Fallback: compute tags from allDocs
  }

  // If API didn't return tags, compute from allDocs
  if (!tagData || tagData.length === 0) {
    const tagCounts = {};
    allDocs.forEach(doc => {
      if (doc.tags && Array.isArray(doc.tags)) {
        doc.tags.forEach(t => {
          tagCounts[t] = (tagCounts[t] || 0) + 1;
        });
      }
    });
    tagData = Object.entries(tagCounts)
      .map(([tag, count]) => ({ tag, count }))
      .sort((a, b) => b.count - a.count);
  }

  // If tagData is an object with tag->count, normalize
  if (tagData && !Array.isArray(tagData)) {
    tagData = Object.entries(tagData)
      .map(([tag, count]) => ({ tag, count }))
      .sort((a, b) => b.count - a.count);
  }

  const topTags = (tagData || []).slice(0, 10);
  const maxTagCount = topTags.length > 0 ? Math.max(...topTags.map(t => t.count), 1) : 1;

  // Build HTML
  let html = '';

  // Summary cards
  html += '<div class="stats-summary">';
  html += '<div class="stats-card"><div class="stats-card-num">' + allDocs.length + '</div><div class="stats-card-label">Total Documents</div></div>';
  html += '<div class="stats-card"><div class="stats-card-num">' + domainCount + '</div><div class="stats-card-label">Domains</div></div>';
  html += '<div class="stats-card"><div class="stats-card-num">' + totalEdges + '</div><div class="stats-card-label">Dependency Edges</div></div>';
  html += '<div class="stats-card"><div class="stats-card-num">' + topTags.length + '</div><div class="stats-card-label">Unique Tags</div></div>';
  html += '</div>';

  // Domain bar chart
  html += '<div class="stats-section"><h3>Documents per Domain</h3><div class="stats-bar-chart">';
  domainKeys.forEach(key => {
    const d = domainMap[key];
    const pct = (d.count / maxDomainCount * 100).toFixed(1);
    const color = DOMAIN_COLORS[key] || '#6c7086';
    html += '<div class="stats-bar-row">';
    html += '<div class="stats-bar-label" title="D' + escHtml(key) + ' ' + escHtml(d.name) + '">D' + escHtml(key) + ' ' + escHtml(d.name) + '</div>';
    html += '<div class="stats-bar-track"><div class="stats-bar-fill" style="width:' + pct + '%;background:' + color + '"></div></div>';
    html += '<div class="stats-bar-value">' + d.count + '</div>';
    html += '</div>';
  });
  html += '</div></div>';

  // Two-column layout for tables
  html += '<div class="stats-columns">';

  // Top 10 most connected
  html += '<div class="stats-section"><h3>Top 10 Most Connected Documents</h3>';
  html += '<table class="stats-table"><thead><tr><th>Document</th><th style="text-align:right">Links</th></tr></thead><tbody>';
  topConnected.forEach(([docId, info]) => {
    html += '<tr>';
    html += '<td><span class="st-docid" onclick="closeStatsDashboard();openDoc(\'' + escHtml(docId) + '\')">' + escHtml(docId) + '</span><br><span style="font-size:11px;color:var(--text-muted)">' + escHtml(info.title) + '</span></td>';
    html += '<td class="st-num">' + info.total + '<br><span style="font-size:10px;color:var(--text-muted)">' + info.dependsOn + ' out / ' + info.dependedBy + ' in</span></td>';
    html += '</tr>';
  });
  html += '</tbody></table></div>';

  // Top 10 tags
  html += '<div class="stats-section"><h3>Top 10 Tags</h3>';
  if (topTags.length > 0) {
    html += '<div class="stats-bar-chart">';
    topTags.forEach(t => {
      const pct = (t.count / maxTagCount * 100).toFixed(1);
      html += '<div class="stats-bar-row">';
      html += '<div class="stats-bar-label" style="min-width:100px;max-width:140px;cursor:pointer" onclick="closeStatsDashboard();filterByTag(\'' + escHtml(t.tag) + '\')">#' + escHtml(t.tag) + '</div>';
      html += '<div class="stats-bar-track"><div class="stats-bar-fill" style="width:' + pct + '%;background:var(--mauve)"></div></div>';
      html += '<div class="stats-bar-value">' + t.count + '</div>';
      html += '</div>';
    });
    html += '</div>';
  } else {
    html += '<span style="color:var(--text-muted);font-size:13px">No tags available</span>';
  }
  html += '</div>';

  html += '</div>'; // close stats-columns

  container.innerHTML = html;
}

</script>

<!-- STATS DASHBOARD OVERLAY -->
<div class="stats-overlay" id="statsOverlay" onclick="if(event.target===this)closeStatsDashboard()">
  <div class="stats-dashboard">
    <div class="stats-dashboard-header">
      <h2>Domain Statistics Dashboard</h2>
      <button class="stats-close-btn" onclick="closeStatsDashboard()">&times;</button>
    </div>
    <div id="statsDashboardContent">
      <div class="loading"><div class="spinner"></div>Loading statistics...</div>
    </div>
  </div>
</div>

</body>
</html>
