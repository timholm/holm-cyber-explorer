<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <title>File Explorer</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-text-size-adjust: 100%; }

    :root {
      --bg: #1e1e1e;
      --sidebar-bg: #252526;
      --titlebar-bg: #323233;
      --address-bg: #3c3c3c;
      --border: #333333;
      --text: #cccccc;
      --text-dim: #888888;
      --accent: #0078d4;
      --hover: #2a2d2e;
      --selected: #094771;
      --scrollbar: #424242;
      --icon-folder: #dcb67a;
      --icon-file: #75beff;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 13px;
      height: 100vh;
      height: 100dvh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* ── TITLE BAR ── */
    .titlebar {
      background: var(--titlebar-bg);
      display: flex;
      align-items: center;
      padding: 6px 12px;
      border-bottom: 1px solid var(--border);
      min-height: 36px;
      flex-shrink: 0;
    }

    .titlebar-icon {
      width: 16px; height: 16px;
      margin-right: 8px;
      fill: var(--icon-folder);
    }

    .titlebar-text {
      font-size: 12px;
      color: var(--text);
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .win-btns {
      display: flex;
      gap: 2px;
      margin-left: auto;
    }

    .win-btn {
      width: 12px; height: 12px;
      border-radius: 50%;
      border: none;
    }

    .win-btn.minimize { background: #ffbd2e; }
    .win-btn.maximize { background: #27c93f; }
    .win-btn.close { background: #ff5f57; }

    /* ── TOOLBAR ── */
    .toolbar {
      background: var(--titlebar-bg);
      display: flex;
      align-items: center;
      padding: 4px 8px;
      border-bottom: 1px solid var(--border);
      gap: 4px;
      flex-shrink: 0;
    }

    .nav-btn {
      width: 28px; height: 28px;
      background: transparent;
      border: none;
      color: var(--text-dim);
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 3px;
      -webkit-tap-highlight-color: transparent;
    }

    .nav-btn:hover { background: var(--hover); }
    .nav-btn:active { background: var(--selected); color: #fff; }
    .nav-btn.disabled { opacity: 0.3; pointer-events: none; }

    .address-bar {
      flex: 1;
      display: flex;
      align-items: center;
      background: var(--address-bg);
      border: 1px solid var(--border);
      border-radius: 2px;
      padding: 0 10px;
      height: 28px;
      margin: 0 4px;
      overflow-x: auto;
      white-space: nowrap;
      -webkit-overflow-scrolling: touch;
    }

    .address-bar::-webkit-scrollbar { display: none; }

    .addr-seg {
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 2px;
      -webkit-tap-highlight-color: transparent;
    }

    .addr-seg:hover { background: var(--hover); }
    .addr-seg:active { background: var(--selected); color: #fff; }

    .addr-sep {
      color: var(--text-dim);
      font-size: 10px;
      margin: 0 1px;
    }

    .search-box {
      width: 180px;
      height: 28px;
      background: var(--address-bg);
      border: 1px solid var(--border);
      border-radius: 2px;
      color: var(--text);
      font-family: inherit;
      font-size: 12px;
      padding: 0 8px;
      outline: none;
    }

    .search-box:focus { border-color: var(--accent); }
    .search-box::placeholder { color: var(--text-dim); }

    @media (max-width: 600px) {
      .search-box { width: 100px; }
    }

    /* ── MAIN LAYOUT ── */
    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* ── SIDEBAR / NAV PANE ── */
    .sidebar {
      width: 220px;
      min-width: 220px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      overflow-x: hidden;
      flex-shrink: 0;
      padding: 4px 0;
      -webkit-overflow-scrolling: touch;
    }

    .sidebar::-webkit-scrollbar { width: 8px; }
    .sidebar::-webkit-scrollbar-track { background: transparent; }
    .sidebar::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 4px; }

    @media (max-width: 700px) {
      .sidebar { display: none; }
      .sidebar.show { display: block; position: absolute; left: 0; top: 0; bottom: 0; z-index: 500; width: 260px; box-shadow: 4px 0 20px rgba(0,0,0,0.5); }
      .hamburger { display: flex !important; }
    }

    .hamburger {
      display: none;
      width: 28px; height: 28px;
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      border-radius: 3px;
    }

    .sidebar-label {
      padding: 8px 16px 4px;
      font-size: 11px;
      color: var(--text-dim);
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .tree-item {
      display: flex;
      align-items: center;
      padding: 3px 8px 3px 0;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
      font-size: 13px;
    }

    .tree-item:hover { background: var(--hover); }
    .tree-item.active { background: var(--selected); color: #fff; }

    .tree-arrow {
      width: 20px;
      text-align: center;
      font-size: 10px;
      color: var(--text-dim);
      flex-shrink: 0;
      transition: transform 0.15s;
    }

    .tree-arrow.expanded { transform: rotate(90deg); }

    .tree-icon {
      margin-right: 6px;
      font-size: 14px;
      flex-shrink: 0;
    }

    .tree-icon.folder { color: var(--icon-folder); }

    .tree-children {
      display: none;
    }

    .tree-children.show {
      display: block;
    }

    /* ── CONTENT AREA ── */
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Column headers */
    .col-headers {
      display: flex;
      align-items: center;
      padding: 0 12px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
      min-height: 28px;
      flex-shrink: 0;
    }

    .col-h {
      font-size: 12px;
      color: var(--text-dim);
      padding: 4px 8px;
      cursor: default;
      white-space: nowrap;
    }

    .col-name { flex: 1; min-width: 0; }
    .col-date { width: 140px; }
    .col-type { width: 80px; }
    .col-size { width: 80px; text-align: right; }

    @media (max-width: 600px) {
      .col-date { display: none; }
      .col-type { display: none; }
      .col-size { width: 60px; }
    }

    /* File list */
    .file-list {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      padding: 2px 0;
    }

    .file-list::-webkit-scrollbar { width: 8px; }
    .file-list::-webkit-scrollbar-track { background: transparent; }
    .file-list::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 4px; }

    .file-row {
      display: flex;
      align-items: center;
      padding: 2px 12px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      min-height: 26px;
    }

    .file-row:hover { background: var(--hover); }
    .file-row.selected { background: var(--selected); color: #fff; }

    .file-row .col-name {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }

    .file-row .fname {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 13px;
    }

    .file-row .ficon {
      font-size: 16px;
      flex-shrink: 0;
    }

    .file-row .ficon.folder { color: var(--icon-folder); }
    .file-row .ficon.file { color: var(--icon-file); }

    .file-row .col-date,
    .file-row .col-type,
    .file-row .col-size {
      font-size: 12px;
      color: var(--text-dim);
      white-space: nowrap;
    }

    .file-row.selected .col-date,
    .file-row.selected .col-type,
    .file-row.selected .col-size { color: #ccc; }

    /* ── READING PANE ── */
    .reader-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: rgba(0,0,0,0.6);
    }

    .reader-overlay.show { display: flex; flex-direction: column; }

    .reader {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin: 0;
      background: var(--bg);
      overflow: hidden;
    }

    @media (min-width: 700px) {
      .reader {
        margin: 20px 40px;
        border-radius: 6px;
        border: 1px solid var(--border);
      }
    }

    .reader-toolbar {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      background: var(--titlebar-bg);
      border-bottom: 1px solid var(--border);
      min-height: 38px;
      flex-shrink: 0;
    }

    .reader-title {
      flex: 1;
      font-size: 13px;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin: 0 12px;
    }

    .reader-close {
      width: 30px; height: 30px;
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .reader-close:hover { background: #c42b1c; color: #fff; }

    .reader-body {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 24px 32px 40px;
      font-size: 14px;
      line-height: 1.7;
      color: #d4d4d4;
    }

    .reader-body::-webkit-scrollbar { width: 8px; }
    .reader-body::-webkit-scrollbar-track { background: transparent; }
    .reader-body::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 4px; }

    @media (max-width: 600px) {
      .reader-body { padding: 16px; font-size: 13px; }
    }

    /* Markdown rendered styles */
    .reader-body h1 { font-size: 24px; color: #fff; margin: 24px 0 12px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
    .reader-body h2 { font-size: 20px; color: #fff; margin: 20px 0 10px; padding-bottom: 4px; border-bottom: 1px solid var(--border); }
    .reader-body h3 { font-size: 17px; color: #e0e0e0; margin: 16px 0 8px; }
    .reader-body h4 { font-size: 15px; color: #d0d0d0; margin: 14px 0 6px; }
    .reader-body h5, .reader-body h6 { font-size: 14px; color: #c0c0c0; margin: 12px 0 6px; }
    .reader-body p { margin: 8px 0; }
    .reader-body ul, .reader-body ol { margin: 8px 0; padding-left: 24px; }
    .reader-body li { margin: 3px 0; }
    .reader-body blockquote { border-left: 3px solid var(--accent); padding: 4px 16px; margin: 8px 0; color: #999; background: rgba(255,255,255,0.03); }
    .reader-body pre { background: #1a1a2e; padding: 12px 16px; border-radius: 4px; overflow-x: auto; margin: 8px 0; font-family: 'Courier New', monospace; font-size: 13px; color: #ce9178; border: 1px solid #2a2a3e; }
    .reader-body code { background: #2a2a3e; padding: 2px 6px; border-radius: 3px; font-family: 'Courier New', monospace; font-size: 12px; color: #ce9178; }
    .reader-body pre code { background: none; padding: 0; border-radius: 0; }
    .reader-body hr { border: none; border-top: 1px solid var(--border); margin: 16px 0; }
    .reader-body table { border-collapse: collapse; margin: 8px 0; width: 100%; }
    .reader-body th { background: #2a2a3e; padding: 6px 12px; border: 1px solid var(--border); text-align: left; font-size: 12px; color: #e0e0e0; }
    .reader-body td { padding: 6px 12px; border: 1px solid var(--border); font-size: 12px; }
    .reader-body a { color: var(--accent); }
    .reader-body strong { color: #fff; }
    .reader-body em { color: #c0c0c0; font-style: italic; }

    .loading { text-align: center; padding: 40px; color: var(--text-dim); }

    /* ── STATUS BAR ── */
    .statusbar {
      display: flex;
      align-items: center;
      padding: 2px 12px;
      background: var(--titlebar-bg);
      border-top: 1px solid var(--border);
      min-height: 24px;
      flex-shrink: 0;
      font-size: 11px;
      color: var(--text-dim);
      gap: 16px;
    }

    .status-left { flex: 1; }
  </style>
</head>
<body>

  <!-- TITLE BAR -->
  <div class="titlebar">
    <svg class="titlebar-icon" viewBox="0 0 16 16"><path d="M1 3.5A1.5 1.5 0 012.5 2h3.379a1.5 1.5 0 011.06.44l.622.62A1.5 1.5 0 008.622 3.5H13.5A1.5 1.5 0 0115 5v7.5a1.5 1.5 0 01-1.5 1.5h-11A1.5 1.5 0 011 12.5v-9z" fill="#dcb67a"/></svg>
    <span class="titlebar-text" id="titlebar-text">HOLM Intelligence Complex</span>
    <div class="win-btns">
      <div class="win-btn minimize"></div>
      <div class="win-btn maximize"></div>
      <div class="win-btn close"></div>
    </div>
  </div>

  <!-- TOOLBAR -->
  <div class="toolbar">
    <button class="hamburger" id="hamburger-btn">&#9776;</button>
    <button class="nav-btn disabled" id="btn-back">&#8592;</button>
    <button class="nav-btn disabled" id="btn-fwd">&#8594;</button>
    <button class="nav-btn" id="btn-up">&#8593;</button>
    <div class="address-bar" id="address-bar"></div>
    <input class="search-box" id="search-box" type="text" placeholder="Search..." autocomplete="off" autocorrect="off" spellcheck="false">
  </div>

  <!-- MAIN -->
  <div class="main">
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-label">Quick Access</div>
      <div id="sidebar-tree"></div>
    </div>

    <!-- CONTENT -->
    <div class="content">
      <div class="col-headers">
        <div class="col-h col-name">Name</div>
        <div class="col-h col-date">Date modified</div>
        <div class="col-h col-type">Type</div>
        <div class="col-h col-size">Size</div>
      </div>
      <div class="file-list" id="file-list"></div>
    </div>
  </div>

  <!-- STATUS BAR -->
  <div class="statusbar">
    <span class="status-left" id="status-text">0 items</span>
    <span id="status-path"></span>
  </div>

  <!-- READER OVERLAY -->
  <div class="reader-overlay" id="reader-overlay">
    <div class="reader">
      <div class="reader-toolbar">
        <svg width="16" height="16" viewBox="0 0 16 16"><path d="M2 3h12v1H2V3zm0 3h12v1H2V6zm0 3h9v1H2V9zm0 3h11v1H2v-1z" fill="#75beff"/></svg>
        <span class="reader-title" id="reader-title"></span>
        <button class="reader-close" id="reader-close">&#10005;</button>
      </div>
      <div class="reader-body" id="reader-body">
        <div class="loading">Loading...</div>
      </div>
    </div>
  </div>

  <script>
    /* ================================================================
       FILE SYSTEM DATA
       ================================================================ */
    var FILES = {
      "stage1-meta-framework.md": { size: 45, date: "2026-02-17" },
      "stage1-domains-1-5.md": { size: 62, date: "2026-02-17" },
      "stage1-domains-6-10.md": { size: 58, date: "2026-02-17" },
      "stage1-domains-11-15.md": { size: 55, date: "2026-02-17" },
      "stage1-domains-16-20.md": { size: 60, date: "2026-02-17" },
      "stage2-core-charter.md": { size: 48, date: "2026-02-17" },
      "stage2-philosophy-batch2.md": { size: 52, date: "2026-02-17" },
      "stage2-philosophy-batch3.md": { size: 50, date: "2026-02-17" },
      "stage2-philosophy-batch4.md": { size: 51, date: "2026-02-17" },
      "stage3-automation-ops.md": { size: 42, date: "2026-02-17" },
      "stage3-data-ops.md": { size: 38, date: "2026-02-17" },
      "stage3-education-ops.md": { size: 40, date: "2026-02-17" },
      "stage3-ethics-quality-ops.md": { size: 44, date: "2026-02-17" },
      "stage3-federation-ops.md": { size: 41, date: "2026-02-17" },
      "stage3-governance-ops.md": { size: 39, date: "2026-02-17" },
      "stage3-intel-ops.md": { size: 43, date: "2026-02-17" },
      "stage3-interface-ops.md": { size: 37, date: "2026-02-17" },
      "stage3-ops-batch1.md": { size: 46, date: "2026-02-17" },
      "stage3-ops-batch2.md": { size: 45, date: "2026-02-17" },
      "stage3-ops-batch3.md": { size: 47, date: "2026-02-17" },
      "stage3-platform-ops.md": { size: 36, date: "2026-02-17" },
      "stage4-automation-advanced.md": { size: 55, date: "2026-02-17" },
      "stage4-data-advanced.md": { size: 52, date: "2026-02-17" },
      "stage4-evolution-memory-advanced.md": { size: 58, date: "2026-02-17" },
      "stage4-federation-import-advanced.md": { size: 54, date: "2026-02-17" },
      "stage4-hic-architecture.md": { size: 84, date: "2026-02-17" },
      "stage4-hic-interaction.md": { size: 75, date: "2026-02-17" },
      "stage4-hic-knowledge-mapping.md": { size: 92, date: "2026-02-17" },
      "stage4-hic-master-blueprint.md": { size: 81, date: "2026-02-17" },
      "stage4-hic-offline-rendering.md": { size: 81, date: "2026-02-17" },
      "stage4-hic-spatial-data.md": { size: 70, date: "2026-02-17" },
      "stage4-hic-visual-design.md": { size: 62, date: "2026-02-17" },
      "stage4-infrastructure-advanced.md": { size: 60, date: "2026-02-17" },
      "stage4-research-advanced.md": { size: 56, date: "2026-02-17" },
      "stage4-security-advanced.md": { size: 53, date: "2026-02-17" },
      "stage5-meta-batch1.md": { size: 48, date: "2026-02-17" },
      "stage5-meta-batch2.md": { size: 50, date: "2026-02-17" },
      "stage5-meta-batch3.md": { size: 47, date: "2026-02-17" },
      "deploy-quick.md": { size: 12, date: "2026-02-17" }
    };

    /* Virtual folder tree */
    var TREE = {
      name: "HOLM Intelligence Complex",
      children: [
        { name: "Simulation & Foresight", children: [
          { name: "HIC Control", files: [
            "stage4-hic-architecture.md", "stage4-hic-visual-design.md",
            "stage4-hic-spatial-data.md", "stage4-hic-interaction.md",
            "stage4-hic-knowledge-mapping.md", "stage4-hic-offline-rendering.md",
            "stage4-hic-master-blueprint.md"
          ]},
          { name: "Disaster & Evolution", files: [
            "stage4-evolution-memory-advanced.md"
          ]}
        ]},
        { name: "Strategy & Doctrine", children: [
          { name: "Constitution & Charter", files: [
            "stage2-core-charter.md"
          ]},
          { name: "Meta Framework", files: [
            "stage1-meta-framework.md", "stage5-meta-batch1.md",
            "stage5-meta-batch2.md", "stage5-meta-batch3.md"
          ]},
          { name: "Philosophy", files: [
            "stage2-philosophy-batch2.md", "stage2-philosophy-batch3.md",
            "stage2-philosophy-batch4.md"
          ]},
          { name: "Domain Frameworks", files: [
            "stage1-domains-1-5.md", "stage1-domains-6-10.md",
            "stage1-domains-11-15.md", "stage1-domains-16-20.md"
          ]}
        ]},
        { name: "Command", children: [
          { name: "Governance & Admin", files: [
            "stage3-governance-ops.md", "stage3-ethics-quality-ops.md"
          ]},
          { name: "Security", files: [
            "stage4-security-advanced.md"
          ]},
          { name: "Automation", files: [
            "stage3-automation-ops.md", "stage4-automation-advanced.md"
          ]},
          { name: "Education & Training", files: [
            "stage3-education-ops.md"
          ]},
          { name: "Operations Doctrine", files: [
            "stage3-ops-batch1.md", "stage3-ops-batch2.md", "stage3-ops-batch3.md"
          ]}
        ]},
        { name: "Analysis", children: [
          { name: "Intelligence", files: [
            "stage3-intel-ops.md"
          ]},
          { name: "Research & Theory", files: [
            "stage4-research-advanced.md"
          ]},
          { name: "Infrastructure", files: [
            "stage3-platform-ops.md", "stage4-infrastructure-advanced.md"
          ]}
        ]},
        { name: "Collection", children: [
          { name: "Data & Archives", files: [
            "stage3-data-ops.md", "stage4-data-advanced.md"
          ]},
          { name: "Federation & Import", files: [
            "stage3-federation-ops.md", "stage3-interface-ops.md",
            "stage4-federation-import-advanced.md"
          ]}
        ]},
        { name: "Deploy", files: [
          "deploy-quick.md"
        ]}
      ]
    };

    /* ================================================================
       STATE
       ================================================================ */
    var currentPath = [];
    var history = [];
    var historyIdx = -1;
    var selectedRow = null;

    /* ================================================================
       NAVIGATION
       ================================================================ */
    function getNode(path) {
      var node = TREE;
      for (var i = 0; i < path.length; i++) {
        if (!node.children) return null;
        var found = false;
        for (var j = 0; j < node.children.length; j++) {
          if (node.children[j].name === path[i]) {
            node = node.children[j];
            found = true;
            break;
          }
        }
        if (!found) return null;
      }
      return node;
    }

    function navigate(path, addHistory) {
      var node = getNode(path);
      if (!node) return;
      currentPath = path.slice();

      if (addHistory !== false) {
        if (historyIdx < history.length - 1) {
          history = history.slice(0, historyIdx + 1);
        }
        history.push(path.slice());
        historyIdx = history.length - 1;
      }

      renderAddressBar();
      renderContent(node);
      renderSidebarActive();
      updateNavButtons();

      document.getElementById("titlebar-text").textContent =
        path.length > 0 ? path[path.length - 1] : TREE.name;
      document.getElementById("status-path").textContent =
        "HOLM Intelligence Complex" + (path.length > 0 ? " > " + path.join(" > ") : "");
    }

    function goBack() {
      if (historyIdx > 0) {
        historyIdx--;
        navigate(history[historyIdx], false);
      }
    }

    function goForward() {
      if (historyIdx < history.length - 1) {
        historyIdx++;
        navigate(history[historyIdx], false);
      }
    }

    function goUp() {
      if (currentPath.length > 0) {
        navigate(currentPath.slice(0, -1));
      }
    }

    function updateNavButtons() {
      var bb = document.getElementById("btn-back");
      var bf = document.getElementById("btn-fwd");
      bb.className = "nav-btn" + (historyIdx > 0 ? "" : " disabled");
      bf.className = "nav-btn" + (historyIdx < history.length - 1 ? "" : " disabled");
    }

    /* ================================================================
       ADDRESS BAR
       ================================================================ */
    function renderAddressBar() {
      var bar = document.getElementById("address-bar");
      var html = '<span class="addr-seg" onclick="navigate([])">HOLM Intelligence Complex</span>';
      for (var i = 0; i < currentPath.length; i++) {
        var p = currentPath.slice(0, i + 1);
        html += '<span class="addr-sep">&#8250;</span>';
        html += '<span class="addr-seg" onclick="navigate(' + JSON.stringify(p) + ')">' + currentPath[i] + '</span>';
      }
      bar.innerHTML = html;
      bar.scrollLeft = bar.scrollWidth;
    }

    /* ================================================================
       CONTENT AREA
       ================================================================ */
    function renderContent(node, filter) {
      var list = document.getElementById("file-list");
      var items = [];

      /* Sub-folders */
      if (node.children) {
        node.children.forEach(function(child) {
          var count = countFiles(child);
          items.push({
            type: "folder",
            name: child.name,
            date: "2026-02-17 00:00",
            typeLabel: "File folder",
            size: count + " items",
            path: currentPath.concat([child.name])
          });
        });
      }

      /* Files */
      if (node.files) {
        node.files.forEach(function(fname) {
          var meta = FILES[fname] || { size: 0, date: "2026-02-17" };
          items.push({
            type: "file",
            name: fname,
            date: meta.date + " 00:00",
            typeLabel: "MD File",
            size: meta.size + " KB",
            filename: fname
          });
        });
      }

      /* Search filter */
      if (filter) {
        var q = filter.toLowerCase();
        items = items.filter(function(it) {
          return it.name.toLowerCase().indexOf(q) !== -1;
        });
      }

      var html = "";
      items.forEach(function(it, idx) {
        var icon, cls;
        if (it.type === "folder") {
          icon = "&#128193;";
          cls = "folder";
        } else {
          icon = "&#128196;";
          cls = "file";
        }

        html += '<div class="file-row" data-idx="' + idx + '" data-type="' + it.type + '"' +
          (it.type === "folder" ? ' data-path=\'' + JSON.stringify(it.path) + '\'' : '') +
          (it.type === "file" ? ' data-file="' + it.filename + '"' : '') +
          '>' +
          '<div class="col-name"><span class="ficon ' + cls + '">' + icon + '</span><span class="fname">' + it.name + '</span></div>' +
          '<div class="col-date">' + it.date + '</div>' +
          '<div class="col-type">' + it.typeLabel + '</div>' +
          '<div class="col-size">' + it.size + '</div>' +
          '</div>';
      });

      list.innerHTML = html;

      document.getElementById("status-text").textContent = items.length + " item" + (items.length !== 1 ? "s" : "");

      /* Click handlers */
      var rows = list.querySelectorAll(".file-row");
      rows.forEach(function(row) {
        row.addEventListener("click", function() {
          /* Select */
          if (selectedRow) selectedRow.classList.remove("selected");
          row.classList.add("selected");
          selectedRow = row;
        });

        row.addEventListener("dblclick", function() {
          openRow(row);
        });

        /* Mobile: single tap opens after brief delay to distinguish from scroll */
        var tapTimer = null;
        row.addEventListener("touchend", function(e) {
          if (selectedRow === row && tapTimer) {
            clearTimeout(tapTimer);
            tapTimer = null;
            openRow(row);
            return;
          }
          if (selectedRow) selectedRow.classList.remove("selected");
          row.classList.add("selected");
          selectedRow = row;
          tapTimer = setTimeout(function() { tapTimer = null; }, 400);
        });
      });
    }

    function openRow(row) {
      if (row.getAttribute("data-type") === "folder") {
        var p = JSON.parse(row.getAttribute("data-path"));
        navigate(p);
      } else {
        var fname = row.getAttribute("data-file");
        if (fname) openFile(fname);
      }
    }

    function countFiles(node) {
      var c = 0;
      if (node.files) c += node.files.length;
      if (node.children) node.children.forEach(function(ch) { c += countFiles(ch); });
      return c;
    }

    /* ================================================================
       SIDEBAR TREE
       ================================================================ */
    function renderSidebar() {
      var container = document.getElementById("sidebar-tree");
      container.innerHTML = "";
      renderTreeNode(container, TREE, [], 0);
    }

    function renderTreeNode(parent, node, path, depth) {
      var item = document.createElement("div");
      item.className = "tree-item";
      item.style.paddingLeft = (8 + depth * 16) + "px";
      item.setAttribute("data-path", JSON.stringify(path));

      var hasChildren = node.children && node.children.length > 0;
      var arrowHTML = hasChildren ? '<span class="tree-arrow">&#9656;</span>' : '<span class="tree-arrow"></span>';

      item.innerHTML = arrowHTML +
        '<span class="tree-icon folder">&#128193;</span>' +
        '<span>' + node.name + '</span>';

      parent.appendChild(item);

      var childContainer = null;
      if (hasChildren) {
        childContainer = document.createElement("div");
        childContainer.className = "tree-children";
        parent.appendChild(childContainer);

        node.children.forEach(function(child) {
          renderTreeNode(childContainer, child, path.concat([child.name]), depth + 1);
        });
      }

      item.addEventListener("click", function(e) {
        e.stopPropagation();
        navigate(path);

        /* Toggle expand */
        if (childContainer) {
          var isOpen = childContainer.classList.contains("show");
          childContainer.classList.toggle("show");
          var arrow = item.querySelector(".tree-arrow");
          if (arrow) {
            arrow.classList.toggle("expanded", !isOpen);
          }
        }

        /* Close sidebar on mobile */
        if (window.innerWidth <= 700) {
          document.getElementById("sidebar").classList.remove("show");
        }
      });
    }

    function renderSidebarActive() {
      var items = document.querySelectorAll(".tree-item");
      var pathStr = JSON.stringify(currentPath);
      items.forEach(function(it) {
        it.classList.toggle("active", it.getAttribute("data-path") === pathStr);
      });

      /* Auto-expand parents */
      items.forEach(function(it) {
        var p = JSON.parse(it.getAttribute("data-path"));
        if (currentPath.length >= p.length && p.length > 0) {
          var match = true;
          for (var i = 0; i < p.length; i++) {
            if (p[i] !== currentPath[i]) { match = false; break; }
          }
          if (match) {
            var next = it.nextElementSibling;
            if (next && next.classList.contains("tree-children")) {
              next.classList.add("show");
              var arrow = it.querySelector(".tree-arrow");
              if (arrow) arrow.classList.add("expanded");
            }
          }
        }
      });
    }

    /* ================================================================
       FILE READER + MARKDOWN PARSER
       ================================================================ */
    function openFile(filename) {
      var overlay = document.getElementById("reader-overlay");
      var body = document.getElementById("reader-body");
      var title = document.getElementById("reader-title");

      title.textContent = filename;
      body.innerHTML = '<div class="loading">Loading document...</div>';
      overlay.classList.add("show");

      fetch("docs/" + filename)
        .then(function(res) {
          if (!res.ok) throw new Error("Not found");
          return res.text();
        })
        .then(function(md) {
          body.innerHTML = renderMarkdown(md);
          body.scrollTop = 0;
        })
        .catch(function(err) {
          body.innerHTML = '<div class="loading">Error loading file: ' + err.message + '</div>';
        });
    }

    function renderMarkdown(src) {
      var lines = src.split("\n");
      var html = "";
      var inCodeBlock = false;
      var codeContent = "";
      var inList = false;
      var listType = "";
      var inTable = false;
      var tableRows = [];

      function closeList() {
        if (inList) {
          html += "</" + listType + ">";
          inList = false;
        }
      }

      function closeTable() {
        if (inTable) {
          html += "<table><thead><tr>";
          if (tableRows.length > 0) {
            tableRows[0].forEach(function(c) { html += "<th>" + esc(c.trim()) + "</th>"; });
            html += "</tr></thead><tbody>";
            for (var i = 2; i < tableRows.length; i++) {
              html += "<tr>";
              tableRows[i].forEach(function(c) { html += "<td>" + inline(c.trim()) + "</td>"; });
              html += "</tr>";
            }
            html += "</tbody>";
          }
          html += "</table>";
          inTable = false;
          tableRows = [];
        }
      }

      function esc(s) {
        return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      }

      function inline(s) {
        s = esc(s);
        s = s.replace(/`([^`]+)`/g, "<code>$1</code>");
        s = s.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
        s = s.replace(/\*([^*]+)\*/g, "<em>$1</em>");
        s = s.replace(/__([^_]+)__/g, "<strong>$1</strong>");
        s = s.replace(/_([^_]+)_/g, "<em>$1</em>");
        s = s.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
        return s;
      }

      for (var i = 0; i < lines.length; i++) {
        var line = lines[i];

        /* Code blocks */
        if (line.match(/^```/)) {
          if (inCodeBlock) {
            html += "<pre><code>" + esc(codeContent) + "</code></pre>";
            codeContent = "";
            inCodeBlock = false;
          } else {
            closeList();
            closeTable();
            inCodeBlock = true;
          }
          continue;
        }

        if (inCodeBlock) {
          codeContent += (codeContent ? "\n" : "") + line;
          continue;
        }

        /* Table rows */
        if (line.match(/^\|/)) {
          closeList();
          if (!inTable) inTable = true;
          var cells = line.split("|").slice(1, -1);
          if (!line.match(/^\|\s*[-:]+/)) {
            tableRows.push(cells);
          } else {
            tableRows.push(null); /* separator row */
          }
          continue;
        } else {
          closeTable();
        }

        /* Blank line */
        if (line.trim() === "") {
          closeList();
          continue;
        }

        /* Headings */
        var hm = line.match(/^(#{1,6})\s+(.*)$/);
        if (hm) {
          closeList();
          var lvl = hm[1].length;
          html += "<h" + lvl + ">" + inline(hm[2]) + "</h" + lvl + ">";
          continue;
        }

        /* HR */
        if (line.match(/^---+\s*$/) || line.match(/^\*\*\*+\s*$/)) {
          closeList();
          html += "<hr>";
          continue;
        }

        /* Blockquote */
        if (line.match(/^>\s?/)) {
          closeList();
          html += "<blockquote>" + inline(line.replace(/^>\s?/, "")) + "</blockquote>";
          continue;
        }

        /* Unordered list */
        if (line.match(/^\s*[-*+]\s+/)) {
          if (!inList || listType !== "ul") {
            closeList();
            html += "<ul>";
            inList = true;
            listType = "ul";
          }
          html += "<li>" + inline(line.replace(/^\s*[-*+]\s+/, "")) + "</li>";
          continue;
        }

        /* Ordered list */
        if (line.match(/^\s*\d+\.\s+/)) {
          if (!inList || listType !== "ol") {
            closeList();
            html += "<ol>";
            inList = true;
            listType = "ol";
          }
          html += "<li>" + inline(line.replace(/^\s*\d+\.\s+/, "")) + "</li>";
          continue;
        }

        /* Paragraph */
        closeList();
        html += "<p>" + inline(line) + "</p>";
      }

      closeList();
      closeTable();
      if (inCodeBlock) {
        html += "<pre><code>" + esc(codeContent) + "</code></pre>";
      }

      return html;
    }

    /* ================================================================
       SEARCH
       ================================================================ */
    var searchBox = document.getElementById("search-box");
    var searchTimer = null;

    searchBox.addEventListener("input", function() {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(function() {
        var q = searchBox.value.trim();
        if (q) {
          /* Search all files globally */
          var results = [];
          searchNode(TREE, [], q.toLowerCase(), results);
          renderSearchResults(results);
        } else {
          navigate(currentPath, false);
        }
      }, 200);
    });

    function searchNode(node, path, q, results) {
      if (node.files) {
        node.files.forEach(function(fname) {
          if (fname.toLowerCase().indexOf(q) !== -1) {
            results.push({ name: fname, path: path.slice() });
          }
        });
      }
      if (node.children) {
        node.children.forEach(function(ch) {
          searchNode(ch, path.concat([ch.name]), q, results);
        });
      }
    }

    function renderSearchResults(results) {
      var list = document.getElementById("file-list");
      var html = "";
      results.forEach(function(r) {
        var meta = FILES[r.name] || { size: 0, date: "2026-02-17" };
        html += '<div class="file-row" data-type="file" data-file="' + r.name + '">' +
          '<div class="col-name"><span class="ficon file">&#128196;</span><span class="fname">' + r.name + '</span></div>' +
          '<div class="col-date">' + meta.date + ' 00:00</div>' +
          '<div class="col-type">MD File</div>' +
          '<div class="col-size">' + meta.size + ' KB</div>' +
          '</div>';
      });

      if (results.length === 0) {
        html = '<div class="file-row"><div class="col-name"><span class="fname" style="color:#888">No results found</span></div></div>';
      }

      list.innerHTML = html;
      document.getElementById("status-text").textContent = results.length + " result" + (results.length !== 1 ? "s" : "");

      /* Re-bind click handlers */
      list.querySelectorAll(".file-row").forEach(function(row) {
        row.addEventListener("click", function() {
          if (selectedRow) selectedRow.classList.remove("selected");
          row.classList.add("selected");
          selectedRow = row;
        });
        row.addEventListener("dblclick", function() { openRow(row); });
        var tap = null;
        row.addEventListener("touchend", function() {
          if (selectedRow === row && tap) { clearTimeout(tap); tap = null; openRow(row); return; }
          if (selectedRow) selectedRow.classList.remove("selected");
          row.classList.add("selected");
          selectedRow = row;
          tap = setTimeout(function() { tap = null; }, 400);
        });
      });
    }

    /* ================================================================
       EVENT HANDLERS
       ================================================================ */
    document.getElementById("btn-back").addEventListener("click", goBack);
    document.getElementById("btn-fwd").addEventListener("click", goForward);
    document.getElementById("btn-up").addEventListener("click", goUp);

    document.getElementById("reader-close").addEventListener("click", function() {
      document.getElementById("reader-overlay").classList.remove("show");
    });

    document.getElementById("reader-overlay").addEventListener("click", function(e) {
      if (e.target === this) this.classList.remove("show");
    });

    document.getElementById("hamburger-btn").addEventListener("click", function() {
      document.getElementById("sidebar").classList.toggle("show");
    });

    /* Close sidebar when tapping outside on mobile */
    document.querySelector(".content").addEventListener("click", function() {
      if (window.innerWidth <= 700) {
        document.getElementById("sidebar").classList.remove("show");
      }
    });

    /* ================================================================
       INIT
       ================================================================ */
    renderSidebar();
    navigate([]);
  </script>

</body>
</html>
