# ═══════════════════════════════════════════════════════════════
# HOLM Network Policies — Air-Gapped Namespace Isolation
# ═══════════════════════════════════════════════════════════════
# Enforces zero-trust networking within the HOLM cluster.
# Each namespace gets explicit ingress/egress rules.
# Default: deny everything, then allow only what's needed.
#
# TASK-031: Local DNS and Firewall Rules
# ═══════════════════════════════════════════════════════════════

---
# ── Default Deny All (holm-cyber namespace) ──────────────────
# Block all ingress AND egress by default. Every connection must
# be explicitly permitted by a subsequent policy.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: holm-cyber
  labels:
    holm.chat/layer: security
    holm.chat/task: TASK-031
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress

---
# ── Allow DNS Resolution ─────────────────────────────────────
# All pods in holm-cyber need to reach CoreDNS in kube-system
# for service discovery. Without this, nothing resolves.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns
  namespace: holm-cyber
  labels:
    holm.chat/layer: security
    holm.chat/task: TASK-031
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

---
# ── Allow App → MongoDB ──────────────────────────────────────
# The holm-cyber Express app connects to MongoDB on port 27017.
# Only the app pod can reach MongoDB, not arbitrary pods.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-app-to-mongodb
  namespace: holm-cyber
  labels:
    holm.chat/layer: security
    holm.chat/task: TASK-031
spec:
  podSelector:
    matchLabels:
      app: holm-cyber
  policyTypes:
    - Egress
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: mongodb
      ports:
        - protocol: TCP
          port: 27017

---
# ── Allow MongoDB Ingress from App ────────────────────────────
# MongoDB only accepts connections from the holm-cyber app.
# No external access, no cross-namespace access.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-mongodb-from-app
  namespace: holm-cyber
  labels:
    holm.chat/layer: security
    holm.chat/task: TASK-031
spec:
  podSelector:
    matchLabels:
      app: mongodb
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: holm-cyber
      ports:
        - protocol: TCP
          port: 27017

---
# ── Allow Envoy Gateway → App ────────────────────────────────
# Envoy Gateway routes external (LAN) traffic to the app.
# Only the gateway namespace can reach the app on port 3000.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-from-gateway
  namespace: holm-cyber
  labels:
    holm.chat/layer: security
    holm.chat/task: TASK-031
spec:
  podSelector:
    matchLabels:
      app: holm-cyber
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: envoy-gateway-system
      ports:
        - protocol: TCP
          port: 3000

---
# ── Allow LAN-Only Egress (Air-Gap Enforcement) ──────────────
# The app can reach the local network (192.168.8.0/24) for
# inter-node communication but CANNOT reach the internet.
# This is the core air-gap policy at the k8s network layer.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-lan-egress-only
  namespace: holm-cyber
  labels:
    holm.chat/layer: security
    holm.chat/task: TASK-031
spec:
  podSelector:
    matchLabels:
      app: holm-cyber
  policyTypes:
    - Egress
  egress:
    # Local network — node-to-node, services on LAN
    - to:
        - ipBlock:
            cidr: 192.168.8.0/24
    # k3s pod network (default CIDR)
    - to:
        - ipBlock:
            cidr: 10.42.0.0/16
    # k3s service network (default CIDR)
    - to:
        - ipBlock:
            cidr: 10.43.0.0/16

---
# ── Allow NodePort Ingress ────────────────────────────────────
# When MetalLB is unavailable, NodePort 30080 serves as fallback.
# Allow ingress from LAN IPs only.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-nodeport-from-lan
  namespace: holm-cyber
  labels:
    holm.chat/layer: security
    holm.chat/task: TASK-031
spec:
  podSelector:
    matchLabels:
      app: holm-cyber
  policyTypes:
    - Ingress
  ingress:
    - from:
        - ipBlock:
            cidr: 192.168.8.0/24
      ports:
        - protocol: TCP
          port: 3000

---
# ── Monitoring Namespace Policies ─────────────────────────────
# Allow Prometheus/Grafana in monitoring namespace to scrape
# metrics from holm-cyber pods.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-monitoring-scrape
  namespace: holm-cyber
  labels:
    holm.chat/layer: security
    holm.chat/task: TASK-031
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - protocol: TCP
          port: 3000
