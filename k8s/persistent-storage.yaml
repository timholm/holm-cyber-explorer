# ═══════════════════════════════════════════════════════════════
# HOLM Persistent Storage for Offline Operation (TASK-030)
# ═══════════════════════════════════════════════════════════════
# Provides persistent volumes so the system survives restarts,
# network outages, and eventual air-gap without data loss.
#
# Components:
#   1. app-content PVC    — cached app code + docs (no GitHub needed on restart)
#   2. mongodb-backup PVC — scheduled MongoDB dumps for disaster recovery
#   3. local-cache PVC    — file-based fallback cache for offline reads
#   4. MongoDB backup CronJob — nightly mongodump to PV
# ═══════════════════════════════════════════════════════════════

---
# App content — persists cloned repos so init container only clones once
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: app-content
  namespace: holm-cyber
  labels:
    app: holm-cyber
    holm.chat/component: app-storage
spec:
  accessModes: ["ReadWriteOnce"]
  storageClassName: longhorn
  resources:
    requests:
      storage: 2Gi

---
# MongoDB backup volume — stores mongodump archives
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mongodb-backup
  namespace: holm-cyber
  labels:
    app: mongodb
    holm.chat/component: backup
spec:
  accessModes: ["ReadWriteOnce"]
  storageClassName: longhorn
  resources:
    requests:
      storage: 1Gi

---
# Local cache volume — file-based read cache for offline operation
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: local-cache
  namespace: holm-cyber
  labels:
    app: holm-cyber
    holm.chat/component: offline-cache
spec:
  accessModes: ["ReadWriteOnce"]
  storageClassName: longhorn
  resources:
    requests:
      storage: 512Mi

---
# MongoDB backup CronJob — nightly dump at 02:00
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mongodb-backup
  namespace: holm-cyber
  labels:
    app: mongodb
    holm.chat/component: backup
spec:
  schedule: "0 2 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: mongodump
              image: mongo:7
              command:
                - sh
                - -c
                - |
                  TIMESTAMP=$(date +%Y%m%d-%H%M%S)
                  BACKUP_DIR=/backup/${TIMESTAMP}
                  echo "[backup] Starting MongoDB dump → ${BACKUP_DIR}"
                  mongodump \
                    --uri="mongodb://mongodb.holm-cyber.svc:27017/holmvault" \
                    --out="${BACKUP_DIR}" \
                    --gzip
                  echo "[backup] Dump complete. Pruning backups older than 7 days..."
                  find /backup -maxdepth 1 -type d -mtime +7 -exec rm -rf {} +
                  echo "[backup] Remaining backups:"
                  ls -la /backup/
                  echo "[backup] Done."
              volumeMounts:
                - name: backup-vol
                  mountPath: /backup
              resources:
                requests:
                  memory: "128Mi"
                  cpu: "50m"
                limits:
                  memory: "256Mi"
                  cpu: "200m"
          volumes:
            - name: backup-vol
              persistentVolumeClaim:
                claimName: mongodb-backup
