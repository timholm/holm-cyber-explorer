# ═══════════════════════════════════════════════════════════════
# HOLM Local Networking Configuration
# ═══════════════════════════════════════════════════════════════
# Replaces Cloudflare tunnel with direct local network access.
# Envoy Gateway gets a MetalLB LoadBalancer IP so all services
# are reachable on the LAN without any external dependency.
#
# Architecture:
#   Client (LAN) → MetalLB VIP → Envoy Gateway → HTTPRoute → Service
#
# DNS: See dns-config.yaml for CoreDNS zone configuration.
# Firewall: See network-policies.yaml for k8s-level isolation.
# Node firewall: See scripts/holm-firewall.sh for iptables rules.
# ═══════════════════════════════════════════════════════════════

---
# Patch Envoy Gateway's auto-created proxy service to LoadBalancer
# MetalLB will assign an IP from pool 192.168.8.50-192.168.8.99
apiVersion: v1
kind: Service
metadata:
  name: envoy-gateway-proxy
  namespace: envoy-gateway-system
  annotations:
    metallb.universe.tf/address-pool: default-pool
    holm.chat/purpose: "local-ingress"
spec:
  type: LoadBalancer
  # MetalLB auto-assigns from 192.168.8.50-99 pool
  # To pin a specific IP, uncomment:
  # loadBalancerIP: 192.168.8.50

---
# NodePort fallback — direct access on cluster node IPs
# Use this if MetalLB is unavailable
apiVersion: v1
kind: Service
metadata:
  name: holm-cyber-nodeport
  namespace: holm-cyber
  labels:
    app: holm-cyber
    holm.chat/access: "local-direct"
spec:
  type: NodePort
  selector:
    app: holm-cyber
  ports:
    - name: http
      port: 3000
      targetPort: 3000
      nodePort: 30080
