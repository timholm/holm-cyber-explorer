<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claude Code Gitea Actions</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: #0d1117;
  color: #c9d1d9;
  min-height: 100vh;
}
.header {
  background: #161b22;
  border-bottom: 1px solid #30363d;
  padding: 16px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.header h1 {
  font-size: 18px;
  font-weight: 600;
  color: #e6edf3;
}
.header h1 span { color: #7c3aed; }
.status-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: #3fb950;
  display: inline-block;
  margin-right: 8px;
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}
.container { max-width: 1200px; margin: 0 auto; padding: 24px; }
.grid { display: grid; grid-template-columns: 1fr 400px; gap: 24px; }
@media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

/* Stats */
.stats {
  display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap;
}
.stat-card {
  background: #161b22;
  border: 1px solid #30363d;
  border-radius: 8px;
  padding: 16px 20px;
  flex: 1;
  min-width: 120px;
}
.stat-card .label { font-size: 12px; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; }
.stat-card .value { font-size: 28px; font-weight: 700; color: #e6edf3; margin-top: 4px; }
.stat-card .value.working { color: #d29922; }
.stat-card .value.error { color: #f85149; }
.stat-card .value.complete { color: #3fb950; }

/* Event list */
.panel {
  background: #161b22;
  border: 1px solid #30363d;
  border-radius: 8px;
  overflow: hidden;
}
.panel-header {
  padding: 12px 16px;
  border-bottom: 1px solid #30363d;
  font-size: 14px;
  font-weight: 600;
  color: #e6edf3;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.event-list { max-height: 600px; overflow-y: auto; }
.event-item {
  padding: 12px 16px;
  border-bottom: 1px solid #21262d;
  cursor: pointer;
  transition: background 0.15s;
}
.event-item:hover { background: #1c2128; }
.event-item.selected { background: #1c2128; border-left: 3px solid #7c3aed; }
.event-meta {
  display: flex; align-items: center; gap: 8px;
  font-size: 12px; color: #8b949e; margin-bottom: 4px;
}
.event-badge {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 10px;
  font-weight: 600;
  text-transform: uppercase;
}
.badge-working { background: #d29922; color: #0d1117; }
.badge-complete { background: #238636; color: #fff; }
.badge-error { background: #da3633; color: #fff; }
.badge-pending { background: #30363d; color: #8b949e; }
.badge-pr { background: #1f6feb22; color: #58a6ff; border: 1px solid #1f6feb44; }
.badge-issue { background: #23863622; color: #3fb950; border: 1px solid #23863644; }
.badge-manual { background: #7c3aed22; color: #a78bfa; border: 1px solid #7c3aed44; }
.event-prompt {
  font-size: 13px; color: #c9d1d9;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.event-repo { color: #58a6ff; font-weight: 500; }
.event-time { margin-left: auto; white-space: nowrap; }

/* Detail panel */
.detail-panel { position: sticky; top: 24px; }
.detail-empty {
  padding: 40px 20px;
  text-align: center;
  color: #484f58;
  font-size: 14px;
}
.detail-content { padding: 16px; }
.detail-content h3 { font-size: 14px; color: #e6edf3; margin-bottom: 12px; }
.detail-field { margin-bottom: 12px; }
.detail-label { font-size: 11px; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
.detail-value { font-size: 13px; color: #c9d1d9; }
.detail-response {
  background: #0d1117;
  border: 1px solid #30363d;
  border-radius: 6px;
  padding: 12px;
  font-size: 13px;
  line-height: 1.5;
  max-height: 350px;
  overflow-y: auto;
  white-space: pre-wrap;
  word-break: break-word;
}

/* Trigger form */
.trigger-form { padding: 16px; }
.trigger-form label {
  display: block; font-size: 12px; color: #8b949e;
  text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;
}
.trigger-form input,
.trigger-form textarea {
  width: 100%;
  background: #0d1117;
  border: 1px solid #30363d;
  border-radius: 6px;
  padding: 8px 12px;
  color: #c9d1d9;
  font-size: 13px;
  font-family: inherit;
  margin-bottom: 12px;
  outline: none;
}
.trigger-form input:focus,
.trigger-form textarea:focus { border-color: #7c3aed; }
.trigger-form textarea { resize: vertical; min-height: 80px; }
.btn {
  background: #7c3aed;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 8px 16px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.15s;
  width: 100%;
}
.btn:hover { background: #6d28d9; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #30363d; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #484f58; }

/* Empty state */
.empty-state {
  text-align: center; padding: 60px 20px; color: #484f58;
}
.empty-state svg { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.3; }
</style>
</head>
<body>

<div class="header">
  <h1><span class="status-dot"></span>Claude Code <span>Gitea Actions</span></h1>
  <div style="font-size:12px;color:#8b949e" id="last-refresh">--</div>
</div>

<div class="container">
  <div class="stats" id="stats">
    <div class="stat-card"><div class="label">Total Events</div><div class="value" id="stat-total">0</div></div>
    <div class="stat-card"><div class="label">Working</div><div class="value working" id="stat-working">0</div></div>
    <div class="stat-card"><div class="label">Complete</div><div class="value complete" id="stat-complete">0</div></div>
    <div class="stat-card"><div class="label">Errors</div><div class="value error" id="stat-errors">0</div></div>
  </div>

  <div class="grid">
    <div>
      <div class="panel">
        <div class="panel-header">
          <span>Event Feed</span>
          <span style="font-size:12px;color:#8b949e" id="event-count">0 events</span>
        </div>
        <div class="event-list" id="event-list">
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            <p>No events yet</p>
            <p style="font-size:12px;margin-top:8px">Comment @claude on a Gitea issue to get started</p>
          </div>
        </div>
      </div>
    </div>

    <div class="detail-panel">
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-header">Event Detail</div>
        <div id="detail-content">
          <div class="detail-empty">Select an event to view details</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">Manual Trigger</div>
        <div class="trigger-form">
          <label>Repository (owner/repo)</label>
          <input type="text" id="trigger-repo" placeholder="tim/my-project">
          <label>Prompt</label>
          <textarea id="trigger-prompt" placeholder="What does this repo do?"></textarea>
          <button class="btn" id="trigger-btn" onclick="manualTrigger()">Send to Claude</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let allEvents = [];
let selectedId = null;

function timeAgo(ts) {
  const diff = Date.now() - new Date(ts).getTime();
  const s = Math.floor(diff / 1000);
  if (s < 60) return s + 's ago';
  const m = Math.floor(s / 60);
  if (m < 60) return m + 'm ago';
  const h = Math.floor(m / 60);
  if (h < 24) return h + 'h ago';
  return Math.floor(h / 24) + 'd ago';
}

function badgeClass(status) {
  return 'event-badge badge-' + status;
}

function typeBadge(type) {
  if (type === 'pr_comment') return '<span class="event-badge badge-pr">PR</span>';
  if (type === 'issue_comment') return '<span class="event-badge badge-issue">Issue</span>';
  return '<span class="event-badge badge-manual">Manual</span>';
}

function renderEvents() {
  const list = document.getElementById('event-list');
  const count = document.getElementById('event-count');
  count.textContent = allEvents.length + ' events';

  if (allEvents.length === 0) {
    list.innerHTML = `<div class="empty-state">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      <p>No events yet</p>
      <p style="font-size:12px;margin-top:8px">Comment @claude on a Gitea issue to get started</p>
    </div>`;
    return;
  }

  list.innerHTML = allEvents.map(e => `
    <div class="event-item ${e.id === selectedId ? 'selected' : ''}" onclick="selectEvent('${e.id}')">
      <div class="event-meta">
        ${typeBadge(e.type)}
        <span class="${badgeClass(e.status)}">${e.status}</span>
        <span class="event-repo">${e.repo || '--'}</span>
        ${e.issue ? '<span>#' + e.issue + '</span>' : ''}
        <span class="event-time">${timeAgo(e.timestamp)}</span>
      </div>
      <div class="event-prompt">${escapeHtml(e.prompt || '--')}</div>
    </div>
  `).join('');

  // Stats
  document.getElementById('stat-total').textContent = allEvents.length;
  document.getElementById('stat-working').textContent = allEvents.filter(e => e.status === 'working').length;
  document.getElementById('stat-complete').textContent = allEvents.filter(e => e.status === 'complete').length;
  document.getElementById('stat-errors').textContent = allEvents.filter(e => e.status === 'error').length;
}

function selectEvent(id) {
  selectedId = id;
  const e = allEvents.find(ev => ev.id === id);
  const detail = document.getElementById('detail-content');
  if (!e) {
    detail.innerHTML = '<div class="detail-empty">Event not found</div>';
    renderEvents();
    return;
  }
  detail.innerHTML = `<div class="detail-content">
    <div class="detail-field">
      <div class="detail-label">Status</div>
      <div class="detail-value"><span class="${badgeClass(e.status)}">${e.status}</span></div>
    </div>
    <div class="detail-field">
      <div class="detail-label">Type</div>
      <div class="detail-value">${e.type}${e.isPR ? ' (Pull Request)' : ''}</div>
    </div>
    <div class="detail-field">
      <div class="detail-label">Repository</div>
      <div class="detail-value" style="color:#58a6ff">${e.repo || '--'}</div>
    </div>
    ${e.issue ? `<div class="detail-field"><div class="detail-label">Issue/PR</div><div class="detail-value">#${e.issue}</div></div>` : ''}
    <div class="detail-field">
      <div class="detail-label">User</div>
      <div class="detail-value">@${e.user || '--'}</div>
    </div>
    <div class="detail-field">
      <div class="detail-label">Prompt</div>
      <div class="detail-value">${escapeHtml(e.prompt || '--')}</div>
    </div>
    <div class="detail-field">
      <div class="detail-label">Time</div>
      <div class="detail-value">${new Date(e.timestamp).toLocaleString()}</div>
    </div>
    <div class="detail-field">
      <div class="detail-label">Response</div>
      <div class="detail-response">${e.response ? escapeHtml(e.response) : '<span style="color:#484f58">Waiting for response...</span>'}</div>
    </div>
  </div>`;
  renderEvents();
}

function escapeHtml(str) {
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

async function fetchEvents() {
  try {
    const res = await fetch('/api/events');
    allEvents = await res.json();
    renderEvents();
    if (selectedId) selectEvent(selectedId);
    document.getElementById('last-refresh').textContent = 'Updated ' + new Date().toLocaleTimeString();
  } catch (err) {
    console.error('Fetch error:', err);
  }
}

async function manualTrigger() {
  const repo = document.getElementById('trigger-repo').value.trim();
  const prompt = document.getElementById('trigger-prompt').value.trim();
  if (!repo || !prompt) return;

  const btn = document.getElementById('trigger-btn');
  btn.disabled = true;
  btn.textContent = 'Sending...';

  try {
    const res = await fetch('/api/trigger', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ repo, prompt }),
    });
    const data = await res.json();
    if (data.eventId) {
      document.getElementById('trigger-prompt').value = '';
      selectedId = data.eventId;
      setTimeout(fetchEvents, 500);
    }
  } catch (err) {
    console.error('Trigger error:', err);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Send to Claude';
  }
}

// Initial load + auto-refresh
fetchEvents();
setInterval(fetchEvents, 10000);
</script>
</body>
</html>
