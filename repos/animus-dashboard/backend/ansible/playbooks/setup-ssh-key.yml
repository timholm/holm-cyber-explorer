---
- name: Setup SSH key for Animus Dashboard
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    ssh_public_key: "{{ lookup('file', ssh_public_key_path) }}"
    target_user: tim

  tasks:
    - name: Ensure .ssh directory exists
      file:
        path: /home/{{ target_user }}/.ssh
        state: directory
        mode: '0700'
        owner: "{{ target_user }}"
        group: "{{ target_user }}"

    - name: Add public key to authorized_keys
      authorized_key:
        user: "{{ target_user }}"
        state: present
        key: "{{ ssh_public_key }}"
        comment: "animus-dashboard"

    - name: Verify SSH access
      command: echo "SSH access verified for {{ inventory_hostname }}"
      register: verify_result
      changed_when: false

    - name: Display verification
      debug:
        msg: "{{ verify_result.stdout }}"
