---
- name: Uncordon Kubernetes node
  hosts: "{{ target_hosts | default('all') }}"
  gather_facts: yes

  tasks:
    - name: Get node name
      command: hostname
      register: node_name
      changed_when: false

    - name: Check current node status
      delegate_to: localhost
      command: kubectl get node {{ node_name.stdout }} -o jsonpath='{.spec.unschedulable}'
      register: unschedulable_status
      changed_when: false

    - name: Display current status
      debug:
        msg: "Node {{ node_name.stdout }} unschedulable: {{ unschedulable_status.stdout | default('false') }}"

    - name: Uncordon the node
      delegate_to: localhost
      command: kubectl uncordon {{ node_name.stdout }}
      register: uncordon_result
      when: unschedulable_status.stdout == 'true'

    - name: Display uncordon result
      debug:
        msg: "{{ uncordon_result.stdout | default('Node was already schedulable') }}"

    - name: Wait for node to be ready
      delegate_to: localhost
      command: kubectl wait --for=condition=Ready node/{{ node_name.stdout }} --timeout=60s
      register: wait_result

    - name: Get final node status
      delegate_to: localhost
      shell: kubectl get node {{ node_name.stdout }}
      register: node_final_status
      changed_when: false

    - name: Display final node status
      debug:
        msg: "{{ node_final_status.stdout_lines }}"

    - name: Confirm node is ready
      debug:
        msg: "Node {{ node_name.stdout }} is now schedulable and ready for workloads"
