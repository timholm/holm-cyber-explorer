# Build stage
FROM mirror.gcr.io/library/golang:1.21-alpine AS builder

WORKDIR /app

# Embed source code via base64 to work around ConfigMap symlink issues
RUN echo 'cGFja2FnZSBtYWluCgppbXBvcnQgKAoJImRhdGFiYXNlL3NxbCIKCSJlbmNvZGluZy9qc29uIgoJImxvZyIKCSJuZXQvaHR0cCIKCSJvcyIKCSJ0aW1lIgoKCV8gImdpdGh1Yi5jb20vbGliL3BxIgopCgp2YXIgZGIgKnNxbC5EQgoKdHlwZSBTZXR0aW5nc0ltcG9ydCBzdHJ1Y3QgewoJVmVyc2lvbiAgICBzdHJpbmcgICAgICAgICAgICAgICAgIGBqc29uOiJ2ZXJzaW9uImAKCUV4cG9ydGVkQXQgdGltZS5UaW1lICAgICAgICAgICAgICBganNvbjoiZXhwb3J0ZWRBdCJgCglDbHVzdGVyICAgIG1hcFtzdHJpbmddaW50ZXJmYWNle30gYGpzb246ImNsdXN0ZXIiYAoJUmVnaXN0cnkgICBtYXBbc3RyaW5nXWludGVyZmFjZXt9IGBqc29uOiJyZWdpc3RyeSJgCglUaGVtZSAgICAgIG1hcFtzdHJpbmddaW50ZXJmYWNle30gYGpzb246InRoZW1lImAKCVRhYlN0YXRlICAgbWFwW3N0cmluZ11pbnRlcmZhY2V7fSBganNvbjoidGFiU3RhdGUiYAoJQ3VzdG9tRGF0YSBtYXBbc3RyaW5nXWludGVyZmFjZXt9IGBqc29uOiJjdXN0b21EYXRhLG9taXRlbXB0eSJgCn0KCnR5cGUgUmVzdG9yZVJlc3VsdCBzdHJ1Y3QgewoJU3RhdHVzICAgc3RyaW5nICAgYGpzb246InN0YXR1cyJgCglSZXN0b3JlZCBbXXN0cmluZyBganNvbjoicmVzdG9yZWQiYAoJRXJyb3JzICAgW11zdHJpbmcgYGpzb246ImVycm9ycyxvbWl0ZW1wdHkiYAp9CgpmdW5jIG1haW4oKSB7CgkvLyBDb25uZWN0IHRvIFBvc3RncmVTUUwKCWNvbm5TdHIgOj0gImhvc3Q9cG9zdGdyZXMuaG9sbS5zdmMuY2x1c3Rlci5sb2NhbCBwb3J0PTU0MzIgdXNlcj1wb3N0Z3JlcyBwYXNzd29yZD1wb3N0Z3JlcyBkYm5hbWU9aG9sbSBzc2xtb2RlPWRpc2FibGUiCgl2YXIgZXJyIGVycm9yCglkYiwgZXJyID0gc3FsLk9wZW4oInBvc3RncmVzIiwgY29ublN0cikKCWlmIGVyciAhPSBuaWwgewoJCWxvZy5QcmludGYoIldhcm5pbmc6IENvdWxkIG5vdCBjb25uZWN0IHRvIGRhdGFiYXNlOiAldiIsIGVycikKCX0gZWxzZSB7CgkJZGVmZXIgZGIuQ2xvc2UoKQoJCWluaXREQigpCgl9CgoJLy8gUm91dGVzCglodHRwLkhhbmRsZUZ1bmMoIi9oZWFsdGgiLCBoZWFsdGhIYW5kbGVyKQoJaHR0cC5IYW5kbGVGdW5jKCIvaW1wb3J0IiwgaW1wb3J0SGFuZGxlcikKCWh0dHAuSGFuZGxlRnVuYygiL3ZhbGlkYXRlIiwgdmFsaWRhdGVIYW5kbGVyKQoKCXBvcnQgOj0gb3MuR2V0ZW52KCJQT1JUIikKCWlmIHBvcnQgPT0gIiIgewoJCXBvcnQgPSAiODA4MCIKCX0KCglsb2cuUHJpbnRmKCJTZXR0aW5ncyBSZXN0b3JlIHNlcnZpY2Ugc3RhcnRpbmcgb24gcG9ydCAlcyIsIHBvcnQpCglpZiBlcnIgOj0gaHR0cC5MaXN0ZW5BbmRTZXJ2ZSgiOiIrcG9ydCwgbmlsKTsgZXJyICE9IG5pbCB7CgkJbG9nLkZhdGFsKGVycikKCX0KfQoKZnVuYyBpbml0REIoKSB7CgkvLyBFbnN1cmUgYWxsIHJlcXVpcmVkIHRhYmxlcyBleGlzdAoJdGFibGVzIDo9IFtdc3RyaW5newoJCWBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyBjbHVzdGVyX3NldHRpbmdzICgKCQkJaWQgU0VSSUFMIFBSSU1BUlkgS0VZLAoJCQluYW1lIFZBUkNIQVIoMjU1KSBERUZBVUxUICdob2xtLWNsdXN0ZXInLAoJCQlyZXNvdXJjZV9saW1pdHMgQk9PTEVBTiBERUZBVUxUIHRydWUsCgkJCWF1dG9fc2NhbGluZyBCT09MRUFOIERFRkFVTFQgZmFsc2UsCgkJCW5ldHdvcmtfcG9saWN5IEJPT0xFQU4gREVGQVVMVCB0cnVlLAoJCQl1cGRhdGVkX2F0IFRJTUVTVEFNUCBERUZBVUxUIENVUlJFTlRfVElNRVNUQU1QCgkJKWAsCgkJYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIHJlZ2lzdHJ5X3NldHRpbmdzICgKCQkJaWQgU0VSSUFMIFBSSU1BUlkgS0VZLAoJCQl1cmwgVkFSQ0hBUigyNTUpIERFRkFVTFQgJzEwLjExMC42Ny44Nzo1MDAwJywKCQkJbmFtZXNwYWNlIFZBUkNIQVIoMjU1KSBERUZBVUxUICdob2xtJywKCQkJaW5zZWN1cmUgQk9PTEVBTiBERUZBVUxUIHRydWUsCgkJCXB1bGxfcG9saWN5IFZBUkNIQVIoNTApIERFRkFVTFQgJ0lmTm90UHJlc2VudCcsCgkJCWltYWdlX2djIEJPT0xFQU4gREVGQVVMVCB0cnVlLAoJCQl1cGRhdGVkX2F0IFRJTUVTVEFNUCBERUZBVUxUIENVUlJFTlRfVElNRVNUQU1QCgkJKWAsCgkJYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIHRoZW1lX3ByZWZlcmVuY2VzICgKCQkJaWQgU0VSSUFMIFBSSU1BUlkgS0VZLAoJCQl1c2VyX2lkIFZBUkNIQVIoMjU1KSBVTklRVUUgREVGQVVMVCAnZGVmYXVsdCcsCgkJCXRoZW1lIFZBUkNIQVIoNTApIERFRkFVTFQgJ21vY2hhJywKCQkJY29tcGFjdF9tb2RlIEJPT0xFQU4gREVGQVVMVCBmYWxzZSwKCQkJYW5pbWF0aW9ucyBCT09MRUFOIERFRkFVTFQgdHJ1ZSwKCQkJZm9udF9zaXplIElOVEVHRVIgREVGQVVMVCAxNiwKCQkJYWNjZW50X2NvbG9yIFZBUkNIQVIoMjApIERFRkFVTFQgJ2xhdmVuZGVyJywKCQkJdXBkYXRlZF9hdCBUSU1FU1RBTVAgREVGQVVMVCBDVVJSRU5UX1RJTUVTVEFNUAoJCSlgLAoJCWBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyB0YWJfc3RhdGVzICgKCQkJaWQgU0VSSUFMIFBSSU1BUlkgS0VZLAoJCQl1c2VyX2lkIFZBUkNIQVIoMjU1KSBVTklRVUUgREVGQVVMVCAnZGVmYXVsdCcsCgkJCWFjdGl2ZV90YWIgVkFSQ0hBUig1MCkgREVGQVVMVCAnY2x1c3RlcicsCgkJCXVwZGF0ZWRfYXQgVElNRVNUQU1QIERFRkFVTFQgQ1VSUkVOVF9USU1FU1RBTVAKCQkpYCwKCX0KCglmb3IgXywgdGFibGUgOj0gcmFuZ2UgdGFibGVzIHsKCQlfLCBlcnIgOj0gZGIuRXhlYyh0YWJsZSkKCQlpZiBlcnIgIT0gbmlsIHsKCQkJbG9nLlByaW50ZigiRXJyb3IgY3JlYXRpbmcgdGFibGU6ICV2IiwgZXJyKQoJCX0KCX0KfQoKZnVuYyBoZWFsdGhIYW5kbGVyKHcgaHR0cC5SZXNwb25zZVdyaXRlciwgciAqaHR0cC5SZXF1ZXN0KSB7Cgl3LkhlYWRlcigpLlNldCgiQ29udGVudC1UeXBlIiwgImFwcGxpY2F0aW9uL2pzb24iKQoJanNvbi5OZXdFbmNvZGVyKHcpLkVuY29kZShtYXBbc3RyaW5nXXN0cmluZ3sic3RhdHVzIjogImhlYWx0aHkiLCAic2VydmljZSI6ICJzZXR0aW5ncy1yZXN0b3JlIn0pCn0KCmZ1bmMgaW1wb3J0SGFuZGxlcih3IGh0dHAuUmVzcG9uc2VXcml0ZXIsIHIgKmh0dHAuUmVxdWVzdCkgewoJdy5IZWFkZXIoKS5TZXQoIkNvbnRlbnQtVHlwZSIsICJhcHBsaWNhdGlvbi9qc29uIikKCXcuSGVhZGVyKCkuU2V0KCJBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4iLCAiKiIpCgl3LkhlYWRlcigpLlNldCgiQWNjZXNzLUNvbnRyb2wtQWxsb3ctTWV0aG9kcyIsICJQT1NULCBPUFRJT05TIikKCXcuSGVhZGVyKCkuU2V0KCJBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzIiwgIkNvbnRlbnQtVHlwZSIpCgoJaWYgci5NZXRob2QgPT0gIk9QVElPTlMiIHsKCQl3LldyaXRlSGVhZGVyKGh0dHAuU3RhdHVzT0spCgkJcmV0dXJuCgl9CgoJaWYgci5NZXRob2QgIT0gIlBPU1QiIHsKCQlodHRwLkVycm9yKHcsICJNZXRob2Qgbm90IGFsbG93ZWQiLCBodHRwLlN0YXR1c01ldGhvZE5vdEFsbG93ZWQpCgkJcmV0dXJuCgl9CgoJdmFyIHNldHRpbmdzIFNldHRpbmdzSW1wb3J0CglpZiBlcnIgOj0ganNvbi5OZXdEZWNvZGVyKHIuQm9keSkuRGVjb2RlKCZzZXR0aW5ncyk7IGVyciAhPSBuaWwgewoJCWh0dHAuRXJyb3IodywgZXJyLkVycm9yKCksIGh0dHAuU3RhdHVzQmFkUmVxdWVzdCkKCQlyZXR1cm4KCX0KCglyZXN1bHQgOj0gUmVzdG9yZVJlc3VsdHsKCQlTdGF0dXM6ICAgIm9rIiwKCQlSZXN0b3JlZDogW11zdHJpbmd7fSwKCQlFcnJvcnM6ICAgW11zdHJpbmd7fSwKCX0KCgkvLyBSZXN0b3JlIGNsdXN0ZXIgc2V0dGluZ3MKCWlmIHNldHRpbmdzLkNsdXN0ZXIgIT0gbmlsIHsKCQlpZiBlcnIgOj0gcmVzdG9yZUNsdXN0ZXJTZXR0aW5ncyhzZXR0aW5ncy5DbHVzdGVyKTsgZXJyICE9IG5pbCB7CgkJCXJlc3VsdC5FcnJvcnMgPSBhcHBlbmQocmVzdWx0LkVycm9ycywgImNsdXN0ZXI6ICIrZXJyLkVycm9yKCkpCgkJfSBlbHNlIHsKCQkJcmVzdWx0LlJlc3RvcmVkID0gYXBwZW5kKHJlc3VsdC5SZXN0b3JlZCwgImNsdXN0ZXIiKQoJCX0KCX0KCgkvLyBSZXN0b3JlIHJlZ2lzdHJ5IHNldHRpbmdzCglpZiBzZXR0aW5ncy5SZWdpc3RyeSAhPSBuaWwgewoJCWlmIGVyciA6PSByZXN0b3JlUmVnaXN0cnlTZXR0aW5ncyhzZXR0aW5ncy5SZWdpc3RyeSk7IGVyciAhPSBuaWwgewoJCQlyZXN1bHQuRXJyb3JzID0gYXBwZW5kKHJlc3VsdC5FcnJvcnMsICJyZWdpc3RyeTogIitlcnIuRXJyb3IoKSkKCQl9IGVsc2UgewoJCQlyZXN1bHQuUmVzdG9yZWQgPSBhcHBlbmQocmVzdWx0LlJlc3RvcmVkLCAicmVnaXN0cnkiKQoJCX0KCX0KCgkvLyBSZXN0b3JlIHRoZW1lIHNldHRpbmdzCglpZiBzZXR0aW5ncy5UaGVtZSAhPSBuaWwgewoJCWlmIGVyciA6PSByZXN0b3JlVGhlbWVTZXR0aW5ncyhzZXR0aW5ncy5UaGVtZSk7IGVyciAhPSBuaWwgewoJCQlyZXN1bHQuRXJyb3JzID0gYXBwZW5kKHJlc3VsdC5FcnJvcnMsICJ0aGVtZTogIitlcnIuRXJyb3IoKSkKCQl9IGVsc2UgewoJCQlyZXN1bHQuUmVzdG9yZWQgPSBhcHBlbmQocmVzdWx0LlJlc3RvcmVkLCAidGhlbWUiKQoJCX0KCX0KCgkvLyBSZXN0b3JlIHRhYiBzdGF0ZQoJaWYgc2V0dGluZ3MuVGFiU3RhdGUgIT0gbmlsIHsKCQlpZiBlcnIgOj0gcmVzdG9yZVRhYlN0YXRlKHNldHRpbmdzLlRhYlN0YXRlKTsgZXJyICE9IG5pbCB7CgkJCXJlc3VsdC5FcnJvcnMgPSBhcHBlbmQocmVzdWx0LkVycm9ycywgInRhYlN0YXRlOiAiK2Vyci5FcnJvcigpKQoJCX0gZWxzZSB7CgkJCXJlc3VsdC5SZXN0b3JlZCA9IGFwcGVuZChyZXN1bHQuUmVzdG9yZWQsICJ0YWJTdGF0ZSIpCgkJfQoJfQoKCWlmIGxlbihyZXN1bHQuRXJyb3JzKSA+IDAgewoJCXJlc3VsdC5TdGF0dXMgPSAicGFydGlhbCIKCX0KCglqc29uLk5ld0VuY29kZXIodykuRW5jb2RlKHJlc3VsdCkKfQoKZnVuYyByZXN0b3JlQ2x1c3RlclNldHRpbmdzKGRhdGEgbWFwW3N0cmluZ11pbnRlcmZhY2V7fSkgZXJyb3IgewoJaWYgZGIgPT0gbmlsIHsKCQlyZXR1cm4gbmlsCgl9CgoJbmFtZSA6PSBnZXRTdHJpbmdWYWx1ZShkYXRhLCAibmFtZSIsICJob2xtLWNsdXN0ZXIiKQoJcmVzb3VyY2VMaW1pdHMgOj0gZ2V0Qm9vbFZhbHVlKGRhdGEsICJyZXNvdXJjZUxpbWl0cyIsIHRydWUpCglhdXRvU2NhbGluZyA6PSBnZXRCb29sVmFsdWUoZGF0YSwgImF1dG9TY2FsaW5nIiwgZmFsc2UpCgluZXR3b3JrUG9saWN5IDo9IGdldEJvb2xWYWx1ZShkYXRhLCAibmV0d29ya1BvbGljeSIsIHRydWUpCgoJLy8gRGVsZXRlIGV4aXN0aW5nIGFuZCBpbnNlcnQgbmV3CglkYi5FeGVjKCJERUxFVEUgRlJPTSBjbHVzdGVyX3NldHRpbmdzIikKCV8sIGVyciA6PSBkYi5FeGVjKGAKCQlJTlNFUlQgSU5UTyBjbHVzdGVyX3NldHRpbmdzIChuYW1lLCByZXNvdXJjZV9saW1pdHMsIGF1dG9fc2NhbGluZywgbmV0d29ya19wb2xpY3kpCgkJVkFMVUVTICgkMSwgJDIsICQzLCAkNCkKCWAsIG5hbWUsIHJlc291cmNlTGltaXRzLCBhdXRvU2NhbGluZywgbmV0d29ya1BvbGljeSkKCglyZXR1cm4gZXJyCn0KCmZ1bmMgcmVzdG9yZVJlZ2lzdHJ5U2V0dGluZ3MoZGF0YSBtYXBbc3RyaW5nXWludGVyZmFjZXt9KSBlcnJvciB7CglpZiBkYiA9PSBuaWwgewoJCXJldHVybiBuaWwKCX0KCgl1cmwgOj0gZ2V0U3RyaW5nVmFsdWUoZGF0YSwgInVybCIsICIxMC4xMTAuNjcuODc6NTAwMCIpCgluYW1lc3BhY2UgOj0gZ2V0U3RyaW5nVmFsdWUoZGF0YSwgIm5hbWVzcGFjZSIsICJob2xtIikKCWluc2VjdXJlIDo9IGdldEJvb2xWYWx1ZShkYXRhLCAiaW5zZWN1cmUiLCB0cnVlKQoJcHVsbFBvbGljeSA6PSBnZXRTdHJpbmdWYWx1ZShkYXRhLCAicHVsbFBvbGljeSIsICJJZk5vdFByZXNlbnQiKQoJaW1hZ2VHQyA6PSBnZXRCb29sVmFsdWUoZGF0YSwgImltYWdlR0MiLCB0cnVlKQoKCS8vIERlbGV0ZSBleGlzdGluZyBhbmQgaW5zZXJ0IG5ldwoJZGIuRXhlYygiREVMRVRFIEZST00gcmVnaXN0cnlfc2V0dGluZ3MiKQoJXywgZXJyIDo9IGRiLkV4ZWMoYAoJCUlOU0VSVCBJTlRPIHJlZ2lzdHJ5X3NldHRpbmdzICh1cmwsIG5hbWVzcGFjZSwgaW5zZWN1cmUsIHB1bGxfcG9saWN5LCBpbWFnZV9nYykKCQlWQUxVRVMgKCQxLCAkMiwgJDMsICQ0LCAkNSkKCWAsIHVybCwgbmFtZXNwYWNlLCBpbnNlY3VyZSwgcHVsbFBvbGljeSwgaW1hZ2VHQykKCglyZXR1cm4gZXJyCn0KCmZ1bmMgcmVzdG9yZVRoZW1lU2V0dGluZ3MoZGF0YSBtYXBbc3RyaW5nXWludGVyZmFjZXt9KSBlcnJvciB7CglpZiBkYiA9PSBuaWwgewoJCXJldHVybiBuaWwKCX0KCgl0aGVtZSA6PSBnZXRTdHJpbmdWYWx1ZShkYXRhLCAidGhlbWUiLCAibW9jaGEiKQoJY29tcGFjdE1vZGUgOj0gZ2V0Qm9vbFZhbHVlKGRhdGEsICJjb21wYWN0TW9kZSIsIGZhbHNlKQoJYW5pbWF0aW9ucyA6PSBnZXRCb29sVmFsdWUoZGF0YSwgImFuaW1hdGlvbnMiLCB0cnVlKQoJZm9udFNpemUgOj0gZ2V0SW50VmFsdWUoZGF0YSwgImZvbnRTaXplIiwgMTYpCglhY2NlbnRDb2xvciA6PSBnZXRTdHJpbmdWYWx1ZShkYXRhLCAiYWNjZW50Q29sb3IiLCAibGF2ZW5kZXIiKQoKCS8vIFVwc2VydCBmb3IgZGVmYXVsdCB1c2VyCglfLCBlcnIgOj0gZGIuRXhlYyhgCgkJSU5TRVJUIElOVE8gdGhlbWVfcHJlZmVyZW5jZXMgKHVzZXJfaWQsIHRoZW1lLCBjb21wYWN0X21vZGUsIGFuaW1hdGlvbnMsIGZvbnRfc2l6ZSwgYWNjZW50X2NvbG9yLCB1cGRhdGVkX2F0KQoJCVZBTFVFUyAoJ2RlZmF1bHQnLCAkMSwgJDIsICQzLCAkNCwgJDUsIENVUlJFTlRfVElNRVNUQU1QKQoJCU9OIENPTkZMSUNUICh1c2VyX2lkKSBETyBVUERBVEUgU0VUCgkJCXRoZW1lID0gJDEsCgkJCWNvbXBhY3RfbW9kZSA9ICQyLAoJCQlhbmltYXRpb25zID0gJDMsCgkJCWZvbnRfc2l6ZSA9ICQ0LAoJCQlhY2NlbnRfY29sb3IgPSAkNSwKCQkJdXBkYXRlZF9hdCA9IENVUlJFTlRfVElNRVNUQU1QCglgLCB0aGVtZSwgY29tcGFjdE1vZGUsIGFuaW1hdGlvbnMsIGZvbnRTaXplLCBhY2NlbnRDb2xvcikKCglyZXR1cm4gZXJyCn0KCmZ1bmMgcmVzdG9yZVRhYlN0YXRlKGRhdGEgbWFwW3N0cmluZ11pbnRlcmZhY2V7fSkgZXJyb3IgewoJaWYgZGIgPT0gbmlsIHsKCQlyZXR1cm4gbmlsCgl9CgoJYWN0aXZlVGFiIDo9IGdldFN0cmluZ1ZhbHVlKGRhdGEsICJhY3RpdmVUYWIiLCAiY2x1c3RlciIpCgoJLy8gVXBzZXJ0IGZvciBkZWZhdWx0IHVzZXIKCV8sIGVyciA6PSBkYi5FeGVjKGAKCQlJTlNFUlQgSU5UTyB0YWJfc3RhdGVzICh1c2VyX2lkLCBhY3RpdmVfdGFiLCB1cGRhdGVkX2F0KQoJCVZBTFVFUyAoJ2RlZmF1bHQnLCAkMSwgQ1VSUkVOVF9USU1FU1RBTVApCgkJT04gQ09ORkxJQ1QgKHVzZXJfaWQpIERPIFVQREFURSBTRVQKCQkJYWN0aXZlX3RhYiA9ICQxLAoJCQl1cGRhdGVkX2F0ID0gQ1VSUkVOVF9USU1FU1RBTVAKCWAsIGFjdGl2ZVRhYikKCglyZXR1cm4gZXJyCn0KCmZ1bmMgdmFsaWRhdGVIYW5kbGVyKHcgaHR0cC5SZXNwb25zZVdyaXRlciwgciAqaHR0cC5SZXF1ZXN0KSB7Cgl3LkhlYWRlcigpLlNldCgiQ29udGVudC1UeXBlIiwgImFwcGxpY2F0aW9uL2pzb24iKQoJdy5IZWFkZXIoKS5TZXQoIkFjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbiIsICIqIikKCXcuSGVhZGVyKCkuU2V0KCJBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzIiwgIlBPU1QsIE9QVElPTlMiKQoJdy5IZWFkZXIoKS5TZXQoIkFjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMiLCAiQ29udGVudC1UeXBlIikKCglpZiByLk1ldGhvZCA9PSAiT1BUSU9OUyIgewoJCXcuV3JpdGVIZWFkZXIoaHR0cC5TdGF0dXNPSykKCQlyZXR1cm4KCX0KCglpZiByLk1ldGhvZCAhPSAiUE9TVCIgewoJCWh0dHAuRXJyb3IodywgIk1ldGhvZCBub3QgYWxsb3dlZCIsIGh0dHAuU3RhdHVzTWV0aG9kTm90QWxsb3dlZCkKCQlyZXR1cm4KCX0KCgl2YXIgc2V0dGluZ3MgU2V0dGluZ3NJbXBvcnQKCWlmIGVyciA6PSBqc29uLk5ld0RlY29kZXIoci5Cb2R5KS5EZWNvZGUoJnNldHRpbmdzKTsgZXJyICE9IG5pbCB7CgkJanNvbi5OZXdFbmNvZGVyKHcpLkVuY29kZShtYXBbc3RyaW5nXWludGVyZmFjZXt9ewoJCQkidmFsaWQiOiAgZmFsc2UsCgkJCSJlcnJvciI6ICAiSW52YWxpZCBKU09OIGZvcm1hdCIsCgkJCSJkZXRhaWwiOiBlcnIuRXJyb3IoKSwKCQl9KQoJCXJldHVybgoJfQoKCS8vIFZhbGlkYXRlIHN0cnVjdHVyZQoJdmFsaWRhdGlvbiA6PSBtYXBbc3RyaW5nXWludGVyZmFjZXt9ewoJCSJ2YWxpZCI6ICAgIHRydWUsCgkJInNlY3Rpb25zIjogW11zdHJpbmd7fSwKCX0KCglzZWN0aW9ucyA6PSBbXXN0cmluZ3t9CglpZiBzZXR0aW5ncy5DbHVzdGVyICE9IG5pbCB7CgkJc2VjdGlvbnMgPSBhcHBlbmQoc2VjdGlvbnMsICJjbHVzdGVyIikKCX0KCWlmIHNldHRpbmdzLlJlZ2lzdHJ5ICE9IG5pbCB7CgkJc2VjdGlvbnMgPSBhcHBlbmQoc2VjdGlvbnMsICJyZWdpc3RyeSIpCgl9CglpZiBzZXR0aW5ncy5UaGVtZSAhPSBuaWwgewoJCXNlY3Rpb25zID0gYXBwZW5kKHNlY3Rpb25zLCAidGhlbWUiKQoJfQoJaWYgc2V0dGluZ3MuVGFiU3RhdGUgIT0gbmlsIHsKCQlzZWN0aW9ucyA9IGFwcGVuZChzZWN0aW9ucywgInRhYlN0YXRlIikKCX0KCgl2YWxpZGF0aW9uWyJzZWN0aW9ucyJdID0gc2VjdGlvbnMKCglpZiBsZW4oc2VjdGlvbnMpID09IDAgewoJCXZhbGlkYXRpb25bInZhbGlkIl0gPSBmYWxzZQoJCXZhbGlkYXRpb25bImVycm9yIl0gPSAiTm8gdmFsaWQgc2V0dGluZ3Mgc2VjdGlvbnMgZm91bmQiCgl9CgoJanNvbi5OZXdFbmNvZGVyKHcpLkVuY29kZSh2YWxpZGF0aW9uKQp9CgovLyBIZWxwZXIgZnVuY3Rpb25zCmZ1bmMgZ2V0U3RyaW5nVmFsdWUoZGF0YSBtYXBbc3RyaW5nXWludGVyZmFjZXt9LCBrZXksIGRlZmF1bHRWYWx1ZSBzdHJpbmcpIHN0cmluZyB7CglpZiB2YWwsIG9rIDo9IGRhdGFba2V5XTsgb2sgewoJCWlmIHN0ciwgb2sgOj0gdmFsLihzdHJpbmcpOyBvayB7CgkJCXJldHVybiBzdHIKCQl9Cgl9CglyZXR1cm4gZGVmYXVsdFZhbHVlCn0KCmZ1bmMgZ2V0Qm9vbFZhbHVlKGRhdGEgbWFwW3N0cmluZ11pbnRlcmZhY2V7fSwga2V5IHN0cmluZywgZGVmYXVsdFZhbHVlIGJvb2wpIGJvb2wgewoJaWYgdmFsLCBvayA6PSBkYXRhW2tleV07IG9rIHsKCQlpZiBiLCBvayA6PSB2YWwuKGJvb2wpOyBvayB7CgkJCXJldHVybiBiCgkJfQoJfQoJcmV0dXJuIGRlZmF1bHRWYWx1ZQp9CgpmdW5jIGdldEludFZhbHVlKGRhdGEgbWFwW3N0cmluZ11pbnRlcmZhY2V7fSwga2V5IHN0cmluZywgZGVmYXVsdFZhbHVlIGludCkgaW50IHsKCWlmIHZhbCwgb2sgOj0gZGF0YVtrZXldOyBvayB7CgkJaWYgZiwgb2sgOj0gdmFsLihmbG9hdDY0KTsgb2sgewoJCQlyZXR1cm4gaW50KGYpCgkJfQoJCWlmIGksIG9rIDo9IHZhbC4oaW50KTsgb2sgewoJCQlyZXR1cm4gaQoJCX0KCX0KCXJldHVybiBkZWZhdWx0VmFsdWUKfQo=' | base64 -d > /app/main.go

# Initialize module and build
RUN go mod init settings-restore && \
    go get github.com/lib/pq && \
    go mod tidy && \
    CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -o server /app/main.go

# Runtime stage - use scratch for minimal static binary
FROM scratch

# Copy binary
COPY --from=builder /app/server /server

EXPOSE 8080

ENTRYPOINT ["/server"]
