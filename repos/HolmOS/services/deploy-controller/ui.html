<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deploy Controller - HolmOS</title>
    <style>
        :root {
            --ctp-rosewater: #f5e0dc; --ctp-flamingo: #f2cdcd; --ctp-pink: #f5c2e7;
            --ctp-mauve: #cba6f7; --ctp-red: #f38ba8; --ctp-maroon: #eba0ac;
            --ctp-peach: #fab387; --ctp-yellow: #f9e2af; --ctp-green: #a6e3a1;
            --ctp-teal: #94e2d5; --ctp-sky: #89dceb; --ctp-sapphire: #74c7ec;
            --ctp-blue: #89b4fa; --ctp-lavender: #b4befe; --ctp-text: #cdd6f4;
            --ctp-subtext1: #bac2de; --ctp-subtext0: #a6adc8;
            --ctp-surface2: #585b70; --ctp-surface1: #45475a; --ctp-surface0: #313244;
            --ctp-base: #1e1e2e; --ctp-mantle: #181825; --ctp-crust: #11111b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--ctp-base); color: var(--ctp-text); min-height: 100vh; padding: 1.5rem; }
        .container { max-width: 1600px; margin: 0 auto; }
        header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--ctp-surface0); }
        h1 { color: var(--ctp-mauve); font-size: 1.75rem; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; }
        .status-Running { background: var(--ctp-green); color: var(--ctp-crust); }
        .status-Updating { background: var(--ctp-yellow); color: var(--ctp-crust); }
        .status-NotReady { background: var(--ctp-red); color: var(--ctp-crust); }
        .status-success { background: var(--ctp-green); color: var(--ctp-crust); }
        .status-failed { background: var(--ctp-red); color: var(--ctp-crust); }
        .status-deploying { background: var(--ctp-blue); color: var(--ctp-crust); }
        .status-healthy { background: var(--ctp-green); color: var(--ctp-crust); }
        .status-checking { background: var(--ctp-yellow); color: var(--ctp-crust); }
        .status-pending { background: var(--ctp-surface2); color: var(--ctp-text); }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--ctp-surface0); padding-bottom: 0.5rem; flex-wrap: wrap; }
        .tab { padding: 0.5rem 1rem; border-radius: 8px 8px 0 0; cursor: pointer; background: var(--ctp-surface0); color: var(--ctp-subtext0); border: none; font-size: 0.9rem; }
        .tab.active { background: var(--ctp-mauve); color: var(--ctp-crust); }
        .tab:hover { background: var(--ctp-surface1); }
        .tab.active:hover { background: var(--ctp-mauve); }
        .panel { display: none; }
        .panel.active { display: block; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1rem; }
        .card { background: var(--ctp-surface0); border-radius: 12px; padding: 1rem; border: 1px solid var(--ctp-surface1); }
        .card:hover { border-color: var(--ctp-mauve); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .card-title { font-weight: 600; }
        .card-body { font-size: 0.85rem; color: var(--ctp-subtext0); }
        .image-tag { font-family: monospace; font-size: 0.75rem; background: var(--ctp-surface1); padding: 0.25rem 0.5rem; border-radius: 4px; word-break: break-all; display: inline-block; margin-top: 0.5rem; }
        .events-list { max-height: 600px; overflow-y: auto; }
        .event-item { background: var(--ctp-surface0); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; border-left: 3px solid var(--ctp-mauve); }
        .event-item.success { border-left-color: var(--ctp-green); }
        .event-item.failed { border-left-color: var(--ctp-red); }
        .event-item.deploying { border-left-color: var(--ctp-blue); }
        .event-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .event-title { font-weight: 600; }
        .event-time { font-size: 0.75rem; color: var(--ctp-subtext0); }
        .btn { padding: 0.5rem 1rem; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; font-size: 0.85rem; transition: all 0.2s; }
        .btn:hover { filter: brightness(1.1); }
        .btn-primary { background: var(--ctp-mauve); color: var(--ctp-crust); }
        .btn-danger { background: var(--ctp-red); color: var(--ctp-crust); }
        .btn-secondary { background: var(--ctp-surface1); color: var(--ctp-text); }
        .btn-success { background: var(--ctp-green); color: var(--ctp-crust); }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.25rem; font-size: 0.85rem; color: var(--ctp-subtext0); }
        .form-input { width: 100%; padding: 0.5rem; border-radius: 8px; background: var(--ctp-surface1); border: 1px solid var(--ctp-surface2); color: var(--ctp-text); }
        .form-input:focus { outline: none; border-color: var(--ctp-mauve); }
        .form-checkbox { display: flex; align-items: center; gap: 0.5rem; }
        .form-checkbox input { width: 18px; height: 18px; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: var(--ctp-surface0); border-radius: 16px; padding: 1.5rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: var(--ctp-mauve); margin-bottom: 1rem; }
        .modal-footer { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem; }
        .webhook-info { background: var(--ctp-surface1); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; font-family: monospace; font-size: 0.8rem; }
        .webhook-info code { background: var(--ctp-surface0); padding: 0.15rem 0.35rem; border-radius: 4px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: var(--ctp-surface0); border-radius: 12px; padding: 1rem; text-align: center; }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--ctp-mauve); }
        .stat-label { font-size: 0.85rem; color: var(--ctp-subtext0); }
        .auto-badge { background: var(--ctp-blue); color: var(--ctp-crust); padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem; }
        .trigger-badge { background: var(--ctp-surface1); padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.7rem; }
        .trigger-badge.registry-webhook { background: var(--ctp-peach); color: var(--ctp-crust); }
        .trigger-badge.registry-poll { background: var(--ctp-yellow); color: var(--ctp-crust); }
        .trigger-badge.manual { background: var(--ctp-blue); color: var(--ctp-crust); }
        .trigger-badge.rollback { background: var(--ctp-red); color: var(--ctp-crust); }
        .trigger-badge.auto-create { background: var(--ctp-green); color: var(--ctp-crust); }
        .trigger-badge.build-webhook { background: var(--ctp-teal); color: var(--ctp-crust); }

        /* Health check indicator */
        .health-indicator { display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; }
        .health-dot { width: 8px; height: 8px; border-radius: 50%; }
        .health-dot.healthy { background: var(--ctp-green); }
        .health-dot.checking { background: var(--ctp-yellow); animation: pulse 1s infinite; }
        .health-dot.pending { background: var(--ctp-surface2); }
        .health-dot.failed { background: var(--ctp-red); }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* History timeline */
        .history-timeline { position: relative; padding-left: 2rem; }
        .history-timeline::before { content: ''; position: absolute; left: 0.5rem; top: 0; bottom: 0; width: 2px; background: var(--ctp-surface1); }
        .history-item { position: relative; margin-bottom: 1rem; padding: 0.75rem; background: var(--ctp-surface0); border-radius: 8px; }
        .history-item::before { content: ''; position: absolute; left: -1.75rem; top: 1rem; width: 12px; height: 12px; border-radius: 50%; background: var(--ctp-mauve); border: 2px solid var(--ctp-base); }
        .history-item.success::before { background: var(--ctp-green); }
        .history-item.failed::before { background: var(--ctp-red); }
        .history-item.deploying::before { background: var(--ctp-blue); }
        .history-version { font-weight: 600; color: var(--ctp-mauve); }
        .history-meta { font-size: 0.75rem; color: var(--ctp-subtext0); margin-top: 0.25rem; }

        /* Registry events */
        .registry-event { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--ctp-surface0); border-radius: 8px; margin-bottom: 0.5rem; }
        .registry-event.processed { border-left: 3px solid var(--ctp-green); }
        .registry-event.pending { border-left: 3px solid var(--ctp-yellow); }
        .digest { font-family: monospace; font-size: 0.7rem; color: var(--ctp-subtext0); }

        /* Health checks panel */
        .health-check-card { background: var(--ctp-surface0); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; }
        .health-check-card.healthy { border-left: 3px solid var(--ctp-green); }
        .health-check-card.checking { border-left: 3px solid var(--ctp-yellow); }
        .health-check-card.failed { border-left: 3px solid var(--ctp-red); }
        .health-check-card.pending { border-left: 3px solid var(--ctp-surface2); }
        .pod-status { display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.15rem 0.5rem; background: var(--ctp-surface1); border-radius: 4px; font-size: 0.7rem; margin-right: 0.5rem; margin-top: 0.5rem; }
        .pod-status.ready { background: var(--ctp-green); color: var(--ctp-crust); }
        .pod-status.not-ready { background: var(--ctp-yellow); color: var(--ctp-crust); }

        /* Progress bar for health checks */
        .progress-bar { height: 4px; background: var(--ctp-surface1); border-radius: 2px; margin-top: 0.5rem; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--ctp-mauve); transition: width 0.3s; }
        .progress-fill.healthy { background: var(--ctp-green); }
        .progress-fill.failed { background: var(--ctp-red); }

        /* Scale controls */
        .scale-controls { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; }
        .scale-btn { width: 24px; height: 24px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; }
        .scale-btn:hover { filter: brightness(1.2); }

        /* Notification animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        /* Live indicator */
        .live-indicator { display: inline-flex; align-items: center; gap: 0.5rem; }
        .live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--ctp-green); animation: pulse 1.5s infinite; }

        /* Apply manifest textarea */
        #apply-manifest { font-size: 0.85rem; line-height: 1.4; tab-size: 2; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Deploy Controller v4 <span class="live-indicator" id="live-indicator" style="font-size:0.75rem;color:var(--ctp-subtext0)"><span class="live-dot"></span>Live</span></h1>
            <span class="status-badge status-Running" id="health-badge">Healthy</span>
        </header>
        <div class="stats" id="stats">
            <div class="stat-card"><div class="stat-value" id="total-deps">0</div><div class="stat-label">Deployments</div></div>
            <div class="stat-card"><div class="stat-value" id="running-count">0</div><div class="stat-label">Running</div></div>
            <div class="stat-card"><div class="stat-value" id="auto-count">0</div><div class="stat-label">Auto-Deploy</div></div>
            <div class="stat-card"><div class="stat-value" id="events-count">0</div><div class="stat-label">Deploy Events</div></div>
            <div class="stat-card"><div class="stat-value" id="health-count">0</div><div class="stat-label">Health Checks</div></div>
        </div>
        <div class="tabs">
            <button class="tab active" data-tab="deployments">Deployments</button>
            <button class="tab" data-tab="health-checks">Health Checks</button>
            <button class="tab" data-tab="logs">Logs</button>
            <button class="tab" data-tab="history">History</button>
            <button class="tab" data-tab="events">Events</button>
            <button class="tab" data-tab="apply">Apply Manifest</button>
            <button class="tab" data-tab="registry">Registry</button>
            <button class="tab" data-tab="webhooks">Webhooks</button>
            <button class="tab" data-tab="images">Images</button>
            <button class="tab" data-tab="autodeploy">Auto-Deploy</button>
        </div>

        <div id="deployments" class="panel active"><div class="grid" id="deps-grid"></div></div>

        <div id="health-checks" class="panel">
            <div class="events-list" id="health-list"></div>
        </div>

        <div id="logs" class="panel">
            <div class="form-group" style="margin-bottom:1rem;display:flex;gap:1rem;align-items:flex-end">
                <div>
                    <label class="form-label">Deployment</label>
                    <select id="logs-select" class="form-input" style="width:300px">
                        <option value="">Select deployment...</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="loadLogs()">Refresh Logs</button>
                <label class="form-checkbox">
                    <input type="checkbox" id="logs-auto-refresh">
                    <span>Auto-refresh</span>
                </label>
            </div>
            <div id="logs-content" style="background:var(--ctp-crust);border-radius:8px;padding:1rem;font-family:monospace;font-size:0.8rem;max-height:600px;overflow-y:auto;">
                <p style="color:var(--ctp-subtext0)">Select a deployment to view logs</p>
            </div>
        </div>

        <div id="history" class="panel">
            <div class="form-group" style="margin-bottom:1rem">
                <select id="history-select" class="form-input" style="max-width:300px">
                    <option value="">Select deployment...</option>
                </select>
            </div>
            <div class="history-timeline" id="history-timeline"></div>
        </div>

        <div id="events" class="panel"><div class="events-list" id="events-list"></div></div>

        <div id="apply" class="panel">
            <div class="card">
                <h2 class="modal-title">Apply Kubernetes Manifest</h2>
                <p style="color:var(--ctp-subtext0);margin-bottom:1rem">Paste your YAML manifest below. Supports Deployment, Service, and ConfigMap resources.</p>
                <div class="form-group">
                    <label class="form-label">Namespace (default for resources without namespace)</label>
                    <input type="text" id="apply-namespace" class="form-input" value="holm" style="max-width:200px">
                </div>
                <div class="form-group">
                    <label class="form-label">YAML Manifest</label>
                    <textarea id="apply-manifest" class="form-input" style="font-family:monospace;min-height:300px;resize:vertical" placeholder="apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
spec:
  replicas: 1
  ..."></textarea>
                </div>
                <div style="display:flex;gap:1rem;align-items:center">
                    <button class="btn btn-primary" onclick="applyManifest()">Apply</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('apply-manifest').value=''">Clear</button>
                </div>
                <div id="apply-results" style="margin-top:1rem"></div>
            </div>
        </div>

        <div id="registry" class="panel">
            <div class="webhook-info">
                <strong>Registry Webhook URL:</strong><br>
                <code>POST http://deploy-controller.holm.svc.cluster.local/api/webhook/registry</code><br><br>
                <strong>Configure in registry:</strong> Set <code>REGISTRY_HTTP_NOTIFICATIONS_ENDPOINTS</code> to point here
            </div>
            <div class="events-list" id="registry-list"></div>
        </div>

        <div id="webhooks" class="panel">
            <div class="webhook-info">
                <strong>Git Webhook:</strong> <code>POST /api/webhook/git</code><br>
                <strong>Build Webhook:</strong> <code>POST /api/webhook/build</code><br>
                <strong>Registry Webhook:</strong> <code>POST /api/webhook/registry</code>
            </div>
            <div class="events-list" id="webhook-list"></div>
        </div>

        <div id="images" class="panel"><div class="grid" id="images-grid"></div></div>

        <div id="autodeploy" class="panel">
            <button class="btn btn-primary" onclick="showRuleModal()" style="margin-bottom:1rem">+ Add Rule</button>
            <div class="grid" id="rules-grid"></div>
        </div>
    </div>

    <!-- Deploy Modal -->
    <div id="deploy-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Deploy Image</h2>
            <div class="form-group"><label class="form-label">Deployment</label><input type="text" id="d-name" class="form-input" readonly></div>
            <div class="form-group"><label class="form-label">Image</label><input type="text" id="d-image" class="form-input"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('deploy-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="doDeploy()">Deploy</button>
            </div>
        </div>
    </div>

    <!-- Rule Modal -->
    <div id="rule-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Add Auto-Deploy Rule</h2>
            <div class="form-group">
                <label class="form-label">Image Pattern</label>
                <input type="text" id="r-pattern" class="form-input" placeholder="e.g., my-app">
                <small style="color:var(--ctp-subtext0)">Matches repository names containing this pattern</small>
            </div>
            <div class="form-group">
                <label class="form-label">Tag Pattern (optional)</label>
                <input type="text" id="r-tag" class="form-input" placeholder="e.g., latest, v*, or leave empty for all">
            </div>
            <div class="form-group">
                <label class="form-label">Target Deployment</label>
                <input type="text" id="r-deploy" class="form-input" placeholder="Deployment name">
            </div>
            <div class="form-group">
                <label class="form-label">Namespace</label>
                <input type="text" id="r-ns" class="form-input" value="holm">
            </div>
            <div class="form-group">
                <label class="form-label">Health Check Path</label>
                <input type="text" id="r-health-path" class="form-input" value="/health">
            </div>
            <div class="form-group">
                <label class="form-label">Health Check Port</label>
                <input type="number" id="r-health-port" class="form-input" value="8080">
            </div>
            <div class="form-group">
                <label class="form-label">Service Port (for auto-created services)</label>
                <input type="number" id="r-service-port" class="form-input" value="8080">
            </div>
            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" id="r-autocreate">
                    <span>Auto-create deployment if it doesn't exist</span>
                </label>
            </div>
            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" id="r-createservice">
                    <span>Auto-create service for deployment</span>
                </label>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('rule-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="addRule()">Add Rule</button>
            </div>
        </div>
    </div>

    <!-- Rollback Modal -->
    <div id="rollback-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Rollback Deployment</h2>
            <div class="form-group">
                <label class="form-label">Deployment</label>
                <input type="text" id="rb-name" class="form-input" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">Select Version</label>
                <select id="rb-version" class="form-input"></select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('rollback-modal')">Cancel</button>
                <button class="btn btn-danger" onclick="doRollback()">Rollback</button>
            </div>
        </div>
    </div>

    <!-- Scale Modal -->
    <div id="scale-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Scale Deployment</h2>
            <div class="form-group">
                <label class="form-label">Deployment</label>
                <input type="text" id="s-name" class="form-input" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">Replicas</label>
                <input type="number" id="s-replicas" class="form-input" min="0" max="10">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('scale-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="doScale()">Scale</button>
            </div>
        </div>
    </div>

    <script>
        let deps=[], evts=[], hooks=[], imgs=[], rules={}, regEvts=[], history={}, healthChecks={};
        let eventSource = null;
        let logsAutoRefreshInterval = null;

        document.querySelectorAll('.tab').forEach(t=>t.onclick=()=>{
            document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
            t.classList.add('active');
            document.getElementById(t.dataset.tab).classList.add('active');
        });

        // Setup Server-Sent Events for real-time updates
        function setupSSE() {
            if (eventSource) {
                eventSource.close();
            }
            eventSource = new EventSource('/api/events/stream');

            eventSource.addEventListener('deployments', (e) => {
                try {
                    const newDeps = JSON.parse(e.data);
                    if (JSON.stringify(newDeps) !== JSON.stringify(deps)) {
                        deps = newDeps;
                        renderDeployments();
                    }
                } catch(err) { console.error('SSE deployments error:', err); }
            });

            eventSource.addEventListener('events', (e) => {
                try {
                    const newEvents = JSON.parse(e.data);
                    if (newEvents.length > 0) {
                        evts = [...newEvents, ...evts.slice(0, 100 - newEvents.length)];
                        renderEvents();
                        showNotification(newEvents[0]);
                    }
                } catch(err) { console.error('SSE events error:', err); }
            });

            eventSource.addEventListener('health-checks', (e) => {
                try {
                    healthChecks = JSON.parse(e.data);
                    renderHealthChecks();
                    renderDeployments(); // Update deployment cards with health check status
                    document.getElementById('health-count').textContent = Object.keys(healthChecks).length;
                } catch(err) { console.error('SSE health-checks error:', err); }
            });

            eventSource.addEventListener('rollout-progress', (e) => {
                try {
                    const progress = JSON.parse(e.data);
                    // Update specific deployment card with rollout progress
                    const key = progress.key;
                    if (healthChecks[key]) {
                        healthChecks[key] = {...healthChecks[key], ...progress};
                        renderHealthChecks();
                        renderDeployments();
                    }
                } catch(err) { console.error('SSE rollout-progress error:', err); }
            });

            eventSource.onerror = () => {
                console.log('SSE connection lost, reconnecting...');
                setTimeout(setupSSE, 3000);
            };
        }

        function showNotification(event) {
            if (event.status === 'success' || event.status === 'failed') {
                const color = event.status === 'success' ? 'var(--ctp-green)' : 'var(--ctp-red)';
                const notif = document.createElement('div');
                notif.style.cssText = `position:fixed;top:20px;right:20px;background:${color};color:var(--ctp-crust);padding:1rem;border-radius:8px;z-index:9999;animation:fadeIn 0.3s`;
                notif.innerHTML = `<strong>${event.deployment}</strong>: ${event.status}<br><small>${event.message}</small>`;
                document.body.appendChild(notif);
                setTimeout(() => notif.remove(), 5000);
            }
        }

        async function load(){
            try{
                const [d,e,w,i,r,re,h,hc]=await Promise.all([
                    fetch('/api/deployments').then(r=>r.json()),
                    fetch('/api/events').then(r=>r.json()),
                    fetch('/api/webhook').then(r=>r.json()),
                    fetch('/api/images').then(r=>r.json()),
                    fetch('/api/autodeploy').then(r=>r.json()),
                    fetch('/api/registry-events').then(r=>r.json()),
                    fetch('/api/history').then(r=>r.json()),
                    fetch('/api/health-checks').then(r=>r.json())
                ]);
                deps=d||[];evts=e||[];hooks=w||[];imgs=i||[];rules=r||{};regEvts=re||[];history=h||{};healthChecks=hc||{};
                render();
            }catch(e){console.error(e);}
        }

        function render(){
            document.getElementById('total-deps').textContent=deps.length;
            document.getElementById('running-count').textContent=deps.filter(d=>d.status==='Running').length;
            document.getElementById('auto-count').textContent=Object.keys(rules).length;
            document.getElementById('events-count').textContent=evts.length;
            document.getElementById('health-count').textContent=Object.keys(healthChecks).length;

            // Deployments grid
            document.getElementById('deps-grid').innerHTML=deps.map(d=>{
                const hc = healthChecks[`${d.namespace}/${d.name}`];
                const healthStatus = hc ? hc.status : 'none';
                const rs = hc && hc.rolloutStatus;
                return `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">${d.name}${d.autoDeploy?'<span class="auto-badge">AUTO</span>':''}</span>
                        <span class="status-badge status-${d.status}">${d.status}</span>
                    </div>
                    <div class="card-body">
                        <p>${d.ready}/${d.replicas} ready
                            ${hc ? `<span class="health-indicator"><span class="health-dot ${healthStatus}"></span>${healthStatus}</span>` : ''}
                        </p>
                        <div class="image-tag">${d.image||'No image'}</div>
                        ${hc && (hc.status === 'checking' || hc.status === 'pending') ? `
                            <div class="rollout-progress" style="margin-top:0.5rem;padding:0.5rem;background:var(--ctp-surface1);border-radius:4px;font-size:0.75rem">
                                ${rs ? `
                                    <div>Updated: ${rs.updatedReplicas}/${rs.replicas} | Ready: ${rs.readyReplicas}/${rs.replicas} | Available: ${rs.availableReplicas}/${rs.replicas}</div>
                                    ${rs.stalled ? `<div style="color:var(--ctp-red);margin-top:0.25rem">Stalled: ${rs.stalledReason}</div>` : ''}
                                ` : `<div>${hc.message}</div>`}
                                <div class="progress-bar" style="margin-top:0.25rem">
                                    <div class="progress-fill ${rs && rs.stalled ? 'failed' : ''}" style="width: ${Math.min(100, (hc.attempts / hc.maxAttempts) * 100)}%"></div>
                                </div>
                            </div>
                        ` : ''}
                        <div style="margin-top:0.75rem;display:flex;gap:0.5rem;flex-wrap:wrap">
                            <button class="btn btn-primary btn-sm" onclick="showDeployModal('${d.name}','${d.image||''}')">Deploy</button>
                            <button class="btn btn-success btn-sm" onclick="restartDeployment('${d.name}')">Restart</button>
                            <button class="btn btn-danger btn-sm" onclick="showRollbackModal('${d.name}')">Rollback</button>
                            <button class="btn btn-secondary btn-sm" onclick="showScaleModal('${d.name}',${d.replicas})">Scale</button>
                            <button class="btn btn-secondary btn-sm" onclick="viewLogs('${d.name}')">Logs</button>
                            <button class="btn btn-secondary btn-sm" onclick="showHistory('${d.name}')">History</button>
                        </div>
                    </div>
                </div>
            `}).join('');

            // Health checks list
            const hcList = Object.entries(healthChecks);
            document.getElementById('health-list').innerHTML = hcList.length ? hcList.map(([key, hc]) => {
                const rs = hc.rolloutStatus;
                return `
                <div class="health-check-card ${hc.status}">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <strong>${hc.deployment}</strong>
                            <span class="status-badge status-${hc.status}" style="margin-left:0.5rem">${hc.status}</span>
                        </div>
                        <span style="font-size:0.75rem;color:var(--ctp-subtext0)">${hc.attempts}/${hc.maxAttempts} checks</span>
                    </div>
                    <p style="margin-top:0.5rem;font-size:0.85rem">${hc.message}</p>
                    <div class="image-tag">${hc.image}</div>
                    ${rs ? `
                        <div style="margin-top:0.5rem;padding:0.5rem;background:var(--ctp-surface1);border-radius:4px;font-size:0.8rem">
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;text-align:center">
                                <div><span style="color:var(--ctp-blue)">${rs.updatedReplicas}/${rs.replicas}</span><br><small>Updated</small></div>
                                <div><span style="color:var(--ctp-green)">${rs.readyReplicas}/${rs.replicas}</span><br><small>Ready</small></div>
                                <div><span style="color:var(--ctp-teal)">${rs.availableReplicas}/${rs.replicas}</span><br><small>Available</small></div>
                            </div>
                            ${rs.stalled ? `<div style="color:var(--ctp-red);margin-top:0.5rem;padding:0.25rem;background:rgba(243,139,168,0.1);border-radius:4px">Stalled: ${rs.stalledReason}</div>` : ''}
                            ${rs.conditions && rs.conditions.length ? `
                                <details style="margin-top:0.5rem">
                                    <summary style="cursor:pointer;color:var(--ctp-subtext0)">Deployment Conditions</summary>
                                    <div style="margin-top:0.25rem;font-size:0.7rem">
                                        ${rs.conditions.map(c => `
                                            <div style="padding:0.25rem;border-left:2px solid ${c.status === 'True' ? 'var(--ctp-green)' : c.status === 'False' ? 'var(--ctp-red)' : 'var(--ctp-yellow)'};padding-left:0.5rem;margin-top:0.25rem">
                                                <strong>${c.type}</strong>: ${c.status} (${c.reason})<br>
                                                <span style="color:var(--ctp-subtext0)">${c.message}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </details>
                            ` : ''}
                        </div>
                    ` : ''}
                    ${hc.podStatuses && hc.podStatuses.length ? `
                        <div style="margin-top:0.5rem">
                            ${hc.podStatuses.map(p => `
                                <div class="pod-status ${p.ready ? 'ready' : 'not-ready'}" style="display:block;margin-bottom:0.25rem">
                                    ${p.name.split('-').slice(-2).join('-')} (${p.phase})
                                    ${p.message ? `<br><small style="opacity:0.8">${p.message}</small>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    <div class="progress-bar">
                        <div class="progress-fill ${hc.status}" style="width: ${hc.status === 'healthy' ? 100 : hc.status === 'failed' ? 100 : Math.min(100, (hc.attempts / hc.maxAttempts) * 100)}%"></div>
                    </div>
                    <div style="font-size:0.7rem;color:var(--ctp-subtext0);margin-top:0.5rem">
                        Started: ${new Date(hc.startTime).toLocaleString()} | Last check: ${new Date(hc.lastCheck).toLocaleString()}
                    </div>
                </div>
            `}).join('') : '<p style="color:var(--ctp-subtext0)">No active health checks</p>';

            // Events list
            document.getElementById('events-list').innerHTML=evts.map(e=>`
                <div class="event-item ${e.status}">
                    <div class="event-header">
                        <span class="event-title">${e.deployment}</span>
                        <span class="event-time">${new Date(e.timestamp).toLocaleString()}</span>
                    </div>
                    <div>
                        <span class="status-badge status-${e.status}">${e.status}</span>
                        <span class="trigger-badge ${e.trigger}">${e.trigger}</span>
                        ${e.duration?`<span style="font-size:0.75rem;color:var(--ctp-subtext0);margin-left:0.5rem">${e.duration.toFixed(2)}s</span>`:''}
                    </div>
                    <p style="margin-top:0.5rem">${e.message}</p>
                    <div class="image-tag">${e.image}</div>
                    ${e.oldImage?`<div class="image-tag" style="opacity:0.6">Previous: ${e.oldImage}</div>`:''}
                </div>
            `).join('')||'<p style="color:var(--ctp-subtext0)">No events yet</p>';

            // Registry events
            document.getElementById('registry-list').innerHTML=regEvts.map(e=>`
                <div class="registry-event ${e.processed?'processed':'pending'}">
                    <div>
                        <strong>${e.repository}:${e.tag}</strong>
                        ${e.autoDeploy?'<span class="auto-badge">Auto-deployed</span>':''}
                        <div class="digest">${e.digest?e.digest.substring(0,20)+'...':''}</div>
                        <div style="font-size:0.75rem;color:var(--ctp-subtext0)">${new Date(e.timestamp).toLocaleString()}</div>
                    </div>
                    <span class="status-badge ${e.processed?'status-success':'status-Updating'}">${e.processed?'Processed':'Pending'}</span>
                </div>
            `).join('')||'<p style="color:var(--ctp-subtext0)">No registry events. Configure registry webhooks to receive push notifications.</p>';

            // Webhook list
            document.getElementById('webhook-list').innerHTML=hooks.map(w=>`
                <div class="event-item">
                    <div class="event-header">
                        <span class="event-title">${w.type}: ${w.repo}</span>
                        <span class="event-time">${new Date(w.timestamp).toLocaleString()}</span>
                    </div>
                    <p>Branch: ${w.branch} | Commit: ${w.commit}</p>
                </div>
            `).join('')||'<p style="color:var(--ctp-subtext0)">No webhooks received</p>';

            // Images grid
            document.getElementById('images-grid').innerHTML=imgs.slice(0,50).map(i=>`
                <div class="card">
                    <div class="card-header"><span class="card-title">${i.name}</span></div>
                    <div class="card-body">Tags: ${(i.tags||[]).slice(0,5).join(', ')||'none'}</div>
                </div>
            `).join('');

            // Auto-deploy rules
            document.getElementById('rules-grid').innerHTML=Object.values(rules).map(r=>`
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">${r.deployment}</span>
                        <span class="status-badge status-${r.enabled?'Running':'NotReady'}">${r.enabled?'Enabled':'Disabled'}</span>
                    </div>
                    <div class="card-body">
                        <p><strong>Pattern:</strong> ${r.imagePattern}</p>
                        ${r.tagPattern?`<p><strong>Tag:</strong> ${r.tagPattern}</p>`:''}
                        <p><strong>Namespace:</strong> ${r.namespace}</p>
                        <p><strong>Health:</strong> ${r.healthCheckPath||'/health'}:${r.healthCheckPort||8080}</p>
                        ${r.autoCreate?'<p><span class="auto-badge">Auto-create</span></p>':''}
                        ${r.createService?'<p><span class="auto-badge" style="background:var(--ctp-teal)">Auto-service</span></p>':''}
                        ${r.lastTriggered?`<p style="font-size:0.75rem;color:var(--ctp-subtext0)">Last: ${new Date(r.lastTriggered).toLocaleString()}</p>`:''}
                        <button class="btn btn-danger btn-sm" style="margin-top:0.5rem" onclick="delRule('${r.deployment}')">Delete</button>
                    </div>
                </div>
            `).join('')||'<p style="color:var(--ctp-subtext0)">No auto-deploy rules configured</p>';

            // History select
            const sel=document.getElementById('history-select');
            const currentVal=sel.value;
            sel.innerHTML='<option value="">Select deployment...</option>'+deps.map(d=>`<option value="${d.name}">${d.name}</option>`).join('');
            sel.value=currentVal;
            if(currentVal)renderHistory(currentVal);
        }

        function renderHistory(deployment){
            const h=history[deployment]||[];
            document.getElementById('history-timeline').innerHTML=h.length?h.map(v=>`
                <div class="history-item ${v.status}">
                    <div class="history-version">v${v.version}</div>
                    <div class="image-tag">${v.image}</div>
                    <div class="history-meta">
                        <span class="trigger-badge ${v.trigger}">${v.trigger}</span>
                        <span class="status-badge status-${v.status}" style="margin-left:0.5rem">${v.status}</span>
                        ${v.duration?`<span style="margin-left:0.5rem">${v.duration.toFixed(2)}s</span>`:''}
                        <span style="margin-left:0.5rem">${new Date(v.timestamp).toLocaleString()}</span>
                    </div>
                </div>
            `).join(''):'<p style="color:var(--ctp-subtext0)">No history for this deployment</p>';
        }

        document.getElementById('history-select').onchange=e=>renderHistory(e.target.value);

        function showHistory(name){
            document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
            document.querySelector('[data-tab="history"]').classList.add('active');
            document.getElementById('history').classList.add('active');
            document.getElementById('history-select').value=name;
            renderHistory(name);
        }

        function showDeployModal(n,i){
            document.getElementById('d-name').value=n;
            document.getElementById('d-image').value=i;
            document.getElementById('deploy-modal').classList.add('show');
        }

        function showRuleModal(){
            document.getElementById('r-pattern').value='';
            document.getElementById('r-tag').value='';
            document.getElementById('r-deploy').value='';
            document.getElementById('r-ns').value='holm';
            document.getElementById('r-health-path').value='/health';
            document.getElementById('r-health-port').value='8080';
            document.getElementById('r-service-port').value='8080';
            document.getElementById('r-autocreate').checked=false;
            document.getElementById('r-createservice').checked=false;
            document.getElementById('rule-modal').classList.add('show');
        }

        function showScaleModal(name, replicas){
            document.getElementById('s-name').value=name;
            document.getElementById('s-replicas').value=replicas;
            document.getElementById('scale-modal').classList.add('show');
        }

        async function showRollbackModal(name){
            document.getElementById('rb-name').value=name;
            const h=history[name]||[];
            const sel=document.getElementById('rb-version');
            sel.innerHTML=h.filter(v=>v.status==='success'||v.status==='healthy').slice(1).map(v=>`<option value="${v.version}">v${v.version}: ${v.image.split('/').pop()}</option>`).join('');
            if(sel.options.length===0){
                sel.innerHTML='<option value="">No previous versions</option>';
            }
            document.getElementById('rollback-modal').classList.add('show');
        }

        function closeModal(id){document.getElementById(id).classList.remove('show');}

        async function doDeploy(){
            const d=document.getElementById('d-name').value;
            const i=document.getElementById('d-image').value;
            await fetch('/api/deploy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({deployment:d,image:i,namespace:'holm'})});
            closeModal('deploy-modal');
            load();
        }

        async function doRollback(){
            const d=document.getElementById('rb-name').value;
            const v=parseInt(document.getElementById('rb-version').value)||0;
            await fetch('/api/rollback',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({deployment:d,namespace:'holm',version:v})});
            closeModal('rollback-modal');
            load();
        }

        async function doScale(){
            const d=document.getElementById('s-name').value;
            const r=parseInt(document.getElementById('s-replicas').value);
            await fetch('/api/scale',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({deployment:d,namespace:'holm',replicas:r})});
            closeModal('scale-modal');
            load();
        }

        async function addRule(){
            const r={
                imagePattern:document.getElementById('r-pattern').value,
                tagPattern:document.getElementById('r-tag').value,
                deployment:document.getElementById('r-deploy').value,
                namespace:document.getElementById('r-ns').value,
                healthCheckPath:document.getElementById('r-health-path').value,
                healthCheckPort:parseInt(document.getElementById('r-health-port').value)||8080,
                servicePort:parseInt(document.getElementById('r-service-port').value)||8080,
                autoCreate:document.getElementById('r-autocreate').checked,
                createService:document.getElementById('r-createservice').checked,
                enabled:true
            };
            await fetch('/api/autodeploy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(r)});
            closeModal('rule-modal');
            load();
        }

        async function delRule(d){
            if(confirm('Delete rule for '+d+'?')){
                await fetch('/api/autodeploy?deployment='+d,{method:'DELETE'});
                load();
            }
        }

        // Logs functionality
        async function loadLogs() {
            const deployment = document.getElementById('logs-select').value;
            if (!deployment) {
                document.getElementById('logs-content').innerHTML = '<p style="color:var(--ctp-subtext0)">Select a deployment to view logs</p>';
                return;
            }

            document.getElementById('logs-content').innerHTML = '<p style="color:var(--ctp-yellow)">Loading logs...</p>';

            try {
                const [logsRes, eventsRes] = await Promise.all([
                    fetch(`/api/logs?deployment=${deployment}&namespace=holm`).then(r => r.json()),
                    fetch(`/api/k8s-events?deployment=${deployment}&namespace=holm`).then(r => r.json())
                ]);

                let html = '';

                // Show k8s events first
                if (eventsRes.events && eventsRes.events.length > 0) {
                    html += '<div style="margin-bottom:1rem;padding:0.75rem;background:var(--ctp-surface0);border-radius:8px">';
                    html += '<strong style="color:var(--ctp-mauve)">Kubernetes Events</strong><br>';
                    for (const e of eventsRes.events.slice(0, 10)) {
                        const color = e.type === 'Warning' ? 'var(--ctp-red)' : e.type === 'Normal' ? 'var(--ctp-green)' : 'var(--ctp-text)';
                        html += `<div style="margin-top:0.5rem;padding:0.25rem;border-left:2px solid ${color};padding-left:0.5rem">`;
                        html += `<span style="color:${color}">${e.type}</span> <span style="color:var(--ctp-yellow)">${e.reason}</span>`;
                        html += `<br><span style="color:var(--ctp-subtext0)">${e.message}</span>`;
                        html += `<br><span style="font-size:0.7rem;color:var(--ctp-subtext0)">${new Date(e.lastTimestamp).toLocaleString()} (${e.count}x)</span>`;
                        html += '</div>';
                    }
                    html += '</div>';
                }

                // Show pod logs
                if (logsRes.pods && logsRes.pods.length > 0) {
                    for (const pod of logsRes.pods) {
                        const readyColor = pod.ready ? 'var(--ctp-green)' : 'var(--ctp-red)';
                        html += `<div style="margin-bottom:1rem">`;
                        html += `<div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem">`;
                        html += `<span style="width:10px;height:10px;border-radius:50%;background:${readyColor}"></span>`;
                        html += `<strong style="color:var(--ctp-mauve)">${pod.podName}</strong>`;
                        html += `<span style="color:var(--ctp-subtext0)">(${pod.container})</span>`;
                        html += `<span class="status-badge status-${pod.ready ? 'Running' : 'NotReady'}">${pod.phase}</span>`;
                        html += `</div>`;
                        html += `<pre style="background:var(--ctp-mantle);padding:0.75rem;border-radius:4px;overflow-x:auto;white-space:pre-wrap;word-break:break-all;max-height:300px;overflow-y:auto">${escapeHtml(pod.logs || 'No logs available')}</pre>`;
                        html += `</div>`;
                    }
                } else {
                    html += '<p style="color:var(--ctp-subtext0)">No pods found for this deployment</p>';
                }

                document.getElementById('logs-content').innerHTML = html;
            } catch (err) {
                document.getElementById('logs-content').innerHTML = `<p style="color:var(--ctp-red)">Error loading logs: ${err.message}</p>`;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.getElementById('logs-auto-refresh').onchange = (e) => {
            if (e.target.checked) {
                logsAutoRefreshInterval = setInterval(loadLogs, 5000);
            } else {
                clearInterval(logsAutoRefreshInterval);
            }
        };

        // Apply manifest functionality
        async function applyManifest() {
            const manifest = document.getElementById('apply-manifest').value.trim();
            const namespace = document.getElementById('apply-namespace').value.trim() || 'holm';

            if (!manifest) {
                document.getElementById('apply-results').innerHTML = '<p style="color:var(--ctp-red)">Please enter a manifest</p>';
                return;
            }

            document.getElementById('apply-results').innerHTML = '<p style="color:var(--ctp-yellow)">Applying manifest...</p>';

            try {
                const res = await fetch('/api/apply', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({manifest, namespace})
                });
                const data = await res.json();

                let html = '<div style="margin-top:1rem">';
                for (const result of data.results || []) {
                    const color = result.status === 'error' ? 'var(--ctp-red)' :
                                  result.status === 'created' ? 'var(--ctp-green)' :
                                  result.status === 'updated' ? 'var(--ctp-blue)' : 'var(--ctp-yellow)';
                    html += `<div style="padding:0.5rem;margin-bottom:0.5rem;background:var(--ctp-surface0);border-radius:4px;border-left:3px solid ${color}">`;
                    html += `<strong style="color:${color}">${result.status.toUpperCase()}</strong> `;
                    html += `<span style="color:var(--ctp-mauve)">${result.kind}/${result.name}</span>`;
                    html += `<br><span style="color:var(--ctp-subtext0)">${result.message}</span>`;
                    html += '</div>';
                }
                html += '</div>';
                document.getElementById('apply-results').innerHTML = html;

                // Refresh deployments
                load();
            } catch (err) {
                document.getElementById('apply-results').innerHTML = `<p style="color:var(--ctp-red)">Error: ${err.message}</p>`;
            }
        }

        // Restart deployment
        async function restartDeployment(name) {
            if (!confirm(`Restart deployment ${name}? This will trigger a rolling update.`)) return;

            try {
                const res = await fetch('/api/restart', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({deployment: name, namespace: 'holm'})
                });
                const data = await res.json();
                if (data.status === 'restarted') {
                    showNotification({deployment: name, status: 'deploying', message: 'Restart initiated'});
                }
                load();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Separate render functions for SSE updates
        function renderDeployments() {
            document.getElementById('total-deps').textContent = deps.length;
            document.getElementById('running-count').textContent = deps.filter(d => d.status === 'Running').length;

            document.getElementById('deps-grid').innerHTML = deps.map(d => {
                const hc = healthChecks[`${d.namespace}/${d.name}`];
                const healthStatus = hc ? hc.status : 'none';
                const rs = hc && hc.rolloutStatus;
                return `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">${d.name}${d.autoDeploy ? '<span class="auto-badge">AUTO</span>' : ''}</span>
                        <span class="status-badge status-${d.status}">${d.status}</span>
                    </div>
                    <div class="card-body">
                        <p>${d.ready}/${d.replicas} ready
                            ${hc ? `<span class="health-indicator"><span class="health-dot ${healthStatus}"></span>${healthStatus}</span>` : ''}
                        </p>
                        <div class="image-tag">${d.image || 'No image'}</div>
                        ${hc && (hc.status === 'checking' || hc.status === 'pending') ? `
                            <div class="rollout-progress" style="margin-top:0.5rem;padding:0.5rem;background:var(--ctp-surface1);border-radius:4px;font-size:0.75rem">
                                ${rs ? `
                                    <div>Updated: ${rs.updatedReplicas}/${rs.replicas} | Ready: ${rs.readyReplicas}/${rs.replicas} | Available: ${rs.availableReplicas}/${rs.replicas}</div>
                                    ${rs.stalled ? `<div style="color:var(--ctp-red);margin-top:0.25rem">Stalled: ${rs.stalledReason}</div>` : ''}
                                ` : `<div>${hc.message}</div>`}
                                <div class="progress-bar" style="margin-top:0.25rem">
                                    <div class="progress-fill ${rs && rs.stalled ? 'failed' : ''}" style="width: ${Math.min(100, (hc.attempts / hc.maxAttempts) * 100)}%"></div>
                                </div>
                            </div>
                        ` : ''}
                        <div style="margin-top:0.75rem;display:flex;gap:0.5rem;flex-wrap:wrap">
                            <button class="btn btn-primary btn-sm" onclick="showDeployModal('${d.name}','${d.image || ''}')">Deploy</button>
                            <button class="btn btn-success btn-sm" onclick="restartDeployment('${d.name}')">Restart</button>
                            <button class="btn btn-danger btn-sm" onclick="showRollbackModal('${d.name}')">Rollback</button>
                            <button class="btn btn-secondary btn-sm" onclick="showScaleModal('${d.name}',${d.replicas})">Scale</button>
                            <button class="btn btn-secondary btn-sm" onclick="viewLogs('${d.name}')">Logs</button>
                            <button class="btn btn-secondary btn-sm" onclick="showHistory('${d.name}')">History</button>
                        </div>
                    </div>
                </div>
            `}).join('');

            // Update logs select
            const logsSelect = document.getElementById('logs-select');
            const currentLogsVal = logsSelect.value;
            logsSelect.innerHTML = '<option value="">Select deployment...</option>' + deps.map(d => `<option value="${d.name}">${d.name}</option>`).join('');
            logsSelect.value = currentLogsVal;
        }

        function renderEvents() {
            document.getElementById('events-count').textContent = evts.length;
            document.getElementById('events-list').innerHTML = evts.map(e => `
                <div class="event-item ${e.status}">
                    <div class="event-header">
                        <span class="event-title">${e.deployment}</span>
                        <span class="event-time">${new Date(e.timestamp).toLocaleString()}</span>
                    </div>
                    <div>
                        <span class="status-badge status-${e.status}">${e.status}</span>
                        <span class="trigger-badge ${e.trigger}">${e.trigger}</span>
                        ${e.duration ? `<span style="font-size:0.75rem;color:var(--ctp-subtext0);margin-left:0.5rem">${e.duration.toFixed(2)}s</span>` : ''}
                    </div>
                    <p style="margin-top:0.5rem">${e.message}</p>
                    <div class="image-tag">${e.image}</div>
                    ${e.oldImage ? `<div class="image-tag" style="opacity:0.6">Previous: ${e.oldImage}</div>` : ''}
                </div>
            `).join('') || '<p style="color:var(--ctp-subtext0)">No events yet</p>';
        }

        function renderHealthChecks() {
            const hcList = Object.entries(healthChecks);
            document.getElementById('health-list').innerHTML = hcList.length ? hcList.map(([key, hc]) => {
                const rs = hc.rolloutStatus;
                return `
                <div class="health-check-card ${hc.status}">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <strong>${hc.deployment}</strong>
                            <span class="status-badge status-${hc.status}" style="margin-left:0.5rem">${hc.status}</span>
                        </div>
                        <span style="font-size:0.75rem;color:var(--ctp-subtext0)">${hc.attempts}/${hc.maxAttempts} checks${hc.elapsed ? ` (${hc.elapsed.toFixed(0)}s)` : ''}</span>
                    </div>
                    <p style="margin-top:0.5rem;font-size:0.85rem">${hc.message}</p>
                    <div class="image-tag">${hc.image}</div>
                    ${rs ? `
                        <div style="margin-top:0.5rem;padding:0.5rem;background:var(--ctp-surface1);border-radius:4px;font-size:0.8rem">
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;text-align:center">
                                <div><span style="color:var(--ctp-blue)">${rs.updatedReplicas}/${rs.replicas}</span><br><small>Updated</small></div>
                                <div><span style="color:var(--ctp-green)">${rs.readyReplicas}/${rs.replicas}</span><br><small>Ready</small></div>
                                <div><span style="color:var(--ctp-teal)">${rs.availableReplicas}/${rs.replicas}</span><br><small>Available</small></div>
                            </div>
                            ${rs.stalled ? `<div style="color:var(--ctp-red);margin-top:0.5rem;padding:0.25rem;background:rgba(243,139,168,0.1);border-radius:4px">Stalled: ${rs.stalledReason}</div>` : ''}
                            ${rs.conditions && rs.conditions.length ? `
                                <details style="margin-top:0.5rem">
                                    <summary style="cursor:pointer;color:var(--ctp-subtext0)">Deployment Conditions</summary>
                                    <div style="margin-top:0.25rem;font-size:0.7rem">
                                        ${rs.conditions.map(c => `
                                            <div style="padding:0.25rem;border-left:2px solid ${c.status === 'True' ? 'var(--ctp-green)' : c.status === 'False' ? 'var(--ctp-red)' : 'var(--ctp-yellow)'};padding-left:0.5rem;margin-top:0.25rem">
                                                <strong>${c.type}</strong>: ${c.status} (${c.reason})<br>
                                                <span style="color:var(--ctp-subtext0)">${c.message}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </details>
                            ` : ''}
                        </div>
                    ` : ''}
                    ${hc.podStatuses && hc.podStatuses.length ? `
                        <div style="margin-top:0.5rem">
                            ${hc.podStatuses.map(p => `
                                <div class="pod-status ${p.ready ? 'ready' : 'not-ready'}" style="display:block;margin-bottom:0.25rem">
                                    ${p.name.split('-').slice(-2).join('-')} (${p.phase})
                                    ${p.message ? `<br><small style="opacity:0.8">${p.message}</small>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    <div class="progress-bar">
                        <div class="progress-fill ${hc.status}" style="width: ${hc.status === 'healthy' ? 100 : hc.status === 'failed' ? 100 : Math.min(100, (hc.attempts / hc.maxAttempts) * 100)}%"></div>
                    </div>
                    <div style="font-size:0.7rem;color:var(--ctp-subtext0);margin-top:0.5rem">
                        Started: ${new Date(hc.startTime).toLocaleString()} | Last check: ${new Date(hc.lastCheck).toLocaleString()}
                    </div>
                </div>
            `}).join('') : '<p style="color:var(--ctp-subtext0)">No active health checks</p>';
        }

        function viewLogs(name) {
            document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(x => x.classList.remove('active'));
            document.querySelector('[data-tab="logs"]').classList.add('active');
            document.getElementById('logs').classList.add('active');
            document.getElementById('logs-select').value = name;
            loadLogs();
        }

        // Setup SSE on page load
        setupSSE();

        load();
        setInterval(load, 5000);
    </script>
</body>
</html>
